---
phase: 27-infrastructure-foundation-prisma-fix
plan: 03
type: execute
wave: 2
depends_on: [27-01, 27-02]
files_modified: []
autonomous: false
requirements: [DEPLOY-01, DEPLOY-02, DEPLOY-06]

must_haves:
  truths:
    - "Visiting https://devcollab.fernandomillan.dev returns a live page with valid TLS (no cert warning)"
    - "Visiting https://devcollab-api.fernandomillan.dev/health returns 200 with valid TLS"
    - "Visiting https://teamflow.fernandomillan.dev returns a live page with valid TLS"
    - "The VPS root user has GHCR credentials in /root/.docker/config.json so Coolify can pull private images"
    - "Both GitHub secrets (NEXT_PUBLIC_DEVCOLLAB_API_URL and COOLIFY_DEVCOLLAB_WEBHOOK_URL) are set in the repository"
    - "The Coolify DevCollab stack is running with DEVCOLLAB_WEB_URL=https://devcollab.fernandomillan.dev (no trailing slash)"
  artifacts:
    - path: "/root/.docker/config.json (on VPS)"
      provides: "GHCR pull credentials for Coolify"
      contains: "ghcr.io"
  key_links:
    - from: "Coolify DevCollab stack env var DEVCOLLAB_WEB_URL"
      to: "devcollab-api CORS origin"
      via: "process.env.DEVCOLLAB_WEB_URL in main.ts"
      pattern: "https://devcollab.fernandomillan.dev"
    - from: "GitHub secret COOLIFY_DEVCOLLAB_WEBHOOK_URL"
      to: "Coolify DevCollab stack deploy trigger"
      via: "fjogeleit/http-request-action POST in deploy-devcollab GHA job"
      pattern: "COOLIFY_DEVCOLLAB_WEBHOOK_URL"
---

<objective>
Configure the VPS and Coolify with GHCR authentication, DNS, TLS, stack setup, and environment variables so both TeamFlow and DevCollab are live at HTTPS custom domains with auto-deploy from GitHub.

Purpose: These are manual steps that require SSH access to the VPS and access to the Coolify UI and GitHub repository settings. Claude cannot perform these actions — they require human credentials and browser interaction.
Output: Both apps live at HTTPS domains, Coolify stacks configured, GitHub secrets set.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@coolify-compose.yml
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure GHCR pull authentication on VPS as root (DEPLOY-06)</name>
  <files>VPS: /root/.docker/config.json</files>
  <action>
    SSH into the VPS and configure GHCR pull credentials as root so Coolify can pull private images. Coolify runs Docker as root and reads credentials from /root/.docker/config.json — credentials stored under any other user account (e.g., ubuntu) will not be found.

    Steps:
    1. SSH into the VPS as your normal user.
    2. Switch to root: `sudo su -`
    3. Log in to GHCR using a GitHub Classic Personal Access Token with `read:packages` scope:
       `echo "YOUR_CLASSIC_PAT_HERE" | docker login ghcr.io -u YOUR_GITHUB_USERNAME --password-stdin`
       To create a classic PAT: GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic) → Generate new token → check `read:packages`.
    4. Verify: `cat /root/.docker/config.json` — should contain a `ghcr.io` entry under `auths`.
    5. Test pull: `docker pull ghcr.io/fernandomillan-dev/fernandomillan/devcollab-api:latest` — should succeed.

    Note: push a commit to main first so images exist in GHCR before testing the pull.
  </action>
  <verify>
    Run as root on VPS: `cat /root/.docker/config.json` — shows ghcr.io entry.
    Run: `docker pull ghcr.io/fernandomillan-dev/fernandomillan/devcollab-api:latest` — exits 0.
  </verify>
  <done>/root/.docker/config.json contains ghcr.io credentials and docker pull of a private devcollab image succeeds from VPS root user. Coolify can now pull GHCR images without authentication errors.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Add GitHub repository secrets for DevCollab CI/CD (DEPLOY-05)</name>
  <files>GitHub: repository secrets</files>
  <action>
    Add two GitHub repository secrets required by the updated deploy.yml workflow (created in Plan 02).

    Go to: GitHub → your repository → Settings → Secrets and variables → Actions → Repository secrets

    Secret 1: `NEXT_PUBLIC_DEVCOLLAB_API_URL`
    Value: `https://devcollab-api.fernandomillan.dev` (no trailing slash, https, exact subdomain)

    Secret 2: `COOLIFY_DEVCOLLAB_WEBHOOK_URL`
    Value: The deploy webhook URL from the Coolify DevCollab stack settings page (including the token query parameter).
    How to find it: Coolify UI → DevCollab stack → Settings tab → "Deploy Webhook" or "Webhook URL" section → copy the full URL.
    NOTE: If the Coolify DevCollab stack does not exist yet, complete Task 3 first to create it, then come back to add this secret.
  </action>
  <verify>
    Both `NEXT_PUBLIC_DEVCOLLAB_API_URL` and `COOLIFY_DEVCOLLAB_WEBHOOK_URL` appear in the GitHub repository secrets list (values will be masked — that is expected).
  </verify>
  <done>Both secrets exist in GitHub repository secrets. The existing COOLIFY_WEBHOOK_URL secret (for TeamFlow) remains unchanged.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Create and configure Coolify stacks for TeamFlow and DevCollab (DEPLOY-01, DEPLOY-02)</name>
  <files>Coolify UI, DNS provider</files>
  <action>
    Create the Coolify Docker Compose stacks for both applications, configure DNS A records, let Coolify issue TLS certificates, and set all required environment variables.

    Step A — DNS Setup (do this first, TLS cert issuance needs DNS propagated):
    Configure these DNS A records pointing to your VPS IP:
    - `devcollab.fernandomillan.dev` → VPS IP
    - `devcollab-api.fernandomillan.dev` → VPS IP
    - `teamflow.fernandomillan.dev` → VPS IP
    Wait for propagation: `nslookup devcollab.fernandomillan.dev` should return your VPS IP.

    Step B — DevCollab Stack in Coolify:
    1. Coolify UI → New Resource → Docker Compose
    2. Source: paste or reference the repo's `coolify-compose.yml` file
    3. Set domain for `devcollab-web` service: `https://devcollab.fernandomillan.dev`
    4. Set domain for `devcollab-api` service: `https://devcollab-api.fernandomillan.dev`
    5. Set environment variables on the stack:
       DEVCOLLAB_POSTGRES_USER=devcollab
       DEVCOLLAB_POSTGRES_PASSWORD=<generate strong random password>
       DEVCOLLAB_POSTGRES_DB=devcollab
       DEVCOLLAB_DATABASE_URL=postgresql://devcollab:<password>@devcollab-postgres:5432/devcollab
       DEVCOLLAB_JWT_SECRET=<generate strong random secret 64+ chars>
       DEVCOLLAB_WEB_URL=https://devcollab.fernandomillan.dev
       (IMPORTANT: no trailing slash on DEVCOLLAB_WEB_URL — this is the CORS origin)
       (DO NOT set NEXT_PUBLIC_API_URL here — it was baked at Docker build time)
    6. Deploy the stack. Watch logs: devcollab-migrate runs and exits 0 (stays stopped, not restarting), devcollab-api starts healthy.
    7. Copy the Deploy Webhook URL from Coolify stack Settings and add it as COOLIFY_DEVCOLLAB_WEBHOOK_URL GitHub secret (Task 2).

    Step C — TeamFlow Stack in Coolify:
    1. Coolify UI → New Resource → Docker Compose
    2. Use TeamFlow services (postgres, redis, api, web) with GHCR image references replacing build: sections:
       - web: ghcr.io/fernandomillan-dev/fernandomillan/web:latest
       - api: ghcr.io/fernandomillan-dev/fernandomillan/api:latest
    3. Set domain for web service: `https://teamflow.fernandomillan.dev`
    4. Set environment variables: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB, DATABASE_URL, REDIS_URL, JWT_SECRET, NEXTAUTH_SECRET, NEXTAUTH_URL=https://teamflow.fernandomillan.dev, NEXT_PUBLIC_API_URL=https://teamflow-api.fernandomillan.dev, NODE_ENV=production
    5. Deploy and verify healthy startup.
    6. Verify the existing COOLIFY_WEBHOOK_URL GitHub secret points to the TeamFlow stack webhook.
  </action>
  <verify>
    Visit in browser (padlock icon visible, no cert warning):
    - `https://devcollab.fernandomillan.dev` — loads DevCollab login page
    - `https://devcollab-api.fernandomillan.dev/health` — returns JSON response
    - `https://teamflow.fernandomillan.dev` — loads TeamFlow
  </verify>
  <done>Both Coolify stacks are deployed and healthy. All four HTTPS domains load without TLS warnings. DEVCOLLAB_WEB_URL is set to exactly `https://devcollab.fernandomillan.dev` (no trailing slash). devcollab-migrate container is stopped (not restarting) in Coolify.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: End-to-end production verification</name>
  <files></files>
  <action>
    Verify all five phase success criteria in a browser. This confirms that the code changes from Plans 01 and 02 work correctly end-to-end in production.
  </action>
  <verify>
    Perform each check using Chrome (for DevTools access):

    Check 1 — TLS on all domains:
    - Visit `https://devcollab.fernandomillan.dev` — page loads, padlock visible
    - Visit `https://devcollab-api.fernandomillan.dev/health` — returns JSON, valid TLS
    - Visit `https://teamflow.fernandomillan.dev` — page loads, valid TLS

    Check 2 — NEXT_PUBLIC_API_URL baked correctly:
    - Open `https://devcollab.fernandomillan.dev` in Chrome
    - Open DevTools → Network tab
    - Navigate or log in to trigger an API call
    - Confirm XHR/Fetch requests go to `https://devcollab-api.fernandomillan.dev`, NOT `http://localhost:3003`

    Check 3 — Login and cross-origin cookie:
    - Log in at `https://devcollab.fernandomillan.dev` with valid credentials
    - Open DevTools → Application → Cookies → `https://devcollab.fernandomillan.dev`
    - Confirm `devcollab_token` cookie exists with `SameSite: None` and `Secure: true`
    - Navigate to a protected page — confirm it loads (cookie sent cross-origin successfully)

    Check 4 — Auto-deploy on push:
    - Make a trivial commit to main (e.g., add a comment) and push
    - GitHub → Actions tab — confirm `build-and-push-devcollab` AND `deploy-devcollab` jobs run and succeed
    - In Coolify, confirm DevCollab stack shows a new deploy triggered within ~2-3 minutes
  </verify>
  <done>All four checks pass: TLS valid on all domains, API calls go to the HTTPS API domain (not localhost), devcollab_token cookie has SameSite=None Secure=true, push to main triggers successful auto-deploy in both GHA and Coolify.</done>
</task>

</tasks>

<verification>
All success criteria verified by the human in Task 4. The automated code changes from Plans 01 and 02 are prerequisites — this plan's checkpoints confirm the end-to-end system works.
</verification>

<success_criteria>
- `https://devcollab.fernandomillan.dev` and `https://devcollab-api.fernandomillan.dev` serve live pages with valid TLS
- `https://teamflow.fernandomillan.dev` serves a live page with valid TLS
- Browser DevTools Network tab shows DevCollab API calls going to `https://devcollab-api.fernandomillan.dev` (not localhost)
- Login sets a `devcollab_token` cookie with `SameSite=None; Secure` and subsequent API calls succeed
- A push to main triggers the `deploy-devcollab` GHA job and causes Coolify to redeploy within a few minutes
</success_criteria>

<output>
After completion, create `.planning/phases/27-infrastructure-foundation-prisma-fix/27-03-SUMMARY.md`
</output>
