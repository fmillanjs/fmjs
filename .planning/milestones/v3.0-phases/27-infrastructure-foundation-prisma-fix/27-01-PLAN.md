---
phase: 27-infrastructure-foundation-prisma-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/devcollab-api/src/reactions/reactions.service.ts
  - apps/devcollab-api/src/auth/auth.controller.ts
  - apps/devcollab-web/Dockerfile
autonomous: true
requirements: [FIX-01, DEPLOY-03, DEPLOY-04]

must_haves:
  truths:
    - "The Prisma P2002 race condition in reactions is caught using the DevCollab client's error class, not TeamFlow's"
    - "Auth cookies set in production use SameSite=None; Secure so the cross-origin devcollab-web frontend can send them"
    - "The devcollab-web Docker image build accepts NEXT_PUBLIC_API_URL as a build argument and bakes it into the Next.js JS bundle"
  artifacts:
    - path: "apps/devcollab-api/src/reactions/reactions.service.ts"
      provides: "Fixed Prisma import using devcollab client runtime"
      contains: "from '.prisma/devcollab-client/runtime/library'"
    - path: "apps/devcollab-api/src/auth/auth.controller.ts"
      provides: "Cookie with SameSite=None in production"
      contains: "sameSite: process.env.NODE_ENV === 'production' ? 'none' : 'strict'"
    - path: "apps/devcollab-web/Dockerfile"
      provides: "ARG and ENV declarations for NEXT_PUBLIC_API_URL in builder stage"
      contains: "ARG NEXT_PUBLIC_API_URL"
  key_links:
    - from: "apps/devcollab-api/src/reactions/reactions.service.ts"
      to: "node_modules/.prisma/devcollab-client/runtime/library"
      via: "import statement"
      pattern: "from '.prisma/devcollab-client/runtime/library'"
    - from: "apps/devcollab-web/Dockerfile"
      to: "Next.js bundle NEXT_PUBLIC_API_URL"
      via: "ARG -> ENV -> turbo build"
      pattern: "ARG NEXT_PUBLIC_API_URL"
---

<objective>
Fix three code-level bugs that block production correctness: the wrong Prisma client import in reactions, the SameSite=Strict cookie that blocks cross-origin auth, and the missing build-arg declaration in the devcollab-web Dockerfile.

Purpose: These are prerequisite code fixes before any Coolify deployment can function correctly. Without these fixes, reactions error handling silently fails on P2002, production login sets a cookie browsers refuse to send cross-origin, and the devcollab-web image always calls localhost:3003 regardless of what URL is configured.
Output: Three modified files with surgical one-to-three line changes.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/devcollab-api/src/reactions/reactions.service.ts
@apps/devcollab-api/src/auth/auth.controller.ts
@apps/devcollab-web/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Prisma import in reactions.service.ts (FIX-01)</name>
  <files>apps/devcollab-api/src/reactions/reactions.service.ts</files>
  <action>
    Change line 2 of `apps/devcollab-api/src/reactions/reactions.service.ts`:

    FROM:
    ```typescript
    import { PrismaClientKnownRequestError } from '@prisma/client/runtime/library';
    ```

    TO:
    ```typescript
    import { PrismaClientKnownRequestError } from '.prisma/devcollab-client/runtime/library';
    ```

    This is a one-line change. The devcollab Prisma schema outputs to `node_modules/.prisma/devcollab-client` (as declared in `packages/devcollab-database/prisma/schema.prisma`). The generated client has its own runtime directory at `node_modules/.prisma/devcollab-client/runtime/library` which exports `PrismaClientKnownRequestError`. Importing from `@prisma/client/runtime/library` (TeamFlow's client) means the `instanceof` check on line 61 returns `false` for DevCollab Prisma errors — the P2002 handler never fires and the race condition throws unhandled.

    Do NOT change anything else in this file. The rest of the service logic is correct.
  </action>
  <verify>
    Run: `grep "from '.prisma/devcollab-client/runtime/library'" apps/devcollab-api/src/reactions/reactions.service.ts`
    Expected: prints line 2 with the corrected import path.

    Run: `grep "@prisma/client/runtime/library" apps/devcollab-api/src/reactions/reactions.service.ts`
    Expected: no output (old import gone).
  </verify>
  <done>Line 2 imports from `.prisma/devcollab-client/runtime/library`, not from `@prisma/client/runtime/library`. No other changes in the file.</done>
</task>

<task type="auto">
  <name>Task 2: Fix auth cookie SameSite for cross-origin production use</name>
  <files>apps/devcollab-api/src/auth/auth.controller.ts</files>
  <action>
    The `setAuthCookie` private method in `apps/devcollab-api/src/auth/auth.controller.ts` (lines 59-66) currently sets:
    ```typescript
    sameSite: 'strict',
    ```

    In production, the DevCollab frontend (`https://devcollab.fernandomillan.dev`) and API (`https://devcollab-api.fernandomillan.dev`) are different origins. `SameSite=Strict` prevents browsers from sending the cookie cross-origin — making every authenticated API request fail with 401 after login.

    Change the `setAuthCookie` method to:
    ```typescript
    private setAuthCookie(res: Response, token: string): void {
      const isProduction = process.env.NODE_ENV === 'production';
      res.cookie('devcollab_token', token, {
        httpOnly: true,
        secure: isProduction,
        sameSite: isProduction ? 'none' : 'strict',
        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days
      });
    }
    ```

    Also update the `logout` method's `clearCookie` call on line 49 to match:
    ```typescript
    logout(@Res({ passthrough: true }) res: Response) {
      const isProduction = process.env.NODE_ENV === 'production';
      res.clearCookie('devcollab_token', {
        httpOnly: true,
        secure: isProduction,
        sameSite: isProduction ? 'none' : 'strict',
      });
      return { message: 'Logged out' };
    }
    ```

    Rationale: `SameSite=None` requires `Secure=true` (enforced by all modern browsers). In development (localhost), `SameSite=Strict` is correct because frontend and API are same-site. In production, cross-subdomain requires `SameSite=None; Secure`.

    Do NOT add or remove any imports. Do NOT change any other methods.
  </action>
  <verify>
    Run: `grep -A 8 "private setAuthCookie" apps/devcollab-api/src/auth/auth.controller.ts`
    Expected: shows `sameSite: isProduction ? 'none' : 'strict'` and `secure: isProduction`.

    Run: `grep -A 6 "clearCookie" apps/devcollab-api/src/auth/auth.controller.ts`
    Expected: shows the updated clearCookie with matching SameSite logic.
  </verify>
  <done>The setAuthCookie method uses SameSite=none in production and SameSite=strict in development. The clearCookie call matches. No other changes in the file.</done>
</task>

<task type="auto">
  <name>Task 3: Add NEXT_PUBLIC_API_URL ARG/ENV to devcollab-web Dockerfile (DEPLOY-03)</name>
  <files>apps/devcollab-web/Dockerfile</files>
  <action>
    In `apps/devcollab-web/Dockerfile`, the builder stage (lines 15-21) currently reads:
    ```dockerfile
    FROM node:20-alpine AS builder
    RUN apk add --no-cache libc6-compat
    WORKDIR /app
    COPY --from=pruner /app/out/full/ .
    COPY --from=installer /app/node_modules ./node_modules
    ENV NEXT_TELEMETRY_DISABLED=1
    RUN npx turbo build --filter=devcollab-web
    ```

    Insert `ARG NEXT_PUBLIC_API_URL` and `ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL` BEFORE the existing `ENV NEXT_TELEMETRY_DISABLED=1` line:

    ```dockerfile
    FROM node:20-alpine AS builder
    RUN apk add --no-cache libc6-compat
    WORKDIR /app
    COPY --from=pruner /app/out/full/ .
    COPY --from=installer /app/node_modules ./node_modules
    ARG NEXT_PUBLIC_API_URL
    ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
    ENV NEXT_TELEMETRY_DISABLED=1
    RUN npx turbo build --filter=devcollab-web
    ```

    Placement is critical: `ARG` must come before `ENV` that references it, and both must come before `RUN npx turbo build` because Next.js inlines `NEXT_PUBLIC_*` env vars at build time (not runtime). The `ARG` declaration makes the `--build-arg` flag passed from GitHub Actions visible inside the Dockerfile. The `ENV` line promotes it to an environment variable that `next build` can read.

    Do NOT modify any other line in the Dockerfile. Specifically, do NOT touch the runner stage.
  </action>
  <verify>
    Run: `grep -n "NEXT_PUBLIC_API_URL" apps/devcollab-web/Dockerfile`
    Expected: two lines — `ARG NEXT_PUBLIC_API_URL` and `ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL`.

    Run: `grep -n "turbo build" apps/devcollab-web/Dockerfile`
    Expected: the turbo build line comes AFTER the ARG/ENV lines.
  </verify>
  <done>The devcollab-web Dockerfile builder stage declares ARG NEXT_PUBLIC_API_URL and ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL before the turbo build command. No other lines modified.</done>
</task>

</tasks>

<verification>
After all three tasks:
1. `grep "from '.prisma/devcollab-client/runtime/library'" apps/devcollab-api/src/reactions/reactions.service.ts` returns a match
2. `grep "sameSite: isProduction" apps/devcollab-api/src/auth/auth.controller.ts` returns a match
3. `grep -c "NEXT_PUBLIC_API_URL" apps/devcollab-web/Dockerfile` returns 2
4. TypeScript compilation check: `cd apps/devcollab-api && npx tsc --noEmit 2>&1 | head -20` — should produce no errors related to the changed files
</verification>

<success_criteria>
- reactions.service.ts line 2 imports from `.prisma/devcollab-client/runtime/library`
- auth.controller.ts setAuthCookie uses `sameSite: isProduction ? 'none' : 'strict'` and `secure: isProduction`
- devcollab-web Dockerfile builder stage has `ARG NEXT_PUBLIC_API_URL` followed by `ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL` before `RUN npx turbo build`
- No TypeScript compile errors in devcollab-api
</success_criteria>

<output>
After completion, create `.planning/phases/27-infrastructure-foundation-prisma-fix/27-01-SUMMARY.md`
</output>
