---
phase: 27-infrastructure-foundation-prisma-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - coolify-compose.yml
autonomous: true
requirements: [DEPLOY-05, DEPLOY-06]
user_setup:
  - service: github-actions-secrets
    why: "DevCollab Coolify webhook URL and NEXT_PUBLIC_DEVCOLLAB_API_URL must be added as GitHub repository secrets before the new GHA job can trigger DevCollab deployments"
    env_vars:
      - name: NEXT_PUBLIC_DEVCOLLAB_API_URL
        source: "Set to: https://devcollab-api.fernandomillan.dev"
      - name: COOLIFY_DEVCOLLAB_WEBHOOK_URL
        source: "Coolify UI → DevCollab stack → Settings → Deploy Webhook URL"

must_haves:
  truths:
    - "Pushing to main triggers a separate deploy-devcollab GHA job that fires the DevCollab Coolify webhook after devcollab images are pushed to GHCR"
    - "The devcollab-web GHA build step passes NEXT_PUBLIC_API_URL as a --build-arg sourced from a GitHub secret"
    - "A coolify-compose.yml exists in the repo root with restart: 'no' on devcollab-migrate so it does not loop after migrations complete"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "deploy-devcollab job + build-args on devcollab-web build step"
      contains: "deploy-devcollab"
    - path: "coolify-compose.yml"
      provides: "Production Docker Compose for Coolify with correct restart policies and GHCR image refs"
      contains: "restart: \"no\""
  key_links:
    - from: ".github/workflows/deploy.yml build-and-push-devcollab"
      to: "devcollab-web Docker image"
      via: "build-args: NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_DEVCOLLAB_API_URL }}"
      pattern: "NEXT_PUBLIC_DEVCOLLAB_API_URL"
    - from: ".github/workflows/deploy.yml deploy-devcollab"
      to: "Coolify DevCollab stack"
      via: "fjogeleit/http-request-action POST to COOLIFY_DEVCOLLAB_WEBHOOK_URL"
      pattern: "COOLIFY_DEVCOLLAB_WEBHOOK_URL"
    - from: "coolify-compose.yml devcollab-migrate"
      to: "prisma migrate deploy exit"
      via: "restart: \"no\""
      pattern: "restart: \"no\""
---

<objective>
Update the GitHub Actions workflow to bake NEXT_PUBLIC_API_URL into devcollab-web at build time and trigger the DevCollab Coolify stack on deploy. Create a production-safe Coolify Docker Compose file with correct restart policies.

Purpose: Without these CI/CD changes, DevCollab images are pushed to GHCR but Coolify is never notified to pull them. Without the build-arg, every production devcollab-web build bakes `undefined` as the API URL. Without coolify-compose.yml, there is no reference compose file with the required `restart: "no"` on devcollab-migrate.
Output: Updated deploy.yml (two additions), new coolify-compose.yml at repo root.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.github/workflows/deploy.yml
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add build-arg and deploy-devcollab job to GitHub Actions workflow (DEPLOY-05)</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
    Two additions to `.github/workflows/deploy.yml`:

    **Addition 1: Add `build-args` to the devcollab-web build step.**

    Find the `build-and-push-devcollab` job. Inside it, find the step named "Build and push devcollab-web image" (lines ~238-248). It currently has:
    ```yaml
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/devcollab-web:latest
          cache-to: type=inline
    ```

    Add a `build-args` field between `tags` and `cache-from`:
    ```yaml
          tags: |
            ghcr.io/${{ github.repository }}/devcollab-web:latest
            ghcr.io/${{ github.repository }}/devcollab-web:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_DEVCOLLAB_API_URL }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/devcollab-web:latest
          cache-to: type=inline
    ```

    **Addition 2: Add the `deploy-devcollab` job after the existing `deploy` job.**

    The current file ends with the `deploy` job (lines ~262-272). Append a new job after it:

    ```yaml
      deploy-devcollab:
        name: Deploy DevCollab to Coolify
        runs-on: ubuntu-latest
        needs: build-and-push-devcollab
        if: github.ref == 'refs/heads/main'
        steps:
          - name: Trigger DevCollab Coolify deployment
            uses: fjogeleit/http-request-action@v1
            with:
              url: ${{ secrets.COOLIFY_DEVCOLLAB_WEBHOOK_URL }}
              method: 'POST'
    ```

    Indentation must match the existing `deploy` job exactly (2-space indent for job name under `jobs:`). The `needs: build-and-push-devcollab` ensures DevCollab images are fully pushed to GHCR before Coolify is triggered to pull them.

    Do NOT change the `test`, `lighthouse`, `build-and-push`, `build-and-push-devcollab`, or `deploy` jobs in any other way.
  </action>
  <verify>
    Run: `grep -A 4 "NEXT_PUBLIC_DEVCOLLAB_API_URL" .github/workflows/deploy.yml`
    Expected: shows the build-args block with the secret reference.

    Run: `grep -A 10 "deploy-devcollab:" .github/workflows/deploy.yml`
    Expected: shows the full deploy-devcollab job with needs and webhook step.

    Run: `cat .github/workflows/deploy.yml | python3 -c "import sys,yaml; yaml.safe_load(sys.stdin); print('YAML valid')" 2>&1`
    Expected: prints `YAML valid`.
  </verify>
  <done>deploy.yml has build-args on the devcollab-web step referencing NEXT_PUBLIC_DEVCOLLAB_API_URL secret, and a deploy-devcollab job that fires COOLIFY_DEVCOLLAB_WEBHOOK_URL after build-and-push-devcollab completes. YAML is valid.</done>
</task>

<task type="auto">
  <name>Task 2: Create coolify-compose.yml for production Coolify stack (DEPLOY-06)</name>
  <files>coolify-compose.yml</files>
  <action>
    Create a new file `coolify-compose.yml` at the repo root. This is the Docker Compose file used by the Coolify DevCollab stack — it uses pre-built GHCR images (no `build:` sections) and has the correct restart policies.

    The file must contain the DevCollab production stack only (not TeamFlow — TeamFlow uses its own separate Coolify stack). Use `ghcr.io/fernandomillan-dev/fernandomillan` as the image registry prefix (matching the GitHub repository `fernandomillan-dev/fernandomillan` as seen in deploy.yml's `ghcr.io/${{ github.repository }}/...` pattern).

    ```yaml
    version: '3.8'

    services:
      devcollab-postgres:
        image: postgres:16-alpine
        container_name: devcollab-postgres
        restart: unless-stopped
        environment:
          POSTGRES_USER: ${DEVCOLLAB_POSTGRES_USER:-devcollab}
          POSTGRES_PASSWORD: ${DEVCOLLAB_POSTGRES_PASSWORD}
          POSTGRES_DB: ${DEVCOLLAB_POSTGRES_DB:-devcollab}
        volumes:
          - devcollab-pgdata:/var/lib/postgresql/data
        healthcheck:
          test: ['CMD-SHELL', 'pg_isready -U ${DEVCOLLAB_POSTGRES_USER:-devcollab}']
          interval: 10s
          timeout: 5s
          retries: 5

      devcollab-migrate:
        image: ghcr.io/fernandomillan-dev/fernandomillan/devcollab-migrate:latest
        restart: "no"
        depends_on:
          devcollab-postgres:
            condition: service_healthy
        environment:
          DEVCOLLAB_DATABASE_URL: ${DEVCOLLAB_DATABASE_URL}

      devcollab-api:
        image: ghcr.io/fernandomillan-dev/fernandomillan/devcollab-api:latest
        container_name: devcollab-api
        restart: unless-stopped
        depends_on:
          devcollab-migrate:
            condition: service_completed_successfully
        environment:
          NODE_ENV: production
          PORT: 3003
          DEVCOLLAB_DATABASE_URL: ${DEVCOLLAB_DATABASE_URL}
          DEVCOLLAB_JWT_SECRET: ${DEVCOLLAB_JWT_SECRET}
          DEVCOLLAB_WEB_URL: ${DEVCOLLAB_WEB_URL}
        healthcheck:
          test: ['CMD', 'curl', '-f', 'http://localhost:3003/health']
          interval: 10s
          timeout: 5s
          retries: 5

      devcollab-web:
        image: ghcr.io/fernandomillan-dev/fernandomillan/devcollab-web:latest
        container_name: devcollab-web
        restart: unless-stopped
        environment:
          NODE_ENV: production
          PORT: 3002
          HOSTNAME: 0.0.0.0
        healthcheck:
          test: ['CMD', 'curl', '-f', 'http://localhost:3002']
          interval: 10s
          timeout: 5s
          retries: 5

    volumes:
      devcollab-pgdata:

    networks:
      default:
        name: devcollab-network
    ```

    Key properties:
    - `devcollab-migrate` has `restart: "no"` — CRITICAL. Without this, Coolify restarts the container in an infinite loop after `prisma migrate deploy` exits 0.
    - `devcollab-api` depends on `devcollab-migrate` with `condition: service_completed_successfully` — API only starts after migrations succeed.
    - No `build:` sections — all images are pulled from GHCR.
    - No `ports:` sections — Coolify's Traefik reverse proxy handles routing; internal container ports are used.
    - `DEVCOLLAB_WEB_URL` is an env var reference (no hardcoded value) — set in Coolify UI to `https://devcollab.fernandomillan.dev`.
    - `NEXT_PUBLIC_API_URL` is NOT in the web service env vars — it was baked at build time via Docker --build-arg and has no effect at runtime.
  </action>
  <verify>
    Run: `cat coolify-compose.yml | python3 -c "import sys,yaml; data=yaml.safe_load(sys.stdin); print('YAML valid'); print('migrate restart:', data['services']['devcollab-migrate']['restart'])"`
    Expected: prints `YAML valid` and `migrate restart: no`.

    Run: `grep -c "build:" coolify-compose.yml`
    Expected: 0 (no build sections).

    Run: `grep "restart" coolify-compose.yml`
    Expected: shows `restart: "no"` for devcollab-migrate and `restart: unless-stopped` for postgres, api, and web.
  </verify>
  <done>coolify-compose.yml exists at repo root, passes YAML validation, has restart: "no" on devcollab-migrate, no build: sections, and all required environment variable references for production.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))" && echo "GHA YAML valid"` — passes
2. `python3 -c "import yaml; yaml.safe_load(open('coolify-compose.yml'))" && echo "Coolify YAML valid"` — passes
3. `grep "NEXT_PUBLIC_DEVCOLLAB_API_URL" .github/workflows/deploy.yml` — returns match
4. `grep "deploy-devcollab" .github/workflows/deploy.yml` — returns match
5. `grep 'restart: "no"' coolify-compose.yml` — returns match on devcollab-migrate
</verification>

<success_criteria>
- deploy.yml has build-args with NEXT_PUBLIC_DEVCOLLAB_API_URL on the devcollab-web build step
- deploy.yml has a deploy-devcollab job triggered after build-and-push-devcollab
- coolify-compose.yml exists with devcollab-migrate restart: "no", no build: sections, and correct GHCR image references
- Both YAML files are valid
</success_criteria>

<output>
After completion, create `.planning/phases/27-infrastructure-foundation-prisma-fix/27-02-SUMMARY.md`
</output>
