---
phase: 13-automation-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/e2e/dashboard/visual-regression.spec.ts
  - .github/workflows/deploy.yml
autonomous: true
requirements:
  - MIG-04

must_haves:
  truths:
    - "Dashboard routes are captured as screenshots in both light and dark modes"
    - "Visual regression tests run in CI on every push and detect rendering regressions"
    - "Accessibility (axe) tests also run in CI alongside visual regression"
  artifacts:
    - path: "apps/web/e2e/dashboard/visual-regression.spec.ts"
      provides: "Visual regression spec for /teams, team detail, and project board routes"
      min_lines: 60
    - path: ".github/workflows/deploy.yml"
      provides: "CI pipeline with dedicated accessibility + visual regression job"
      contains: "Run accessibility and visual regression tests"
  key_links:
    - from: "apps/web/e2e/dashboard/visual-regression.spec.ts"
      to: "playwright/.auth/user.json"
      via: "test.use({ storageState })"
      pattern: "storageState.*playwright/.auth/user.json"
    - from: ".github/workflows/deploy.yml"
      to: "apps/web/e2e/dashboard/visual-regression.spec.ts"
      via: "npx playwright test e2e/dashboard/"
      pattern: "playwright test.*e2e/dashboard"
---

<objective>
Create dashboard visual regression tests using the established Playwright `toHaveScreenshot` + auth pattern, then update CI to surface both accessibility and visual regression failures.

Purpose: MIG-04 requires a regression testing suite with visual tests in both light and dark modes for dashboard routes (team list, team detail, project board). The portfolio already has 12 Linux-platform PNG baselines; dashboard needs the same treatment.
Output: `e2e/dashboard/visual-regression.spec.ts` with 8 tests (4 routes × 2 themes), snapshot baselines generated in CI, and a `test` job in `deploy.yml` updated to run dashboard tests explicitly.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-automation-optimization/13-RESEARCH.md
@apps/web/e2e/portfolio/visual-regression.spec.ts
@apps/web/e2e/dashboard/component-accessibility.spec.ts
@apps/web/playwright.config.ts
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard visual regression spec</name>
  <files>apps/web/e2e/dashboard/visual-regression.spec.ts</files>
  <action>
Create `apps/web/e2e/dashboard/visual-regression.spec.ts` following the exact pattern in `e2e/portfolio/visual-regression.spec.ts` (which is the established codebase pattern).

The spec must:
1. Use `test.use({ storageState: 'playwright/.auth/user.json' })` — dashboard routes require auth
2. Define a `dashboardRoutes` array with 4 entries:
   - `{ name: 'teams-list', path: '/teams' }` — direct navigation, stable
   - `{ name: 'profile', path: '/profile' }` — direct navigation, stable
   - `{ name: 'team-detail', path: null }` — dynamic: navigate to /teams first, click first `a[href^="/teams/"]`, capture current URL after navigation
   - `{ name: 'project-board', path: null }` — dynamic: continue from team-detail, click first `a[href*="/projects/"]`, capture
3. For routes with dynamic navigation (team-detail, project-board), use the same navigation pattern from `e2e/dashboard/component-accessibility.spec.ts` (click first team link, then first project link)
4. For dynamic routes that have no projects, use `test.skip(true, 'No projects available')` like accessibility spec does
5. Use `mask` option on dynamic content elements to prevent spurious diffs from changing team/task names:
   - Mask `[data-testid="dynamic-content"]` if present, else mask `.text-muted-foreground` elements and heading text inside `[class*="sidebar"]`
   - Use `page.locator('main h1, main h2')` as mask for page headings with dynamic content
6. Both light and dark mode test suites:
   - Light mode: `page.goto(path)` → `waitForLoadState('networkidle')` → `toHaveScreenshot`
   - Dark mode: `addInitScript(() => localStorage.setItem('theme', 'dark'))` → `page.goto(path)` → `waitForLoadState('networkidle')` → `waitForTimeout(200)` → `toHaveScreenshot`
7. All screenshots use `{ fullPage: true, maxDiffPixelRatio: 0.02 }`
8. Screenshot names: `teams-list-light.png`, `teams-list-dark.png`, `profile-light.png`, `profile-dark.png`, `team-detail-light.png`, `team-detail-dark.png`, `project-board-light.png`, `project-board-dark.png`

Structure the file as two `test.describe` blocks: "Dashboard Visual Regression - Light Mode" and "Dashboard Visual Regression - Dark Mode".

For the dynamic routes (team-detail, project-board), the test structure should be a regular `test()` call (not inside a `for` loop) to handle the conditional navigation.

File header comment: `// Source: pattern from apps/web/e2e/portfolio/visual-regression.spec.ts`

IMPORTANT — snapshot generation: The test file creates the spec but baselines do not yet exist. The execute-plan step MUST run `--update-snapshots` to generate Linux-platform PNG files that will be committed to git. Baselines must be generated in this environment (Linux/WSL2) to match CI Ubuntu runners. Run:
```bash
cd apps/web && npx playwright test e2e/dashboard/visual-regression.spec.ts --update-snapshots 2>&1 | tail -30
```
Then commit the generated PNG files in `e2e/dashboard/visual-regression.spec.ts-snapshots/`.
  </action>
  <verify>
1. File exists: `ls apps/web/e2e/dashboard/visual-regression.spec.ts`
2. Snapshots generated: `ls apps/web/e2e/dashboard/visual-regression.spec.ts-snapshots/*.png | wc -l` — expect 6-8 PNG files (project-board may be skipped if no seed data)
3. Tests pass (using existing baselines): `cd apps/web && npx playwright test e2e/dashboard/visual-regression.spec.ts` — all tests pass or skip
4. No failures (only skips allowed for missing project data)
  </verify>
  <done>
`e2e/dashboard/visual-regression.spec.ts` exists, 6-8 PNG baseline files committed in `visual-regression.spec.ts-snapshots/`, running the spec again produces 0 failures (only optional skips for project-board if no seed data present).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CI workflow to run dashboard visual regression tests</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Update `.github/workflows/deploy.yml` to ensure dashboard visual regression and accessibility tests run in CI. The existing `test` job already starts Docker, runs database migrations, seeds, starts the API server, installs Playwright, and runs `npx playwright test`. This is the correct job for dashboard tests (they need the database and auth seed).

Changes to make:

1. The existing `Run E2E tests` step runs `cd apps/web && npx playwright test` which runs ALL tests including the new visual regression spec. This is sufficient — no separate job needed for dashboard visual regression since the infrastructure (Docker, DB, API) is already there.

2. However, add explicit step naming to make CI output readable. Split the single `npx playwright test` step into two explicit steps (both in the same `test` job, both use the full infrastructure):

Replace the single "Run E2E tests" step:
```yaml
- name: Run E2E tests
  run: cd apps/web && npx playwright test
  env: ...
```

With two steps:
```yaml
- name: Run accessibility tests (axe WCAG AA)
  run: cd apps/web && npx playwright test e2e/portfolio/accessibility.spec.ts e2e/auth/form-accessibility.spec.ts e2e/dashboard/component-accessibility.spec.ts
  env:
    NEXTAUTH_SECRET: test-secret-min-32-chars-required-for-jwt
    NEXTAUTH_URL: http://localhost:3000
    NEXT_PUBLIC_API_URL: http://localhost:3001

- name: Run visual regression tests (light and dark modes)
  run: cd apps/web && npx playwright test e2e/portfolio/visual-regression.spec.ts e2e/dashboard/visual-regression.spec.ts
  env:
    NEXTAUTH_SECRET: test-secret-min-32-chars-required-for-jwt
    NEXTAUTH_URL: http://localhost:3000
    NEXT_PUBLIC_API_URL: http://localhost:3001

- name: Run remaining E2E tests (user journey, edge cases, auth flows)
  run: cd apps/web && npx playwright test --ignore=e2e/portfolio/accessibility.spec.ts --ignore=e2e/auth/form-accessibility.spec.ts --ignore=e2e/dashboard/component-accessibility.spec.ts --ignore=e2e/portfolio/visual-regression.spec.ts --ignore=e2e/dashboard/visual-regression.spec.ts
  env:
    NEXTAUTH_SECRET: test-secret-min-32-chars-required-for-jwt
    NEXTAUTH_URL: http://localhost:3000
    NEXT_PUBLIC_API_URL: http://localhost:3001
```

3. Also add a `next lint` step before the E2E tests to fail CI on ESLint governance violations. Add after "Run API unit tests" step:
```yaml
- name: Run ESLint governance check
  run: cd apps/web && npx next lint
```

4. Update the artifact upload steps to reference `playwright-report` path (unchanged, already correct).

IMPORTANT: Do NOT add a new job. Keep all E2E steps in the existing `test` job that has Docker/DB/API infrastructure.
  </action>
  <verify>
1. File parses as valid YAML: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))" && echo "YAML valid"`
2. Contains accessibility step: `grep -c "Run accessibility tests" .github/workflows/deploy.yml`
3. Contains visual regression step: `grep -c "visual regression tests" .github/workflows/deploy.yml`
4. Contains ESLint step: `grep -c "ESLint governance" .github/workflows/deploy.yml`
5. Contains dashboard visual regression path: `grep "dashboard/visual-regression" .github/workflows/deploy.yml`
  </verify>
  <done>
`deploy.yml` contains separate named steps for accessibility tests, visual regression tests (including dashboard), and ESLint governance check. YAML is valid. CI will fail if WCAG violations are detected or visual regressions occur.
  </done>
</task>

</tasks>

<verification>
1. `ls apps/web/e2e/dashboard/visual-regression.spec.ts` — file exists
2. `ls apps/web/e2e/dashboard/visual-regression.spec.ts-snapshots/*.png | wc -l` — 6+ PNG baselines committed
3. `cd apps/web && npx playwright test e2e/dashboard/visual-regression.spec.ts` — 0 failures
4. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))" && echo valid` — YAML valid
5. `grep "dashboard/visual-regression" .github/workflows/deploy.yml` — reference exists in CI
6. `grep "ESLint governance" .github/workflows/deploy.yml` — ESLint step present
</verification>

<success_criteria>
- Dashboard visual regression spec exists with tests for teams-list, profile, team-detail, project-board in both light and dark modes
- Linux-platform PNG baselines committed so CI comparisons work without platform mismatch
- CI workflow runs accessibility tests and visual regression tests as distinct named steps
- CI will fail on WCAG violations (axe) and visual regressions (toHaveScreenshot diff > 2%)
- ESLint governance check added to CI pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/13-automation-optimization/13-01-SUMMARY.md`
</output>
