---
phase: 17-content-creation-snippets-posts
plan: 02
type: execute
wave: 2
depends_on:
  - "17-01"
files_modified:
  - apps/devcollab-api/src/snippets/snippets.module.ts
  - apps/devcollab-api/src/snippets/snippets.controller.ts
  - apps/devcollab-api/src/snippets/snippets.service.ts
  - apps/devcollab-api/src/snippets/dto/create-snippet.dto.ts
  - apps/devcollab-api/src/snippets/dto/update-snippet.dto.ts
  - apps/devcollab-api/src/posts/posts.module.ts
  - apps/devcollab-api/src/posts/posts.controller.ts
  - apps/devcollab-api/src/posts/posts.service.ts
  - apps/devcollab-api/src/posts/dto/create-post.dto.ts
  - apps/devcollab-api/src/posts/dto/update-post.dto.ts
  - apps/devcollab-api/src/app.module.ts
  - apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts
autonomous: true
requirements:
  - SNIP-01
  - SNIP-04
  - POST-01
  - POST-02
  - POST-03
  - RBAC-02
  - RBAC-03

must_haves:
  truths:
    - "POST /workspaces/:slug/snippets creates a snippet (Contributor succeeds, Viewer gets 403)"
    - "GET /workspaces/:slug/snippets/:id returns snippet data"
    - "PATCH /workspaces/:slug/snippets/:id rejects non-owner Contributors (403)"
    - "POST /workspaces/:slug/posts creates a post as Draft by default"
    - "PATCH /workspaces/:slug/posts/:id/status toggles Draft/Published"
    - "Meta-test still passes: 13+ controller methods covered"
  artifacts:
    - path: "apps/devcollab-api/src/snippets/snippets.controller.ts"
      provides: "5 CRUD endpoints for snippets"
      exports: ["SnippetsController"]
    - path: "apps/devcollab-api/src/snippets/snippets.service.ts"
      provides: "Snippet CRUD with owner-check on update/delete"
      exports: ["SnippetsService"]
    - path: "apps/devcollab-api/src/posts/posts.controller.ts"
      provides: "6 CRUD endpoints for posts including status toggle"
      exports: ["PostsController"]
    - path: "apps/devcollab-api/src/posts/posts.service.ts"
      provides: "Post CRUD + status toggle with owner-check"
      exports: ["PostsService"]
    - path: "apps/devcollab-api/src/app.module.ts"
      provides: "SnippetsModule + PostsModule imported"
      contains: "SnippetsModule"
    - path: "apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts"
      provides: "SnippetsController and PostsController in ALL_CONTROLLERS"
  key_links:
    - from: "apps/devcollab-api/src/snippets/snippets.service.ts"
      to: "apps/devcollab-api/src/core/database/prisma.service.ts"
      via: "PrismaService injection, this.prisma.snippet"
      pattern: "this\\.prisma\\.snippet"
    - from: "apps/devcollab-api/src/posts/posts.service.ts"
      to: "apps/devcollab-api/src/core/database/prisma.service.ts"
      via: "PrismaService injection, this.prisma.post"
      pattern: "this\\.prisma\\.post"
    - from: "apps/devcollab-api/src/snippets/snippets.controller.ts"
      to: "@CheckAbility decorator"
      via: "RBAC guard on every route handler"
      pattern: "@CheckAbility"
---

<objective>
Create NestJS Snippets and Posts modules with full CRUD, RBAC-enforced controllers, owner-scoped service-layer checks, and wire both into AppModule. Update the meta-test to include both new controllers in the deny-by-default invariant check.

Purpose: Delivers all backend API endpoints that the Phase 17 frontend UI will call. RBAC-02 (Contributor can create/edit/delete own content) and RBAC-03 (Viewer is 403 on mutations) are enforced at the guard + service layer.
Output: 11 new files, 2 updated files (AppModule + meta-test).
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-content-creation-snippets-posts/17-RESEARCH.md
@apps/devcollab-api/src/app.module.ts
@apps/devcollab-api/src/workspaces/workspaces.module.ts
@apps/devcollab-api/src/workspaces/workspaces.controller.ts
@apps/devcollab-api/src/workspaces/workspaces.service.ts
@apps/devcollab-api/src/core/database/prisma.service.ts
@apps/devcollab-api/src/common/decorators/check-ability.decorator.ts
@apps/devcollab-api/src/common/decorators/current-user.decorator.ts
@apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts
@.planning/phases/17-content-creation-snippets-posts/17-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SnippetsModule (module, controller, service, DTOs)</name>
  <files>
    apps/devcollab-api/src/snippets/snippets.module.ts
    apps/devcollab-api/src/snippets/snippets.controller.ts
    apps/devcollab-api/src/snippets/snippets.service.ts
    apps/devcollab-api/src/snippets/dto/create-snippet.dto.ts
    apps/devcollab-api/src/snippets/dto/update-snippet.dto.ts
  </files>
  <action>
Create `apps/devcollab-api/src/snippets/` directory with these files:

**dto/create-snippet.dto.ts:**
```typescript
export class CreateSnippetDto {
  title!: string;
  language!: string;
  code!: string;
}
```

**dto/update-snippet.dto.ts:**
```typescript
export class UpdateSnippetDto {
  title?: string;
  language?: string;
  code?: string;
}
```

**snippets.service.ts:**
```typescript
import { Injectable, NotFoundException, ForbiddenException } from '@nestjs/common';
import { PrismaService } from '../core/database/prisma.service';
import { CreateSnippetDto } from './dto/create-snippet.dto';
import { UpdateSnippetDto } from './dto/update-snippet.dto';

@Injectable()
export class SnippetsService {
  constructor(private readonly prisma: PrismaService) {}

  async create(slug: string, dto: CreateSnippetDto, authorId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    return this.prisma.snippet.create({
      data: { ...dto, authorId, workspaceId: workspace.id },
    });
  }

  async findAll(slug: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    return this.prisma.snippet.findMany({
      where: { workspaceId: workspace.id },
      orderBy: { createdAt: 'desc' },
      include: { author: { select: { id: true, name: true, email: true } } },
    });
  }

  async findOne(slug: string, id: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    const snippet = await this.prisma.snippet.findFirst({
      where: { id, workspaceId: workspace.id },
      include: { author: { select: { id: true, name: true, email: true } } },
    });
    if (!snippet) throw new NotFoundException('Snippet not found');
    return snippet;
  }

  async update(slug: string, id: string, dto: UpdateSnippetDto, requesterId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    const snippet = await this.prisma.snippet.findFirst({
      where: { id, workspaceId: workspace.id },
    });
    if (!snippet) throw new NotFoundException('Snippet not found');

    // Owner-only check: Admins bypass (guard granted manage:all), Contributors must own
    const membership = await this.prisma.workspaceMember.findUnique({
      where: { userId_workspaceId: { userId: requesterId, workspaceId: workspace.id } },
      select: { role: true },
    });
    if (snippet.authorId !== requesterId && membership?.role !== 'Admin') {
      throw new ForbiddenException('You can only edit your own snippets');
    }

    return this.prisma.snippet.update({ where: { id }, data: dto });
  }

  async remove(slug: string, id: string, requesterId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    const snippet = await this.prisma.snippet.findFirst({
      where: { id, workspaceId: workspace.id },
    });
    if (!snippet) throw new NotFoundException('Snippet not found');

    const membership = await this.prisma.workspaceMember.findUnique({
      where: { userId_workspaceId: { userId: requesterId, workspaceId: workspace.id } },
      select: { role: true },
    });
    if (snippet.authorId !== requesterId && membership?.role !== 'Admin') {
      throw new ForbiddenException('You can only delete your own snippets');
    }

    return this.prisma.snippet.delete({ where: { id } });
  }
}
```

**snippets.controller.ts:**
```typescript
import { Controller, Get, Post, Patch, Delete, Body, Param } from '@nestjs/common';
import { SnippetsService } from './snippets.service';
import { CreateSnippetDto } from './dto/create-snippet.dto';
import { UpdateSnippetDto } from './dto/update-snippet.dto';
import { CheckAbility } from '../common/decorators/check-ability.decorator';
import { CurrentUser, JwtPayload } from '../common/decorators/current-user.decorator';

@Controller('workspaces/:slug/snippets')
export class SnippetsController {
  constructor(private readonly snippetsService: SnippetsService) {}

  @CheckAbility('create', 'Snippet')
  @Post()
  create(
    @Param('slug') slug: string,
    @Body() dto: CreateSnippetDto,
    @CurrentUser() user: JwtPayload,
  ) {
    return this.snippetsService.create(slug, dto, user.sub);
  }

  @CheckAbility('read', 'Snippet')
  @Get()
  findAll(@Param('slug') slug: string) {
    return this.snippetsService.findAll(slug);
  }

  @CheckAbility('read', 'Snippet')
  @Get(':id')
  findOne(@Param('slug') slug: string, @Param('id') id: string) {
    return this.snippetsService.findOne(slug, id);
  }

  @CheckAbility('update', 'Snippet')
  @Patch(':id')
  update(
    @Param('slug') slug: string,
    @Param('id') id: string,
    @Body() dto: UpdateSnippetDto,
    @CurrentUser() user: JwtPayload,
  ) {
    return this.snippetsService.update(slug, id, dto, user.sub);
  }

  @CheckAbility('delete', 'Snippet')
  @Delete(':id')
  remove(
    @Param('slug') slug: string,
    @Param('id') id: string,
    @CurrentUser() user: JwtPayload,
  ) {
    return this.snippetsService.remove(slug, id, user.sub);
  }
}
```

**snippets.module.ts:**
```typescript
import { Module } from '@nestjs/common';
import { DatabaseModule } from '../core/database/database.module';
import { SnippetsService } from './snippets.service';
import { SnippetsController } from './snippets.controller';

@Module({
  imports: [DatabaseModule],
  controllers: [SnippetsController],
  providers: [SnippetsService],
})
export class SnippetsModule {}
```
  </action>
  <verify>`cd /home/doctor/fernandomillan/apps/devcollab-api && npx tsc --noEmit` — no errors in the snippets directory files</verify>
  <done>5 files created, SnippetsController has 5 route handlers each decorated with @CheckAbility, SnippetsService owner-checks update/delete via membership role query</done>
</task>

<task type="auto">
  <name>Task 2: Create PostsModule + wire both modules into AppModule + update meta-test</name>
  <files>
    apps/devcollab-api/src/posts/posts.module.ts
    apps/devcollab-api/src/posts/posts.controller.ts
    apps/devcollab-api/src/posts/posts.service.ts
    apps/devcollab-api/src/posts/dto/create-post.dto.ts
    apps/devcollab-api/src/posts/dto/update-post.dto.ts
    apps/devcollab-api/src/app.module.ts
    apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts
  </files>
  <action>
**Step 1 — Create PostsModule files:**

**dto/create-post.dto.ts:**
```typescript
export class CreatePostDto {
  title!: string;
  content!: string;
}
```

**dto/update-post.dto.ts:**
```typescript
export class UpdatePostDto {
  title?: string;
  content?: string;
}
```

**posts.service.ts:**
```typescript
import { Injectable, NotFoundException, ForbiddenException } from '@nestjs/common';
import { PrismaService } from '../core/database/prisma.service';
import { CreatePostDto } from './dto/create-post.dto';
import { UpdatePostDto } from './dto/update-post.dto';

@Injectable()
export class PostsService {
  constructor(private readonly prisma: PrismaService) {}

  async create(slug: string, dto: CreatePostDto, authorId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    return this.prisma.post.create({
      data: { ...dto, authorId, workspaceId: workspace.id, status: 'Draft' },
    });
  }

  async findAll(slug: string, requesterId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    // Authors see their own drafts; others see only Published
    return this.prisma.post.findMany({
      where: {
        workspaceId: workspace.id,
        OR: [{ status: 'Published' }, { authorId: requesterId }],
      },
      orderBy: { createdAt: 'desc' },
      include: { author: { select: { id: true, name: true, email: true } } },
    });
  }

  async findOne(slug: string, id: string, requesterId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    const post = await this.prisma.post.findFirst({
      where: {
        id,
        workspaceId: workspace.id,
        OR: [{ status: 'Published' }, { authorId: requesterId }],
      },
      include: { author: { select: { id: true, name: true, email: true } } },
    });
    if (!post) throw new NotFoundException('Post not found or not accessible');
    return post;
  }

  async update(slug: string, id: string, dto: UpdatePostDto, requesterId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    const post = await this.prisma.post.findFirst({
      where: { id, workspaceId: workspace.id },
    });
    if (!post) throw new NotFoundException('Post not found');

    const membership = await this.prisma.workspaceMember.findUnique({
      where: { userId_workspaceId: { userId: requesterId, workspaceId: workspace.id } },
      select: { role: true },
    });
    if (post.authorId !== requesterId && membership?.role !== 'Admin') {
      throw new ForbiddenException('You can only edit your own posts');
    }

    return this.prisma.post.update({ where: { id }, data: dto });
  }

  async setStatus(slug: string, id: string, status: 'Draft' | 'Published', requesterId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    const post = await this.prisma.post.findFirst({
      where: { id, workspaceId: workspace.id },
    });
    if (!post) throw new NotFoundException('Post not found');

    const membership = await this.prisma.workspaceMember.findUnique({
      where: { userId_workspaceId: { userId: requesterId, workspaceId: workspace.id } },
      select: { role: true },
    });
    if (post.authorId !== requesterId && membership?.role !== 'Admin') {
      throw new ForbiddenException('You can only change status of your own posts');
    }

    return this.prisma.post.update({
      where: { id },
      data: {
        status,
        publishedAt: status === 'Published' ? new Date() : null,
      },
    });
  }

  async remove(slug: string, id: string, requesterId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    const post = await this.prisma.post.findFirst({
      where: { id, workspaceId: workspace.id },
    });
    if (!post) throw new NotFoundException('Post not found');

    const membership = await this.prisma.workspaceMember.findUnique({
      where: { userId_workspaceId: { userId: requesterId, workspaceId: workspace.id } },
      select: { role: true },
    });
    if (post.authorId !== requesterId && membership?.role !== 'Admin') {
      throw new ForbiddenException('You can only delete your own posts');
    }

    return this.prisma.post.delete({ where: { id } });
  }
}
```

**posts.controller.ts:**
```typescript
import { Controller, Get, Post, Patch, Delete, Body, Param } from '@nestjs/common';
import { PostsService } from './posts.service';
import { CreatePostDto } from './dto/create-post.dto';
import { UpdatePostDto } from './dto/update-post.dto';
import { CheckAbility } from '../common/decorators/check-ability.decorator';
import { CurrentUser, JwtPayload } from '../common/decorators/current-user.decorator';

@Controller('workspaces/:slug/posts')
export class PostsController {
  constructor(private readonly postsService: PostsService) {}

  @CheckAbility('create', 'Post')
  @Post()
  create(
    @Param('slug') slug: string,
    @Body() dto: CreatePostDto,
    @CurrentUser() user: JwtPayload,
  ) {
    return this.postsService.create(slug, dto, user.sub);
  }

  @CheckAbility('read', 'Post')
  @Get()
  findAll(@Param('slug') slug: string, @CurrentUser() user: JwtPayload) {
    return this.postsService.findAll(slug, user.sub);
  }

  @CheckAbility('read', 'Post')
  @Get(':id')
  findOne(
    @Param('slug') slug: string,
    @Param('id') id: string,
    @CurrentUser() user: JwtPayload,
  ) {
    return this.postsService.findOne(slug, id, user.sub);
  }

  @CheckAbility('update', 'Post')
  @Patch(':id')
  update(
    @Param('slug') slug: string,
    @Param('id') id: string,
    @Body() dto: UpdatePostDto,
    @CurrentUser() user: JwtPayload,
  ) {
    return this.postsService.update(slug, id, dto, user.sub);
  }

  @CheckAbility('update', 'Post')
  @Patch(':id/status')
  setStatus(
    @Param('slug') slug: string,
    @Param('id') id: string,
    @Body() body: { status: 'Draft' | 'Published' },
    @CurrentUser() user: JwtPayload,
  ) {
    return this.postsService.setStatus(slug, id, body.status, user.sub);
  }

  @CheckAbility('delete', 'Post')
  @Delete(':id')
  remove(
    @Param('slug') slug: string,
    @Param('id') id: string,
    @CurrentUser() user: JwtPayload,
  ) {
    return this.postsService.remove(slug, id, user.sub);
  }
}
```

**posts.module.ts:**
```typescript
import { Module } from '@nestjs/common';
import { DatabaseModule } from '../core/database/database.module';
import { PostsService } from './posts.service';
import { PostsController } from './posts.controller';

@Module({
  imports: [DatabaseModule],
  controllers: [PostsController],
  providers: [PostsService],
})
export class PostsModule {}
```

**Step 2 — Update app.module.ts:**
Add to imports array (after WorkspacesModule):
```typescript
import { SnippetsModule } from './snippets/snippets.module';
import { PostsModule } from './posts/posts.module';
```
Add `SnippetsModule` and `PostsModule` to the `imports: [...]` array.

**Step 3 — Update meta-test (controller-coverage.spec.ts):**
Add these two imports after the existing controller imports:
```typescript
import { SnippetsController } from '../../../src/snippets/snippets.controller';
import { PostsController } from '../../../src/posts/posts.controller';
```
Update ALL_CONTROLLERS array:
```typescript
const ALL_CONTROLLERS = [
  HealthController,
  AuthController,
  WorkspacesController,
  SnippetsController,
  PostsController,
] as const;
```
  </action>
  <verify>
1. `cd /home/doctor/fernandomillan/apps/devcollab-api && npx tsc --noEmit` — no TypeScript errors
2. `cd /home/doctor/fernandomillan/apps/devcollab-api && npx vitest run test/unit/meta/controller-coverage.spec.ts` — all tests pass (now covering Snippets + Posts controllers)
  </verify>
  <done>PostsController has 6 route handlers each decorated with @CheckAbility; AppModule imports SnippetsModule and PostsModule; meta-test passes with both new controllers included in ALL_CONTROLLERS</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` in devcollab-api exits 0
2. `npx vitest run test/unit/meta/controller-coverage.spec.ts` all tests pass
3. `curl -X POST http://localhost:3003/workspaces/test-workspace/snippets` with Viewer JWT returns 403
4. `curl -X POST http://localhost:3003/workspaces/test-workspace/snippets` with Contributor JWT returns 201 or 404 (workspace not found) — never 403
</verification>

<success_criteria>
- SnippetsController: POST, GET (list), GET (single), PATCH, DELETE — all @CheckAbility decorated
- PostsController: POST, GET (list), GET (single), PATCH (edit), PATCH (status), DELETE — all @CheckAbility decorated
- SnippetsService owner check: PATCH/DELETE returns 403 if requester is not author AND not Admin
- PostsService owner check: PATCH/DELETE/setStatus returns 403 if requester is not author AND not Admin
- PostsService findAll/findOne: Draft posts only visible to their author
- AppModule imports SnippetsModule and PostsModule
- Meta-test passes with SnippetsController and PostsController in ALL_CONTROLLERS
</success_criteria>

<output>
After completion, create `.planning/phases/17-content-creation-snippets-posts/17-02-SUMMARY.md`
</output>
