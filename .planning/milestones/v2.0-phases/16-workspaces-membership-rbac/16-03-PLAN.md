---
phase: 16-workspaces-membership-rbac
plan: "03"
type: execute
wave: 3
depends_on:
  - "16-01"
  - "16-02"
files_modified:
  - apps/devcollab-api/src/workspaces/dto/create-workspace.dto.ts
  - apps/devcollab-api/src/workspaces/dto/join-workspace.dto.ts
  - apps/devcollab-api/src/workspaces/dto/update-member-role.dto.ts
  - apps/devcollab-api/src/workspaces/workspaces.service.ts
  - apps/devcollab-api/src/workspaces/workspaces.controller.ts
  - apps/devcollab-api/src/workspaces/workspaces.module.ts
autonomous: true
requirements:
  - WORK-01
  - WORK-02
  - WORK-03
  - WORK-04
  - WORK-05
  - RBAC-01

must_haves:
  truths:
    - "A logged-in user can create a workspace with name and slug; creator is assigned Admin role"
    - "An Admin can generate an invite link with 72-hour expiry and single-use enforcement"
    - "A user can join a workspace via invite token and is assigned Contributor role"
    - "An Admin can list members, change roles, and remove members"
    - "The last Admin cannot be removed or demoted (BadRequestException returned)"
    - "Slug uniqueness conflicts return ConflictException with clear message"
  artifacts:
    - path: "apps/devcollab-api/src/workspaces/workspaces.service.ts"
      provides: "All workspace business logic: create, invite, join, listMembers, updateRole, removeMember"
      exports: ["WorkspacesService"]
    - path: "apps/devcollab-api/src/workspaces/workspaces.controller.ts"
      provides: "REST endpoints: POST /workspaces, GET /workspaces, GET /workspaces/:slug, POST /workspaces/:slug/invite-links, POST /workspaces/join, GET /workspaces/:slug/members, PATCH /workspaces/:slug/members/:userId/role, DELETE /workspaces/:slug/members/:userId"
      exports: ["WorkspacesController"]
    - path: "apps/devcollab-api/src/workspaces/workspaces.module.ts"
      provides: "Updated WorkspacesModule with WorkspacesService and WorkspacesController added"
  key_links:
    - from: "apps/devcollab-api/src/workspaces/workspaces.controller.ts"
      to: "apps/devcollab-api/src/workspaces/workspaces.service.ts"
      via: "constructor injection"
      pattern: "WorkspacesService"
    - from: "apps/devcollab-api/src/workspaces/workspaces.service.ts"
      to: "apps/devcollab-api/src/core/database/prisma.service.ts"
      via: "constructor injection"
      pattern: "prisma\\.workspace|prisma\\.workspaceMember|prisma\\.inviteLink"
    - from: "apps/devcollab-api/src/workspaces/workspaces.controller.ts"
      to: "apps/devcollab-api/src/common/decorators/check-ability.decorator.ts"
      via: "@CheckAbility() on every route handler"
      pattern: "@CheckAbility"
---

<objective>
Implement WorkspacesService (all business logic), WorkspacesController (all REST endpoints), DTOs, and update WorkspacesModule to register the controller and service.

Purpose: This plan implements the functional workspace layer: creating workspaces, generating and consuming invite links, managing members, and enforcing last-admin protection. The guard from Plan 02 handles workspace-scoped RBAC; the service handles business rules.

Output: Complete WorkspacesService and WorkspacesController with all 8 endpoints, 3 DTOs, and updated WorkspacesModule.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-workspaces-membership-rbac/16-RESEARCH.md
@.planning/phases/16-workspaces-membership-rbac/16-01-SUMMARY.md
@.planning/phases/16-workspaces-membership-rbac/16-02-SUMMARY.md
@apps/devcollab-api/src/auth/auth.service.ts
@apps/devcollab-api/src/auth/auth.controller.ts
@apps/devcollab-api/src/common/decorators/check-ability.decorator.ts
@apps/devcollab-api/src/common/decorators/current-user.decorator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DTOs and WorkspacesService</name>
  <files>
    apps/devcollab-api/src/workspaces/dto/create-workspace.dto.ts
    apps/devcollab-api/src/workspaces/dto/join-workspace.dto.ts
    apps/devcollab-api/src/workspaces/dto/update-member-role.dto.ts
    apps/devcollab-api/src/workspaces/workspaces.service.ts
  </files>
  <action>
Create `apps/devcollab-api/src/workspaces/dto/create-workspace.dto.ts`:
```typescript
export class CreateWorkspaceDto {
  name: string;
  slug?: string; // Optional: auto-generated from name if not provided
}
```

Create `apps/devcollab-api/src/workspaces/dto/join-workspace.dto.ts`:
```typescript
export class JoinWorkspaceDto {
  token: string;
}
```

Create `apps/devcollab-api/src/workspaces/dto/update-member-role.dto.ts`:
```typescript
export class UpdateMemberRoleDto {
  role: 'Admin' | 'Contributor' | 'Viewer';
}
```

Create `apps/devcollab-api/src/workspaces/workspaces.service.ts`:

```typescript
import {
  Injectable,
  NotFoundException,
  BadRequestException,
  ConflictException,
  ForbiddenException,
} from '@nestjs/common';
import { randomUUID } from 'crypto';
import { PrismaService } from '../core/database/prisma.service';
import { CreateWorkspaceDto } from './dto/create-workspace.dto';
import { JoinWorkspaceDto } from './dto/join-workspace.dto';
import { UpdateMemberRoleDto } from './dto/update-member-role.dto';

@Injectable()
export class WorkspacesService {
  constructor(private readonly prisma: PrismaService) {}

  // WORK-01: Create workspace, creator becomes Admin
  async create(dto: CreateWorkspaceDto, creatorId: string) {
    const slug =
      dto.slug ??
      dto.name
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '');

    try {
      return await this.prisma.workspace.create({
        data: {
          name: dto.name,
          slug,
          members: {
            create: {
              userId: creatorId,
              role: 'Admin',
            },
          },
        },
        include: { members: true },
      });
    } catch (e: any) {
      if (e?.code === 'P2002') {
        throw new ConflictException(`Workspace slug '${slug}' is already taken`);
      }
      throw e;
    }
  }

  // WORK-01: List workspaces where user is a member
  async findAll(userId: string) {
    return this.prisma.workspace.findMany({
      where: { members: { some: { userId } } },
      include: { members: { select: { role: true, userId: true } } },
    });
  }

  // WORK-01: Get workspace by slug (membership enforced by guard)
  async findOne(slug: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      include: { members: { include: { user: { select: { id: true, name: true, email: true } } } } },
    });
    if (!workspace) throw new NotFoundException(`Workspace '${slug}' not found`);
    return workspace;
  }

  // WORK-02: Generate invite link — Admin only (guard enforces Admin via InviteLink ability)
  async generateInviteLink(slug: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException(`Workspace '${slug}' not found`);

    return this.prisma.inviteLink.create({
      data: {
        token: randomUUID(),
        expiresAt: new Date(Date.now() + 72 * 60 * 60 * 1000), // 72 hours
        workspaceId: workspace.id,
      },
    });
  }

  // WORK-03: Join workspace via invite token
  async joinWorkspace(dto: JoinWorkspaceDto, userId: string) {
    const invite = await this.prisma.inviteLink.findUnique({ where: { token: dto.token } });

    if (!invite) throw new NotFoundException('Invite link not found');
    if (invite.usedAt !== null) throw new BadRequestException('Invite link already used');
    if (invite.expiresAt < new Date()) throw new BadRequestException('Invite link has expired');

    // Mark as used before creating membership (prevents double-use; acceptable edge case per Phase 16 scope)
    await this.prisma.inviteLink.update({
      where: { id: invite.id },
      data: { usedAt: new Date() },
    });

    try {
      return await this.prisma.workspaceMember.create({
        data: {
          userId,
          workspaceId: invite.workspaceId,
          role: 'Contributor',
        },
      });
    } catch (e: any) {
      if (e?.code === 'P2002') {
        throw new ConflictException('Already a member of this workspace');
      }
      throw e;
    }
  }

  // WORK-04: List members — guard enforces workspace membership read
  async listMembers(slug: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException(`Workspace '${slug}' not found`);

    return this.prisma.workspaceMember.findMany({
      where: { workspaceId: workspace.id },
      include: { user: { select: { id: true, name: true, email: true } } },
    });
  }

  // RBAC-01 / WORK-04: Update member role — guard enforces Admin (manage WorkspaceMember)
  // WORK-05: Cannot demote last Admin
  async updateMemberRole(slug: string, targetUserId: string, dto: UpdateMemberRoleDto) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException(`Workspace '${slug}' not found`);

    const membership = await this.prisma.workspaceMember.findUnique({
      where: { userId_workspaceId: { userId: targetUserId, workspaceId: workspace.id } },
    });
    if (!membership) throw new NotFoundException('Member not found');

    // WORK-05: Last-admin protection on demotion
    if (membership.role === 'Admin' && dto.role !== 'Admin') {
      const adminCount = await this.prisma.workspaceMember.count({
        where: { workspaceId: workspace.id, role: 'Admin' },
      });
      if (adminCount === 1) {
        throw new BadRequestException('Cannot demote the last Admin of a workspace');
      }
    }

    return this.prisma.workspaceMember.update({
      where: { id: membership.id },
      data: { role: dto.role },
    });
  }

  // WORK-04 / WORK-05: Remove member — guard enforces Admin (delete WorkspaceMember)
  async removeMember(slug: string, targetUserId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException(`Workspace '${slug}' not found`);

    const membership = await this.prisma.workspaceMember.findUnique({
      where: { userId_workspaceId: { userId: targetUserId, workspaceId: workspace.id } },
    });
    if (!membership) throw new NotFoundException('Member not found');

    // WORK-05: Last-admin protection on removal
    if (membership.role === 'Admin') {
      const adminCount = await this.prisma.workspaceMember.count({
        where: { workspaceId: workspace.id, role: 'Admin' },
      });
      if (adminCount === 1) {
        throw new BadRequestException('Cannot remove the last Admin from a workspace');
      }
    }

    await this.prisma.workspaceMember.delete({ where: { id: membership.id } });
    return { success: true };
  }
}
```
  </action>
  <verify>
Run: `npx tsc --noEmit -p /home/doctor/fernandomillan/apps/devcollab-api/tsconfig.json`
Expected: No TypeScript errors in the new files.
  </verify>
  <done>
All 3 DTOs created. WorkspacesService created with create, findAll, findOne, generateInviteLink, joinWorkspace, listMembers, updateMemberRole, removeMember methods. TypeScript exits 0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkspacesController and update WorkspacesModule</name>
  <files>
    apps/devcollab-api/src/workspaces/workspaces.controller.ts
    apps/devcollab-api/src/workspaces/workspaces.module.ts
  </files>
  <action>
Create `apps/devcollab-api/src/workspaces/workspaces.controller.ts`:

IMPORTANT: `POST /workspaces/join` must be declared BEFORE `GET /workspaces/:slug` to prevent NestJS routing treating "join" as a slug value. NestJS resolves routes top-to-bottom, so static path segments must precede dynamic ones.

```typescript
import {
  Controller,
  Get,
  Post,
  Patch,
  Delete,
  Body,
  Param,
} from '@nestjs/common';
import { WorkspacesService } from './workspaces.service';
import { CreateWorkspaceDto } from './dto/create-workspace.dto';
import { JoinWorkspaceDto } from './dto/join-workspace.dto';
import { UpdateMemberRoleDto } from './dto/update-member-role.dto';
import { CheckAbility } from '../common/decorators/check-ability.decorator';
import { CurrentUser } from '../common/decorators/current-user.decorator';

interface JwtPayload {
  sub: string;
  email: string;
}

@Controller('workspaces')
export class WorkspacesController {
  constructor(private readonly workspacesService: WorkspacesService) {}

  // WORK-01: Create workspace — any authenticated user
  @CheckAbility('create', 'Workspace')
  @Post()
  create(@Body() dto: CreateWorkspaceDto, @CurrentUser() user: JwtPayload) {
    return this.workspacesService.create(dto, user.sub);
  }

  // WORK-01: List user's workspaces — any authenticated user
  @CheckAbility('read', 'Workspace')
  @Get()
  findAll(@CurrentUser() user: JwtPayload) {
    return this.workspacesService.findAll(user.sub);
  }

  // WORK-03: Join workspace via invite token — MUST be before :slug routes
  // No :slug param — guard passes through (no workspace ability check needed)
  @CheckAbility('create', 'WorkspaceMember')
  @Post('join')
  joinWorkspace(@Body() dto: JoinWorkspaceDto, @CurrentUser() user: JwtPayload) {
    return this.workspacesService.joinWorkspace(dto, user.sub);
  }

  // WORK-01: Get workspace by slug — guard checks membership via WorkspaceAbilityFactory
  @CheckAbility('read', 'Workspace')
  @Get(':slug')
  findOne(@Param('slug') slug: string) {
    return this.workspacesService.findOne(slug);
  }

  // WORK-02: Generate invite link — Admin only (guard: create InviteLink)
  @CheckAbility('create', 'InviteLink')
  @Post(':slug/invite-links')
  generateInviteLink(@Param('slug') slug: string) {
    return this.workspacesService.generateInviteLink(slug);
  }

  // WORK-04: List members — any workspace member (guard: read WorkspaceMember)
  @CheckAbility('read', 'WorkspaceMember')
  @Get(':slug/members')
  listMembers(@Param('slug') slug: string) {
    return this.workspacesService.listMembers(slug);
  }

  // RBAC-01 / WORK-04: Update member role — Admin only (guard: update WorkspaceMember)
  @CheckAbility('update', 'WorkspaceMember')
  @Patch(':slug/members/:userId/role')
  updateMemberRole(
    @Param('slug') slug: string,
    @Param('userId') userId: string,
    @Body() dto: UpdateMemberRoleDto,
  ) {
    return this.workspacesService.updateMemberRole(slug, userId, dto);
  }

  // WORK-04 / WORK-05: Remove member — Admin only (guard: delete WorkspaceMember)
  @CheckAbility('delete', 'WorkspaceMember')
  @Delete(':slug/members/:userId')
  removeMember(@Param('slug') slug: string, @Param('userId') userId: string) {
    return this.workspacesService.removeMember(slug, userId);
  }
}
```

Update `apps/devcollab-api/src/workspaces/workspaces.module.ts` to add WorkspacesService and WorkspacesController:

```typescript
import { Module } from '@nestjs/common';
import { DatabaseModule } from '../core/database/database.module';
import { WorkspaceAbilityFactory } from './workspace-ability.factory';
import { WorkspacesService } from './workspaces.service';
import { WorkspacesController } from './workspaces.controller';

@Module({
  imports: [DatabaseModule],
  controllers: [WorkspacesController],
  providers: [WorkspacesService, WorkspaceAbilityFactory],
  exports: [WorkspaceAbilityFactory],
})
export class WorkspacesModule {}
```
  </action>
  <verify>
Run: `npx tsc --noEmit -p /home/doctor/fernandomillan/apps/devcollab-api/tsconfig.json`
Expected: Zero TypeScript errors.

Verify route order with grep:
`grep -n "@Post\|@Get\|@Patch\|@Delete\|join\|:slug" /home/doctor/fernandomillan/apps/devcollab-api/src/workspaces/workspaces.controller.ts | head -20`
Confirm `Post('join')` appears BEFORE `Get(':slug')` in the file.
  </verify>
  <done>
WorkspacesController exists with 8 endpoints, all decorated with @CheckAbility. WorkspacesModule updated with WorkspacesController and WorkspacesService. POST /workspaces/join declared before GET /workspaces/:slug. TypeScript exits 0.
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0
2. Controller has 8 route handlers: `grep -c "@CheckAbility" apps/devcollab-api/src/workspaces/workspaces.controller.ts` → 8
3. POST join before GET :slug: `grep -n "Post('join')\|Get(':slug')" apps/devcollab-api/src/workspaces/workspaces.controller.ts`
4. Last-admin protection: `grep "Cannot remove the last Admin\|Cannot demote the last Admin" apps/devcollab-api/src/workspaces/workspaces.service.ts`
5. Module updated: `grep "WorkspacesController\|WorkspacesService" apps/devcollab-api/src/workspaces/workspaces.module.ts`
</verification>

<success_criteria>
- WorkspacesService implements: create (auto-slug, creator Admin), findAll, findOne, generateInviteLink (72h expiry, UUID token), joinWorkspace (single-use validation, Contributor default), listMembers, updateMemberRole (last-admin protection), removeMember (last-admin protection)
- WorkspacesController has 8 endpoints, all decorated with @CheckAbility
- POST /workspaces/join declared before GET /workspaces/:slug
- WorkspacesModule registers controller and service
- TypeScript compilation exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspaces-membership-rbac/16-03-SUMMARY.md`
</output>
