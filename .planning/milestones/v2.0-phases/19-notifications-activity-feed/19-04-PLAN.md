---
phase: 19-notifications-activity-feed
plan: 04
type: execute
wave: 4
depends_on: [19-03]
files_modified: []
autonomous: false
requirements: [NOTF-01, NOTF-02, NOTF-03, FEED-01]

must_haves:
  truths:
    - "Posting a comment with @username notifies that user within 60 seconds"
    - "Bell icon shows a red badge with correct unread count"
    - "Notification panel lists notifications with links to source content"
    - "Mark all read clears the badge immediately"
    - "Activity feed page shows events in reverse-chronological order"
    - "Load More appends older events without collapsing the current list"
    - "Activity feed refreshes with new events at the top without page reload within 30 seconds"
  artifacts:
    - path: "apps/devcollab-web/app/w/[slug]/activity/page.tsx"
      provides: "Activity feed page accessible at /w/:slug/activity"
    - path: "apps/devcollab-web/components/notifications/BellIcon.tsx"
      provides: "Bell icon with polling badge"
  key_links:
    - from: "BellIcon"
      to: "devcollab-api GET /notifications/unread-count"
      via: "60s setInterval in browser"
      pattern: "polling"
    - from: "ActivityFeed"
      to: "devcollab-api GET /workspaces/:slug/activity"
      via: "30s setInterval + Load More"
      pattern: "polling + cursor"
---

<objective>
Human verification of all Phase 19 features: @mention notifications (bell badge + panel + mark read), and workspace activity feed (reverse-chronological events, Load More, 30s refresh).

Purpose: Confirm all 4 success criteria from the ROADMAP are met by a real human testing the live application.
Output: Phase 19 approved or issues fed back for gap closure.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-notifications-activity-feed/19-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Human verification — full notifications + activity feed flow</name>
  <action>
Pause for human verification of the complete Phase 19 notifications and activity feed system.

What was built:
- NotificationsController: GET /notifications, GET /notifications/unread-count, PATCH /notifications/:id/read, PATCH /notifications/read-all
- ActivityController: GET /workspaces/:slug/activity (cursor-paginated, 20 events/page)
- CommentsService: notifyMentions() called after comment create and update
- WorkspacesService/PostsService/SnippetsService: activityEvent.create() after join/create/update
- WorkspaceNav client component with bell icon + activity link
- BellIcon: 60s polling badge (red #ef4444, no purple), setInterval with cleanup
- NotificationList: mark-individual-read + mark-all-read
- ActivityFeed: 30s refresh merge + Load More with cursor pagination
- Activity feed page at /w/:slug/activity

Verify in browser per the how-to-verify steps below.
  </action>
  <what-built>
Complete Phase 19 implementation:
- NotificationsController: GET /notifications, GET /notifications/unread-count, PATCH /notifications/:id/read, PATCH /notifications/read-all
- ActivityController: GET /workspaces/:slug/activity (cursor-paginated)
- CommentsService: notifyMentions() called after comment create/update
- WorkspacesService/PostsService/SnippetsService: activityEvent.create() after join/create/update
- WorkspaceNav client component with bell icon + activity link
- BellIcon: 60s polling badge (red badge, no purple)
- NotificationList: mark-individual + mark-all-read
- ActivityFeed: 30s refresh merge + Load More with cursor pagination
- Activity feed page at /w/:slug/activity
  </what-built>
  <how-to-verify>
Start the development environment if not already running:
```bash
cd /home/doctor/fernandomillan && docker compose up -d
```

Open the app at http://localhost:3002 and log in.

**Step 1 — Workspace layout shows bell + activity link:**
- Navigate to a workspace: http://localhost:3002/w/:slug
- Confirm the top nav shows: Overview | Posts | Snippets | Activity | Bell icon | Dashboard
- Confirm the bell icon is visible (no badge initially if no unread notifications)

**Step 2 — @mention notification flow:**
- Log in as User A in one browser tab
- Log in as User B in another browser / incognito tab (create a second user if needed)
- As User A: navigate to a post or snippet detail page, post a comment containing `@B` (use User B's display name)
- Wait up to 60 seconds
- As User B: observe the bell icon — the red badge should appear with count 1

**Step 3 — Bell panel and notification link:**
- As User B: click the bell icon
- Confirm the notification panel opens and shows: "[User A] mentioned you"
- Confirm the notification has a link — clicking it navigates to the source post/snippet
- Confirm the notification item has a "Mark read" button

**Step 4 — Mark individual notification as read:**
- As User B: click "Mark read" on the notification
- Confirm the item style changes (background returns to white)
- Confirm the badge count decrements (or disappears if count reaches 0)
- Confirm the badge updates immediately (no page reload needed)

**Step 5 — Mark all read:**
- As User B: if there are unread notifications, click "Mark all read"
- Confirm the badge disappears immediately

**Step 6 — Activity feed page:**
- Navigate to: http://localhost:3002/w/:slug/activity
- Confirm the page loads and shows workspace events in reverse-chronological order
- Expected events (from previous test steps): "[User A] created a post", "[User A] created a snippet", "[User X] joined the workspace"

**Step 7 — Activity feed Load More:**
- If fewer than 20 events are shown: create a few more posts and snippets to generate events
- Confirm a "Load More" button appears when there are more than 20 events
- Click "Load More" — confirm older events are appended BELOW the current list (not replacing it)

**Step 8 — Activity feed 30s refresh:**
- Stay on the activity page
- In another tab: create a new post or snippet
- Wait up to 30 seconds
- Confirm the new event appears at the TOP of the feed without a page reload

**Step 9 — Duplicate mention prevention (edit scenario):**
- As User A: edit the comment from Step 2, keeping the `@B` mention
- Wait for the edit to save
- Confirm User B does NOT receive a second notification for the same mention (badge stays at same count)

**Step 10 — CASL guard: Viewer cannot post comments (regression check):**
- Log in as a Viewer-role user
- Attempt to POST to /workspaces/:slug/comments via the UI
- Confirm 403 is returned (comment form shows error, no comment posted)
  </how-to-verify>
  <verify>Human confirms all 10 browser verification steps pass.</verify>
  <done>Human types "approved" — all 10 acceptance criteria verified in browser.</done>
  <resume-signal>
Type "approved" if all 10 steps pass.
Or describe which steps failed (e.g., "step 2 failed — badge not appearing") so gap closure plans can be created.
  </resume-signal>
</task>

</tasks>

<verification>
All 10 acceptance criteria verified by human tester against the live application.
</verification>

<success_criteria>
1. @mention in a comment triggers a notification for the mentioned user — badge appears within 60 seconds
2. Bell icon badge shows correct unread count in red; clicking opens panel with notification list and links
3. Mark individual read and mark all read both update the badge count immediately
4. Activity feed at /w/:slug/activity shows events in reverse-chronological order with cursor-paginated Load More and 30s top-refresh
</success_criteria>

<output>
After completion, create `.planning/phases/19-notifications-activity-feed/19-04-SUMMARY.md`
</output>
