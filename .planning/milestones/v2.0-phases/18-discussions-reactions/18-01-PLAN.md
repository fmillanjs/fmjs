---
phase: 18-discussions-reactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/devcollab-database/prisma/schema.prisma
  - apps/devcollab-api/src/core/database/prisma.service.ts
autonomous: true
requirements:
  - DISC-01
  - DISC-02
  - DISC-03
  - DISC-04

must_haves:
  truths:
    - "Comment and Reaction models exist in the Prisma schema with correct self-relation, nullable FKs, and @@unique constraints"
    - "The Prisma migration runs cleanly against the running devcollab-postgres container"
    - "PrismaService exposes .comment and .reaction getters for use in NestJS services"
    - "Back-reference fields (comments, reactions) are added to User, Post, and Snippet models"
  artifacts:
    - path: "packages/devcollab-database/prisma/schema.prisma"
      provides: "Comment model with parentId self-relation + Reaction model with nullable postId/commentId FKs"
      contains: "model Comment"
    - path: "apps/devcollab-api/src/core/database/prisma.service.ts"
      provides: "comment and reaction getters on PrismaService"
      exports: ["comment", "reaction"]
  key_links:
    - from: "Comment.parentId"
      to: "Comment.id"
      via: "self-relation @relation(\"CommentReplies\")"
      pattern: "CommentReplies"
    - from: "Reaction.postId / Reaction.commentId"
      to: "Post.id / Comment.id"
      via: "nullable FK + @@unique per target type"
      pattern: "@@unique"
---

<objective>
Extend the Prisma schema with Comment and Reaction models, run the migration, and add PrismaService getters.

Purpose: All NestJS services in Phase 18 require these models to exist in the database before any controller or UI work can proceed.
Output: A passing migration applied to devcollab-postgres; PrismaService with .comment and .reaction getters ready for service injection.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/devcollab-database/prisma/schema.prisma
@apps/devcollab-api/src/core/database/prisma.service.ts
@.planning/phases/18-discussions-reactions/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Comment and Reaction models to schema.prisma + back-references on existing models</name>
  <files>packages/devcollab-database/prisma/schema.prisma</files>
  <action>
    Add the following to schema.prisma (append after the Post model):

    ```prisma
    model Comment {
      id        String    @id @default(cuid())
      content   String    @db.Text
      deletedAt DateTime?

      authorId  String
      parentId  String?
      postId    String?
      snippetId String?

      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt

      author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
      parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
      replies   Comment[] @relation("CommentReplies")
      post      Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
      snippet   Snippet?  @relation(fields: [snippetId], references: [id], onDelete: Cascade)
      reactions Reaction[]

      @@index([postId])
      @@index([snippetId])
      @@index([authorId])
      @@index([parentId])
      @@index([createdAt])
    }

    model Reaction {
      id    String @id @default(cuid())
      emoji String // 'thumbs_up' | 'heart' | 'plus_one' | 'laugh'

      userId    String
      postId    String?
      commentId String?

      createdAt DateTime @default(now())

      user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
      post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
      comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

      @@unique([userId, emoji, postId])
      @@unique([userId, emoji, commentId])
      @@index([postId])
      @@index([commentId])
      @@index([userId])
    }
    ```

    Also add back-reference fields to existing models:
    - On the User model: add `comments  Comment[]` and `reactions Reaction[]`
    - On the Post model: add `comments  Comment[]` and `reactions Reaction[]`
    - On the Snippet model: add `comments  Comment[]`

    The self-relation on Comment uses `onDelete: NoAction, onUpdate: NoAction` on the parent side to prevent cascade-deleting replies when a parent comment is soft-deleted. The Reaction model uses separate nullable FKs (not a polymorphic targetType/targetId) to preserve real FK referential integrity.
  </action>
  <verify>Run: `cd /home/doctor/fernandomillan && npx prisma validate --schema=packages/devcollab-database/prisma/schema.prisma` — must exit 0 with no errors.</verify>
  <done>Schema validates cleanly; Comment and Reaction models present; User/Post/Snippet have back-reference fields.</done>
</task>

<task type="auto">
  <name>Task 2: Run migration and add PrismaService getters</name>
  <files>apps/devcollab-api/src/core/database/prisma.service.ts</files>
  <action>
    First, verify the devcollab-postgres container is running:
    ```bash
    docker ps --filter name=devcollab-postgres --format "{{.Status}}"
    ```
    If not running, start it: `docker compose up devcollab-postgres -d`

    Then run the migration:
    ```bash
    cd /home/doctor/fernandomillan
    npx prisma migrate dev --name add-comments-reactions \
      --schema=packages/devcollab-database/prisma/schema.prisma
    ```

    After migration succeeds, add two getters to `apps/devcollab-api/src/core/database/prisma.service.ts` at the end of the class body, after the existing `get post()` getter:

    ```typescript
    get comment() {
      return this.client.comment;
    }

    get reaction() {
      return this.client.reaction;
    }
    ```

    Do not modify any other code in the file.
  </action>
  <verify>
    1. `docker exec devcollab-postgres psql -U devcollab -d devcollab -c "\dt" | grep -E "comment|reaction"` — must show both tables.
    2. `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` — must exit 0.
  </verify>
  <done>Migration applied to devcollab-postgres; Comment and Reaction tables exist; PrismaService compiles with .comment and .reaction getters.</done>
</task>

</tasks>

<verification>
- `npx prisma validate --schema=packages/devcollab-database/prisma/schema.prisma` exits 0
- `docker exec devcollab-postgres psql -U devcollab -d devcollab -c "\dt"` shows comment and reaction tables
- `npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0
</verification>

<success_criteria>
Prisma migration `add-comments-reactions` applied; Comment and Reaction tables exist in devcollab-postgres; PrismaService exports .comment and .reaction getters; TypeScript compilation passes.
</success_criteria>

<output>
After completion, create `.planning/phases/18-discussions-reactions/18-01-SUMMARY.md`
</output>
