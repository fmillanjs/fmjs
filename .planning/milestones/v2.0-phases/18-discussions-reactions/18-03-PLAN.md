---
phase: 18-discussions-reactions
plan: 03
type: execute
wave: 3
depends_on:
  - 18-02
files_modified:
  - apps/devcollab-web/components/discussion/CommentForm.tsx
  - apps/devcollab-web/components/discussion/CommentItem.tsx
  - apps/devcollab-web/components/discussion/ThreadedComments.tsx
  - apps/devcollab-web/components/reaction/ReactionBar.tsx
autonomous: true
requirements:
  - DISC-01
  - DISC-02
  - DISC-03
  - DISC-04

must_haves:
  truths:
    - "ThreadedComments renders a flat list of top-level comments each with their replies indented"
    - "A reply button appears only on top-level comments (parentId === null); it does not appear on replies"
    - "CommentForm submits to POST /workspaces/:slug/comments with credentials:include; shows new comment immediately after success"
    - "An owner's comment shows Edit and Delete buttons; Edit saves via PATCH; Delete calls DELETE and shows [deleted]"
    - "ReactionBar renders 4 emoji buttons (thumbs_up, heart, plus_one, laugh) with counts; clicking toggles via POST /workspaces/:slug/reactions and updates count optimistically without page reload"
    - "ReactionBar highlights the active reaction (blue border/background) for the currentUserId"
  artifacts:
    - path: "apps/devcollab-web/components/discussion/ThreadedComments.tsx"
      provides: "Client component rendering threaded comment list with add/reply/edit/delete"
      exports: ["default ThreadedComments"]
    - path: "apps/devcollab-web/components/discussion/CommentForm.tsx"
      provides: "Textarea + submit button for creating/replying"
      exports: ["default CommentForm"]
    - path: "apps/devcollab-web/components/discussion/CommentItem.tsx"
      provides: "Single comment row with author, timestamp, edited indicator, edit/delete controls, reply button (top-level only)"
      exports: ["default CommentItem"]
    - path: "apps/devcollab-web/components/reaction/ReactionBar.tsx"
      provides: "4-emoji reaction row with optimistic toggle"
      exports: ["default ReactionBar"]
  key_links:
    - from: "ThreadedComments"
      to: "GET /workspaces/:slug/comments"
      via: "useEffect fetch on mount with credentials:include"
      pattern: "fetch.*comments"
    - from: "CommentForm.onSubmit"
      to: "POST /workspaces/:slug/comments"
      via: "fetch with credentials:include; body includes postId or snippetId + optional parentId"
      pattern: "fetch.*POST.*comments"
    - from: "ReactionBar.toggle"
      to: "POST /workspaces/:slug/reactions"
      via: "optimistic useState update before fetch; credentials:include"
      pattern: "fetch.*reactions"
---

<objective>
Build the four client-side React components for discussions and reactions.

Purpose: These components are the entire user-facing surface for Phase 18. They call the NestJS API directly via fetch with credentials:include ‚Äî the established project pattern.
Output: Four new component files; no page files modified in this plan (that happens in Plan 04).
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-discussions-reactions/18-02-SUMMARY.md
@apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx
@apps/devcollab-web/app/w/[slug]/snippets/[id]/page.tsx
@.planning/phases/18-discussions-reactions/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CommentForm and CommentItem components</name>
  <files>
    apps/devcollab-web/components/discussion/CommentForm.tsx
    apps/devcollab-web/components/discussion/CommentItem.tsx
  </files>
  <action>
    Create `apps/devcollab-web/components/discussion/` directory if it does not exist.

    **CommentForm.tsx** ‚Äî `'use client'` component:

    Define the API base URL constant at module scope (same pattern as ReactionBar):
    ```typescript
    const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';
    ```

    Props: `{ workspaceSlug: string; postId?: string; snippetId?: string; parentId?: string; onSuccess: () => void; onCancel?: () => void; placeholder?: string }`

    State: `content` (string), `loading` (boolean), `error` (string | null)

    On submit:
    - Set loading=true
    - POST to `${API_URL}/workspaces/${workspaceSlug}/comments` with `credentials: 'include'`, body: `{ content, postId, snippetId, parentId }` (omit undefined fields)
    - On success: clear content, call onSuccess(), set loading=false
    - On error: set error to response status text, set loading=false

    UI: `<textarea>` (min 3 rows) bound to content state, submit button ("Post comment" or "Reply"), cancel button (if onCancel provided), error message div if error.

    Do not use purple for any color in styling. Use `#3b82f6` (blue) for the submit button.

    **CommentItem.tsx** ‚Äî `'use client'` component:

    Define the API base URL constant at module scope (same pattern as ReactionBar):
    ```typescript
    const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';
    ```

    Props:
    ```typescript
    interface CommentNode {
      id: string;
      content: string;
      deletedAt: string | null;
      createdAt: string;
      updatedAt: string;
      authorId: string;
      parentId: string | null;
      author: { id: string; name: string | null; email: string };
      reactions: Array<{ id: string; emoji: string; userId: string }>;
      replies: CommentNode[];
    }

    interface Props {
      comment: CommentNode;
      currentUserId: string;
      workspaceSlug: string;
      postId?: string;
      snippetId?: string;
      onRefresh: () => void;
    }
    ```

    State: `isEditing` (boolean), `editContent` (string), `showReplyForm` (boolean), `loading` (boolean)

    Behaviors:
    - If `comment.deletedAt` is non-null OR `comment.content === '[deleted]'`: render `<em style={{color:'#9ca3af'}}>[deleted]</em>` for content; no edit/delete/reply buttons
    - "edited" indicator: if `comment.updatedAt !== comment.createdAt`, show `(edited)` in small gray text next to the timestamp
    - Reply button: only render if `comment.parentId === null` (top-level). Clicking toggles `showReplyForm`.
    - Edit button: only if `comment.authorId === currentUserId`. Clicking sets `isEditing=true` and prefills `editContent`.
    - Delete button: only if `comment.authorId === currentUserId`. On click: DELETE `${API_URL}/workspaces/${workspaceSlug}/comments/${comment.id}` with credentials:include ‚Üí on success: call onRefresh().
    - Save edit: PATCH `${API_URL}/workspaces/${workspaceSlug}/comments/${comment.id}` with `{ content: editContent }`, credentials:include ‚Üí on success: setIsEditing(false), onRefresh().
    - Reply form: when showReplyForm=true, render `<CommentForm>` with parentId=comment.id; onSuccess closes the form and calls onRefresh().
    - Render replies (comment.replies array) recursively by mapping over them and rendering `<CommentItem>` for each (no further nesting check needed ‚Äî backend enforces depth=1).
    - ReactionBar: render `<ReactionBar>` below the comment content, passing commentId=comment.id, initialReactions=comment.reactions, currentUserId, workspaceSlug.

    Import ReactionBar from `../../reaction/ReactionBar` (relative path).
    Import CommentForm from `./CommentForm`.

    Use inline styles only. No purple colors.
  </action>
  <verify>
    `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/devcollab-web/tsconfig.json` exits 0.
  </verify>
  <done>CommentForm and CommentItem compile; both files define `const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003'` at module scope; CommentItem shows reply button only on top-level comments; edit/delete only for owner; [deleted] state renders correctly.</done>
</task>

<task type="auto">
  <name>Task 2: ThreadedComments and ReactionBar components</name>
  <files>
    apps/devcollab-web/components/discussion/ThreadedComments.tsx
    apps/devcollab-web/components/reaction/ReactionBar.tsx
  </files>
  <action>
    Create `apps/devcollab-web/components/reaction/` directory if it does not exist.

    **ReactionBar.tsx** ‚Äî `'use client'` component. Follow the exact pattern from RESEARCH.md Pattern 5:

    ```typescript
    'use client';
    import { useState } from 'react';

    const EMOJI_MAP: Record<string, string> = {
      thumbs_up: 'üëç',
      heart: '‚ù§Ô∏è',
      plus_one: '+1',
      laugh: 'üòÑ',
    };

    interface Reaction { emoji: string; userId: string; }

    interface Props {
      postId?: string;
      commentId?: string;
      initialReactions: Reaction[];
      currentUserId: string;
      workspaceSlug: string;
    }

    const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

    export default function ReactionBar({ postId, commentId, initialReactions, currentUserId, workspaceSlug }: Props) {
      const [reactions, setReactions] = useState(initialReactions);
      const [pending, setPending] = useState<string | null>(null);

      const toggle = async (emoji: string) => {
        if (pending) return; // debounce: ignore while a request is in-flight
        setPending(emoji);
        const alreadyReacted = reactions.some(r => r.emoji === emoji && r.userId === currentUserId);
        setReactions(prev =>
          alreadyReacted
            ? prev.filter(r => !(r.emoji === emoji && r.userId === currentUserId))
            : [...prev, { emoji, userId: currentUserId }]
        );
        try {
          await fetch(`${API_URL}/workspaces/${workspaceSlug}/reactions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ emoji, postId, commentId }),
          });
        } finally {
          setPending(null);
        }
      };

      return (
        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', marginTop: '0.5rem' }}>
          {Object.entries(EMOJI_MAP).map(([key, emoji]) => {
            const count = reactions.filter(r => r.emoji === key).length;
            const active = reactions.some(r => r.emoji === key && r.userId === currentUserId);
            return (
              <button
                key={key}
                onClick={() => toggle(key)}
                disabled={pending === key}
                style={{
                  padding: '4px 10px',
                  border: `1px solid ${active ? '#3b82f6' : '#d1d5db'}`,
                  borderRadius: '999px',
                  background: active ? '#eff6ff' : 'white',
                  cursor: pending ? 'not-allowed' : 'pointer',
                  fontSize: '14px',
                  opacity: pending === key ? 0.6 : 1,
                }}
              >
                {emoji} {count > 0 ? count : ''}
              </button>
            );
          })}
        </div>
      );
    }
    ```

    Note: `pending` state prevents double-click race conditions (Pitfall 4 from RESEARCH.md). No purple colors used.

    **ThreadedComments.tsx** ‚Äî `'use client'` component:
    Props: `{ workspaceSlug: string; postId?: string; snippetId?: string; currentUserId: string; initialComments?: CommentNode[] }`

    State: `comments` (CommentNode[]), `loading` (boolean), `error` (string | null)

    On mount (useEffect): if initialComments provided, set them as comments; also set up a refresh function. The refresh function fetches from `${API_URL}/workspaces/${workspaceSlug}/comments?${postId ? 'postId='+postId : 'snippetId='+snippetId}` with `credentials:'include', cache:'no-store'` and updates comments state.

    Render:
    - Section heading: `<h3>Discussion ({comments.length} comment{comments.length !== 1 ? 's' : ''})</h3>`
    - `<CommentForm>` at the top for new top-level comments (no parentId; postId/snippetId forwarded; onSuccess calls refresh)
    - Map over comments array, render `<CommentItem>` for each top-level comment, passing onRefresh=refresh
    - If loading: show `<p>Loading comments...</p>`
    - If error: show `<p style={{color:'#ef4444'}}>{error}</p>`

    Export the `CommentNode` interface from this file so it can be imported by the detail pages in Plan 04.

    Import `CommentItem` from `./CommentItem`. All types must be defined explicitly (no `any`).
  </action>
  <verify>
    `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/devcollab-web/tsconfig.json` exits 0.
  </verify>
  <done>All four discussion/reaction components compile cleanly; no 'any' types; ReactionBar has debounce (pending state); ThreadedComments exports CommentNode interface.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p apps/devcollab-web/tsconfig.json` exits 0
- Component files exist at the declared paths
- No `any` types in any component
- CommentItem: reply button only when parentId === null (verifiable by code inspection)
- ReactionBar: no purple colors; uses #3b82f6 blue for active state
- All three components that call fetch (CommentForm, CommentItem, ThreadedComments) define `const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003'` at module scope
</verification>

<success_criteria>
Four component files created and compile cleanly; ThreadedComments exports CommentNode type; ReactionBar implements optimistic toggle with pending debounce; CommentItem enforces reply-to-reply UI prevention via parentId check; API_URL constant defined consistently in all three components that make fetch calls.
</success_criteria>

<output>
After completion, create `.planning/phases/18-discussions-reactions/18-03-SUMMARY.md`
</output>
