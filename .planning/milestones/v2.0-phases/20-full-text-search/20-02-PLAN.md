---
phase: 20-full-text-search
plan: "02"
type: execute
wave: 2
depends_on:
  - "20-01"
files_modified:
  - apps/devcollab-api/src/search/search.module.ts
  - apps/devcollab-api/src/search/search.service.ts
  - apps/devcollab-api/src/search/search.controller.ts
  - apps/devcollab-api/src/search/dto/search-query.dto.ts
  - apps/devcollab-api/src/app.module.ts
  - apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts
autonomous: true
requirements:
  - SRCH-01
  - SRCH-02

must_haves:
  truths:
    - "GET /workspaces/:slug/search?q=react returns JSON with { posts: [...], snippets: [...] }"
    - "Search results include only items from the queried workspace (workspace-scoped)"
    - "Results include a headline field with matching terms wrapped in <mark> tags"
    - "Partial-word search works: searching 'reac' returns posts/snippets containing 'react'"
    - "Searching with special characters like ( ) | & does not return 500 — returns empty results safely"
    - "The controller-coverage meta-test passes with SearchController included"
  artifacts:
    - path: "apps/devcollab-api/src/search/search.service.ts"
      provides: "Full-text search using $queryRaw with ts_headline, prefix matching, workspace scope"
      exports: ["SearchService"]
    - path: "apps/devcollab-api/src/search/search.controller.ts"
      provides: "GET /workspaces/:slug/search?q= endpoint with @CheckAbility"
      exports: ["SearchController"]
    - path: "apps/devcollab-api/src/search/search.module.ts"
      provides: "NestJS module wiring SearchController + SearchService + DatabaseModule"
      exports: ["SearchModule"]
    - path: "apps/devcollab-api/src/app.module.ts"
      provides: "SearchModule imported in AppModule"
      contains: "SearchModule"
  key_links:
    - from: "apps/devcollab-api/src/search/search.controller.ts"
      to: "apps/devcollab-api/src/search/search.service.ts"
      via: "SearchService injected into SearchController constructor"
      pattern: "SearchService"
    - from: "apps/devcollab-api/src/search/search.service.ts"
      to: "apps/devcollab-api/src/core/database/prisma.service.ts"
      via: "this.prisma.$queryRaw<...>(Prisma.sql`...`)"
      pattern: "prisma\\.\\$queryRaw"
    - from: "apps/devcollab-api/src/app.module.ts"
      to: "apps/devcollab-api/src/search/search.module.ts"
      via: "SearchModule imported in AppModule.imports array"
      pattern: "SearchModule"
---

<objective>
Build the NestJS SearchModule: a single GET endpoint at `GET /workspaces/:slug/search?q=` that queries Post and Snippet tables using tsvector full-text search with prefix matching and ts_headline() highlighting.

Purpose: Implements SRCH-01 (workspace-scoped FTS with prefix matching) and SRCH-02 (grouped results with highlighting). The frontend (Plan 03) calls this endpoint.
Output: SearchModule with SearchService (raw SQL FTS) + SearchController (@CheckAbility protected) + AppModule wiring + meta-test updated.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-full-text-search/20-RESEARCH.md
@.planning/phases/20-full-text-search/20-01-SUMMARY.md
@apps/devcollab-api/src/core/database/prisma.service.ts
@apps/devcollab-api/src/app.module.ts
@apps/devcollab-api/src/notifications/notifications.module.ts
@apps/devcollab-api/src/notifications/notifications.controller.ts
@apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SearchModule (service + controller + DTO)</name>
  <files>apps/devcollab-api/src/search/search.service.ts</files>
  <files>apps/devcollab-api/src/search/search.controller.ts</files>
  <files>apps/devcollab-api/src/search/search.module.ts</files>
  <files>apps/devcollab-api/src/search/dto/search-query.dto.ts</files>
  <action>
Create the directory `apps/devcollab-api/src/search/` with the following four files.

**File 1: `apps/devcollab-api/src/search/dto/search-query.dto.ts`**
```typescript
export class SearchQueryDto {
  q!: string;
}
```

**File 2: `apps/devcollab-api/src/search/search.service.ts`**

```typescript
import { Injectable, NotFoundException } from '@nestjs/common';
import { Prisma } from '@devcollab/database';
import { PrismaService } from '../core/database/prisma.service';

type PostSearchResult = {
  id: string;
  title: string;
  status: string;
  createdAt: Date;
  authorId: string;
  workspaceId: string;
  headline: string;
};

type SnippetSearchResult = {
  id: string;
  title: string;
  language: string;
  createdAt: Date;
  authorId: string;
  workspaceId: string;
  headline: string;
};

@Injectable()
export class SearchService {
  constructor(private readonly prisma: PrismaService) {}

  async search(slug: string, rawQuery: string, userId: string) {
    const workspace = await this.prisma.workspace.findUnique({
      where: { slug },
      select: { id: true },
    });
    if (!workspace) throw new NotFoundException('Workspace not found');

    // Sanitize user input: strip tsquery special chars that cause syntax errors
    const clean = rawQuery
      .trim()
      .replace(/[|&!<>()'":]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();

    // Guard: empty query returns empty results (to_tsquery('') throws a Postgres error)
    if (!clean) return { posts: [], snippets: [] };

    // Build prefix tsquery: "react hooks" -> "react:* & hooks:*"
    const term = clean
      .split(' ')
      .filter(Boolean)
      .map((w) => `${w}:*`)
      .join(' & ');

    const workspaceId = workspace.id;

    const [posts, snippets] = await Promise.all([
      this.prisma.$queryRaw<PostSearchResult[]>(Prisma.sql`
        SELECT
          p.id,
          p.title,
          p.status,
          p."createdAt",
          p."authorId",
          p."workspaceId",
          ts_headline(
            'english',
            p.title || ' ' || p.content,
            to_tsquery('english', ${term}),
            'StartSel=<mark>, StopSel=</mark>, MaxWords=20, MinWords=5, MaxFragments=2'
          ) AS headline
        FROM "Post" p
        WHERE p."workspaceId" = ${workspaceId}
          AND p."searchVector" @@ to_tsquery('english', ${term})
          AND (p.status = 'Published' OR p."authorId" = ${userId})
        ORDER BY ts_rank(p."searchVector", to_tsquery('english', ${term})) DESC
        LIMIT 10
      `),
      this.prisma.$queryRaw<SnippetSearchResult[]>(Prisma.sql`
        SELECT
          s.id,
          s.title,
          s.language,
          s."createdAt",
          s."authorId",
          s."workspaceId",
          ts_headline(
            'english',
            s.title || ' ' || s.code,
            to_tsquery('english', ${term}),
            'StartSel=<mark>, StopSel=</mark>, MaxWords=30, MinWords=10, MaxFragments=2'
          ) AS headline
        FROM "Snippet" s
        WHERE s."workspaceId" = ${workspaceId}
          AND s."searchVector" @@ to_tsquery('english', ${term})
        ORDER BY ts_rank(s."searchVector", to_tsquery('english', ${term})) DESC
        LIMIT 10
      `),
    ]);

    return { posts, snippets };
  }
}
```

Note on Post status filter: `AND (p.status = 'Published' OR p."authorId" = ${userId})` mirrors the existing PostsService access rule. Authors see their own Drafts in search; others see only Published posts.

**File 3: `apps/devcollab-api/src/search/search.controller.ts`**

```typescript
import { Controller, Get, Param, Query } from '@nestjs/common';
import { SearchService } from './search.service';
import { CheckAbility } from '../common/decorators/check-ability.decorator';
import { CurrentUser, JwtPayload } from '../common/decorators/current-user.decorator';

@Controller('workspaces/:slug/search')
export class SearchController {
  constructor(private readonly searchService: SearchService) {}

  @CheckAbility('read', 'Post')
  @Get()
  search(
    @Param('slug') slug: string,
    @Query('q') q: string = '',
    @CurrentUser() user: JwtPayload,
  ) {
    return this.searchService.search(slug, q, user.sub);
  }
}
```

CRITICAL: `@CheckAbility('read', 'Post')` is required. The global CaslAuthGuard (APP_GUARD) denies any endpoint without `@CheckAbility` or `@Public`. Without this decorator, the endpoint always returns 403.

**File 4: `apps/devcollab-api/src/search/search.module.ts`**

```typescript
import { Module } from '@nestjs/common';
import { DatabaseModule } from '../core/database/database.module';
import { SearchService } from './search.service';
import { SearchController } from './search.controller';

@Module({
  imports: [DatabaseModule],
  controllers: [SearchController],
  providers: [SearchService],
})
export class SearchModule {}
```
  </action>
  <verify>
TypeScript compilation must pass:
```bash
cd apps/devcollab-api && npx tsc --noEmit
```

Check all four files exist:
```bash
ls apps/devcollab-api/src/search/
```
Expected output includes: `search.module.ts`, `search.service.ts`, `search.controller.ts`, `dto/`
  </verify>
  <done>
- Four files created: search.module.ts, search.service.ts, search.controller.ts, dto/search-query.dto.ts
- `npx tsc --noEmit` exits with code 0
- SearchController has `@CheckAbility('read', 'Post')` on the GET handler
- SearchService.search() sanitizes rawQuery and guards empty term before calling $queryRaw
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SearchModule into AppModule and update meta-test</name>
  <files>apps/devcollab-api/src/app.module.ts</files>
  <files>apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts</files>
  <action>
**Step 1: Update `apps/devcollab-api/src/app.module.ts`**

Add `SearchModule` to the imports array. The import must go after `ActivityModule` to maintain alphabetical/dependency order:

```typescript
import { SearchModule } from './search/search.module';
```

And add `SearchModule` to the `imports` array in `@Module()` alongside the existing modules.

**Step 2: Update `apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts`**

Add `SearchController` to the meta-test so the deny-by-default invariant is enforced on it:

```typescript
import { SearchController } from '../../../src/search/search.controller';
```

Add `SearchController` to the `ALL_CONTROLLERS` array:
```typescript
const ALL_CONTROLLERS = [
  HealthController,
  AuthController,
  WorkspacesController,
  SnippetsController,
  PostsController,
  CommentsController,
  ReactionsController,
  NotificationsController,
  ActivityController,
  SearchController,   // ADD THIS
] as const;
```

**Step 3: Run the meta-test to confirm it passes**

```bash
cd apps/devcollab-api && npx vitest run test/unit/meta/controller-coverage.spec.ts
```

The test must report that `SearchController.search` has `@CheckAbility` and passes.
  </action>
  <verify>
1. AppModule wiring:
```bash
grep "SearchModule" apps/devcollab-api/src/app.module.ts
```
Expected: two lines (import statement + in imports array).

2. Meta-test passes:
```bash
cd apps/devcollab-api && npx vitest run test/unit/meta/controller-coverage.spec.ts
```
Expected: all tests pass including new `SearchController "search" must have @Public() or @CheckAbility()`.

3. API responds (requires Docker running):
```bash
# Should return 401 (not 403 from deny-by-default — means route is found)
curl -s -o /dev/null -w "%{http_code}" http://localhost:3003/workspaces/demo/search?q=test
```
If Docker is not running, skip the curl test — TypeScript compilation + meta-test passing is sufficient verification.
  </verify>
  <done>
- `app.module.ts` imports SearchModule and includes it in the imports array
- `controller-coverage.spec.ts` includes SearchController in ALL_CONTROLLERS
- Meta-test passes with all controllers including SearchController
  </done>
</task>

</tasks>

<verification>
Full plan verification:
1. `GET /workspaces/:slug/search?q=test` — responds 401 (unauthenticated) or 200 with `{ posts: [], snippets: [] }` with a valid session (not 403)
2. Meta-test passes: `npx vitest run test/unit/meta/controller-coverage.spec.ts` — all pass including SearchController
3. TypeScript: `npx tsc --noEmit` in devcollab-api — exits 0
4. SearchService sanitizes special characters: query `react(hooks)` does not throw 500
</verification>

<success_criteria>
- SearchModule registered in AppModule — the API endpoint is reachable at GET /workspaces/:slug/search?q=
- Search endpoint is protected by @CheckAbility (deny-by-default invariant maintained)
- Meta-test covers SearchController and passes
- ts_headline returns results with `<mark>` tags around matching terms
</success_criteria>

<output>
After completion, create `.planning/phases/20-full-text-search/20-02-SUMMARY.md` following the summary template.
</output>
