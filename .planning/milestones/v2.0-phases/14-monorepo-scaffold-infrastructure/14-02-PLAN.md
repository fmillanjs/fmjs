---
phase: 14-monorepo-scaffold-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/devcollab-api/package.json
  - apps/devcollab-api/tsconfig.json
  - apps/devcollab-api/nest-cli.json
  - apps/devcollab-api/src/main.ts
  - apps/devcollab-api/src/app.module.ts
  - apps/devcollab-api/src/common/decorators/public.decorator.ts
  - apps/devcollab-api/src/guards/casl-auth.guard.ts
  - apps/devcollab-api/src/health/health.module.ts
  - apps/devcollab-api/src/health/health.controller.ts
  - apps/devcollab-api/Dockerfile
  - apps/devcollab-web/package.json
  - apps/devcollab-web/tsconfig.json
  - apps/devcollab-web/next.config.ts
  - apps/devcollab-web/app/page.tsx
  - apps/devcollab-web/app/layout.tsx
  - apps/devcollab-web/Dockerfile
autonomous: true
requirements:
  - INFRA-01

must_haves:
  truths:
    - "apps/devcollab-api is a NestJS 11 app running on port 3003 with GET /health returning 200"
    - "CASL deny-by-default APP_GUARD blocks all routes; @Public() decorator opts out"
    - "HealthController has @Public() so /health returns 200 without any auth token"
    - "apps/devcollab-web is a Next.js 15 app running on port 3002 showing a login placeholder"
    - "Both apps have turbo-prune multi-stage Dockerfiles"
    - "Both tsconfig.json files extend existing packages/config/tsconfig/ shared configs"
  artifacts:
    - path: "apps/devcollab-api/src/app.module.ts"
      provides: "NestJS AppModule with APP_GUARD registration"
      contains: "APP_GUARD"
    - path: "apps/devcollab-api/src/guards/casl-auth.guard.ts"
      provides: "Deny-by-default CaslAuthGuard"
      contains: "IS_PUBLIC_KEY"
    - path: "apps/devcollab-api/src/common/decorators/public.decorator.ts"
      provides: "@Public() decorator"
      contains: "IS_PUBLIC_KEY"
    - path: "apps/devcollab-api/src/health/health.controller.ts"
      provides: "GET /health returning { status: ok }"
      contains: "@Public()"
    - path: "apps/devcollab-api/Dockerfile"
      provides: "Multi-stage turbo prune Dockerfile"
      contains: "turbo prune devcollab-api"
    - path: "apps/devcollab-web/Dockerfile"
      provides: "Multi-stage turbo prune Dockerfile"
      contains: "turbo prune devcollab-web"
  key_links:
    - from: "apps/devcollab-api/src/app.module.ts"
      to: "apps/devcollab-api/src/guards/casl-auth.guard.ts"
      via: "APP_GUARD provider registration"
      pattern: "APP_GUARD.*CaslAuthGuard"
    - from: "apps/devcollab-api/src/health/health.controller.ts"
      to: "apps/devcollab-api/src/common/decorators/public.decorator.ts"
      via: "@Public() decorator on health check method"
      pattern: "@Public\\(\\)"
---

<objective>
Scaffold apps/devcollab-api (NestJS 11, port 3003) with deny-by-default CASL APP_GUARD and a public health endpoint, and apps/devcollab-web (Next.js 15, port 3002) with a login placeholder page. Both apps get turbo-prune multi-stage Dockerfiles.

Purpose: Establishes the two core DevCollab application workspaces in the monorepo. The CASL deny-by-default guard must be in place before ANY feature controllers are added (per user decision) — this is a security invariant for the entire v2.0 milestone.

Output: Two runnable apps ready for Docker Compose integration in Plan 03.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/api/src/app.module.ts
@apps/api/src/modules/auth/decorators/public.decorator.ts
@apps/api/Dockerfile
@apps/web/Dockerfile
@packages/config/tsconfig/nestjs.json
@packages/config/tsconfig/nextjs.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold apps/devcollab-api with NestJS 11, CASL guard, and health endpoint</name>
  <files>
    apps/devcollab-api/package.json
    apps/devcollab-api/tsconfig.json
    apps/devcollab-api/nest-cli.json
    apps/devcollab-api/src/main.ts
    apps/devcollab-api/src/app.module.ts
    apps/devcollab-api/src/common/decorators/public.decorator.ts
    apps/devcollab-api/src/guards/casl-auth.guard.ts
    apps/devcollab-api/src/health/health.module.ts
    apps/devcollab-api/src/health/health.controller.ts
    apps/devcollab-api/Dockerfile
  </files>
  <action>
Create apps/devcollab-api/ directory with all files. Do NOT run `turbo gen workspace` — create files directly since the root package.json already has `"workspaces": ["apps/*", "packages/*"]` which automatically picks up the new directory.

**apps/devcollab-api/package.json**
```json
{
  "name": "devcollab-api",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "build": "nest build",
    "dev": "nest start --watch",
    "start:prod": "node dist/main.js",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.0",
    "@nestjs/core": "^11.0.0",
    "@nestjs/platform-express": "^11.0.0",
    "@nestjs/config": "^4.0.0",
    "@casl/ability": "^6.8.0",
    "reflect-metadata": "^0.2.0",
    "rxjs": "^7.8.0"
  },
  "devDependencies": {
    "@nestjs/cli": "^11.0.0",
    "@types/express": "^5.0.0",
    "@types/node": "^20.0.0",
    "typescript": "~5.6.0"
  }
}
```

CRITICAL: package name must be `"devcollab-api"` (not `@devcollab/api`) because `turbo prune devcollab-api` in the Dockerfile must match this exact name.

**apps/devcollab-api/tsconfig.json**
```json
{
  "extends": "../../packages/config/tsconfig/nestjs.json",
  "compilerOptions": {
    "baseUrl": ".",
    "outDir": "dist",
    "paths": {
      "@/*": ["src/*"],
      "@devcollab/database": ["../../packages/devcollab-database/src"],
      "@devcollab/database/*": ["../../packages/devcollab-database/src/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "test"]
}
```

**apps/devcollab-api/nest-cli.json**
```json
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}
```

**apps/devcollab-api/src/main.ts**
```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  const port = process.env.PORT || 3003;
  await app.listen(port);
  console.log(`DevCollab API running on port ${port}`);
}

bootstrap();
```

**apps/devcollab-api/src/common/decorators/public.decorator.ts**
```typescript
import { SetMetadata } from '@nestjs/common';

export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);
```

**apps/devcollab-api/src/guards/casl-auth.guard.ts**
```typescript
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { IS_PUBLIC_KEY } from '../common/decorators/public.decorator';

@Injectable()
export class CaslAuthGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);
    if (isPublic) return true;
    // Deny-by-default: no @Public() means blocked (403)
    return false;
  }
}
```

**apps/devcollab-api/src/health/health.controller.ts**
```typescript
import { Controller, Get } from '@nestjs/common';
import { Public } from '../common/decorators/public.decorator';

@Controller('health')
export class HealthController {
  @Public()
  @Get()
  check(): { status: string } {
    return { status: 'ok' };
  }
}
```

CRITICAL: @Public() MUST be on this method. Without it the deny-by-default guard will return 403 and Docker healthchecks will fail, causing devcollab-api to show as unhealthy.

**apps/devcollab-api/src/health/health.module.ts**
```typescript
import { Module } from '@nestjs/common';
import { HealthController } from './health.controller';

@Module({
  controllers: [HealthController],
})
export class HealthModule {}
```

**apps/devcollab-api/src/app.module.ts**
```typescript
import { Module } from '@nestjs/common';
import { APP_GUARD } from '@nestjs/core';
import { CaslAuthGuard } from './guards/casl-auth.guard';
import { HealthModule } from './health/health.module';

@Module({
  imports: [HealthModule],
  providers: [
    {
      provide: APP_GUARD,
      useClass: CaslAuthGuard,
    },
  ],
})
export class AppModule {}
```

**apps/devcollab-api/Dockerfile**
```dockerfile
FROM node:20-alpine AS pruner
RUN apk add --no-cache libc6-compat
WORKDIR /app
RUN npm install -g turbo
COPY . .
RUN turbo prune devcollab-api --docker

FROM node:20-alpine AS installer
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY --from=pruner /app/out/json/ .
COPY --from=pruner /app/out/package-lock.json ./package-lock.json
RUN npm ci

FROM node:20-alpine AS builder
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY --from=pruner /app/out/full/ .
COPY --from=installer /app/node_modules ./node_modules
RUN npx prisma generate --schema=packages/devcollab-database/prisma/schema.prisma
RUN npx turbo build --filter=devcollab-api

FROM node:20-alpine AS runner
RUN apk add --no-cache libc6-compat curl
WORKDIR /app
ENV NODE_ENV=production
RUN addgroup --system --gid 1001 nestjs && \
    adduser --system --uid 1001 nestjs
COPY --from=builder --chown=nestjs:nestjs /app/apps/devcollab-api/dist ./dist
COPY --from=builder --chown=nestjs:nestjs /app/node_modules ./node_modules
COPY --from=builder --chown=nestjs:nestjs /app/packages ./packages
USER nestjs
EXPOSE 3003
ENV PORT=3003
CMD ["node", "dist/main.js"]
```

CRITICAL notes:
- `curl` must be installed in the runner stage — healthcheck uses `curl -f http://localhost:3003/health`
- `turbo prune devcollab-api` must match the package.json name field exactly
- `prisma generate` must run BEFORE `turbo build` or TypeScript compilation fails with missing .prisma/devcollab-client module

After creating all files, install dependencies:
```bash
cd /home/doctor/fernandomillan && npm install
```
  </action>
  <verify>
Check the package name matches what turbo prune expects:
```bash
grep '"name"' /home/doctor/fernandomillan/apps/devcollab-api/package.json
```
Must be `"devcollab-api"`.

Verify APP_GUARD is registered:
```bash
grep "APP_GUARD" /home/doctor/fernandomillan/apps/devcollab-api/src/app.module.ts
```

Verify @Public() is on health check:
```bash
grep "@Public" /home/doctor/fernandomillan/apps/devcollab-api/src/health/health.controller.ts
```

Try building locally (TypeScript check):
```bash
cd /home/doctor/fernandomillan/apps/devcollab-api && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>
apps/devcollab-api/ has all files. Package name is "devcollab-api". APP_GUARD is registered with CaslAuthGuard. HealthController has @Public() on the check() method. Dockerfile exists with turbo prune devcollab-api and curl in runner stage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scaffold apps/devcollab-web with Next.js 15, login placeholder, and Dockerfile</name>
  <files>
    apps/devcollab-web/package.json
    apps/devcollab-web/tsconfig.json
    apps/devcollab-web/next.config.ts
    apps/devcollab-web/app/page.tsx
    apps/devcollab-web/app/layout.tsx
    apps/devcollab-web/Dockerfile
  </files>
  <action>
Create apps/devcollab-web/ directory with all files. Use the same turbo-prune pattern as apps/web/Dockerfile but adapted for devcollab-web.

**apps/devcollab-web/package.json**
```json
{
  "name": "devcollab-web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3002",
    "build": "next build",
    "start": "next start -p 3002",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "^15.0.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0",
    "typescript": "~5.6.0"
  }
}
```

CRITICAL: package name must be `"devcollab-web"` (not `@devcollab/web`) so `turbo prune devcollab-web` matches.

**apps/devcollab-web/tsconfig.json**
```json
{
  "extends": "../../packages/config/tsconfig/nextjs.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./app/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

**apps/devcollab-web/next.config.ts**
```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  output: 'standalone',
};

export default nextConfig;
```

`output: 'standalone'` is required for the Dockerfile runner stage to work correctly (copies only the minimal standalone output).

**apps/devcollab-web/app/layout.tsx**
```tsx
export const metadata = {
  title: 'DevCollab',
  description: 'Developer collaboration platform',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  );
}
```

**apps/devcollab-web/app/page.tsx**
```tsx
export default function LoginPage() {
  return (
    <main style={{ padding: '2rem', fontFamily: 'system-ui, sans-serif' }}>
      <h1>DevCollab</h1>
      <p>Login placeholder — authentication coming in Phase 15.</p>
    </main>
  );
}
```

No Tailwind or external styling in this phase — plain inline styles are fine. Do NOT add auth forms — auth is deferred to Phase 15 (locked decision).

**apps/devcollab-web/Dockerfile**
```dockerfile
FROM node:20-alpine AS pruner
RUN apk add --no-cache libc6-compat
WORKDIR /app
RUN npm install -g turbo
COPY . .
RUN turbo prune devcollab-web --docker

FROM node:20-alpine AS installer
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY --from=pruner /app/out/json/ .
COPY --from=pruner /app/out/package-lock.json ./package-lock.json
RUN npm ci

FROM node:20-alpine AS builder
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY --from=pruner /app/out/full/ .
COPY --from=installer /app/node_modules ./node_modules
ENV NEXT_TELEMETRY_DISABLED=1
RUN npx turbo build --filter=devcollab-web

FROM node:20-alpine AS runner
RUN apk add --no-cache libc6-compat curl
WORKDIR /app
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3002
ENV HOSTNAME=0.0.0.0
RUN addgroup --system --gid 1001 nextjs && \
    adduser --system --uid 1001 nextjs
COPY --from=builder --chown=nextjs:nextjs /app/apps/devcollab-web/.next/standalone ./
COPY --from=builder --chown=nextjs:nextjs /app/apps/devcollab-web/.next/static ./apps/devcollab-web/.next/static
COPY --from=builder --chown=nextjs:nextjs /app/apps/devcollab-web/public ./apps/devcollab-web/public 2>/dev/null || true
USER nextjs
EXPOSE 3002
CMD ["node", "apps/devcollab-web/server.js"]
```

CRITICAL notes:
- `curl` must be in runner stage — Docker healthcheck uses curl
- `output: 'standalone'` in next.config.ts generates the standalone server.js
- `HOSTNAME=0.0.0.0` ensures Next.js listens on all interfaces inside Docker
- The `2>/dev/null || true` on public dir copy handles the case where public/ doesn't exist yet

After creating all files, run `npm install` from the monorepo root:
```bash
cd /home/doctor/fernandomillan && npm install
```
  </action>
  <verify>
Check package name:
```bash
grep '"name"' /home/doctor/fernandomillan/apps/devcollab-web/package.json
```
Must be `"devcollab-web"`.

Check standalone output is configured:
```bash
grep "standalone" /home/doctor/fernandomillan/apps/devcollab-web/next.config.ts
```

Check the login placeholder exists:
```bash
cat /home/doctor/fernandomillan/apps/devcollab-web/app/page.tsx
```

Check no auth implementation leaked in (deferred):
```bash
grep -r "login\|signin\|password\|jwt" /home/doctor/fernandomillan/apps/devcollab-web/app/ --include="*.tsx" 2>/dev/null | grep -v "placeholder" | head -5
```
Should return no matches (placeholder text is fine, actual auth code is not).
  </verify>
  <done>
apps/devcollab-web/ has all files. Package name is "devcollab-web". next.config.ts has output: 'standalone'. app/page.tsx shows a login placeholder. Dockerfile exists with turbo prune devcollab-web and curl in runner stage. No auth implementation in this phase.
  </done>
</task>

</tasks>

<verification>
1. `grep '"name"' apps/devcollab-api/package.json` → `"devcollab-api"` (turbo prune match)
2. `grep '"name"' apps/devcollab-web/package.json` → `"devcollab-web"` (turbo prune match)
3. `grep APP_GUARD apps/devcollab-api/src/app.module.ts` → present
4. `grep @Public apps/devcollab-api/src/health/health.controller.ts` → present
5. `grep standalone apps/devcollab-web/next.config.ts` → present
6. `grep "turbo prune devcollab-api" apps/devcollab-api/Dockerfile` → present
7. `grep "turbo prune devcollab-web" apps/devcollab-web/Dockerfile` → present
</verification>

<success_criteria>
1. apps/devcollab-api package name is "devcollab-api" — Dockerfile turbo prune filter will match
2. CaslAuthGuard registered as APP_GUARD in AppModule — deny-by-default is active
3. HealthController.check() decorated with @Public() — /health returns 200 without auth
4. apps/devcollab-web package name is "devcollab-web" — Dockerfile turbo prune filter will match
5. devcollab-web shows login placeholder at app/page.tsx (no actual auth code)
6. Both Dockerfiles have curl in runner stage for healthcheck support
</success_criteria>

<output>
After completion, create `.planning/phases/14-monorepo-scaffold-infrastructure/14-02-SUMMARY.md`
</output>
