---
phase: 24-scroll-animations-entrance
plan: "03"
type: execute
wave: 3
depends_on:
  - "24-02"
files_modified:
  - apps/web/e2e/portfolio/visual-regression.spec.ts
  - apps/web/e2e/portfolio/visual-regression.spec.ts-snapshots/
autonomous: false
requirements:
  - ANIM-01

must_haves:
  truths:
    - "Visual regression snapshots regenerated with reducedMotion emulation — animations disabled during snapshot capture so baselines are stable and deterministic"
    - "Production build completes without TypeScript or bundler errors"
    - "With OS Reduce Motion ON, all scroll animations are completely absent — elements display at final state immediately"
    - "Scrolling through the full page with normal motion shows fade+slide-up on headings and visible stagger on project cards"
    - "Navigating between portfolio pages 3+ times does not cause double-fire or missed animations per page visit"
  artifacts:
    - path: "apps/web/e2e/portfolio/visual-regression.spec.ts"
      provides: "Updated snapshot tests with reducedMotion emulation for stable baselines"
      contains: "reducedMotion"
    - path: "apps/web/e2e/portfolio/visual-regression.spec.ts-snapshots/"
      provides: "Regenerated snapshot baselines after animation components added"
  key_links:
    - from: "apps/web/e2e/portfolio/visual-regression.spec.ts"
      to: "apps/web/e2e/portfolio/visual-regression.spec.ts-snapshots/"
      via: "toHaveScreenshot baseline comparison"
      pattern: "toHaveScreenshot"
---

<objective>
Verify the complete animation implementation is correct and stable: regenerate Playwright visual regression baselines with reduced-motion emulation (so snapshot tests don't fail due to mid-animation captures), run a production build check, and get human confirmation of the visual animation behavior.

Purpose: Phase 24 success criteria require verification that animations actually work visually, that reduced motion completely disables them, and that navigation replay is correct. The snapshot update prevents CI regressions from the layout changes animations introduce.

Output: Updated visual regression test with emulateMedia, regenerated snapshot baselines, production build confirmation, human-verified animation behavior.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-scroll-animations-entrance/24-02-SUMMARY.md
@apps/web/e2e/portfolio/visual-regression.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update visual regression tests and regenerate baselines</name>
  <files>
    apps/web/e2e/portfolio/visual-regression.spec.ts
    apps/web/e2e/portfolio/visual-regression.spec.ts-snapshots/
  </files>
  <action>
**Step A — Update the visual regression test to emulate reduced motion:**

The current test uses `await page.waitForLoadState('networkidle')` then immediately screenshots. With scroll animations added, elements start at `opacity: 0` and the page may show animated-in-progress state. The correct fix is to emulate `prefers-reduced-motion: reduce` during snapshot tests so all animations are skipped and elements show in their final state.

Modify `apps/web/e2e/portfolio/visual-regression.spec.ts`. In BOTH the Light Mode and Dark Mode describe blocks, add `page.emulateMedia({ reducedMotion: 'reduce' })` BEFORE navigation:

```typescript
test(name, async ({ page }) => {
  await page.emulateMedia({ reducedMotion: 'reduce' })  // ADD THIS LINE
  await page.goto(path)
  await page.waitForLoadState('networkidle')
  await expect(page).toHaveScreenshot(`${name}-light.png`, {
    fullPage: true,
    maxDiffPixelRatio: 0.02,
  })
})
```

For dark mode tests:
```typescript
test(name, async ({ page }) => {
  await page.emulateMedia({ reducedMotion: 'reduce' })  // ADD THIS LINE
  await page.addInitScript(() => {
    localStorage.setItem('theme', 'dark')
  })
  await page.goto(path)
  await page.waitForLoadState('networkidle')
  await page.waitForTimeout(200)
  await expect(page).toHaveScreenshot(`${name}-dark.png`, {
    fullPage: true,
    maxDiffPixelRatio: 0.02,
  })
})
```

This ensures:
1. `MotionConfig reducedMotion="user"` detects `prefers-reduced-motion: reduce` and disables animations.
2. `AnimateIn` and `StaggerContainer` render as plain elements immediately (per `useReducedMotion()` early-return).
3. Snapshots capture final state — deterministic, no timing dependency.

**Step B — Run production build to verify no bundler errors:**

```bash
cd /home/doctor/fernandomillan && npm run build --workspace=apps/web 2>&1 | tail -20
```

Confirm build exits with code 0 (Next.js "Compiled successfully" or "Build completed").

**Step C — Regenerate snapshot baselines:**

Delete old snapshots and regenerate:
```bash
cd /home/doctor/fernandomillan && npx playwright test --config=apps/web/playwright.config.ts e2e/portfolio/visual-regression.spec.ts --update-snapshots 2>&1 | tail -30
```

If Playwright is not available directly, run via the web app workspace:
```bash
cd /home/doctor/fernandomillan/apps/web && npx playwright test e2e/portfolio/visual-regression.spec.ts --update-snapshots 2>&1 | tail -30
```

After regeneration, run once more WITHOUT `--update-snapshots` to confirm tests pass:
```bash
cd /home/doctor/fernandomillan/apps/web && npx playwright test e2e/portfolio/visual-regression.spec.ts 2>&1 | tail -20
```

Note: If the dev server is not running, start it first:
```bash
cd /home/doctor/fernandomillan && npm run dev --workspace=apps/web &
sleep 5
```

Check `apps/web/playwright.config.ts` for the `webServer` config — it may handle this automatically.
  </action>
  <verify>
1. `grep "reducedMotion" /home/doctor/fernandomillan/apps/web/e2e/portfolio/visual-regression.spec.ts` — returns matches in both Light and Dark mode test blocks.
2. Production build: `cd /home/doctor/fernandomillan && npm run build --workspace=apps/web 2>&1 | grep -E "error|Error|compiled|success" | head -10` — shows success, no errors.
3. Snapshot tests pass: `cd /home/doctor/fernandomillan/apps/web && npx playwright test e2e/portfolio/visual-regression.spec.ts 2>&1 | grep -E "passed|failed"` — all tests show "passed".
  </verify>
  <done>
Visual regression test has `page.emulateMedia({ reducedMotion: 'reduce' })` before navigation in both describe blocks. Production build completes with zero errors. All Playwright visual regression tests pass with regenerated baselines.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verify all five Phase 24 success criteria</name>
  <action>
Pause for human visual verification of the complete scroll animation implementation. Claude has completed all automation. Human must verify the following using a browser:

Run `cd /home/doctor/fernandomillan && npm run dev --workspace=apps/web` if not already running (port 3000).

**Test 1 — Heading animation (SC1):**
1. Open http://localhost:3000 in Chrome
2. Open DevTools Console — confirm zero hydration warnings on initial load
3. Scroll down past the hero section to "Featured Projects" heading — it should fade in and slide up from below
4. Continue scrolling to the Stats section — it should also animate in
5. Visit /projects, /projects/teamflow, /projects/devcollab, /contact and confirm headings animate in on scroll

**Test 2 — Stagger (SC2):**
1. Go to http://localhost:3000/projects
2. The "Projects" heading should fade+slide-up into view
3. The two ProjectCards should stagger in sequentially — TeamFlow card appears first, DevCollab card appears ~150ms later
4. The stagger delay should be visibly obvious (not simultaneous)

**Test 3 — Reduced Motion (SC3):**
1. Enable OS Reduce Motion (Windows: Settings > Ease of Access > Display > Show animations OFF; or use DevTools Rendering tab: "Emulate CSS prefers-reduced-motion: reduce")
2. Refresh http://localhost:3000
3. Scroll the full page — ALL headings and cards should appear immediately with NO transition, NO fade, NO slide
4. Disable Reduce Motion after testing

**Test 4 — Hydration (SC4):**
1. With production build running (`npm run build --workspace=apps/web && npm run start --workspace=apps/web`)
2. Open http://localhost:3000 in Chrome DevTools Console
3. Confirm zero "Warning: Extra attributes from the server" or "Hydration failed" messages

**Test 5 — Navigation replay (SC5):**
1. With dev server running and Reduce Motion OFF
2. Visit http://localhost:3000, scroll through, cards animate in (1x)
3. Click TeamFlow, case study sections animate in (1x)
4. Click back, return to homepage, scroll down — heading animates in again (once, correctly)
5. Confirm no double-fire on any single page visit
  </action>
  <verify>
Human reports "approved" after testing all five criteria above.
  </verify>
  <done>
Human confirms: heading fade+slide-up on all 5 routes (SC1), visible card stagger (SC2), instant display with Reduce Motion ON (SC3), zero hydration warnings in production (SC4), animations fire exactly once per page visit across 3+ navigations (SC5).
  </done>
</task>

</tasks>

<verification>
After Plan 03 is complete:

1. `grep "reducedMotion" apps/web/e2e/portfolio/visual-regression.spec.ts` — present in both test blocks
2. Production build exits 0: `npm run build --workspace=apps/web`
3. Playwright snapshot tests pass: all visual-regression tests show "passed"
4. Human confirmed all 5 success criteria via checkpoint
</verification>

<success_criteria>
- Visual regression Playwright tests pass with `page.emulateMedia({ reducedMotion: 'reduce' })` added
- Snapshot baselines regenerated and current
- Production build has zero errors
- Human verifier confirms: headings animate on scroll (SC1), cards stagger visibly (SC2), reduced motion disables all animation (SC3), zero hydration warnings (SC4), navigation replay is correct once-per-visit (SC5)
- ANIM-01 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/24-scroll-animations-entrance/24-03-SUMMARY.md`
</output>
