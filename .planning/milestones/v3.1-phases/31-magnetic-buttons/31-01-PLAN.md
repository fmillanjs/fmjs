---
phase: 31-magnetic-buttons
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/portfolio/magnetic-button.tsx
autonomous: true
requirements:
  - MAGN-01
  - MAGN-02
  - MAGN-03

must_haves:
  truths:
    - "MagneticButton component exists as a 'use client' wrapper accepting children and optional className"
    - "User with prefers-reduced-motion active sees a plain <div> wrapper — no motion values allocated, no spring physics"
    - "User on a touch-only device (any-hover: hover evaluates false) gets no magnetic offset on tap"
    - "Spring physics uses stiffness:150, damping:30, mass:0.2 — perceptible attraction without oscillation"
    - "getBoundingClientRect() is cached on mouseenter, not called per-pixel in mousemove — prevents TBT spike"
  artifacts:
    - path: "apps/web/components/portfolio/magnetic-button.tsx"
      provides: "MagneticButton 'use client' component"
      min_lines: 55
      exports: ["MagneticButton"]
  key_links:
    - from: "apps/web/components/portfolio/magnetic-button.tsx"
      to: "motion/react"
      via: "import { motion, useMotionValue, useSpring, useReducedMotion }"
      pattern: "from 'motion/react'"
    - from: "MagneticButton render"
      to: "motion.div style"
      via: "style={{ x: springX, y: springY }}"
      pattern: "springX.*springY"
---

<objective>
Create the MagneticButton 'use client' component implementing spring-physics cursor attraction using motion/react hooks, with correct reduced-motion early-return and touch device guard.

Purpose: This component is the foundation for MAGN-01, MAGN-02, MAGN-03. All three CTA wraps in Plan 31-02 depend on this file existing and being correct before they can be wired.
Output: apps/web/components/portfolio/magnetic-button.tsx — exported MagneticButton function component.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-magnetic-buttons/31-RESEARCH.md
@apps/web/components/portfolio/dot-grid-spotlight.tsx
@apps/web/components/portfolio/evervault-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MagneticButton component</name>
  <files>apps/web/components/portfolio/magnetic-button.tsx</files>
  <action>
Create `apps/web/components/portfolio/magnetic-button.tsx` as a `'use client'` component.

**Hook ordering (rules of hooks — call ALL before any conditional return):**
```
useRef<HTMLDivElement>(null)          // wrapper ref for rect caching
useRef<DOMRect | null>(null)          // cached rect — updated on mouseenter only
useRef<boolean>(false)               // canHoverRef — set in useEffect
useMotionValue(0)                    // raw target x
useMotionValue(0)                    // raw target y
useSpring(x, SPRING_CONFIG)          // smoothed x
useSpring(y, SPRING_CONFIG)          // smoothed y
useReducedMotion()                   // boolean | null; null = SSR safe = no-motion default
useEffect(...)                       // sets canHoverRef from window.matchMedia
```

**SPRING_CONFIG constant (outside component):**
```typescript
const SPRING_CONFIG = { stiffness: 150, damping: 30, mass: 0.2 }
const MAGNETIC_STRENGTH = 0.3
```

**After all hooks, conditional early return:**
```typescript
if (prefersReducedMotion) {
  return <div className={className}>{children}</div>
}
```
Note: `null` (SSR) is falsy → falls through to motion render. `true` (reduced-motion) → plain div. `false` (normal) → motion render.

**useEffect for touch guard:**
```typescript
useEffect(() => {
  canHoverRef.current = window.matchMedia('(any-hover: hover)').matches
}, [])
```
No dependency array entries — runs once on mount. `window.matchMedia` is client-only; inside useEffect is the correct location (same as dot-grid-spotlight.tsx project pattern).

**handleMouseEnter:** Cache `ref.current.getBoundingClientRect()` into `rectRef.current`. Do NOT call getBoundingClientRect in handleMouseMove — prevents forced reflow on every pixel of cursor movement (Pitfall 5 from RESEARCH.md).

**handleMouseMove:**
```typescript
const handleMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
  if (!canHoverRef.current || !rectRef.current) return
  const centerX = rectRef.current.left + rectRef.current.width / 2
  const centerY = rectRef.current.top + rectRef.current.height / 2
  x.set((e.clientX - centerX) * MAGNETIC_STRENGTH)
  y.set((e.clientY - centerY) * MAGNETIC_STRENGTH)
}
```

**handleMouseLeave:** `x.set(0)` and `y.set(0)` — spring physics handles the snap-back with correct velocity and deceleration.

**Render (motion.div wrapper — NOT motion.button):**
```typescript
return (
  <motion.div
    ref={ref}
    className={className}
    style={{ x: springX, y: springY }}
    onMouseEnter={handleMouseEnter}
    onMouseMove={handleMouseMove}
    onMouseLeave={handleMouseLeave}
  >
    {children}
  </motion.div>
)
```

**Interface:**
```typescript
interface MagneticButtonProps {
  children: React.ReactNode
  className?: string
}
```

**Imports:**
```typescript
'use client'
import { useRef, useEffect } from 'react'
import { motion, useMotionValue, useSpring, useReducedMotion } from 'motion/react'
```

Do NOT import from 'framer-motion' — project convention is `from 'motion/react'` (STATE.md v2.5 decision). Do NOT apply transform to `<button>` element — focus ring alignment breaks (RESEARCH.md Pitfall 3). The `motion.div` wrapper moves; the button inside stays at its layout position.
  </action>
  <verify>
Run from `/home/doctor/fernandomillan`:
```bash
cd apps/web && npx tsc --noEmit 2>&1 | grep -i "magnetic-button" || echo "no magnetic-button errors"
```
TypeScript must report zero errors referencing magnetic-button.tsx.
  </verify>
  <done>
`apps/web/components/portfolio/magnetic-button.tsx` exists, exports `MagneticButton`, TypeScript compiles with zero errors for that file. All hooks called before the conditional reduced-motion early return. `getBoundingClientRect()` called only in `handleMouseEnter`, not in `handleMouseMove`.
  </done>
</task>

</tasks>

<verification>
- `apps/web/components/portfolio/magnetic-button.tsx` exists and exports `MagneticButton`
- `npx tsc --noEmit` reports zero errors referencing the file
- File imports from `motion/react` (not `framer-motion`)
- `useReducedMotion`, `useMotionValue`, `useSpring`, `useRef`, `useEffect` all called before any conditional return
- `canHoverRef` populated inside `useEffect` (not at render time)
- `rectRef` updated on `mouseenter` only, not on `mousemove`
</verification>

<success_criteria>
MagneticButton component exists, compiles clean, and follows all established patterns. Ready for Plan 31-02 to import and apply to CTAs.
</success_criteria>

<output>
After completion, create `.planning/phases/31-magnetic-buttons/31-01-SUMMARY.md`
</output>
