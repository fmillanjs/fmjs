---
phase: 29-lenis-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "29-01"
files_modified:
  - apps/web/components/ui/command-palette.tsx
autonomous: false
requirements:
  - SCROLL-02
  - SCROLL-04

must_haves:
  truths:
    - "User navigating between portfolio pages always arrives at the top of the destination page, even when navigating while still scrolling"
    - "User opening CommandPalette (Cmd+K) cannot scroll the background page while the modal is open"
    - "User closing CommandPalette (keyboard Escape, backdrop click, or item select) resumes background scroll immediately"
    - "CommandPalette on dashboard routes has no errors when opened (lenis is undefined there — optional chaining handles it)"
  artifacts:
    - path: "apps/web/components/ui/command-palette.tsx"
      provides: "CommandPalette with useLenis() stop/start on open state changes"
      contains: "useLenis"
      min_lines: 5
  key_links:
    - from: "apps/web/components/ui/command-palette.tsx"
      to: "lenis/react"
      via: "useLenis() hook"
      pattern: "useLenis"
    - from: "apps/web/components/ui/command-palette.tsx"
      to: "lenis instance"
      via: "lenis?.stop() on open, lenis?.start() on close"
      pattern: "lenis\\?\\.(stop|start)"
---

<objective>
Wire the CommandPalette to the Lenis instance for scroll lock on open, and confirm route-change scroll reset works through the LenisScrollReset component already placed inside LenisProvider in 29-01.

Purpose: SCROLL-02 is already handled by the `LenisScrollReset` inner component created in 29-01. This plan's primary task is SCROLL-04 — adding `useLenis()` to CommandPalette so background scroll is locked while the modal is open. The human checkpoint verifies all four SCROLL requirements work in the browser.
Output: CommandPalette modified with Lenis stop/start integration. Human confirms all behaviors.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-lenis-foundation/29-RESEARCH.md
@.planning/phases/29-lenis-foundation/29-01-SUMMARY.md
@apps/web/components/ui/command-palette.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Lenis stop/start to CommandPalette</name>
  <files>apps/web/components/ui/command-palette.tsx</files>
  <action>
Modify `apps/web/components/ui/command-palette.tsx` to lock scroll when the palette is open and unlock it when closed.

**Changes required (minimal diff):**

1. Add import at the top of the file (alongside existing imports):
   ```typescript
   import { useLenis } from 'lenis/react'
   ```

2. Inside the `CommandPalette` function body, after the existing `const [open, setOpen] = useState(false)` and other state/hook declarations, add:
   ```typescript
   const lenis = useLenis()

   // SCROLL-04: lock background scroll when palette is open
   useEffect(() => {
     if (open) {
       lenis?.stop()
     } else {
       lenis?.start()
     }
   }, [open, lenis])
   ```

3. The `useEffect` import is already in the file. Do NOT add a duplicate import.

**Critical rules:**
- Use `lenis?.stop()` and `lenis?.start()` with optional chaining — `useLenis()` returns `undefined` when no ReactLenis ancestor exists (dashboard routes). Optional chaining prevents the runtime error "Cannot read properties of undefined (reading 'stop')" on dashboard.
- Do NOT use `overflow: hidden` on `document.body` — body overflow breaks Lenis scroll position tracking. Lenis's own stop/start is the correct API.
- Do NOT add `lenis?.destroy()` — destroy permanently removes the instance; stop/start is the correct toggle pattern.
- All other CommandPalette behavior (keyboard shortcut, routing, theme toggle, backdrop click) must remain exactly as-is. This is a minimal addition of 6 lines.

**Verify the close paths are all covered:** The `open` state is the single source of truth. When `open` becomes `false` via any path (backdrop click `onClick={() => setOpen(false)}`, item select via `handleSelect`, keyboard `Escape` via cmdk's built-in close), the `useEffect` on `[open, lenis]` fires and calls `lenis?.start()`. No additional cleanup needed.
  </action>
  <verify>
1. Check useLenis import exists: `grep "useLenis" /home/doctor/fernandomillan/apps/web/components/ui/command-palette.tsx`
2. Check stop/start calls exist: `grep -n "lenis\?" /home/doctor/fernandomillan/apps/web/components/ui/command-palette.tsx`
3. TypeScript check: `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | grep command-palette` — no errors.
4. Build check: `cd /home/doctor/fernandomillan && pnpm --filter web build 2>&1 | tail -10` — completes without error.
  </verify>
  <done>
CommandPalette imports `useLenis`, declares `const lenis = useLenis()`, has a `useEffect` on `[open, lenis]` calling `lenis?.stop()` when `open` is true and `lenis?.start()` when false. TypeScript passes. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verify all four SCROLL requirements in browser</name>
  <action>
Start dev server: `cd /home/doctor/fernandomillan && pnpm --filter web dev`
Visit: http://localhost:3000

Verify each behavior manually:

1. **SCROLL-01 — Smooth scroll:**
   - Scroll any portfolio page (/, /projects, /contact). Expected: smooth inertia feel — scroll decelerates gradually instead of stopping instantly. Should feel like scrolling on a premium site.

2. **SCROLL-02 — Route reset:**
   - Scroll down on / (home page) until you are mid-page. Click a nav link to /projects. Expected: /projects loads and you are at the very top (scroll position = 0), not mid-page.
   - Repeat: scroll down on /projects, navigate to /contact. Expected: arrives at top.

3. **SCROLL-03 — Reduced-motion bypass:**
   - Enable "Reduce motion" in OS settings (macOS: System Settings > Accessibility > Display > Reduce Motion; Windows: Settings > Ease of Access > Display > Show animations — toggle off).
   - Reload a portfolio page. Expected: native browser scroll (instant stop, no inertia).
   - (Re-enable reduce motion after testing.)

4. **SCROLL-04 — CommandPalette scroll lock:**
   - Scroll a portfolio page to the middle. Press Cmd+K (or Ctrl+K). Expected: CommandPalette opens, background page does NOT scroll.
   - Press Escape to close. Expected: page scroll resumes immediately.

5. **Dashboard isolation:**
   - Navigate to /dashboard (TeamFlow). Expected: scroll behavior is native — no Lenis inertia. No console errors when opening CommandPalette on dashboard.
  </action>
  <verify>
All five behaviors verified manually in browser with no issues.
  </verify>
  <done>
User types "approved" confirming all 5 SCROLL behaviors are working correctly in the browser.
  </done>
</task>

</tasks>

<verification>
1. `grep "useLenis" apps/web/components/ui/command-palette.tsx` returns the import and usage
2. `grep "lenis\?" apps/web/components/ui/command-palette.tsx` returns `lenis?.stop()` and `lenis?.start()`
3. `pnpm --filter web build` passes clean
4. Human checkpoint confirms all 5 scroll behaviors work in browser
</verification>

<success_criteria>
- CommandPalette locks scroll on open via lenis?.stop() and resumes on close via lenis?.start()
- Route-change scroll reset works (LenisScrollReset from 29-01 fires correctly)
- All four SCROLL requirements verified working in browser by user
- No console errors on dashboard (optional chaining no-ops correctly)
</success_criteria>

<output>
After completion, create `.planning/phases/29-lenis-foundation/29-02-SUMMARY.md`
</output>
