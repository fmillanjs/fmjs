---
phase: 29-lenis-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - "29-01"
  - "29-02"
files_modified: []
autonomous: true
requirements:
  - SCROLL-01
  - SCROLL-02
  - SCROLL-03
  - SCROLL-04

must_haves:
  truths:
    - "Lighthouse CI performance score is >= 0.90 on all five portfolio URLs with Lenis active"
    - "No Lighthouse regression introduced by Lenis CSS (html height: auto does not affect CLS)"
    - "All five portfolio URLs pass the CI gate: /, /projects, /projects/teamflow, /projects/devcollab, /contact"
  artifacts:
    - path: ".lighthouseci/lhr-*.json"
      provides: "Lighthouse CI results for all 5 URLs"
      contains: "performance"
  key_links:
    - from: "Lighthouse CI"
      to: "LenisProvider"
      via: "performance score with Lenis active"
      pattern: "performance.*score"
---

<objective>
Run Lighthouse CI against all five portfolio URLs with Lenis now active to confirm no performance regression was introduced. This is the mandatory CI hard gate defined in the v3.1 milestone for every phase.

Purpose: Prove that Lenis's RAF loop, CSS (`html { height: auto }`), and LenisProvider hydration do not degrade Lighthouse performance score below the 0.90 gate on any portfolio URL.
Output: Lighthouse CI run artifacts confirming >= 0.90 on all 5 URLs.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-lenis-foundation/29-01-SUMMARY.md
@.planning/phases/29-lenis-foundation/29-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Lighthouse CI gate on all 5 portfolio URLs</name>
  <files></files>
  <action>
Run Lighthouse CI against the production deployment (or a production build) to verify the >= 0.90 performance gate passes for all five portfolio URLs.

**Step 1 — Check if a Docker container is running for the web app:**
```bash
docker ps --format "table {{.Names}}\t{{.Ports}}" 2>/dev/null
```
If a container is running and serving the web app, use its exposed port for Lighthouse CI. If not, proceed to build locally.

**Step 2 — Build and serve production locally (if no Docker container):**
```bash
cd /home/doctor/fernandomillan
pnpm --filter web build
pnpm --filter web start &
```
Wait 5 seconds for server to start. The server should be at http://localhost:3000.

**Step 3 — Run Lighthouse CI:**
```bash
cd /home/doctor/fernandomillan/apps/web
npx lhci autorun 2>&1
```

If `lhci` is not available globally, try:
```bash
cd /home/doctor/fernandomillan/apps/web
pnpm exec lhci autorun 2>&1
```

**Step 4 — Check results:**
After the run completes, check the output for the five URLs:
- `http://localhost:3000/` (or production URL)
- `http://localhost:3000/projects`
- `http://localhost:3000/projects/teamflow`
- `http://localhost:3000/projects/devcollab`
- `http://localhost:3000/contact`

Each must show `performance: >= 0.90` (i.e., score 90 or above).

**Step 5 — If any URL scores < 0.90:**
Investigate the specific Lighthouse report. Common Lenis-related causes:
- Render-blocking resources from Lenis CSS: ensure `@import "lenis/dist/lenis.css"` is in globals.css (not a separate stylesheet link that blocks render)
- TBT increase from LenisProvider hydration: unlikely at 0.1 lerp with autoRaf, but check if `LenisProvider` triggers a large hydration JS cost
- Check the `.lighthouseci/` directory for JSON reports: `ls apps/web/.lighthouseci/*.json`

**If score is 0.88-0.89 (borderline):** Document the exact score in the summary. This may be measurement noise — re-run once to confirm.

**If score is consistently < 0.88:** Escalate — this is a real regression. Do not mark phase complete.

**Stop the local server after Lighthouse run:**
```bash
pkill -f "next start" 2>/dev/null || true
```
  </action>
  <verify>
Parse Lighthouse CI output for all 5 URLs:

```bash
# Check JSON reports for performance scores
for f in /home/doctor/fernandomillan/apps/web/.lighthouseci/lhr-*.json; do
  echo "=== $f ==="
  node -e "const r = require('$f'); console.log(r.finalUrl, 'performance:', r.categories.performance.score)"
done
```

Expected output: each URL shows `performance: 0.9` or higher (Lighthouse reports as 0-1 scale, so 0.90 = 90%).
  </verify>
  <done>
All five portfolio URLs score >= 0.90 on Lighthouse CI performance. Results documented in summary. No performance regression from Lenis installation.
  </done>
</task>

</tasks>

<verification>
Lighthouse CI output shows:
- `/` performance >= 0.90
- `/projects` performance >= 0.90
- `/projects/teamflow` performance >= 0.90
- `/projects/devcollab` performance >= 0.90
- `/contact` performance >= 0.90
</verification>

<success_criteria>
All five portfolio URLs pass the Lighthouse CI performance gate at >= 0.90. Phase 29 (Lenis Foundation) is complete: SCROLL-01, SCROLL-02, SCROLL-03, and SCROLL-04 are all implemented and verified through both human checkpoint (Plan 29-02) and automated CI gate (this plan).
</success_criteria>

<output>
After completion, create `.planning/phases/29-lenis-foundation/29-03-SUMMARY.md`
</output>
