---
phase: 35-full-qa-audit-and-fixes
plan: 02
type: execute
wave: 2
depends_on:
  - 35-01
files_modified:
  - apps/devcollab-web/**
  - apps/devcollab-api/**
autonomous: false
requirements:
  - QA-01

must_haves:
  truths:
    - "Recruiter can open devcollab.fernandomillan.me and see a login page with demo credentials displayed"
    - "Login with admin@demo.devcollab / Demo1234! succeeds and redirects to /w/devcollab-demo"
    - "Workspace page at /w/devcollab-demo shows seeded snippets, posts, and members — not empty state"
    - "Clicking a snippet shows the detail page with Tiptap-rendered content"
    - "Clicking a post shows the detail page with Markdown rendered"
    - "Cmd+K search opens and returns results for terms matching seeded content"
    - "Bell icon notifications panel loads without errors"
    - "Logout completes and returns to login page"
  artifacts:
    - path: "apps/devcollab-web/app/w/[slug]/page.tsx"
      provides: "Workspace server component — must return seeded data, not empty state"
    - path: "apps/devcollab-web/app/(auth)/login/page.tsx"
      provides: "Login page — must show demo credentials"
  key_links:
    - from: "apps/devcollab-web/app/w/[slug]/page.tsx"
      to: "NestJS API /workspaces/:slug"
      via: "SSR fetch with devcollab_token cookie forwarded"
      pattern: "devcollab_token"
    - from: "apps/devcollab-web/components/search/SearchModal.tsx"
      to: "NestJS API /search"
      via: "credentials: 'include' fetch"
      pattern: "credentials.*include"
---

<objective>
Walk the complete DevCollab recruiter flow on the live production app, document every bug or broken state, fix all issues in code, redeploy via CI/CD, and verify the full flow works end-to-end.

Purpose: QA-01 requires the login → workspace → view content → search → notifications flow completes without errors. Phase 34 confirmed auth works; this plan confirms everything after auth works too.
Output: Bug-free DevCollab recruiter flow confirmed by human walkthrough. Any fixes committed and redeployed.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-full-qa-audit-and-fixes/35-RESEARCH.md
@.planning/phases/35-full-qa-audit-and-fixes/35-01-SUMMARY.md

<interfaces>
<!-- Key patterns from Phase 34 and codebase review. -->

DevCollab Auth Pattern (from research + Phase 34):
- Login endpoint: POST https://devcollab.fernandomillan.me/api/auth/login
- Sets httpOnly cookie: devcollab_token, domain=.fernandomillan.me
- After login: redirects to /w/devcollab-demo

Demo credentials:
- admin@demo.devcollab / Demo1234!
- contributor@demo.devcollab / Demo1234!
- viewer@demo.devcollab / Demo1234!

SSR Cookie Forwarding (from apps/devcollab-web/app/w/[slug]/page.tsx):
```typescript
import { cookies } from 'next/headers';
const cookieStore = await cookies();
const token = cookieStore.get('devcollab_token')?.value;
const res = await fetch(`${API_URL}/workspaces/${slug}`, {
  headers: token ? { Cookie: `devcollab_token=${token}` } : {},
  cache: 'no-store',
});
```
If /w/devcollab-demo shows empty or "not found": check browser devtools → Application → Cookies for devcollab_token present at devcollab.fernandomillan.me.

Known pitfalls (from research):
- Empty workspace: seed service may have failed — if so, the fix is re-running seed on VPS (not a code change)
- Search empty results: tsvector trigger may not have indexed seeded data
- Cookie not forwarded: domain mismatch — Phase 34 already fixed COOKIE_DOMAIN=.fernandomillan.me

Fix-then-redeploy pattern:
```bash
git add apps/devcollab-web/... apps/devcollab-api/...
git commit -m "fix(devcollab): <description of fix>"
git push origin main
# CI rebuilds devcollab-web and devcollab-api images → Coolify redeploys
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated pre-walkthrough API health check</name>
  <files></files>
  <action>
    Before the human walkthrough, run automated checks to surface any obvious infrastructure issues:

    1. Confirm the DevCollab API is responding:
    ```bash
    curl -s -o /dev/null -w "%{http_code}" https://devcollab.fernandomillan.me/api/health 2>/dev/null || curl -s -o /dev/null -w "%{http_code}" https://devcollab.fernandomillan.me/api/auth/me 2>/dev/null
    ```

    2. Confirm login endpoint accepts credentials and returns a cookie:
    ```bash
    curl -s -c /tmp/devcollab-cookies.txt -X POST https://devcollab.fernandomillan.me/api/auth/login \
      -H "Content-Type: application/json" \
      -d '{"email":"admin@demo.devcollab","password":"Demo1234!"}' \
      -w "\nHTTP Status: %{http_code}" 2>&1 | tail -5
    ```
    Expected: HTTP Status 200 or 201. Cookie file /tmp/devcollab-cookies.txt should contain devcollab_token.

    3. Using that cookie, fetch the workspace to confirm seeded content exists:
    ```bash
    COOKIE=$(grep devcollab_token /tmp/devcollab-cookies.txt | awk '{print $NF}')
    curl -s -H "Cookie: devcollab_token=$COOKIE" \
      "https://devcollab.fernandomillan.me/api/workspaces/devcollab-demo" \
      -w "\nHTTP Status: %{http_code}" 2>&1 | python3 -m json.tool 2>/dev/null | head -30
    ```

    4. Test the search endpoint:
    ```bash
    curl -s -H "Cookie: devcollab_token=$COOKIE" \
      "https://devcollab.fernandomillan.me/api/search?q=javascript" \
      -w "\nHTTP Status: %{http_code}" 2>&1 | python3 -m json.tool 2>/dev/null | head -20
    ```

    Document the output of each check. If the workspace API returns empty arrays for snippets/posts/members, flag it — the seed data may need to be rerun on the VPS. If any endpoint returns 401, 500, or connection refused, investigate the DevCollab API logs via Coolify dashboard before proceeding to the human walkthrough.

    If a code fix is needed based on automated check results, implement it following the fix-then-redeploy pattern, wait for CI/CD to complete (~3-5 min), then re-run the check to confirm.
  </action>
  <verify>
    All four curl checks return HTTP 200. The workspace API returns JSON with non-empty `snippets` or `posts` arrays. The search endpoint returns HTTP 200 (even if results are empty — 200 confirms the endpoint is reachable).
  </verify>
  <done>API health check passes: login returns 200 + token cookie, workspace endpoint returns 200 with content data, search endpoint returns 200.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: DevCollab recruiter walkthrough — human browser verification</name>
  <what-built>
    DevCollab API health confirmed automated (Task 1). Now the full recruiter flow requires human walkthrough — browser session, cookie state, visual rendering, and interactive UX cannot be verified by curl.
  </what-built>
  <how-to-verify>
    Walk this exact flow in a browser:

    1. Open https://devcollab.fernandomillan.me in an incognito/private window
    2. Confirm: Login page is visible. Are demo credentials displayed on the page?
    3. Enter email: admin@demo.devcollab / password: Demo1234! — click Login
    4. Confirm: Redirected to /w/devcollab-demo? (not an error page, not a loop)
    5. Confirm: Workspace page shows a workspace name, not "No workspaces yet" or "Workspace not found"
    6. Confirm: Snippets list has items. Click one — does the detail page render with content?
    7. Navigate to Posts (via sidebar) — are posts listed? Click one — does Markdown render?
    8. Press Cmd+K (or Ctrl+K on Windows) — does the search modal open?
    9. Type "javascript" or "typescript" in search — do results appear? (If zero results: note it)
    10. Click the bell icon (top right) — does a notifications panel open without errors?
    11. Click logout — does it redirect back to the login page?

    For each step that fails:
    - Note the URL at time of failure
    - Note the browser console error (F12 → Console tab)
    - Note the HTTP status of any failed API call (F12 → Network tab)
    - Report in your response: "Step N failed: [description of failure]"

    If ALL 11 steps pass without errors: type "approved"
    If any step fails: describe each failure (step number + error details)
  </how-to-verify>
  <resume-signal>Type "approved" if all 11 steps pass. Or describe each failure with step number and error details so Claude can implement fixes.</resume-signal>
</task>

</tasks>

<verification>
After human approval or after fixes are implemented and redeployed:
1. `curl -s -X POST https://devcollab.fernandomillan.me/api/auth/login -H "Content-Type: application/json" -d '{"email":"admin@demo.devcollab","password":"Demo1234!"}' -w "\nHTTP: %{http_code}"` — returns HTTP 200
2. Human walkthrough: all 11 recruiter flow steps complete without errors
3. Any code fixes committed and pushed to main, CI/CD redeploy verified
</verification>

<success_criteria>
- Login → workspace → snippets → posts → search → notifications → logout: all steps complete without errors or broken UI
- No browser console errors during the recruiter flow
- Any bugs found are fixed in code (not VPS hotfixes) and redeployed via CI/CD
- QA-01 requirement marked as satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/35-full-qa-audit-and-fixes/35-02-SUMMARY.md` following the standard summary template. Document every bug found, the fix applied, and the final verification status.
</output>
