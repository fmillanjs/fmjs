---
phase: 30-gsap-scrolltrigger-parallax
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/portfolio/lenis-provider.tsx
  - apps/web/components/portfolio/hero-section.tsx
autonomous: true
requirements: [PRLLX-01]

must_haves:
  truths:
    - "User scrolling the hero section sees the hero text drift upward visibly slower than the page scroll speed"
    - "Lenis smooth scroll continues to work without jitter (no double-RAF loop)"
    - "Navigating away from the homepage and returning re-fires the hero parallax correctly (no stale instances)"
    - "User with prefers-reduced-motion set sees no parallax — static hero text only"
  artifacts:
    - path: "apps/web/components/portfolio/lenis-provider.tsx"
      provides: "LenisGSAPBridge inner component wired inside ReactLenis tree; autoRaf: false; gsap.ticker.add + lagSmoothing(0)"
      contains: "autoRaf: false"
    - path: "apps/web/components/portfolio/hero-section.tsx"
      provides: "Hero text parallax via useGSAP + ScrollTrigger; sectionRef + textRef wired"
      contains: "useGSAP"
  key_links:
    - from: "apps/web/components/portfolio/lenis-provider.tsx"
      to: "gsap.ticker"
      via: "LenisGSAPBridge useEffect — gsap.ticker.add(tickerFn)"
      pattern: "gsap\\.ticker\\.add"
    - from: "apps/web/components/portfolio/lenis-provider.tsx"
      to: "ScrollTrigger"
      via: "lenis.on('scroll', ScrollTrigger.update)"
      pattern: "ScrollTrigger\\.update"
    - from: "apps/web/components/portfolio/hero-section.tsx"
      to: "ScrollTrigger"
      via: "useGSAP callback with gsap.to + scrollTrigger config"
      pattern: "scrub: 1"
---

<objective>
Switch LenisProvider from autoRaf: true to autoRaf: false and add the LenisGSAPBridge inner component so GSAP's ticker drives Lenis (eliminating double-RAF jitter). Then add hero text parallax to HeroSection using useGSAP + ScrollTrigger with yPercent: -15 and scrub: 1.

Purpose: PRLLX-01 requires the hero text to drift upward at a slower rate than page scroll. This requires two tightly-coupled changes: (1) the ticker bridge so ScrollTrigger has the correct scroll position from Lenis, and (2) the useGSAP parallax hook on the hero text element.

Output: Updated lenis-provider.tsx with bridge; updated hero-section.tsx with parallax hook and section/text refs.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-gsap-scrolltrigger-parallax/30-RESEARCH.md
@.planning/phases/29-lenis-foundation/29-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update LenisProvider — autoRaf: false + LenisGSAPBridge</name>
  <files>apps/web/components/portfolio/lenis-provider.tsx</files>
  <action>
Replace the current content of `apps/web/components/portfolio/lenis-provider.tsx` with the Phase 30 version that adds GSAP ScrollTrigger ticker sync.

Key changes from the current Phase 29 version:
1. Add imports: `gsap` from `'gsap'`, `ScrollTrigger` from `'gsap/ScrollTrigger'`, `useGSAP` from `'@gsap/react'`
2. Register plugins at module level (idempotent): `gsap.registerPlugin(ScrollTrigger, useGSAP)`
3. Add `LenisGSAPBridge` inner function component (alongside existing `LenisScrollReset`):
   ```typescript
   function LenisGSAPBridge() {
     const lenis = useLenis()
     useEffect(() => {
       if (!lenis) return
       lenis.on('scroll', ScrollTrigger.update)
       const tickerFn = (time: number) => { lenis.raf(time * 1000) }
       gsap.ticker.add(tickerFn)
       gsap.ticker.lagSmoothing(0)
       return () => {
         lenis.off('scroll', ScrollTrigger.update)
         gsap.ticker.remove(tickerFn)
       }
     }, [lenis])
     return null
   }
   ```
   CRITICAL: Store tickerFn in a named variable — NOT inline arrow function — so the same reference is removed in cleanup.
4. In the ReactLenis `options` prop: change `autoRaf: true` to `autoRaf: false`
5. Insert `<LenisGSAPBridge />` inside the ReactLenis JSX, after `<LenisScrollReset />`:
   ```tsx
   <ReactLenis root options={{ lerp: 0.1, autoRaf: false, smoothWheel: true }}>
     <LenisScrollReset />
     <LenisGSAPBridge />
     {children}
   </ReactLenis>
   ```
   CRITICAL: Bridge must be INSIDE ReactLenis tree (not outside) so useLenis() has a ReactLenis ancestor.

Keep all existing `LenisScrollReset` logic and reduced-motion detection exactly as-is. Only add the three items above.

Do NOT use `scrollerProxy` (deprecated). The `lenis.on('scroll', ScrollTrigger.update)` + `gsap.ticker.add` pattern is the current official approach (Lenis README, verified in 30-RESEARCH.md).
  </action>
  <verify>
Run `npx tsc --noEmit` from the monorepo root to confirm no TypeScript errors in the updated file. Grep the file to confirm: `grep -n "autoRaf: false" apps/web/components/portfolio/lenis-provider.tsx` (must return the options line), `grep -n "LenisGSAPBridge" apps/web/components/portfolio/lenis-provider.tsx` (must appear in both the function definition and in JSX).
  </verify>
  <done>
lenis-provider.tsx has `autoRaf: false`, `LenisGSAPBridge` function defined and rendered inside ReactLenis, `gsap.ticker.lagSmoothing(0)` called, cleanup removes both lenis event listener and ticker function using the same named reference. TypeScript build clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add hero text parallax with useGSAP + ScrollTrigger</name>
  <files>apps/web/components/portfolio/hero-section.tsx</files>
  <action>
Update `apps/web/components/portfolio/hero-section.tsx` to add GSAP ScrollTrigger parallax on the hero text block.

The file is already `'use client'`. Current structure:
- `<section className="relative ...">` — outer section
- `<MatrixRainCanvas />` — background canvas
- `<div className="relative z-10 ...">` — text content wrapper

Changes to make:
1. Add imports at top: `useRef` from `'react'`, `gsap` from `'gsap'`, `ScrollTrigger` from `'gsap/ScrollTrigger'`, `useGSAP` from `'@gsap/react'`
2. Register plugins at module level: `gsap.registerPlugin(ScrollTrigger)` (useGSAP already registered in lenis-provider; re-registration is idempotent and safe)
3. Inside `HeroSection()`, add two refs before the return:
   ```typescript
   const sectionRef = useRef<HTMLElement>(null)
   const textRef = useRef<HTMLDivElement>(null)
   ```
4. Add `useGSAP` hook after the refs:
   ```typescript
   useGSAP(() => {
     const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
     if (prefersReducedMotion || !textRef.current || !sectionRef.current) return

     gsap.to(textRef.current, {
       yPercent: -15,
       ease: 'none',
       scrollTrigger: {
         trigger: sectionRef.current,
         start: 'top top',
         end: 'bottom top',
         scrub: 1,
         invalidateOnRefresh: true,
         // pin: false (never use pin: true — CLS spacer, fails Lighthouse)
       },
     })
   }, { scope: sectionRef })
   ```
5. Attach refs to JSX:
   - `<section ref={sectionRef} className="relative overflow-hidden ...">` — add `ref={sectionRef}` and `overflow-hidden` to prevent text from floating above nav on fast scroll (Pitfall 6 from RESEARCH.md)
   - `<div ref={textRef} className="relative z-10 ...">` — add `ref={textRef}`

Keep ALL existing content (ScrambleHero, heading, paragraph, Button links) exactly as-is. Only add imports, refs, hook, and JSX ref/overflow attributes.

NOTE on MatrixRainCanvas: the canvas uses `position: absolute` with `inset: 0` — adding `overflow: hidden` to the parent `<section>` is safe and clips only the drifting text, not the canvas. Verify by checking matrix-rain-canvas.tsx positioning before adding overflow-hidden; if canvas extends outside section bounds, add overflow-hidden to the textRef div instead (as a fallback, not the default).
  </action>
  <verify>
Run `npx tsc --noEmit` from monorepo root. Grep to confirm: `grep -n "useGSAP\|sectionRef\|textRef\|yPercent\|scrub" apps/web/components/portfolio/hero-section.tsx` — all five terms must appear. Grep for overflow: `grep -n "overflow-hidden" apps/web/components/portfolio/hero-section.tsx`.

Dev server smoke test: start `npx next dev` in apps/web, visit http://localhost:3000, open browser devtools Network tab, confirm no JavaScript errors on load. Scroll slowly — hero text should drift upward at a visibly slower rate than page scroll.
  </verify>
  <done>
hero-section.tsx has sectionRef on the section element (with overflow-hidden), textRef on the text container div, useGSAP hook with yPercent: -15, scrub: 1, start: 'top top', end: 'bottom top', invalidateOnRefresh: true, and prefers-reduced-motion guard. TypeScript build clean. Scrolling the hero drifts the text upward more slowly than page scroll speed.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` (from monorepo root) — zero TypeScript errors in lenis-provider.tsx and hero-section.tsx
2. `grep -n "autoRaf: false" apps/web/components/portfolio/lenis-provider.tsx` — returns the options line
3. `grep -n "LenisGSAPBridge" apps/web/components/portfolio/lenis-provider.tsx` — appears in function definition and in JSX
4. `grep -n "useGSAP\|yPercent\|scrub" apps/web/components/portfolio/hero-section.tsx` — all three present
5. `grep -n "pin:" apps/web/components/portfolio/hero-section.tsx` — must NOT appear (or only appear in comments saying never use it)
6. Dev server: visit http://localhost:3000, scroll — hero text drifts upward slower than page scroll; no console errors; Lenis smooth scroll still functions (inertia on scroll visible)
</verification>

<success_criteria>
- lenis-provider.tsx: autoRaf: false, LenisGSAPBridge inner component with gsap.ticker.add + lagSmoothing(0) + lenis.on('scroll', ScrollTrigger.update) wired inside ReactLenis tree with correct cleanup
- hero-section.tsx: useGSAP hook with yPercent: -15, scrub: 1, sectionRef + textRef, overflow-hidden on section, prefers-reduced-motion guard, invalidateOnRefresh: true
- TypeScript build clean
- Hero text visibly drifts upward slower than page scroll; no double-RAF jitter; no stale instances on navigation
</success_criteria>

<output>
After completion, create `.planning/phases/30-gsap-scrolltrigger-parallax/30-01-SUMMARY.md`
</output>
