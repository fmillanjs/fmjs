---
phase: 23-canvas-matrix-rain
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/portfolio/matrix-rain-canvas.tsx
  - apps/web/components/portfolio/hero-section.tsx
autonomous: true
requirements:
  - ANIM-02

must_haves:
  truths:
    - "The hero section has a canvas element positioned absolutely behind the hero content"
    - "The canvas has aria-hidden='true' and does not appear in the accessibility tree"
    - "The canvas animates falling Matrix characters at CSS opacity 0.05 — visible but content stays readable"
    - "The RAF loop does not start when OS Reduce Motion is active"
    - "The RAF loop is fully canceled on component unmount via cancelAnimationFrame"
    - "No TypeScript or build errors are introduced"
  artifacts:
    - path: "apps/web/components/portfolio/matrix-rain-canvas.tsx"
      provides: "MatrixRainCanvas client component — canvas element + RAF loop + 30fps cap + cleanup"
      exports: ["default MatrixRainCanvas"]
    - path: "apps/web/components/portfolio/hero-section.tsx"
      provides: "HeroSection with MatrixRainCanvas loaded via next/dynamic ssr:false"
      contains: "'use client'"
  key_links:
    - from: "apps/web/components/portfolio/hero-section.tsx"
      to: "apps/web/components/portfolio/matrix-rain-canvas.tsx"
      via: "next/dynamic with ssr:false at module top level"
      pattern: "dynamic.*matrix-rain-canvas.*ssr.*false"
    - from: "apps/web/components/portfolio/matrix-rain-canvas.tsx"
      to: "requestAnimationFrame"
      via: "useEffect RAF loop with cancelAnimationFrame cleanup"
      pattern: "cancelAnimationFrame"
---

<objective>
Create the MatrixRainCanvas client component and integrate it into the hero section via next/dynamic.

Purpose: ANIM-02 — hero section displays falling Matrix digital rain behind content, SSR-safe, aria-hidden, reduced-motion-aware, leak-free.
Output: New matrix-rain-canvas.tsx component + updated hero-section.tsx with dynamic import.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-canvas-matrix-rain/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MatrixRainCanvas client component</name>
  <files>apps/web/components/portfolio/matrix-rain-canvas.tsx</files>
  <action>
    Create a new file `apps/web/components/portfolio/matrix-rain-canvas.tsx` with the following exact implementation.

    The file must start with `'use client'` directive.

    Constants at module top level:
    - `CHARS`: the half-width katakana string plus digits — `'ｦｧｨｩｪｫｬｭｮｯｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝ0123456789'`
    - `FONT_SIZE = 14` (px — also column width)
    - `FPS_TARGET = 30`
    - `FRAME_INTERVAL = 1000 / FPS_TARGET` (~33.33ms)

    Component `MatrixRainCanvas` (default export):
    - `canvasRef = useRef<HTMLCanvasElement>(null)`
    - Single `useEffect(() => { ... }, [])` containing:
      1. Reduce-motion gate: `if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return`
      2. Get canvas and ctx; return early if either is null
      3. Size the drawing buffer: `canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight`
      4. Compute `columns = Math.floor(canvas.width / FONT_SIZE)` and `drops: number[] = Array(columns).fill(1)`
      5. Local variables `let lastTime = 0; let rafId: number`
      6. Inner `function draw(timestamp: number)` that:
         - Throttles to 30fps: if `timestamp - lastTime < FRAME_INTERVAL`, schedule next frame and return
         - Sets `lastTime = timestamp`
         - Draws fade trail: `ctx.fillStyle = 'rgba(10, 10, 10, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height)`
         - Sets character style: `ctx.fillStyle = '#00FF41'; ctx.font = \`${FONT_SIZE}px monospace\``
         - Loops over drops: draw random char at `(i * FONT_SIZE, drops[i] * FONT_SIZE)`, reset drop if past bottom (`drops[i] * FONT_SIZE > canvas.height && Math.random() > 0.975`), then increment
         - Ends with `rafId = requestAnimationFrame(draw)`
      7. Kick off: `rafId = requestAnimationFrame(draw)`
      8. Cleanup return: `return () => { cancelAnimationFrame(rafId) }`

    JSX returned from component:
    ```
    <canvas
      ref={canvasRef}
      aria-hidden="true"
      className="absolute inset-0 w-full h-full z-0"
      style={{ opacity: 0.05 }}
    />
    ```

    Imports: only `useEffect` and `useRef` from `'react'`. No other imports.

    The opacity MUST be set via `style={{ opacity: 0.05 }}` on the canvas element (CSS-level compositing) — NOT via `ctx.globalAlpha`. Using `ctx.globalAlpha` would make each character nearly invisible. CSS opacity composites the fully-drawn canvas at 5% against the page.
  </action>
  <verify>
    Run `npx tsc --noEmit` from `/home/doctor/fernandomillan/apps/web` — zero TypeScript errors.
    Confirm file exists: `ls apps/web/components/portfolio/matrix-rain-canvas.tsx`
  </verify>
  <done>
    `matrix-rain-canvas.tsx` exists, has `'use client'` at line 1, exports `default MatrixRainCanvas`, includes `cancelAnimationFrame(rafId)` in useEffect cleanup, TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate MatrixRainCanvas into HeroSection via next/dynamic</name>
  <files>apps/web/components/portfolio/hero-section.tsx</files>
  <action>
    Rewrite `apps/web/components/portfolio/hero-section.tsx` to:

    1. Add `'use client'` as the very first line (required by Next.js 15 — calling `dynamic()` with `ssr: false` from a Server Component causes a build error per Next.js #72236).

    2. Add import at top: `import dynamic from 'next/dynamic'`

    3. At module top level (OUTSIDE the component function, after imports):
       ```tsx
       const MatrixRainCanvas = dynamic(
         () => import('./matrix-rain-canvas'),
         { ssr: false }
       )
       ```
       The `dynamic()` call MUST be at module top level, not inside the render function.

    4. Inside the `<section>` element, add `<MatrixRainCanvas />` as the FIRST child (before the content div), so it renders behind everything.

    5. Add `relative z-10` to the existing content `<div>` that wraps all hero text and buttons — this ensures text sits above the z-0 canvas. The `<section>` already has `relative` via Tailwind. Do NOT remove any other existing classes.

    The existing imports (`Link` from `'next/link'`, `Button` from `'@/components/ui/button'`) stay intact. All existing JSX content (h1, p, buttons) stays unchanged. Only additions: `'use client'`, dynamic import, `<MatrixRainCanvas />`, and `z-10` on the content div.

    Current `hero-section.tsx` is a Server Component with no async data fetching — converting to `'use client'` is safe (confirmed in research).
  </action>
  <verify>
    Run `cd /home/doctor/fernandomillan/apps/web && npx tsc --noEmit` — zero TypeScript errors.
    Run `npm run build --workspace apps/web` from `/home/doctor/fernandomillan` — build succeeds with no errors.
    Confirm file starts with `'use client'` and contains `dynamic` and `MatrixRainCanvas`.
  </verify>
  <done>
    Build succeeds. `hero-section.tsx` has `'use client'` at line 1, `MatrixRainCanvas` loaded via `dynamic(..., { ssr: false })`, `<MatrixRainCanvas />` rendered inside the hero section before the content div, content div has `relative z-10`.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx tsc --noEmit` from `apps/web` reports zero errors
2. `npm run build --workspace apps/web` succeeds
3. `grep -n "cancelAnimationFrame" apps/web/components/portfolio/matrix-rain-canvas.tsx` — confirms cleanup is present
4. `grep -n "aria-hidden" apps/web/components/portfolio/matrix-rain-canvas.tsx` — confirms accessibility attribute
5. `grep -n "'use client'" apps/web/components/portfolio/hero-section.tsx` — confirms client directive at line 1
6. `grep -n "ssr: false" apps/web/components/portfolio/hero-section.tsx` — confirms SSR-safe import
</verification>

<success_criteria>
- `matrix-rain-canvas.tsx` exists and TypeScript compiles clean
- `hero-section.tsx` has `'use client'`, dynamic import, `<MatrixRainCanvas />` in JSX
- Production build (`npm run build`) succeeds with no errors
- Canvas has `aria-hidden="true"` and `style={{ opacity: 0.05 }}`
- `cancelAnimationFrame(rafId)` is in the useEffect cleanup
- Reduced-motion gate is present: `window.matchMedia('(prefers-reduced-motion: reduce)').matches`
</success_criteria>

<output>
After completion, create `.planning/phases/23-canvas-matrix-rain/23-01-SUMMARY.md`
</output>
