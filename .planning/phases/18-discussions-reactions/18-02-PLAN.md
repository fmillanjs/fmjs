---
phase: 18-discussions-reactions
plan: 02
type: execute
wave: 2
depends_on:
  - 18-01
files_modified:
  - apps/devcollab-api/src/comments/comments.module.ts
  - apps/devcollab-api/src/comments/comments.controller.ts
  - apps/devcollab-api/src/comments/comments.service.ts
  - apps/devcollab-api/src/comments/dto/create-comment.dto.ts
  - apps/devcollab-api/src/comments/dto/update-comment.dto.ts
  - apps/devcollab-api/src/reactions/reactions.module.ts
  - apps/devcollab-api/src/reactions/reactions.controller.ts
  - apps/devcollab-api/src/reactions/reactions.service.ts
  - apps/devcollab-api/src/reactions/dto/toggle-reaction.dto.ts
  - apps/devcollab-api/src/app.module.ts
autonomous: true
requirements:
  - DISC-01
  - DISC-02
  - DISC-03
  - DISC-04

must_haves:
  truths:
    - "POST /workspaces/:slug/comments creates a top-level comment or a reply; reply-to-reply returns 400"
    - "GET /workspaces/:slug/comments?postId= returns a threaded tree assembled in-memory from a flat fetch (max 2 DB queries)"
    - "PATCH /workspaces/:slug/comments/:id allows ONLY the comment owner to update content; any other requester receives 403 regardless of role"
    - "DELETE /workspaces/:slug/comments/:id soft-deletes (owner) or hard-deletes (Admin on other's comment)"
    - "POST /workspaces/:slug/reactions toggles a reaction; second call with same emoji removes it; race condition P2002 handled"
    - "CommentsModule and ReactionsModule are imported in AppModule and all endpoints respond correctly"
  artifacts:
    - path: "apps/devcollab-api/src/comments/comments.service.ts"
      provides: "create, findAll (flat+tree), update (owner-only), remove (soft/hard)"
      exports: ["CommentsService"]
    - path: "apps/devcollab-api/src/reactions/reactions.service.ts"
      provides: "toggleReaction (upsert/delete pattern)"
      exports: ["ReactionsService"]
    - path: "apps/devcollab-api/src/comments/comments.controller.ts"
      provides: "POST/GET/PATCH/DELETE endpoints under workspaces/:slug/comments"
      exports: ["CommentsController"]
    - path: "apps/devcollab-api/src/reactions/reactions.controller.ts"
      provides: "POST /workspaces/:slug/reactions endpoint"
      exports: ["ReactionsController"]
  key_links:
    - from: "CommentsService.findAll"
      to: "prisma.comment.findMany (flat)"
      via: "in-memory Map + tree assembly — never recursive include"
      pattern: "new Map.*replies"
    - from: "CommentsService.update"
      to: "owner-only guard"
      via: "if comment.authorId !== requesterId throw ForbiddenException — no Admin bypass"
      pattern: "ForbiddenException"
    - from: "CommentsService.remove"
      to: "soft-delete vs hard-delete"
      via: "isAdmin && !isOwner → prisma.comment.delete; else → prisma.comment.update content='[deleted]'"
      pattern: "content.*deleted"
    - from: "ReactionsService.toggleReaction"
      to: "prisma.reaction.findUnique → delete or create"
      via: "existing reaction → delete; no reaction → create; catch P2002"
      pattern: "P2002"
---

<objective>
Build the NestJS CommentsModule and ReactionsModule: controllers, services, DTOs, and AppModule wiring.

Purpose: This is the complete API layer for Phase 18. Web components in Plan 03 call these endpoints directly.
Output: 9 files; CommentsModule and ReactionsModule registered in AppModule; all 5 discussion API endpoints responding correctly.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-discussions-reactions/18-01-SUMMARY.md
@apps/devcollab-api/src/app.module.ts
@apps/devcollab-api/src/core/database/prisma.service.ts
@apps/devcollab-api/src/snippets/snippets.service.ts
@apps/devcollab-api/src/snippets/snippets.controller.ts
@apps/devcollab-api/src/comments/dto/create-comment.dto.ts
@.planning/phases/18-discussions-reactions/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CommentsModule — DTOs, service, controller, module file</name>
  <files>
    apps/devcollab-api/src/comments/dto/create-comment.dto.ts
    apps/devcollab-api/src/comments/dto/update-comment.dto.ts
    apps/devcollab-api/src/comments/comments.service.ts
    apps/devcollab-api/src/comments/comments.controller.ts
    apps/devcollab-api/src/comments/comments.module.ts
  </files>
  <action>
    Create all five files. Follow the snippets.service.ts patterns exactly (NotFoundException, ForbiddenException, workspace-first lookup).

    **create-comment.dto.ts:**
    ```typescript
    export class CreateCommentDto {
      content!: string;
      postId?: string;
      snippetId?: string;
      parentId?: string;
    }
    ```

    **update-comment.dto.ts:**
    ```typescript
    export class UpdateCommentDto {
      content!: string;
    }
    ```

    **comments.service.ts** — implement five methods:
    - `create(slug, dto, authorId)`: workspace lookup → if dto.parentId set, fetch parent and throw BadRequestException if parent.parentId is non-null (reply-to-reply guard) → prisma.comment.create
    - `findAll(slug, requesterId, filter: {postId?, snippetId?})`: workspace lookup (query 1) → flat findMany with `include: { author: { select: {id,name,email} }, reactions: { select: {id,emoji,userId} } }` (query 2) → in-memory tree: `new Map(flat.map(c => [c.id, {...c, replies:[]}]))`, iterate flat, push replies into parent, collect roots → return roots. CRITICAL: no recursive Prisma include.
    - `update(slug, id, dto, requesterId)`: workspace lookup → findFirst comment → **OWNER-ONLY CHECK: if comment.authorId !== requesterId, throw ForbiddenException unconditionally — Admin role does NOT bypass this check; only the comment's own author may edit their comment** → prisma.comment.update({where:{id}, data:{content:dto.content}})
    - `remove(slug, id, requesterId)`: workspace lookup → findFirst comment → fetch membership → isOwner = comment.authorId === requesterId; isAdmin = membership?.role === 'Admin'; if !isOwner && !isAdmin throw ForbiddenException → if isAdmin && !isOwner: hard-delete (prisma.comment.delete) → else: soft-delete (prisma.comment.update content='[deleted]', deletedAt=new Date())

    Permission summary for implementors:
    - **edit (PATCH)**: owner only — throw ForbiddenException if authorId !== requesterId, period.
    - **delete (DELETE)**: owner → soft-delete; Admin on someone else's comment → hard-delete.
    Admin privilege is limited to hard-delete only, not editing.

    **comments.controller.ts** — follow snippets.controller.ts pattern:
    - `@Controller('workspaces/:slug/comments')`
    - `@CheckAbility('create','Comment') @Post()` → create
    - `@CheckAbility('read','Comment') @Get()` → findAll (accepts @Query('postId') postId?: string, @Query('snippetId') snippetId?: string)
    - `@CheckAbility('update','Comment') @Patch(':id')` → update
    - `@CheckAbility('delete','Comment') @Delete(':id')` → remove
    - All methods extract @CurrentUser() user: JwtPayload and pass user.sub

    **comments.module.ts:**
    ```typescript
    import { Module } from '@nestjs/common';
    import { DatabaseModule } from '../core/database/database.module';
    import { CommentsService } from './comments.service';
    import { CommentsController } from './comments.controller';

    @Module({
      imports: [DatabaseModule],
      controllers: [CommentsController],
      providers: [CommentsService],
    })
    export class CommentsModule {}
    ```

    Import paths: use `../common/decorators/check-ability.decorator` and `../common/decorators/current-user.decorator` (same as snippets.controller.ts).
  </action>
  <verify>
    `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0.
  </verify>
  <done>All five comment files compile without TypeScript errors; service implements flat fetch + in-memory tree; update throws ForbiddenException for any non-owner regardless of role; soft/hard-delete logic present.</done>
</task>

<task type="auto">
  <name>Task 2: ReactionsModule + AppModule wiring</name>
  <files>
    apps/devcollab-api/src/reactions/dto/toggle-reaction.dto.ts
    apps/devcollab-api/src/reactions/reactions.service.ts
    apps/devcollab-api/src/reactions/reactions.controller.ts
    apps/devcollab-api/src/reactions/reactions.module.ts
    apps/devcollab-api/src/app.module.ts
  </files>
  <action>
    **toggle-reaction.dto.ts:**
    ```typescript
    export class ToggleReactionDto {
      emoji!: string; // 'thumbs_up' | 'heart' | 'plus_one' | 'laugh'
      postId?: string;
      commentId?: string;
    }
    ```

    **reactions.service.ts** — implement `toggleReaction(slug, dto, userId)`:
    1. Workspace lookup (or NotFoundException)
    2. If !dto.postId && !dto.commentId: throw BadRequestException('postId or commentId required')
    3. Build the unique `where` clause:
       - if postId: `{ userId_emoji_postId: { userId, emoji: dto.emoji, postId: dto.postId } }`
       - else: `{ userId_emoji_commentId: { userId, emoji: dto.emoji, commentId: dto.commentId! } }`
    4. Try `prisma.reaction.findUnique({ where })` → if existing: delete and return `{action:'removed', emoji}` → else: create and return `{action:'added', emoji}`
    5. Wrap the create in try/catch: catch `PrismaClientKnownRequestError` with `code === 'P2002'` and return `{action:'added', emoji}` (idempotent race condition handling)

    Import `PrismaClientKnownRequestError` from `@prisma/client/runtime/library`.

    **reactions.controller.ts:**
    - `@Controller('workspaces/:slug/reactions')`
    - `@CheckAbility('create','Reaction') @Post()` → calls reactionsService.toggleReaction(slug, dto, user.sub)
    - Note: CASL ability factory already grants Admin `manage all` and Contributor `create Reaction`. Viewer has `read all` only — cannot create reactions (403 expected for Viewer on POST).

    **reactions.module.ts:**
    ```typescript
    import { Module } from '@nestjs/common';
    import { DatabaseModule } from '../core/database/database.module';
    import { ReactionsService } from './reactions.service';
    import { ReactionsController } from './reactions.controller';

    @Module({
      imports: [DatabaseModule],
      controllers: [ReactionsController],
      providers: [ReactionsService],
    })
    export class ReactionsModule {}
    ```

    **app.module.ts** — add CommentsModule and ReactionsModule to the imports array:
    ```typescript
    import { CommentsModule } from './comments/comments.module';
    import { ReactionsModule } from './reactions/reactions.module';
    // ... in @Module imports array:
    CommentsModule,
    ReactionsModule,
    ```
    Keep all existing imports intact (ConfigModule, JwtModule, DatabaseModule, HealthModule, AuthModule, WorkspacesModule, SnippetsModule, PostsModule).
  </action>
  <verify>
    1. `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0.
    2. Start the API and verify: `curl -s http://localhost:3003/health` returns 200 (confirms AppModule registered correctly without boot errors).
    3. Smoke test (requires auth cookie): `curl -s -X GET "http://localhost:3003/workspaces/demo/comments?postId=nonexistent" -H "Cookie: devcollab_token=INVALID"` returns 401 (guard is active), not 404 or 500.
  </verify>
  <done>ReactionsModule wired; AppModule imports both CommentsModule and ReactionsModule; API boots without errors; TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0
- API boots: `curl http://localhost:3003/health` returns 200
- Comments endpoint active: unauthenticated GET to /workspaces/*/comments returns 401 (not 404)
- Reactions endpoint active: unauthenticated POST to /workspaces/*/reactions returns 401 (not 404)
</verification>

<success_criteria>
All discussion and reaction API endpoints exist and are guarded; flat comment fetch + in-memory tree assembly implemented in CommentsService; update is owner-only (Admin cannot edit other users' comments); soft/hard-delete logic correct (Admin can only hard-delete, not edit); P2002 race condition handled in ReactionsService; TypeScript compiles clean.
</success_criteria>

<output>
After completion, create `.planning/phases/18-discussions-reactions/18-02-SUMMARY.md`
</output>
