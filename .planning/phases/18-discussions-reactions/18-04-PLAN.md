---
phase: 18-discussions-reactions
plan: 04
type: execute
wave: 4
depends_on:
  - 18-03
files_modified:
  - apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx
  - apps/devcollab-web/app/w/[slug]/snippets/[id]/page.tsx
  - apps/devcollab-api/src/posts/posts.service.ts
autonomous: false
requirements:
  - DISC-01
  - DISC-02
  - DISC-03
  - DISC-04

must_haves:
  truths:
    - "The post detail page shows a ThreadedComments section below the post content; comments load on page render"
    - "The snippet detail page shows a ThreadedComments section below the code block"
    - "A ReactionBar appears on the post detail page above the comment section; reaction counts update on click without page reload"
    - "The currentUserId is resolved server-side via GET /auth/me with the forwarded cookie; it is never null when a user is logged in"
    - "next build completes without TypeScript errors or React hydration warnings"
    - "A human verifies the full comment + reaction flow end-to-end in the browser"
  artifacts:
    - path: "apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx"
      provides: "Post detail page with SSR-fetched comments passed as initialComments to ThreadedComments + ReactionBar"
      contains: "ThreadedComments"
    - path: "apps/devcollab-web/app/w/[slug]/snippets/[id]/page.tsx"
      provides: "Snippet detail page with SSR-fetched comments passed as initialComments to ThreadedComments"
      contains: "ThreadedComments"
  key_links:
    - from: "PostDetailPage (SSR)"
      to: "GET /auth/me"
      via: "forwarded devcollab_token cookie → currentUserId for client components"
      pattern: "auth/me"
    - from: "PostDetailPage (SSR)"
      to: "GET /workspaces/:slug/comments?postId="
      via: "initial SSR fetch → passed as initialComments prop to ThreadedComments"
      pattern: "initialComments"
    - from: "ThreadedComments (client)"
      to: "NestJS comments API"
      via: "client-side refresh after mutations"
      pattern: "credentials.*include"
---

<objective>
Wire ThreadedComments and ReactionBar into the existing post and snippet detail pages, and verify the full discussion + reaction flow with a human-verify checkpoint.

Purpose: Completes Phase 18 by connecting all four components to the actual content pages. The SSR pages resolve currentUserId server-side and pass initial comment data as props.
Output: Modified post and snippet detail pages; a production build passes; human confirms the full flow works.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-discussions-reactions/18-03-SUMMARY.md
@apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx
@apps/devcollab-web/app/w/[slug]/snippets/[id]/page.tsx
@apps/devcollab-api/src/posts/posts.service.ts
@.planning/phases/18-discussions-reactions/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire ThreadedComments + ReactionBar into post and snippet detail pages</name>
  <files>
    apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx
    apps/devcollab-web/app/w/[slug]/snippets/[id]/page.tsx
    apps/devcollab-api/src/posts/posts.service.ts
  </files>
  <action>
    Both pages are SSR Server Components. Follow the Phase 17 cookie-forwarding pattern already established in these files.

    **Post detail page** — add two SSR helper functions and update the component:

    Add `getCurrentUser(token)` helper:
    ```typescript
    async function getCurrentUser(token: string) {
      const res = await fetch(`${API_URL}/auth/me`, {
        headers: { Cookie: `devcollab_token=${token}` },
        cache: 'no-store',
      });
      if (!res.ok) return null;
      const data = await res.json();
      return data.user as { sub: string; email: string };
    }
    ```

    Add `getComments(slug, postId, token)` helper:
    ```typescript
    async function getComments(slug: string, postId: string, token?: string) {
      const res = await fetch(`${API_URL}/workspaces/${slug}/comments?postId=${postId}`, {
        headers: token ? { Cookie: `devcollab_token=${token}` } : {},
        cache: 'no-store',
      });
      if (!res.ok) return [];
      return res.json();
    }
    ```

    In `PostDetailPage`:
    - After resolving params and fetching the post, also call `getCurrentUser(token)` and `getComments(slug, post.id, token)`
    - Store results in `currentUser` and `initialComments` constants

    Add these imports at the top:
    ```typescript
    import ThreadedComments from '../../../../../components/discussion/ThreadedComments';
    import ReactionBar from '../../../../../components/reaction/ReactionBar';
    ```

    Below the `<MarkdownRenderer>` in the return JSX, add:
    ```tsx
    <div style={{ marginTop: '2rem', borderTop: '1px solid #e5e7eb', paddingTop: '1.5rem' }}>
      <ReactionBar
        postId={post.id}
        initialReactions={post.reactions ?? []}
        currentUserId={currentUser?.sub ?? ''}
        workspaceSlug={slug}
      />
    </div>
    <div style={{ marginTop: '2rem' }}>
      <ThreadedComments
        workspaceSlug={slug}
        postId={post.id}
        currentUserId={currentUser?.sub ?? ''}
        initialComments={initialComments}
      />
    </div>
    ```

    Also update `apps/devcollab-api/src/posts/posts.service.ts` `findOne` method: add
    `reactions: { select: { id: true, emoji: true, userId: true } }` to the existing `include` object so the SSR page can pass real initial reaction data to ReactionBar. Keep all other service methods unchanged.

    **Snippet detail page** — same pattern but simpler (snippets have comments but no ReactionBar):

    Add `getCurrentUser` helper (identical to the post page version) and add `getComments(slug, snippetId, token)` helper using `snippetId=` query param.

    Import `ThreadedComments` and add below the `<SnippetCodeBlock>`:
    ```tsx
    <div style={{ marginTop: '2rem', borderTop: '1px solid #e5e7eb', paddingTop: '1.5rem' }}>
      <ThreadedComments
        workspaceSlug={slug}
        snippetId={snippet.id}
        currentUserId={currentUser?.sub ?? ''}
        initialComments={initialComments}
      />
    </div>
    ```

    Both pages must keep the existing edit/back buttons and all current content intact.
  </action>
  <verify>
    1. `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/devcollab-web/tsconfig.json` exits 0
    2. `cd /home/doctor/fernandomillan && npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0
    3. `cd /home/doctor/fernandomillan && npm run build --workspace=apps/devcollab-web 2>&1 | tail -20` — next build must complete with no errors
  </verify>
  <done>Post and snippet detail pages render ThreadedComments; post page renders ReactionBar; next build passes; no TypeScript errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — full discussion and reaction flow</name>
  <files>N/A — verification only, no files modified</files>
  <action>
    Pause for human verification of the complete Phase 18 discussion and reaction system.

    What was built:
    - NestJS CommentsModule: POST/GET/PATCH/DELETE /workspaces/:slug/comments (flat fetch + in-memory tree, soft/hard-delete)
    - NestJS ReactionsModule: POST /workspaces/:slug/reactions (toggle upsert/delete, P2002 safe)
    - ThreadedComments, CommentForm, CommentItem, ReactionBar client components
    - Post detail page: comments + reactions wired
    - Snippet detail page: comments wired

    Verify in browser per the how-to-verify steps below.
  </action>
  <what-built>
    Complete Phase 18 discussion and reaction system:
    - NestJS CommentsModule: POST/GET/PATCH/DELETE /workspaces/:slug/comments (flat fetch + in-memory tree, soft/hard-delete)
    - NestJS ReactionsModule: POST /workspaces/:slug/reactions (toggle upsert/delete, P2002 safe)
    - ThreadedComments, CommentForm, CommentItem, ReactionBar client components
    - Post detail page: comments + reactions wired
    - Snippet detail page: comments wired
  </what-built>
  <how-to-verify>
    Ensure devcollab-web (port 3002) and devcollab-api (port 3003) are running: `docker compose up devcollab-web devcollab-api -d`

    1. Log in to DevCollab at http://localhost:3002 as a Contributor.

    2. Open any published post detail page (e.g., http://localhost:3002/w/{slug}/posts/{id}).
       Expected: ReactionBar visible below content; ThreadedComments section visible with "Discussion" heading and CommentForm.

    3. Post a top-level comment. Expected: comment appears immediately with your name and timestamp.

    4. Click Reply on the top-level comment. Expected: inline CommentForm appears; after posting, reply appears indented under the parent.

    5. On a reply, confirm there is NO Reply button. Expected: no reply-to-reply option visible.

    6. Edit your own comment. Expected: Edit mode opens pre-filled; after save, content updates and "(edited)" appears.

    7. Delete your own comment. Expected: content changes to "[deleted]" in gray italic; thread structure (including any replies) stays intact.

    8. Click a reaction emoji (thumbs up). Expected: count increments, button turns blue. Click again. Expected: count decrements, button returns to gray. No page reload at any point.

    9. Open any snippet detail page. Expected: ThreadedComments section visible; can post and reply.

    10. Log in as a Viewer. Expected: comment submission fails with a clear error (403 from API); the form may still display but posting is blocked server-side.

    11. Run: `docker compose logs devcollab-api --tail 50` — confirm no unhandled exceptions in the logs.
  </how-to-verify>
  <verify>Human confirms all 11 browser verification steps pass.</verify>
  <done>Human types "approved" — all 11 acceptance criteria verified in browser.</done>
  <resume-signal>Type "approved" if all 11 steps pass. Describe any failures in detail.</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p apps/devcollab-web/tsconfig.json` exits 0
- `npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0
- `next build` completes for devcollab-web
- Human verifies all 11 steps in the checkpoint
</verification>

<success_criteria>
Post and snippet detail pages show discussion threads; reactions toggle without page reload; edit/delete work per RBAC; next build passes; human-approved all acceptance criteria.
</success_criteria>

<output>
After completion, create `.planning/phases/18-discussions-reactions/18-04-SUMMARY.md`
</output>
