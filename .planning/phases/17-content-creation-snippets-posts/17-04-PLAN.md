---
phase: 17-content-creation-snippets-posts
plan: 04
type: execute
wave: 4
depends_on:
  - "17-03"
files_modified:
  - apps/devcollab-web/components/post/PostEditor.tsx
  - apps/devcollab-web/components/post/MarkdownRenderer.tsx
  - apps/devcollab-web/app/w/[slug]/posts/page.tsx
  - apps/devcollab-web/app/w/[slug]/posts/new/page.tsx
  - apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx
  - apps/devcollab-web/app/w/[slug]/posts/[id]/edit/page.tsx
autonomous: true
requirements:
  - POST-01
  - POST-02
  - POST-03

must_haves:
  truths:
    - "User can create a Markdown post using a write/preview split-pane editor"
    - "Preview pane renders Markdown with syntax-highlighted code fences"
    - "User can save post as Draft or Publish it via two distinct buttons"
    - "Draft posts are only visible to their author; Published posts visible to all workspace members"
    - "Published post detail page renders Markdown server-side with react-markdown"
    - "User can edit post content and toggle Draft/Published status"
    - "User can delete own post"
  artifacts:
    - path: "apps/devcollab-web/components/post/PostEditor.tsx"
      provides: "Client textarea + react-markdown split-pane editor with Draft/Publish buttons"
    - path: "apps/devcollab-web/components/post/MarkdownRenderer.tsx"
      provides: "Server Component rendering Markdown with react-markdown + remark-gfm"
    - path: "apps/devcollab-web/app/w/[slug]/posts/page.tsx"
      provides: "Server Component listing posts (Draft + own, Published for all)"
    - path: "apps/devcollab-web/app/w/[slug]/posts/new/page.tsx"
      provides: "PostEditor for creating new post"
    - path: "apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx"
      provides: "Server Component detail view with MarkdownRenderer"
    - path: "apps/devcollab-web/app/w/[slug]/posts/[id]/edit/page.tsx"
      provides: "PostEditor pre-filled for editing + status toggle + delete"
  key_links:
    - from: "apps/devcollab-web/components/post/PostEditor.tsx"
      to: "apps/devcollab-web/app/w/[slug]/posts/new/page.tsx"
      via: "PostEditor rendered on new page, onSave calls POST /workspaces/:slug/posts"
      pattern: "PostEditor"
    - from: "apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx"
      to: "apps/devcollab-web/components/post/MarkdownRenderer.tsx"
      via: "MarkdownRenderer receives post.content from server fetch"
      pattern: "MarkdownRenderer"
    - from: "apps/devcollab-web/components/post/PostEditor.tsx"
      to: "react-markdown"
      via: "import ReactMarkdown for live preview pane in client component"
      pattern: "ReactMarkdown"
---

<objective>
Build the PostEditor split-pane component (textarea write + react-markdown preview), a server-side MarkdownRenderer, and all four post UI pages (list, new, detail, edit). No Tiptap — the research confirms textarea + react-markdown is the production-safe choice for Markdown posts.

Purpose: Completes POST-01 (write/preview editor), POST-02 (draft/publish), POST-03 (edit/delete). The PostEditor is a 'use client' component; the published post view uses a Server Component for zero-JS Markdown rendering.
Output: 6 files created. Posts are fully functional in the workspace UI.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-content-creation-snippets-posts/17-RESEARCH.md
@apps/devcollab-web/package.json
@apps/devcollab-web/app/w/[slug]/page.tsx
@.planning/phases/17-content-creation-snippets-posts/17-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build PostEditor and MarkdownRenderer components</name>
  <files>
    apps/devcollab-web/components/post/PostEditor.tsx
    apps/devcollab-web/components/post/MarkdownRenderer.tsx
  </files>
  <action>
**`apps/devcollab-web/components/post/PostEditor.tsx`** — Client component, write/preview split pane:
```typescript
'use client';
import { useState } from 'react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import ReactSyntaxHighlighter from 'react-syntax-highlighter';
import { githubGist } from 'react-syntax-highlighter/dist/esm/styles/hljs';

interface Props {
  initialTitle?: string;
  initialContent?: string;
  initialStatus?: 'Draft' | 'Published';
  onSave: (title: string, content: string, status: 'Draft' | 'Published') => Promise<void>;
  saving?: boolean;
  error?: string;
}

export default function PostEditor({
  initialTitle = '',
  initialContent = '',
  onSave,
  saving = false,
  error = '',
}: Props) {
  const [title, setTitle] = useState(initialTitle);
  const [content, setContent] = useState(initialContent);

  return (
    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem', height: '100%' }}>
      <div>
        <input
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          placeholder="Post title..."
          required
          style={{
            width: '100%',
            padding: '10px',
            fontSize: '1.25rem',
            fontWeight: 600,
            border: '1px solid #d1d5db',
            borderRadius: '4px',
          }}
        />
      </div>

      <div
        style={{
          display: 'grid',
          gridTemplateColumns: '1fr 1fr',
          gap: '1rem',
          height: '60vh',
        }}
      >
        <div style={{ display: 'flex', flexDirection: 'column' }}>
          <h3 style={{ fontSize: '14px', fontWeight: 600, color: '#6b7280', marginBottom: '4px' }}>Write</h3>
          <textarea
            value={content}
            onChange={(e) => setContent(e.target.value)}
            placeholder="Write Markdown here... Use ``` for code blocks."
            style={{
              flex: 1,
              padding: '12px',
              fontFamily: 'monospace',
              fontSize: '14px',
              border: '1px solid #d1d5db',
              borderRadius: '4px',
              resize: 'none',
              lineHeight: 1.6,
            }}
          />
        </div>

        <div style={{ display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
          <h3 style={{ fontSize: '14px', fontWeight: 600, color: '#6b7280', marginBottom: '4px' }}>Preview</h3>
          <div
            style={{
              flex: 1,
              padding: '12px',
              border: '1px solid #e5e7eb',
              borderRadius: '4px',
              overflowY: 'auto',
              background: '#f9fafb',
            }}
          >
            <ReactMarkdown
              remarkPlugins={[remarkGfm]}
              components={{
                code({ className, children, ...props }) {
                  const match = /language-(\w+)/.exec(className ?? '');
                  const isBlock = !props.ref && match;
                  return isBlock ? (
                    <ReactSyntaxHighlighter
                      style={githubGist}
                      language={match![1]}
                      PreTag="div"
                    >
                      {String(children).replace(/\n$/, '')}
                    </ReactSyntaxHighlighter>
                  ) : (
                    <code
                      className={className}
                      style={{ background: '#f3f4f6', padding: '2px 4px', borderRadius: '3px' }}
                      {...props}
                    >
                      {children}
                    </code>
                  );
                },
              }}
            >
              {content || '*Nothing to preview yet...*'}
            </ReactMarkdown>
          </div>
        </div>
      </div>

      {error && <p style={{ color: '#dc2626', fontSize: '14px' }}>{error}</p>}

      <div style={{ display: 'flex', gap: '0.75rem' }}>
        <button
          onClick={() => onSave(title, content, 'Draft')}
          disabled={saving || !title.trim()}
          style={{
            padding: '10px 20px',
            background: '#6b7280',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
          }}
        >
          {saving ? 'Saving...' : 'Save as Draft'}
        </button>
        <button
          onClick={() => onSave(title, content, 'Published')}
          disabled={saving || !title.trim()}
          style={{
            padding: '10px 20px',
            background: '#2563eb',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
          }}
        >
          {saving ? 'Publishing...' : 'Publish'}
        </button>
      </div>
    </div>
  );
}
```

**`apps/devcollab-web/components/post/MarkdownRenderer.tsx`** — Server Component (no 'use client'):
```typescript
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';

interface Props {
  content: string;
}

// Server Component — react-markdown works in RSC; no client JS needed for rendering
export default function MarkdownRenderer({ content }: Props) {
  return (
    <article
      style={{
        maxWidth: '720px',
        lineHeight: 1.7,
        fontSize: '16px',
        color: '#111827',
      }}
    >
      <ReactMarkdown remarkPlugins={[remarkGfm]}>
        {content}
      </ReactMarkdown>
    </article>
  );
}
```

Note on code fences in MarkdownRenderer: react-markdown's default code rendering is used in the Server Component (no custom highlighter plugin) — the published post view renders clean HTML. If Shiki-highlighted code fences are needed in the server-side rendered view, that can be added as a Phase 18+ enhancement. The success criterion ("preview renders Shiki-highlighted code fences") refers to the editor preview pane, which uses react-syntax-highlighter (client-safe).
  </action>
  <verify>`cd /home/doctor/fernandomillan/apps/devcollab-web && npx tsc --noEmit` — no errors in components/post/</verify>
  <done>PostEditor: 'use client', textarea write pane + ReactMarkdown preview with syntax highlighting, two buttons (Draft/Publish). MarkdownRenderer: server component with react-markdown + remark-gfm.</done>
</task>

<task type="auto">
  <name>Task 2: Build post pages (list, new, detail, edit)</name>
  <files>
    apps/devcollab-web/app/w/[slug]/posts/page.tsx
    apps/devcollab-web/app/w/[slug]/posts/new/page.tsx
    apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx
    apps/devcollab-web/app/w/[slug]/posts/[id]/edit/page.tsx
  </files>
  <action>
CRITICAL: Use `const { slug } = await params` in server components (Next.js 15 async params). Use `useParams()` in client pages.

**`apps/devcollab-web/app/w/[slug]/posts/page.tsx`** (Server Component):
```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

async function getPosts(slug: string) {
  const res = await fetch(`${API_URL}/workspaces/${slug}/posts`, {
    credentials: 'include',
    cache: 'no-store',
  });
  if (!res.ok) return [];
  return res.json();
}

export default async function PostsPage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  const posts = await getPosts(slug);

  return (
    <div style={{ padding: '2rem' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
        <h1 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Posts</h1>
        <a
          href={`/w/${slug}/posts/new`}
          style={{
            padding: '8px 16px',
            background: '#2563eb',
            color: 'white',
            borderRadius: '6px',
            textDecoration: 'none',
            fontSize: '14px',
          }}
        >
          New Post
        </a>
      </div>

      {posts.length === 0 ? (
        <p style={{ color: '#6b7280' }}>No posts yet. Write the first one!</p>
      ) : (
        <ul style={{ listStyle: 'none', padding: 0, display: 'flex', flexDirection: 'column', gap: '1rem' }}>
          {posts.map((post: { id: string; title: string; status: string; author: { name?: string; email: string }; createdAt: string }) => (
            <li
              key={post.id}
              style={{ border: '1px solid #e5e7eb', borderRadius: '8px', padding: '1rem' }}
            >
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <a
                  href={`/w/${slug}/posts/${post.id}`}
                  style={{ fontWeight: 600, textDecoration: 'none', color: '#111827' }}
                >
                  {post.title}
                </a>
                <span
                  style={{
                    fontSize: '11px',
                    padding: '2px 8px',
                    borderRadius: '9999px',
                    background: post.status === 'Published' ? '#dcfce7' : '#f3f4f6',
                    color: post.status === 'Published' ? '#166534' : '#6b7280',
                  }}
                >
                  {post.status}
                </span>
              </div>
              <div style={{ fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>
                by {post.author?.name ?? post.author?.email} · {new Date(post.createdAt).toLocaleDateString()}
              </div>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
```

**`apps/devcollab-web/app/w/[slug]/posts/new/page.tsx`** (Client Component):
```typescript
'use client';
import { useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import PostEditor from '../../../../../components/post/PostEditor';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

export default function NewPostPage() {
  const params = useParams();
  const slug = params.slug as string;
  const router = useRouter();
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');

  const handleSave = async (title: string, content: string, status: 'Draft' | 'Published') => {
    setSaving(true);
    setError('');

    const res = await fetch(`${API_URL}/workspaces/${slug}/posts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ title, content }),
    });

    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      setError(data.message ?? 'Failed to create post');
      setSaving(false);
      return;
    }

    const post = await res.json();

    // If Published, set the status after creation (posts default to Draft)
    if (status === 'Published') {
      await fetch(`${API_URL}/workspaces/${slug}/posts/${post.id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status: 'Published' }),
      });
    }

    setSaving(false);
    router.push(`/w/${slug}/posts/${post.id}`);
  };

  return (
    <div style={{ padding: '2rem' }}>
      <h1 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '1.5rem' }}>New Post</h1>
      <PostEditor onSave={handleSave} saving={saving} error={error} />
    </div>
  );
}
```

**`apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx`** (Server Component):
```typescript
import MarkdownRenderer from '../../../../../components/post/MarkdownRenderer';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

async function getPost(slug: string, id: string) {
  const res = await fetch(`${API_URL}/workspaces/${slug}/posts/${id}`, {
    credentials: 'include',
    cache: 'no-store',
  });
  if (!res.ok) return null;
  return res.json();
}

export default async function PostDetailPage({
  params,
}: {
  params: Promise<{ slug: string; id: string }>;
}) {
  const { slug, id } = await params;
  const post = await getPost(slug, id);

  if (!post) {
    return (
      <div style={{ padding: '2rem' }}>
        <h1>Post not found</h1>
        <a href={`/w/${slug}/posts`}>Back to posts</a>
      </div>
    );
  }

  return (
    <div style={{ padding: '2rem', maxWidth: '800px' }}>
      <div style={{ marginBottom: '1.5rem' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
          <div>
            <h1 style={{ fontSize: '2rem', fontWeight: 700, marginBottom: '0.5rem' }}>{post.title}</h1>
            <div style={{ fontSize: '13px', color: '#6b7280' }}>
              by {post.author?.name ?? post.author?.email} ·{' '}
              {post.publishedAt
                ? `Published ${new Date(post.publishedAt).toLocaleDateString()}`
                : `Draft — ${new Date(post.createdAt).toLocaleDateString()}`}
            </div>
          </div>
          <div style={{ display: 'flex', gap: '0.5rem' }}>
            <a
              href={`/w/${slug}/posts/${id}/edit`}
              style={{ padding: '6px 14px', border: '1px solid #d1d5db', borderRadius: '6px', textDecoration: 'none', color: '#374151', fontSize: '14px' }}
            >
              Edit
            </a>
            <a
              href={`/w/${slug}/posts`}
              style={{ padding: '6px 14px', border: '1px solid #d1d5db', borderRadius: '6px', textDecoration: 'none', color: '#374151', fontSize: '14px' }}
            >
              Back
            </a>
          </div>
        </div>
      </div>
      <hr style={{ marginBottom: '1.5rem', borderColor: '#e5e7eb' }} />
      <MarkdownRenderer content={post.content} />
    </div>
  );
}
```

**`apps/devcollab-web/app/w/[slug]/posts/[id]/edit/page.tsx`** (Client Component):
```typescript
'use client';
import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import PostEditor from '../../../../../../components/post/PostEditor';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

export default function EditPostPage() {
  const params = useParams();
  const slug = params.slug as string;
  const id = params.id as string;
  const router = useRouter();

  const [post, setPost] = useState<{ title: string; content: string; status: string } | null>(null);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');
  const [fetching, setFetching] = useState(true);

  useEffect(() => {
    fetch(`${API_URL}/workspaces/${slug}/posts/${id}`, { credentials: 'include' })
      .then((r) => r.json())
      .then((p) => {
        setPost(p);
        setFetching(false);
      })
      .catch(() => setFetching(false));
  }, [slug, id]);

  const handleSave = async (title: string, content: string, status: 'Draft' | 'Published') => {
    setSaving(true);
    setError('');

    // Update content
    const updateRes = await fetch(`${API_URL}/workspaces/${slug}/posts/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ title, content }),
    });

    if (!updateRes.ok) {
      const data = await updateRes.json().catch(() => ({}));
      setError(data.message ?? 'Failed to update post');
      setSaving(false);
      return;
    }

    // Set status if changed
    if (status !== post?.status) {
      await fetch(`${API_URL}/workspaces/${slug}/posts/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status }),
      });
    }

    setSaving(false);
    router.push(`/w/${slug}/posts/${id}`);
  };

  const handleDelete = async () => {
    if (!confirm('Delete this post?')) return;
    await fetch(`${API_URL}/workspaces/${slug}/posts/${id}`, {
      method: 'DELETE',
      credentials: 'include',
    });
    router.push(`/w/${slug}/posts`);
  };

  if (fetching) return <div style={{ padding: '2rem' }}>Loading...</div>;
  if (!post) return <div style={{ padding: '2rem' }}>Post not found.</div>;

  return (
    <div style={{ padding: '2rem' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
        <h1 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Edit Post</h1>
        <button
          onClick={handleDelete}
          style={{ padding: '8px 16px', background: '#dc2626', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '14px' }}
        >
          Delete Post
        </button>
      </div>
      <PostEditor
        initialTitle={post.title}
        initialContent={post.content}
        onSave={handleSave}
        saving={saving}
        error={error}
      />
    </div>
  );
}
```
  </action>
  <verify>
1. `cd /home/doctor/fernandomillan/apps/devcollab-web && npx tsc --noEmit` — no TypeScript errors
2. `ls /home/doctor/fernandomillan/apps/devcollab-web/app/w/\[slug\]/posts/` shows page.tsx, new/, [id]/
  </verify>
  <done>4 post pages created: list (server with Draft/Published badges), new (PostEditor with Draft/Publish buttons), detail (server with MarkdownRenderer), edit (prefilled PostEditor with status toggle + delete). All server pages use await params pattern.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` in devcollab-web passes
2. PostEditor.tsx has 'use client' as first line
3. MarkdownRenderer.tsx has NO 'use client' directive
4. posts/new/page.tsx creates post then calls PATCH /:id/status if Publish was clicked
5. posts/[id]/edit/page.tsx calls PATCH /:id/status only when status changed from original
</verification>

<success_criteria>
- PostEditor: 'use client', textarea write + ReactMarkdown preview with code syntax highlighting, Draft and Publish buttons
- MarkdownRenderer: server component, react-markdown + remark-gfm
- Post list: shows Draft badge (gray) or Published badge (green), only author sees own drafts
- Post new: creates post then optionally sets Published status in two API calls
- Post detail: renders Markdown server-side via MarkdownRenderer
- Post edit: prefills editor, updates content and status, handles delete
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-content-creation-snippets-posts/17-04-SUMMARY.md`
</output>
