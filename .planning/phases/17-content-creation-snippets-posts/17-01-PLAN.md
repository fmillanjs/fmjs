---
phase: 17-content-creation-snippets-posts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/devcollab-database/prisma/schema.prisma
  - apps/devcollab-api/src/core/database/prisma.service.ts
  - apps/devcollab-api/src/workspaces/workspace-ability.factory.ts
autonomous: true
requirements:
  - SNIP-01
  - SNIP-02
  - SNIP-04
  - SNIP-05
  - POST-01
  - POST-02
  - POST-03
  - RBAC-02
  - RBAC-03

must_haves:
  truths:
    - "Snippet and Post models exist in the database (migration applied)"
    - "PrismaService exposes snippet and post getters"
    - "WorkspaceAbilityFactory grants Contributor delete on Snippet and Post"
    - "Viewer is denied create/update/delete on Snippet and Post"
  artifacts:
    - path: "packages/devcollab-database/prisma/schema.prisma"
      provides: "Snippet model, Post model, PostStatus enum"
      contains: "model Snippet"
    - path: "packages/devcollab-database/prisma/migrations"
      provides: "add_snippet_post migration applied to DB"
    - path: "apps/devcollab-api/src/core/database/prisma.service.ts"
      provides: "snippet and post getters"
      exports: ["get snippet()", "get post()"]
    - path: "apps/devcollab-api/src/workspaces/workspace-ability.factory.ts"
      provides: "delete ability for Contributor + Viewer restrictions"
  key_links:
    - from: "apps/devcollab-api/src/core/database/prisma.service.ts"
      to: "packages/devcollab-database/prisma/schema.prisma"
      via: "prisma client regeneration after schema change"
      pattern: "get snippet\\(\\)"
    - from: "apps/devcollab-api/src/workspaces/workspace-ability.factory.ts"
      to: "Snippet and Post subjects"
      via: "can('delete', 'Snippet') can('delete', 'Post')"
      pattern: "can\\('delete'"
---

<objective>
Extend the Prisma schema with Snippet and Post models, run the migration in Docker, expose new PrismaService getters, and fix the WorkspaceAbilityFactory to grant Contributor delete access on own content (required for Phase 17 CRUD).

Purpose: All Phase 17 API modules (Plans 02+) depend on these Prisma models existing and being accessible via PrismaService getters. The CASL fix activates RBAC-02/RBAC-03 enforcement on the new content endpoints.
Output: Migration applied to devcollab-postgres in Docker, PrismaService updated, CASL updated.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-content-creation-snippets-posts/17-RESEARCH.md
@packages/devcollab-database/prisma/schema.prisma
@apps/devcollab-api/src/core/database/prisma.service.ts
@apps/devcollab-api/src/workspaces/workspace-ability.factory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema with Snippet and Post models</name>
  <files>packages/devcollab-database/prisma/schema.prisma</files>
  <action>
Add the following to schema.prisma AFTER the existing InviteLink model. Do NOT remove or change any existing models.

1. Add PostStatus enum:
```
enum PostStatus {
  Draft
  Published
}
```

2. Add Snippet model:
```
model Snippet {
  id          String   @id @default(cuid())
  title       String
  language    String
  code        String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  authorId    String
  workspaceId String

  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([authorId])
}
```

3. Add Post model:
```
model Post {
  id          String     @id @default(cuid())
  title       String
  content     String     @db.Text
  status      PostStatus @default(Draft)
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  authorId    String
  workspaceId String

  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status])
  @@index([authorId])
}
```

4. Add back-references to User model (inside model User block, after workspaceMemberships line):
```
  snippets Snippet[]
  posts    Post[]
```

5. Add back-references to Workspace model (inside model Workspace block, after inviteLinks line):
```
  snippets Snippet[]
  posts    Post[]
```

CRITICAL: Prisma requires these back-references or `prisma migrate dev` fails with "Relation field X must have an opposite relation field."
  </action>
  <verify>Run: `docker compose exec devcollab-api npx prisma validate --schema /app/prisma/schema.prisma` — should output "The schema at ... is valid". If devcollab-api container is not running, validate locally: `cd /home/doctor/fernandomillan/packages/devcollab-database && npx prisma validate`</verify>
  <done>schema.prisma contains PostStatus enum, Snippet model, Post model, User.snippets/posts arrays, Workspace.snippets/posts arrays — no validation errors</done>
</task>

<task type="auto">
  <name>Task 2: Run migration in Docker and extend PrismaService</name>
  <files>
    apps/devcollab-api/src/core/database/prisma.service.ts
  </files>
  <action>
Step 1 — Check if Docker is running and run the migration:
```bash
docker compose ps
```
If devcollab-migrate or devcollab-api is running, exec migration:
```bash
docker compose run --rm devcollab-migrate npx prisma migrate dev --name add-snippet-post --schema /app/prisma/schema.prisma
```
If Docker is not up, start it:
```bash
docker compose up -d devcollab-postgres devcollab-migrate devcollab-api
```
Wait for migrate to complete (exit 0), then verify:
```bash
docker compose exec devcollab-postgres psql -U devcollab -d devcollab -c "\dt" | grep -E "snippet|post"
```

Step 2 — Regenerate the Prisma client in the API container:
```bash
docker compose exec devcollab-api npx prisma generate --schema /app/prisma/schema.prisma
```
Or locally (monorepo root):
```bash
cd /home/doctor/fernandomillan && npx prisma generate --schema packages/devcollab-database/prisma/schema.prisma
```

Step 3 — Add getters to PrismaService. In `apps/devcollab-api/src/core/database/prisma.service.ts`, add after the `get inviteLink()` getter:
```typescript
get snippet() {
  return this.client.snippet;
}

get post() {
  return this.client.post;
}
```
  </action>
  <verify>
1. `docker compose exec devcollab-postgres psql -U devcollab -d devcollab -c "\dt"` lists "snippet" and "post" tables.
2. PrismaService file contains `get snippet()` and `get post()` getters.
  </verify>
  <done>Migration applied (snippet + post tables in DB), PrismaService exposes get snippet() and get post() typed getters</done>
</task>

<task type="auto">
  <name>Task 3: Fix WorkspaceAbilityFactory — add Contributor delete + owner-scoped comment</name>
  <files>apps/devcollab-api/src/workspaces/workspace-ability.factory.ts</files>
  <action>
In `workspace-ability.factory.ts`, in the `Contributor` branch, add `delete` abilities for Post, Snippet, and Comment (the existing factory only has `create` and `update` for these types, missing `delete`). Also remove the deferred Phase 17 comment since owner enforcement is now in service layer.

Replace the Contributor block with:
```typescript
} else if (membership.role === 'Contributor') {
  can('read', 'all');
  can('create', 'Post');
  can('create', 'Snippet');
  can('create', 'Comment');
  can('update', 'Post');
  can('update', 'Snippet');
  can('update', 'Comment');
  can('delete', 'Post');
  can('delete', 'Snippet');
  can('delete', 'Comment');
  cannot('manage', 'Workspace');
  cannot('manage', 'WorkspaceMember');
  cannot('create', 'InviteLink');
  // Owner-only enforcement (authorId check) is in service layer — guard passes,
  // service fetches record and throws ForbiddenException if requester is not author
}
```

The Viewer branch already has `cannot('create', 'all')`, `cannot('update', 'all')`, `cannot('delete', 'all')` — no changes needed for Viewer (RBAC-03 already enforced).
  </action>
  <verify>TypeScript compiles: `cd /home/doctor/fernandomillan/apps/devcollab-api && npx tsc --noEmit`</verify>
  <done>WorkspaceAbilityFactory Contributor branch has can('delete', 'Snippet'), can('delete', 'Post'), can('delete', 'Comment') — TypeScript compiles without errors</done>
</task>

</tasks>

<verification>
1. `packages/devcollab-database/prisma/schema.prisma` contains PostStatus enum, Snippet model, Post model
2. `prisma validate` reports no errors
3. Database has `snippet` and `post` tables (migration applied)
4. `apps/devcollab-api/src/core/database/prisma.service.ts` has `get snippet()` and `get post()` getters
5. `workspace-ability.factory.ts` Contributor block includes `can('delete', 'Snippet')` and `can('delete', 'Post')`
6. `npx tsc --noEmit` in devcollab-api succeeds
</verification>

<success_criteria>
- Snippet and Post Prisma models exist with correct fields: title, language/content, code, status, authorId, workspaceId, timestamps
- Migration is applied: tables exist in devcollab-postgres Docker container
- PrismaService exposes typed `snippet` and `post` getters
- WorkspaceAbilityFactory grants Contributor: create/update/delete on Snippet, Post, Comment
- WorkspaceAbilityFactory denies Viewer: cannot create/update/delete anything
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-content-creation-snippets-posts/17-01-SUMMARY.md`
</output>
