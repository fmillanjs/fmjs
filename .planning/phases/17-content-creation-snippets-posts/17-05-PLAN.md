---
phase: 17-content-creation-snippets-posts
plan: 05
type: execute
wave: 5
depends_on:
  - "17-04"
files_modified: []
autonomous: false
requirements:
  - SNIP-02
  - SNIP-03
  - RBAC-02
  - RBAC-03

must_haves:
  truths:
    - "next build && next start completes with zero React hydration errors"
    - "No Duplicate extension names warnings in browser console"
    - "Snippet detail page renders Shiki-highlighted code in production build"
    - "CopyButton copies code to clipboard in production build"
    - "Viewer JWT gets 403 on POST /workspaces/:slug/snippets and POST /workspaces/:slug/posts"
    - "Contributor JWT gets 201 on POST /workspaces/:slug/snippets"
  artifacts:
    - path: "apps/devcollab-web/.next"
      provides: "Production build output — must exist without build errors"
  key_links:
    - from: "apps/devcollab-web/components/snippet/SnippetCodeBlock.tsx"
      to: "next build"
      via: "async Server Component runs at build/request time, not client — verified by no WASM in browser network tab"
      pattern: "dangerouslySetInnerHTML"
    - from: "apps/devcollab-api"
      to: "CaslAuthGuard"
      via: "Viewer role returns 403 on create Snippet/Post endpoints"
      pattern: "403"
---

<objective>
Run `next build && next start` in Docker to validate SSR safety (zero hydration errors, zero Tiptap warnings). Then perform RBAC smoke tests against the live API to confirm RBAC-02 (Contributor can create) and RBAC-03 (Viewer gets 403). This is the hard acceptance gate before Phase 17 is considered complete.

Purpose: Phase 17 success criterion #5 explicitly requires "next build && next start completes with zero React hydration errors and zero Duplicate extension names Tiptap warnings." Since Tiptap is not used in this implementation, the primary risk is Shiki Server Component wiring and react-markdown client hydration.
Output: Human-verified production build passes + RBAC smoke tests pass.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-content-creation-snippets-posts/17-RESEARCH.md
@.planning/phases/17-content-creation-snippets-posts/17-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run production build and RBAC smoke tests</name>
  <files></files>
  <action>
**Step 1 — Ensure Docker containers are running:**
```bash
docker compose ps
docker compose up -d devcollab-api devcollab-web devcollab-postgres
```

**Step 2 — Trigger production build inside devcollab-web container:**
The devcollab-web Dockerfile already runs `next build`. To test the production build, rebuild the image:
```bash
docker compose build devcollab-web
docker compose up -d devcollab-web
```
Then check the build log:
```bash
docker compose logs devcollab-web | grep -E "error|Error|warn|hydrat" | head -40
```
Or run next build locally if faster:
```bash
cd /home/doctor/fernandomillan/apps/devcollab-web && npx next build 2>&1 | tail -30
```

**Step 3 — RBAC smoke tests (using curl with API directly):**

First, create a Viewer account and get its JWT (or use an existing one from Docker DB):
```bash
# Register a test Viewer user
curl -c /tmp/viewer-cookie.txt -X POST http://localhost:3003/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"viewer-test@example.com","name":"Viewer Test","password":"Test1234!"}'

# Register a Contributor user
curl -c /tmp/contributor-cookie.txt -X POST http://localhost:3003/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"contributor-test@example.com","name":"Contributor Test","password":"Test1234!"}'
```

Create a workspace with the Contributor user and get the slug:
```bash
curl -b /tmp/contributor-cookie.txt -X POST http://localhost:3003/workspaces \
  -H "Content-Type: application/json" \
  -d '{"name":"RBAC Test WS","slug":"rbac-test-ws"}'
```

Generate an invite link and have Viewer join:
```bash
INVITE=$(curl -s -b /tmp/contributor-cookie.txt -X POST http://localhost:3003/workspaces/rbac-test-ws/invite-links)
TOKEN=$(echo $INVITE | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
curl -b /tmp/viewer-cookie.txt -X POST http://localhost:3003/workspaces/join \
  -H "Content-Type: application/json" \
  -d "{\"token\":\"$TOKEN\"}"
```

Demote viewer-test to Viewer role using Admin (contributor-test is workspace creator = Admin):
```bash
VIEWER_ID=$(curl -s -b /tmp/viewer-cookie.txt http://localhost:3003/auth/me | grep -o '"sub":"[^"]*"' | cut -d'"' -f4)
curl -b /tmp/contributor-cookie.txt -X PATCH \
  http://localhost:3003/workspaces/rbac-test-ws/members/$VIEWER_ID/role \
  -H "Content-Type: application/json" \
  -d '{"role":"Viewer"}'
```

Now test RBAC:
```bash
# RBAC-03: Viewer should get 403 on create snippet
SNIPPET_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
  -b /tmp/viewer-cookie.txt \
  -X POST http://localhost:3003/workspaces/rbac-test-ws/snippets \
  -H "Content-Type: application/json" \
  -d '{"title":"Test","language":"typescript","code":"const x = 1"}')
echo "Viewer create snippet: $SNIPPET_STATUS (expect 403)"

# RBAC-03: Viewer should get 403 on create post
POST_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
  -b /tmp/viewer-cookie.txt \
  -X POST http://localhost:3003/workspaces/rbac-test-ws/posts \
  -H "Content-Type: application/json" \
  -d '{"title":"Test","content":"hello"}')
echo "Viewer create post: $POST_STATUS (expect 403)"

# RBAC-02: Admin (contributor-test) should succeed with 201
ADMIN_SNIPPET=$(curl -s -o /dev/null -w "%{http_code}" \
  -b /tmp/contributor-cookie.txt \
  -X POST http://localhost:3003/workspaces/rbac-test-ws/snippets \
  -H "Content-Type: application/json" \
  -d '{"title":"Admin Snippet","language":"typescript","code":"const x = 1"}')
echo "Admin create snippet: $ADMIN_SNIPPET (expect 201)"
```

Record results. If any test fails, diagnose and fix before proceeding to checkpoint.
  </action>
  <verify>
1. `next build` exits 0 (no build errors)
2. `docker compose logs devcollab-web` shows no "Error" lines in build output
3. Viewer create snippet returns 403
4. Viewer create post returns 403
5. Admin create snippet returns 201
  </verify>
  <done>Production build succeeds. RBAC smoke tests: Viewer=403 on both endpoints, Admin=201 on snippet creation. Results logged for human verification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verify Phase 17 end-to-end</name>
  <files></files>
  <action>Human verification of snippet flow, post flow, browser console, and RBAC — see how-to-verify steps below.</action>
  <verify>All 4 verification steps in how-to-verify pass — snippets render with Shiki, posts save as Draft/Published, zero console errors, RBAC smoke test shows Viewer=403.</verify>
  <done>User types "approved" confirming all 6 Phase 17 success criteria are met.</done>
  <what-built>
Phase 17 complete implementation:
- API: SnippetsController (5 endpoints) + PostsController (6 endpoints) with owner-scoped RBAC
- Web: 4 snippet pages (list/new/detail/edit) with Shiki server-side highlighting + CopyButton
- Web: 4 post pages (list/new/detail/edit) with textarea+react-markdown split-pane editor
- Production build verified (next build exits 0)
- RBAC smoke tests: Viewer gets 403, Admin gets 201
  </what-built>
  <how-to-verify>
1. **Snippet flow** (verify SNIP-01 through SNIP-05):
   - Open http://localhost:3002/w/[your-workspace-slug]/snippets in a new tab
   - Click "New Snippet" — fill in a title, pick "typescript", paste: `const greet = (name: string) => 'Hello!'`
   - Submit — you should be redirected to the snippet detail page
   - Verify: code is rendered with Shiki syntax highlighting (colored tokens, dark background)
   - Verify: "Copy" button appears in top-right of code block — click it and paste in a text editor to confirm clipboard works
   - Open the detail URL in a new browser tab — it should work (SNIP-05: shareable URL)

2. **Post flow** (verify POST-01 through POST-03):
   - Open http://localhost:3002/w/[your-workspace-slug]/posts
   - Click "New Post" — the write/preview split pane should appear
   - Type in the write pane: `# Hello World` then a code fence with typescript
   - Verify: preview pane shows rendered Markdown with syntax-highlighted code block
   - Click "Save as Draft" — redirected to post detail, showing "Draft" badge
   - Go back, click the post, click "Edit" — verify editor is prefilled
   - Click "Publish" — redirected to detail page, showing "Published" status

3. **Browser console check** (verify success criterion #5):
   - Open http://localhost:3002/w/[your-workspace-slug]/snippets/[snippet-id] in browser
   - Open DevTools Console
   - Verify: ZERO "Hydration failed" errors
   - Verify: ZERO "Duplicate extension names" warnings

4. **RBAC verification** (verify RBAC-02/RBAC-03):
   - Confirm the curl test output from Task 1 shows: Viewer=403, Admin=201
   - If you have a Viewer account, try creating a snippet from the UI — should see an error or 403 response
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- `next build` exits 0
- Browser console on snippet detail page: zero hydration errors, zero Tiptap duplicate extension warnings
- Shiki-highlighted code appears on snippet detail page (colored syntax, not plain text)
- CopyButton copies to clipboard
- PostEditor preview pane shows live Markdown rendering with code highlighting
- Viewer JWT returns 403 on POST /workspaces/:slug/snippets
- Viewer JWT returns 403 on POST /workspaces/:slug/posts
- Contributor/Admin JWT returns 201 on POST /workspaces/:slug/snippets
</verification>

<success_criteria>
All 6 Phase 17 success criteria are met:
1. Snippet create flow works: title + language selector + code body; Shiki highlights server-side; copy button works
2. Snippet shareable URL /w/:slug/snippets/:id accessible in new tab
3. Post write/preview editor: textarea + live react-markdown preview with code highlighting
4. Draft/Published toggle: Draft not visible to others, Published visible to all members
5. next build exits 0, zero hydration errors, zero Duplicate extension names warnings in browser console
6. Viewer gets 403 on create snippet/post; Contributor/Admin gets 201
</success_criteria>

<output>
After completion, create `.planning/phases/17-content-creation-snippets-posts/17-05-SUMMARY.md`
</output>
