---
phase: 15-authentication-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/devcollab-api/package.json
  - apps/devcollab-api/src/main.ts
  - apps/devcollab-api/src/guards/casl-auth.guard.ts
  - apps/devcollab-api/src/common/decorators/check-ability.decorator.ts
  - apps/devcollab-api/src/common/decorators/current-user.decorator.ts
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-04

must_haves:
  truths:
    - "devcollab-api package.json declares all auth runtime dependencies so turbo prune includes them in Docker builds"
    - "main.ts uses cookieParser() middleware and enables CORS with credentials: true for port 3002"
    - "CaslAuthGuard upgraded: verifies JWT from devcollab_token cookie, sets req.user, throws 403 if no @CheckAbility and not @Public()"
    - "@CheckAbility decorator exists and exports CHECK_ABILITY_KEY constant"
    - "@CurrentUser param decorator exists to extract req.user"
  artifacts:
    - path: "apps/devcollab-api/package.json"
      provides: "Auth dependency declarations"
      contains: "cookie-parser"
    - path: "apps/devcollab-api/src/main.ts"
      provides: "cookie-parser middleware and CORS config"
      contains: "cookieParser"
    - path: "apps/devcollab-api/src/guards/casl-auth.guard.ts"
      provides: "Upgraded deny-by-default guard with JWT cookie verification"
      contains: "JwtService"
    - path: "apps/devcollab-api/src/common/decorators/check-ability.decorator.ts"
      provides: "@CheckAbility decorator and CHECK_ABILITY_KEY"
      contains: "CHECK_ABILITY_KEY"
    - path: "apps/devcollab-api/src/common/decorators/current-user.decorator.ts"
      provides: "@CurrentUser param decorator"
      contains: "CurrentUser"
  key_links:
    - from: "apps/devcollab-api/src/main.ts"
      to: "cookie-parser"
      via: "app.use(cookieParser()) middleware registration"
      pattern: "cookieParser"
    - from: "apps/devcollab-api/src/guards/casl-auth.guard.ts"
      to: "apps/devcollab-api/src/common/decorators/check-ability.decorator.ts"
      via: "CHECK_ABILITY_KEY import"
      pattern: "CHECK_ABILITY_KEY"
---

<objective>
Upgrade the DevCollab API foundation: install auth dependencies in package.json, add cookie-parser middleware + CORS to main.ts, upgrade CaslAuthGuard to verify JWT cookies, and add the @CheckAbility and @CurrentUser decorators.

Purpose: These changes are pure infrastructure — no feature logic, no database queries. They run in parallel with Plan 01 (password migration). Plan 03 (auth feature) depends on these decorators and the upgraded guard being in place first.
Output: A devcollab-api that boots with JWT-aware deny-by-default guard, cookie parsing enabled, and the two new decorators ready for use.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-authentication-system/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Declare auth dependencies in devcollab-api package.json and install cookie-parser</name>
  <files>
    apps/devcollab-api/package.json
  </files>
  <action>
    Open `apps/devcollab-api/package.json`. The current `dependencies` block only has NestJS core packages. Add the following to `dependencies`:

    ```json
    "@nestjs/jwt": "^11.0.0",
    "@nestjs/passport": "^11.0.0",
    "bcrypt": "^6.0.0",
    "cookie-parser": "^1.4.7",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1"
    ```

    Add the following to `devDependencies`:
    ```json
    "@types/bcrypt": "^5.0.0",
    "@types/cookie-parser": "^1.4.7",
    "@types/passport-jwt": "^4.0.1"
    ```

    Also add a `test` script to `scripts`:
    ```json
    "test": "vitest run",
    "test:watch": "vitest"
    ```

    These packages are already installed in the monorepo root `node_modules/` (verified in research). Declaring them in `devcollab-api/package.json` ensures `turbo prune devcollab-api --docker` includes them in the Docker build context.

    After updating package.json, run `npm install` from the monorepo root to update package-lock.json:
    ```bash
    cd /home/doctor/fernandomillan && npm install
    ```

    Also install cookie-parser at root if not already present (research confirmed it's NOT installed):
    ```bash
    npm install cookie-parser
    ```
  </action>
  <verify>
    1. `grep "cookie-parser" apps/devcollab-api/package.json` — shows the dependency.
    2. `grep "@nestjs/jwt" apps/devcollab-api/package.json` — shows the dependency.
    3. `ls node_modules/cookie-parser` — directory exists (installed at monorepo root).
    4. `grep "test" apps/devcollab-api/package.json` — shows vitest test scripts.
  </verify>
  <done>All auth deps declared in devcollab-api/package.json; cookie-parser installed at monorepo root; test scripts present.</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade main.ts, add CheckAbility and CurrentUser decorators, upgrade CaslAuthGuard</name>
  <files>
    apps/devcollab-api/src/main.ts
    apps/devcollab-api/src/common/decorators/check-ability.decorator.ts
    apps/devcollab-api/src/common/decorators/current-user.decorator.ts
    apps/devcollab-api/src/guards/casl-auth.guard.ts
  </files>
  <action>
    **File 1: `apps/devcollab-api/src/main.ts`** — Replace entirely with:
    ```typescript
    import { NestFactory } from '@nestjs/core';
    import { AppModule } from './app.module';
    import * as cookieParser from 'cookie-parser';

    async function bootstrap() {
      const app = await NestFactory.create(AppModule);

      // Required: populate req.cookies for JWT cookie extraction in CaslAuthGuard
      app.use(cookieParser());

      // CORS for devcollab-web (port 3002 → port 3003 cross-origin)
      // credentials: true is required for httpOnly cookies to be sent cross-origin
      app.enableCors({
        origin: process.env.DEVCOLLAB_WEB_URL || 'http://localhost:3002',
        credentials: true,
      });

      const port = process.env.PORT || 3003;
      await app.listen(port);
      console.log(`DevCollab API running on port ${port}`);
    }

    bootstrap();
    ```

    Note: `import * as cookieParser` (CommonJS style) is correct for NestJS; NOT `import cookieParser`.

    **File 2: `apps/devcollab-api/src/common/decorators/check-ability.decorator.ts`** — Create new file:
    ```typescript
    import { SetMetadata } from '@nestjs/common';

    export const CHECK_ABILITY_KEY = 'check_ability';

    export interface AbilityRequirement {
      action: string;
      subject: string;
    }

    export const CheckAbility = (action: string, subject: string) =>
      SetMetadata(CHECK_ABILITY_KEY, { action, subject } as AbilityRequirement);
    ```

    **File 3: `apps/devcollab-api/src/common/decorators/current-user.decorator.ts`** — Create new file:
    ```typescript
    import { createParamDecorator, ExecutionContext } from '@nestjs/common';

    export interface JwtPayload {
      sub: string;
      email: string;
    }

    export const CurrentUser = createParamDecorator(
      (_data: unknown, ctx: ExecutionContext): JwtPayload => {
        const request = ctx.switchToHttp().getRequest();
        return request.user as JwtPayload;
      },
    );
    ```

    **File 4: `apps/devcollab-api/src/guards/casl-auth.guard.ts`** — Replace entirely with:
    ```typescript
    import {
      Injectable,
      CanActivate,
      ExecutionContext,
      UnauthorizedException,
      ForbiddenException,
    } from '@nestjs/common';
    import { Reflector } from '@nestjs/core';
    import { JwtService } from '@nestjs/jwt';
    import { IS_PUBLIC_KEY } from '../common/decorators/public.decorator';
    import { CHECK_ABILITY_KEY } from '../common/decorators/check-ability.decorator';

    @Injectable()
    export class CaslAuthGuard implements CanActivate {
      constructor(
        private reflector: Reflector,
        private jwtService: JwtService,
      ) {}

      canActivate(context: ExecutionContext): boolean {
        const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
          context.getHandler(),
          context.getClass(),
        ]);

        if (isPublic) return true;

        // Not public: require valid JWT in devcollab_token cookie
        const request = context.switchToHttp().getRequest();
        const token = request.cookies?.['devcollab_token'];

        if (!token) {
          throw new UnauthorizedException('No authentication token');
        }

        let payload: { sub: string; email: string };
        try {
          payload = this.jwtService.verify(token);
        } catch {
          throw new UnauthorizedException('Invalid or expired token');
        }

        // Set req.user so @CurrentUser() works in controllers
        request.user = payload;

        // Deny-by-default: every non-public endpoint must declare @CheckAbility
        const ability = this.reflector.getAllAndOverride<{ action: string; subject: string }>(
          CHECK_ABILITY_KEY,
          [context.getHandler(), context.getClass()],
        );

        if (!ability) {
          throw new ForbiddenException(
            'Endpoint must declare @CheckAbility — deny-by-default security invariant',
          );
        }

        return true;
      }
    }
    ```

    CRITICAL: `JwtService` is injected here. For this to resolve, `JwtModule` must be registered as `global: true` in `AppModule` — this is done in Plan 03 (Task 1) when AppModule is updated. The guard file itself is correct; DI wiring completes in 15-03.
  </action>
  <verify>
    1. `grep "cookieParser" apps/devcollab-api/src/main.ts` — shows middleware registration.
    2. `grep "credentials: true" apps/devcollab-api/src/main.ts` — shows CORS config.
    3. `grep "CHECK_ABILITY_KEY" apps/devcollab-api/src/common/decorators/check-ability.decorator.ts` — shows the export.
    4. `grep "CurrentUser" apps/devcollab-api/src/common/decorators/current-user.decorator.ts` — shows the decorator.
    5. `grep "JwtService" apps/devcollab-api/src/guards/casl-auth.guard.ts` — shows JwtService injection.
    6. `grep "ForbiddenException" apps/devcollab-api/src/guards/casl-auth.guard.ts` — shows deny-by-default throw.
    7. `grep "devcollab_token" apps/devcollab-api/src/guards/casl-auth.guard.ts` — confirms cookie name.
  </verify>
  <done>main.ts has cookie-parser + CORS; @CheckAbility and @CurrentUser decorators created; CaslAuthGuard upgraded with JWT verification and deny-by-default logic. The app will not compile until AppModule adds JwtModule (Plan 03), which is expected.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `grep "cookie-parser" apps/devcollab-api/package.json` confirms dependency declared
2. `grep "cookieParser" apps/devcollab-api/src/main.ts` confirms middleware
3. `grep "JwtService" apps/devcollab-api/src/guards/casl-auth.guard.ts` confirms upgrade
4. `ls apps/devcollab-api/src/common/decorators/` shows: check-ability.decorator.ts, current-user.decorator.ts, public.decorator.ts
5. `grep "CHECK_ABILITY_KEY" apps/devcollab-api/src/common/decorators/check-ability.decorator.ts` confirms export
</verification>

<success_criteria>
- `apps/devcollab-api/package.json` declares @nestjs/jwt, @nestjs/passport, bcrypt, cookie-parser, passport, passport-jwt as dependencies; @types/bcrypt, @types/cookie-parser, @types/passport-jwt as devDependencies; vitest test scripts present
- `apps/devcollab-api/src/main.ts` uses cookieParser() middleware and enableCors with credentials: true
- `apps/devcollab-api/src/guards/casl-auth.guard.ts` injects JwtService, verifies devcollab_token cookie, throws ForbiddenException when no @CheckAbility
- `apps/devcollab-api/src/common/decorators/check-ability.decorator.ts` exports CHECK_ABILITY_KEY and CheckAbility decorator
- `apps/devcollab-api/src/common/decorators/current-user.decorator.ts` exports CurrentUser param decorator
</success_criteria>

<output>
After completion, create `.planning/phases/15-authentication-system/15-02-SUMMARY.md`
</output>
