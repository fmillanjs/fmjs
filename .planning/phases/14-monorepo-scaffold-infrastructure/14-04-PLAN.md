---
phase: 14-monorepo-scaffold-infrastructure
plan: 04
type: execute
wave: 2
depends_on:
  - "14-02"
files_modified:
  - .github/workflows/deploy.yml
autonomous: true
requirements:
  - INFRA-04

must_haves:
  truths:
    - "CI/CD pipeline builds devcollab-web Docker image and pushes to GHCR on push to main"
    - "CI/CD pipeline builds devcollab-api Docker image and pushes to GHCR on push to main"
    - "New build jobs run after the existing test job passes"
    - "Existing TeamFlow build job is unmodified"
    - "Images are tagged with both :latest and :<git-sha>"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Extended CI/CD with devcollab build+push jobs"
      contains: "build-and-push-devcollab"
    - path: ".github/workflows/deploy.yml"
      provides: "GHCR image push for devcollab-web"
      contains: "devcollab-web"
    - path: ".github/workflows/deploy.yml"
      provides: "GHCR image push for devcollab-api"
      contains: "devcollab-api"
  key_links:
    - from: "build-and-push-devcollab job"
      to: "test job"
      via: "needs: [test]"
      pattern: "needs:.*test"
    - from: "build-and-push-devcollab job"
      to: "ghcr.io"
      via: "docker/login-action with GITHUB_TOKEN"
      pattern: "ghcr.io"
---

<objective>
Extend .github/workflows/deploy.yml to add a build-and-push-devcollab job that builds and pushes Docker images for devcollab-web and devcollab-api to GHCR (GitHub Container Registry) on push to main. Follows the identical pattern as the existing TeamFlow build job.

Purpose: Satisfies INFRA-04. DevCollab images are available in GHCR for deployment in Phase 21. The pattern matches existing TeamFlow CI so there's no new infrastructure to learn.

Output: deploy.yml with an additional parallel build job producing GHCR-tagged images for both DevCollab apps.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.github/workflows/deploy.yml
@.planning/phases/14-monorepo-scaffold-infrastructure/14-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add build-and-push-devcollab job to deploy.yml</name>
  <files>
    .github/workflows/deploy.yml
  </files>
  <action>
Read the full .github/workflows/deploy.yml first. Identify the existing build-and-push job structure (it uses docker/setup-buildx-action@v3, docker/login-action@v3, docker/build-push-action@v5 with GHCR). Then add the new job following the exact same pattern.

Add the following job to the `jobs:` section of deploy.yml (after the existing build-and-push job if one exists, or after the test job):

```yaml
  build-and-push-devcollab:
    name: Build and Push DevCollab Docker Images
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push devcollab-web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/devcollab-web/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/devcollab-web:latest
            ghcr.io/${{ github.repository }}/devcollab-web:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/devcollab-web:latest
          cache-to: type=inline

      - name: Build and push devcollab-api image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/devcollab-api/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/devcollab-api:latest
            ghcr.io/${{ github.repository }}/devcollab-api:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/devcollab-api:latest
          cache-to: type=inline
```

CRITICAL notes:
- `needs: [test]` — the devcollab build only starts after the test job passes. Do NOT change the test job.
- Both devcollab images (web and api) are built in the SAME job as sequential steps. This is intentional — they share the same checkout, buildx setup, and GHCR login, saving CI minutes.
- The `file:` path is relative to the `context: .` (monorepo root) — this matches how the Dockerfiles use `COPY` from root.
- Keep the existing TeamFlow build job (build-and-push or whatever it's named) UNCHANGED. Only add the new `build-and-push-devcollab` job.
- The `push: true` requires GITHUB_TOKEN to have `packages: write` permission — verify the existing workflow top-level `permissions:` block includes `packages: write`. If it does, no change needed there.
- Image cache uses `type=inline` which stores cache metadata in the image itself — same pattern as existing job.

After reading the existing deploy.yml, preserve ALL existing content and only append the new job to the jobs section. Do not reformat or reorder existing jobs.
  </action>
  <verify>
Validate YAML syntax of the workflow file:
```bash
python3 -c "import yaml; yaml.safe_load(open('/home/doctor/fernandomillan/.github/workflows/deploy.yml'))" 2>&1
```
Must print nothing (no errors).

Verify the new job is present:
```bash
grep "build-and-push-devcollab" /home/doctor/fernandomillan/.github/workflows/deploy.yml
```
Must return a match.

Verify both images are configured:
```bash
grep "devcollab-web\|devcollab-api" /home/doctor/fernandomillan/.github/workflows/deploy.yml | head -10
```
Must show both app names.

Verify the existing test job is unchanged (check the test job name still exists):
```bash
grep "name: Run Tests\|name: test" /home/doctor/fernandomillan/.github/workflows/deploy.yml
```

Verify needs relationship:
```bash
grep -A 2 "build-and-push-devcollab:" /home/doctor/fernandomillan/.github/workflows/deploy.yml | grep "needs"
```
Must show `needs: [test]` or equivalent.
  </verify>
  <done>
deploy.yml has the build-and-push-devcollab job. Both devcollab-web and devcollab-api images are built and pushed to GHCR with :latest and :sha tags. The job depends on the test job. YAML is valid. Existing TeamFlow jobs are unmodified.
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"` — no YAML errors
2. `grep build-and-push-devcollab .github/workflows/deploy.yml` — job exists
3. `grep "devcollab-web" .github/workflows/deploy.yml` — image build step present
4. `grep "devcollab-api" .github/workflows/deploy.yml` — image build step present
5. `grep "needs:.*test" .github/workflows/deploy.yml` — devcollab job depends on test
6. Existing test job still present and unchanged
</verification>

<success_criteria>
1. build-and-push-devcollab job exists in deploy.yml with `needs: [test]`
2. devcollab-web image pushed to ghcr.io/<repo>/devcollab-web with :latest and :sha tags
3. devcollab-api image pushed to ghcr.io/<repo>/devcollab-api with :latest and :sha tags
4. deploy.yml is valid YAML (python3 yaml.safe_load passes)
5. Existing TeamFlow build job is unmodified
6. Trigger is push to main (inherited from existing workflow `on:` block — no change needed)
</success_criteria>

<output>
After completion, create `.planning/phases/14-monorepo-scaffold-infrastructure/14-04-SUMMARY.md`
</output>
