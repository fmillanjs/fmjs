---
phase: 14-monorepo-scaffold-infrastructure
plan: 03
type: execute
wave: 2
depends_on:
  - "14-01"
  - "14-02"
files_modified:
  - docker-compose.yml
autonomous: true
requirements:
  - INFRA-03

must_haves:
  truths:
    - "docker compose up starts devcollab-postgres on port 5435 without conflicting with TeamFlow's port 5434"
    - "devcollab-migrate service runs prisma migrate deploy and exits before devcollab-api starts"
    - "devcollab-api starts on port 3003 only after migrate exits with code 0"
    - "devcollab-web starts on port 3002 with a healthcheck visible in docker ps"
    - "MinIO starts on port 9002 (API) and 9003 (console)"
    - "TeamFlow services (postgres, redis, api, web) are unaffected by the additions"
    - "devcollab services use devcollab-network; TeamFlow services use teamflow-network"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Extended Compose file with all DevCollab + MinIO services"
      contains: "devcollab-postgres"
    - path: "docker-compose.yml"
      provides: "migrate service with depends_on service_completed_successfully"
      contains: "service_completed_successfully"
    - path: "docker-compose.yml"
      provides: "MinIO service with console port binding"
      contains: "devcollab-minio"
  key_links:
    - from: "devcollab-api service"
      to: "devcollab-migrate service"
      via: "depends_on: condition: service_completed_successfully"
      pattern: "service_completed_successfully"
    - from: "devcollab-migrate service"
      to: "devcollab-postgres service"
      via: "depends_on: condition: service_healthy"
      pattern: "service_healthy"
    - from: "devcollab-api service"
      to: "devcollab-network"
      via: "networks configuration"
      pattern: "devcollab-network"
---

<objective>
Extend docker-compose.yml to add devcollab-postgres (port 5435), devcollab-migrate (one-shot), devcollab-api (port 3003), devcollab-web (port 3002), and MinIO (ports 9002/9003) services — all on their own devcollab-network. TeamFlow services remain untouched.

Purpose: Satisfies INFRA-03. All DevCollab services start together with `docker compose up` alongside TeamFlow. The migrate-then-api startup sequence eliminates migration race conditions. Health checks make service status visible in `docker ps`.

Output: Single docker-compose.yml that runs the complete dual-application stack.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docker-compose.yml
@.planning/phases/14-monorepo-scaffold-infrastructure/14-01-SUMMARY.md
@.planning/phases/14-monorepo-scaffold-infrastructure/14-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend docker-compose.yml with all DevCollab and MinIO services</name>
  <files>
    docker-compose.yml
  </files>
  <action>
Read the current docker-compose.yml first, then append the DevCollab services. The existing file has:
- postgres (TeamFlow, port 5434)
- redis (TeamFlow, port 6380)
- volumes: pgdata, redisdata
- networks: teamflow-network

Read the file COMPLETELY before modifying. Then write the updated version with DevCollab services appended.

The final docker-compose.yml must include the existing TeamFlow services unchanged plus the following new DevCollab services:

```yaml
  devcollab-postgres:
    image: postgres:16-alpine
    container_name: devcollab-postgres
    restart: unless-stopped
    ports:
      - '5435:5432'
    environment:
      POSTGRES_USER: ${DEVCOLLAB_POSTGRES_USER:-devcollab}
      POSTGRES_PASSWORD: ${DEVCOLLAB_POSTGRES_PASSWORD:-devcollab}
      POSTGRES_DB: ${DEVCOLLAB_POSTGRES_DB:-devcollab}
    volumes:
      - devcollab-pgdata:/var/lib/postgresql/data
    networks:
      - devcollab-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DEVCOLLAB_POSTGRES_USER:-devcollab}']
      interval: 10s
      timeout: 5s
      retries: 5

  devcollab-migrate:
    build:
      context: .
      dockerfile: packages/devcollab-database/Dockerfile.migrate
    depends_on:
      devcollab-postgres:
        condition: service_healthy
    networks:
      - devcollab-network
    environment:
      DEVCOLLAB_DATABASE_URL: postgresql://${DEVCOLLAB_POSTGRES_USER:-devcollab}:${DEVCOLLAB_POSTGRES_PASSWORD:-devcollab}@devcollab-postgres:5432/${DEVCOLLAB_POSTGRES_DB:-devcollab}

  devcollab-api:
    build:
      context: .
      dockerfile: apps/devcollab-api/Dockerfile
    container_name: devcollab-api
    restart: unless-stopped
    ports:
      - '3003:3003'
    depends_on:
      devcollab-migrate:
        condition: service_completed_successfully
    networks:
      - devcollab-network
    environment:
      NODE_ENV: production
      PORT: 3003
      DEVCOLLAB_DATABASE_URL: postgresql://${DEVCOLLAB_POSTGRES_USER:-devcollab}:${DEVCOLLAB_POSTGRES_PASSWORD:-devcollab}@devcollab-postgres:5432/${DEVCOLLAB_POSTGRES_DB:-devcollab}
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3003/health']
      interval: 10s
      timeout: 5s
      retries: 5

  devcollab-web:
    build:
      context: .
      dockerfile: apps/devcollab-web/Dockerfile
    container_name: devcollab-web
    restart: unless-stopped
    ports:
      - '3002:3002'
    networks:
      - devcollab-network
    environment:
      NODE_ENV: production
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3002']
      interval: 10s
      timeout: 5s
      retries: 5

  devcollab-minio:
    image: quay.io/minio/minio
    container_name: devcollab-minio
    restart: unless-stopped
    ports:
      - '9002:9000'
      - '9003:9001'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    networks:
      - devcollab-network
    command: server /data --console-address ":9001"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 10s
      timeout: 5s
      retries: 5
```

Also extend the `volumes:` section to add:
```yaml
  devcollab-pgdata:
  minio-data:
```

Also extend the `networks:` section to add:
```yaml
  devcollab-network:
    driver: bridge
```

CRITICAL notes:
- devcollab-api `depends_on: devcollab-migrate: condition: service_completed_successfully` — this is the only correct condition for a one-shot migrate service. `service_started` would NOT work.
- devcollab-migrate `depends_on: devcollab-postgres: condition: service_healthy` — postgres must pass its healthcheck before migrate runs.
- TeamFlow services remain on `teamflow-network` ONLY. DevCollab services are on `devcollab-network` ONLY. No service spans both networks.
- Port mapping for MinIO: `9002:9000` (API) and `9003:9001` (console). The `--console-address ":9001"` flag is required or MinIO console picks a random port.
- devcollab-migrate has NO `restart` policy — it must exit after completion (not restart on failure loop).
- Default env var values (`:- devcollab`) allow `docker compose up` to work without a .env file for local dev.

Do NOT add a `restart:` directive to the devcollab-migrate service.
  </action>
  <verify>
Validate the YAML is syntactically correct:
```bash
docker compose -f /home/doctor/fernandomillan/docker-compose.yml config --quiet 2>&1
```
Must print nothing (no errors). If there are YAML parse errors, fix them before proceeding.

Verify all required services are present:
```bash
docker compose -f /home/doctor/fernandomillan/docker-compose.yml config --services
```
Must list: postgres, redis, devcollab-postgres, devcollab-migrate, devcollab-api, devcollab-web, devcollab-minio

Verify the port assignments don't conflict:
```bash
docker compose -f /home/doctor/fernandomillan/docker-compose.yml config | grep "ports" -A 2
```
Must show: 5434, 6380 (TeamFlow), 5435, 3002, 3003, 9002, 9003 (DevCollab). No duplicates.

Verify the dependency chain:
```bash
docker compose -f /home/doctor/fernandomillan/docker-compose.yml config | grep "service_completed_successfully"
```
Must return a match (devcollab-api depends on devcollab-migrate with this condition).
  </verify>
  <done>
docker-compose.yml passes `docker compose config --quiet` (no YAML errors). All 7 services are listed. No port conflicts between 5434/5435, 3000/3001/3002/3003, 6380, 9002/9003. devcollab-api depends on devcollab-migrate with service_completed_successfully condition. Both networks (teamflow-network, devcollab-network) are defined. devcollab-pgdata and minio-data volumes are defined.
  </done>
</task>

</tasks>

<verification>
1. `docker compose -f docker-compose.yml config --quiet` — exits 0 (valid YAML)
2. `docker compose -f docker-compose.yml config --services` — lists 7 services including all devcollab services
3. Port conflict check: no duplicate port bindings (5434 TeamFlow ≠ 5435 DevCollab)
4. `grep service_completed_successfully docker-compose.yml` — present for devcollab-api depends_on
5. `grep devcollab-network docker-compose.yml | wc -l` — multiple occurrences (all devcollab services on network)
6. TeamFlow services still on teamflow-network only (grep teamflow-network)
</verification>

<success_criteria>
1. docker-compose.yml is valid YAML — `docker compose config --quiet` exits 0
2. All 5 devcollab services defined: devcollab-postgres, devcollab-migrate, devcollab-api, devcollab-web, devcollab-minio
3. devcollab-api depends on devcollab-migrate with `service_completed_successfully` (not `service_started`)
4. devcollab-migrate has no `restart` policy (exits cleanly, not restarted)
5. Ports: 5435 (postgres), 3003 (api), 3002 (web), 9002/9003 (MinIO) — no conflict with TeamFlow
6. Both devcollab volumes (devcollab-pgdata, minio-data) defined in volumes section
7. devcollab-network defined, TeamFlow services NOT on it
</success_criteria>

<output>
After completion, create `.planning/phases/14-monorepo-scaffold-infrastructure/14-03-SUMMARY.md`
</output>
