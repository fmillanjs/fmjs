---
phase: 14-monorepo-scaffold-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/devcollab-database/package.json
  - packages/devcollab-database/prisma/schema.prisma
  - packages/devcollab-database/src/client.ts
  - packages/devcollab-database/src/index.ts
  - packages/devcollab-database/Dockerfile.migrate
  - packages/devcollab-database/tsconfig.json
autonomous: true
requirements:
  - INFRA-02

must_haves:
  truths:
    - "packages/devcollab-database is a valid npm workspace package named @devcollab/database"
    - "Prisma schema generates a client at node_modules/.prisma/devcollab-client (not overwriting @prisma/client)"
    - "User model exists with id (cuid), email (unique), name (optional), createdAt, updatedAt fields"
    - "package exports PrismaClient singleton importable from @devcollab/database"
    - "Dockerfile.migrate exists and runs prisma migrate deploy in a one-shot container"
  artifacts:
    - path: "packages/devcollab-database/prisma/schema.prisma"
      provides: "Prisma schema with custom output path and User model"
      contains: "output.*devcollab-client"
    - path: "packages/devcollab-database/src/client.ts"
      provides: "PrismaClient singleton from custom path"
      contains: ".prisma/devcollab-client"
    - path: "packages/devcollab-database/src/index.ts"
      provides: "Public exports for @devcollab/database consumers"
      exports: ["prisma"]
    - path: "packages/devcollab-database/Dockerfile.migrate"
      provides: "One-shot migrate runner"
      contains: "prisma migrate deploy"
  key_links:
    - from: "packages/devcollab-database/prisma/schema.prisma"
      to: "node_modules/.prisma/devcollab-client"
      via: "prisma generate --schema=packages/devcollab-database/prisma/schema.prisma"
      pattern: "output.*node_modules/\\.prisma/devcollab-client"
    - from: "packages/devcollab-database/src/client.ts"
      to: ".prisma/devcollab-client"
      via: "import statement"
      pattern: "from '.prisma/devcollab-client'"
---

<objective>
Create the packages/devcollab-database workspace package: Prisma schema with a User model and custom output path that does not overwrite TeamFlow's @prisma/client, a PrismaClient singleton, and a Dockerfile.migrate for the one-shot migration service.

Purpose: DevCollab needs its own isolated Prisma client to coexist with TeamFlow's @prisma/client without type or runtime collisions. Establishing this package first unblocks devcollab-api (which depends on @devcollab/database) and the Docker Compose migrate service.

Output: packages/devcollab-database/ package ready for npm workspace consumption and Docker migrate runner.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/database/prisma/schema.prisma
@packages/database/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create packages/devcollab-database workspace package with Prisma schema</name>
  <files>
    packages/devcollab-database/package.json
    packages/devcollab-database/prisma/schema.prisma
    packages/devcollab-database/tsconfig.json
  </files>
  <action>
Create the directory packages/devcollab-database/ and add the following files:

**packages/devcollab-database/package.json**
```json
{
  "name": "@devcollab/database",
  "version": "0.1.0",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts"
  },
  "scripts": {
    "generate": "prisma generate --schema=./prisma/schema.prisma",
    "migrate:dev": "prisma migrate dev --schema=./prisma/schema.prisma",
    "migrate:deploy": "prisma migrate deploy --schema=./prisma/schema.prisma"
  },
  "dependencies": {
    "@prisma/client": "^5.22.0"
  },
  "devDependencies": {
    "prisma": "^5.22.0",
    "typescript": "~5.6.0"
  }
}
```

**packages/devcollab-database/prisma/schema.prisma**
```prisma
generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/devcollab-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DEVCOLLAB_DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}
```

CRITICAL: The output path must be exactly `"../../../node_modules/.prisma/devcollab-client"`. This places the generated client in the monorepo's root node_modules alongside (not overwriting) TeamFlow's `.prisma/client`. Do NOT use `@prisma/client` as the import path anywhere in this package.

**packages/devcollab-database/tsconfig.json**
```json
{
  "extends": "../../packages/config/tsconfig/base.json",
  "compilerOptions": {
    "outDir": "dist",
    "rootDir": "src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

After creating the files, run `npm install` from the monorepo root to register the workspace:
```bash
cd /home/doctor/fernandomillan && npm install
```

Then generate the Prisma client (requires no database connection — just generates types):
```bash
cd /home/doctor/fernandomillan && npx prisma generate --schema=packages/devcollab-database/prisma/schema.prisma
```
  </action>
  <verify>
Run from monorepo root:
```bash
ls /home/doctor/fernandomillan/node_modules/.prisma/devcollab-client/
```
The directory must exist and contain generated Prisma client files (index.js, index.d.ts, etc.).

Also verify the package is recognized as a workspace:
```bash
cd /home/doctor/fernandomillan && npm ls @devcollab/database 2>/dev/null | head -5
```
  </verify>
  <done>
node_modules/.prisma/devcollab-client/ directory exists with generated files. @devcollab/database is registered as an npm workspace package. The schema.prisma generator output path is "../../../node_modules/.prisma/devcollab-client".
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PrismaClient singleton and Dockerfile.migrate</name>
  <files>
    packages/devcollab-database/src/client.ts
    packages/devcollab-database/src/index.ts
    packages/devcollab-database/Dockerfile.migrate
  </files>
  <action>
Create the source files and migrate Dockerfile:

**packages/devcollab-database/src/client.ts**
```typescript
import { PrismaClient } from '.prisma/devcollab-client';

const globalForPrisma = globalThis as unknown as {
  devcollabPrisma: PrismaClient;
};

export const prisma =
  globalForPrisma.devcollabPrisma ||
  new PrismaClient({
    log:
      process.env.NODE_ENV === 'development'
        ? ['query', 'error', 'warn']
        : ['error'],
  });

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.devcollabPrisma = prisma;
}
```

CRITICAL: Import is from `'.prisma/devcollab-client'` — NOT from `'@prisma/client'`. Using `@prisma/client` would import TeamFlow's generated types.

**packages/devcollab-database/src/index.ts**
```typescript
export { prisma } from './client';
export * from '.prisma/devcollab-client';
```

**packages/devcollab-database/Dockerfile.migrate**

Use the turbo-prune pattern but simplified for a one-shot migrate runner:
```dockerfile
FROM node:20-alpine AS runner
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Copy only what's needed for migration
COPY packages/devcollab-database/prisma ./packages/devcollab-database/prisma
COPY node_modules ./node_modules

ENV DEVCOLLAB_DATABASE_URL=${DEVCOLLAB_DATABASE_URL}

CMD ["node_modules/.bin/prisma", "migrate", "deploy", "--schema=./packages/devcollab-database/prisma/schema.prisma"]
```

Note: This Dockerfile is built from the monorepo root (context: .) so the COPY paths are relative to the root. The prisma binary is available via node_modules/.bin/prisma from the root node_modules.
  </action>
  <verify>
Check the import statement in client.ts is correct:
```bash
grep "from '.prisma/devcollab-client'" /home/doctor/fernandomillan/packages/devcollab-database/src/client.ts
```
Must return a match. If it shows `@prisma/client`, fix it — wrong import will use TeamFlow's types.

Check index.ts exports:
```bash
grep "export" /home/doctor/fernandomillan/packages/devcollab-database/src/index.ts
```
Must show both `export { prisma }` and `export * from '.prisma/devcollab-client'`.

Check Dockerfile.migrate exists:
```bash
ls /home/doctor/fernandomillan/packages/devcollab-database/Dockerfile.migrate
```
  </verify>
  <done>
src/client.ts imports from '.prisma/devcollab-client' (not @prisma/client). src/index.ts exports prisma singleton and all Prisma types. Dockerfile.migrate exists and references the schema path correctly. All three files exist on disk.
  </done>
</task>

</tasks>

<verification>
From monorepo root:
1. `ls node_modules/.prisma/devcollab-client/` — generated client directory exists
2. `grep "devcollab-client" packages/devcollab-database/src/client.ts` — correct import path
3. `cat packages/devcollab-database/prisma/schema.prisma | grep output` — shows custom output path
4. TeamFlow's client is unaffected: `ls node_modules/.prisma/client/` — still exists alongside devcollab-client
</verification>

<success_criteria>
1. packages/devcollab-database/ is a valid npm workspace with name "@devcollab/database"
2. Prisma generates to node_modules/.prisma/devcollab-client (confirmed by ls)
3. TeamFlow's node_modules/.prisma/client is NOT overwritten
4. src/client.ts imports from '.prisma/devcollab-client' — correct isolation
5. Dockerfile.migrate has correct prisma migrate deploy command with schema path
</success_criteria>

<output>
After completion, create `.planning/phases/14-monorepo-scaffold-infrastructure/14-01-SUMMARY.md`
</output>
