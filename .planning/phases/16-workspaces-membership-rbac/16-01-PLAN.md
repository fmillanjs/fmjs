---
phase: 16-workspaces-membership-rbac
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/devcollab-database/prisma/schema.prisma
  - apps/devcollab-api/src/core/database/prisma.service.ts
autonomous: true
requirements:
  - WORK-01
  - WORK-02
  - WORK-03
  - WORK-04
  - WORK-05

must_haves:
  truths:
    - "Prisma schema contains Workspace, WorkspaceMember, InviteLink models and WorkspaceRole enum"
    - "User model has workspaceMemberships relation field"
    - "A migration SQL file exists under packages/devcollab-database/prisma/migrations/"
    - "PrismaService exposes .workspace, .workspaceMember, and .inviteLink accessors"
    - "prisma generate produces a client that includes workspace, workspaceMember, inviteLink models"
  artifacts:
    - path: "packages/devcollab-database/prisma/schema.prisma"
      provides: "Workspace, WorkspaceMember, InviteLink models, WorkspaceRole enum"
      contains: "model Workspace"
    - path: "packages/devcollab-database/prisma/migrations/"
      provides: "Migration SQL for workspace tables"
    - path: "apps/devcollab-api/src/core/database/prisma.service.ts"
      provides: "Accessor getters for workspace, workspaceMember, inviteLink"
      exports: ["PrismaService"]
  key_links:
    - from: "apps/devcollab-api/src/core/database/prisma.service.ts"
      to: "packages/devcollab-database/prisma/schema.prisma"
      via: "prisma generate output in node_modules/.prisma/devcollab-client"
      pattern: "get workspace\\(\\)"
    - from: "packages/devcollab-database/prisma/schema.prisma"
      to: "WorkspaceMember"
      via: "@@unique([userId, workspaceId]) compound constraint"
      pattern: "userId_workspaceId"
---

<objective>
Extend the Prisma schema with workspace data models and expose them through PrismaService accessors.

Purpose: The workspace, membership, and invite link data layer must exist before any business logic or guard can reference these models. This is the foundation every other Phase 16 plan depends on.

Output: Three new Prisma models (Workspace, WorkspaceMember, InviteLink), WorkspaceRole enum, a migration applied to devcollab-postgres, and PrismaService accessors for the new models.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-workspaces-membership-rbac/16-RESEARCH.md
@packages/devcollab-database/prisma/schema.prisma
@apps/devcollab-api/src/core/database/prisma.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema with Workspace models</name>
  <files>packages/devcollab-database/prisma/schema.prisma</files>
  <action>
Add the following to schema.prisma (after the existing User model):

1. Add `workspaceMemberships WorkspaceMember[]` relation field to the existing User model.

2. Add the WorkspaceRole enum:
```
enum WorkspaceRole {
  Admin
  Contributor
  Viewer
}
```

3. Add the Workspace model:
```
model Workspace {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     WorkspaceMember[]
  inviteLinks InviteLink[]

  @@index([slug])
}
```

4. Add the WorkspaceMember model:
```
model WorkspaceMember {
  id        String        @id @default(cuid())
  role      WorkspaceRole @default(Contributor)
  joinedAt  DateTime      @default(now())

  userId      String
  workspaceId String

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}
```

5. Add the InviteLink model:
```
model InviteLink {
  id          String    @id @default(cuid())
  token       String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([workspaceId])
}
```

The @@unique([userId, workspaceId]) compound constraint on WorkspaceMember generates a Prisma named accessor `userId_workspaceId` used by findUnique queries in the service layer.
  </action>
  <verify>
Run: `cd /home/doctor/fernandomillan && npx prisma validate --schema packages/devcollab-database/prisma/schema.prisma`
Expected: "The schema at ... is valid!"
  </verify>
  <done>
schema.prisma contains Workspace, WorkspaceMember, InviteLink models, WorkspaceRole enum, and User.workspaceMemberships relation. `npx prisma validate` exits 0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate migration and regenerate Prisma client</name>
  <files>packages/devcollab-database/prisma/migrations/</files>
  <action>
Check if devcollab-postgres container is running:
```
docker ps --filter "name=devcollab-postgres" --format "{{.Names}}"
```

If devcollab-postgres is NOT running, generate the migration SQL offline using prisma migrate diff (no live DB needed — same pattern as Phase 15):
```
cd /home/doctor/fernandomillan
npx prisma migrate diff \
  --from-schema-datamodel packages/devcollab-database/prisma/schema.prisma \
  --to-schema-datasource packages/devcollab-database/prisma/schema.prisma \
  --script \
  --schema packages/devcollab-database/prisma/schema.prisma
```

Then create the migration directory manually and write the SQL output there:
```
mkdir -p packages/devcollab-database/prisma/migrations/$(date +%Y%m%d%H%M%S)_add_workspace_models
```
Write the SQL to `migration.sql` inside that directory.

If devcollab-postgres IS running, use:
```
cd /home/doctor/fernandomillan && npx prisma migrate dev \
  --name add_workspace_models \
  --schema packages/devcollab-database/prisma/schema.prisma
```

After migration is in place (either way), regenerate the Prisma client:
```
cd /home/doctor/fernandomillan && npx prisma generate \
  --schema packages/devcollab-database/prisma/schema.prisma
```

This regenerates `node_modules/.prisma/devcollab-client` with the new model types.

IMPORTANT: If devcollab-postgres is not running, the migration file is created offline and applied at next `docker compose up devcollab-migrate`. This matches the Phase 15 pattern (prisma migrate diff --from-empty).

Correct command for offline SQL generation (verified in Phase 15):
```
npx prisma migrate diff \
  --from-empty \
  --to-schema-datamodel packages/devcollab-database/prisma/schema.prisma \
  --script \
  --schema packages/devcollab-database/prisma/schema.prisma > /tmp/workspace_migration.sql
```
Then place that SQL in the migrations directory.
  </action>
  <verify>
Run: `ls /home/doctor/fernandomillan/packages/devcollab-database/prisma/migrations/ | grep workspace`
Expected: A directory like `20260217XXXXXX_add_workspace_models` exists with a `migration.sql` file.

Also verify client regenerated:
`ls /home/doctor/fernandomillan/node_modules/.prisma/devcollab-client/ | grep -E "schema|client"`
Expected: Files present (index.js, schema.prisma, etc.)
  </verify>
  <done>
Migration directory with migration.sql exists under packages/devcollab-database/prisma/migrations/. Prisma client regenerated with workspace model types available.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add PrismaService accessors for new models</name>
  <files>apps/devcollab-api/src/core/database/prisma.service.ts</files>
  <action>
Add three new getter accessors to PrismaService, following the exact pattern of the existing `get user()` accessor:

```typescript
get workspace() {
  return this.client.workspace;
}

get workspaceMember() {
  return this.client.workspaceMember;
}

get inviteLink() {
  return this.client.inviteLink;
}
```

Place these after the existing `get user()` accessor. The file should remain minimal — no new imports needed.
  </action>
  <verify>
Run: `npx tsc --noEmit -p /home/doctor/fernandomillan/apps/devcollab-api/tsconfig.json`
Expected: No errors (the new accessors type-check against the regenerated Prisma client).
  </verify>
  <done>
PrismaService exposes .workspace, .workspaceMember, and .inviteLink getters. TypeScript compilation exits 0.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate --schema packages/devcollab-database/prisma/schema.prisma` exits 0
2. Migration file exists: `ls packages/devcollab-database/prisma/migrations/ | grep workspace`
3. TypeScript compiles: `npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` exits 0
4. Grep confirms new accessors: `grep -n "get workspace\|get workspaceMember\|get inviteLink" apps/devcollab-api/src/core/database/prisma.service.ts`
</verification>

<success_criteria>
- schema.prisma contains WorkspaceRole enum, Workspace, WorkspaceMember, InviteLink models
- User model has workspaceMemberships relation
- Migration SQL file created in packages/devcollab-database/prisma/migrations/
- Prisma client regenerated (node_modules/.prisma/devcollab-client updated)
- PrismaService has .workspace, .workspaceMember, .inviteLink getters
- TypeScript compilation exits 0 with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspaces-membership-rbac/16-01-SUMMARY.md`
</output>
