---
phase: 16-workspaces-membership-rbac
plan: "04"
type: execute
wave: 4
depends_on:
  - "16-02"
  - "16-03"
files_modified:
  - apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts
  - apps/devcollab-web/app/w/[slug]/layout.tsx
  - apps/devcollab-web/app/w/[slug]/page.tsx
  - apps/devcollab-web/app/dashboard/page.tsx
  - apps/devcollab-web/app/join/page.tsx
autonomous: false
requirements:
  - WORK-01
  - WORK-03

must_haves:
  truths:
    - "The meta-test covers WorkspacesController — undecorated handlers fail CI"
    - "A logged-in user can visit /w/:slug and see the workspace name"
    - "The dashboard page shows the user's workspaces and a Create Workspace form"
    - "A user with an invite token can visit /join?token=... to join a workspace"
    - "Next.js 15 params is awaited in all new workspace pages (no TypeError)"
  artifacts:
    - path: "apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts"
      provides: "ALL_CONTROLLERS includes WorkspacesController"
      contains: "WorkspacesController"
    - path: "apps/devcollab-web/app/w/[slug]/page.tsx"
      provides: "Workspace home page at /w/:slug"
    - path: "apps/devcollab-web/app/w/[slug]/layout.tsx"
      provides: "Workspace layout with slug display"
    - path: "apps/devcollab-web/app/dashboard/page.tsx"
      provides: "Dashboard with workspace list and Create Workspace form"
    - path: "apps/devcollab-web/app/join/page.tsx"
      provides: "Join workspace page consuming ?token= query param"
  key_links:
    - from: "apps/devcollab-web/app/w/[slug]/page.tsx"
      to: "apps/devcollab-api (GET /workspaces/:slug)"
      via: "fetch in server component using NEXT_PUBLIC_API_URL"
      pattern: "fetch.*workspaces.*slug"
    - from: "apps/devcollab-web/app/dashboard/page.tsx"
      to: "apps/devcollab-api (GET /workspaces, POST /workspaces)"
      via: "fetch in server component and form action"
      pattern: "fetch.*workspaces"
    - from: "apps/devcollab-web/app/join/page.tsx"
      to: "apps/devcollab-api (POST /workspaces/join)"
      via: "form submission with token"
      pattern: "fetch.*workspaces/join"
---

<objective>
Add WorkspacesController to the deny-by-default meta-test, and build the minimal Next.js 15 workspace UI: workspace home page, dashboard with create form, and invite link join page.

Purpose: Close the security invariant gap (meta-test must cover the new controller) and deliver the minimum web UI for Phase 16 success criteria: workspace accessible at /w/:slug, dashboard shows workspaces, users can join via invite link.

Output: Updated meta-test, workspace layout/page at /w/[slug], updated dashboard, and join page.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-workspaces-membership-rbac/16-RESEARCH.md
@.planning/phases/16-workspaces-membership-rbac/16-03-SUMMARY.md
@apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts
@apps/devcollab-web/app/dashboard/page.tsx
@apps/devcollab-web/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update controller-coverage meta-test to include WorkspacesController</name>
  <files>apps/devcollab-api/test/unit/meta/controller-coverage.spec.ts</files>
  <action>
Add WorkspacesController to the ALL_CONTROLLERS array in the meta-test. The file already has HealthController and AuthController — add WorkspacesController as a third entry.

The full updated file:

```typescript
// CRITICAL: reflect-metadata MUST be the FIRST import.
// Without it, Reflect.getMetadata returns undefined for all decorator metadata.
import 'reflect-metadata';
import { describe, it, expect } from 'vitest';

import { IS_PUBLIC_KEY } from '../../../src/common/decorators/public.decorator';
import { CHECK_ABILITY_KEY } from '../../../src/common/decorators/check-ability.decorator';
import { HealthController } from '../../../src/health/health.controller';
import { AuthController } from '../../../src/auth/auth.controller';
import { WorkspacesController } from '../../../src/workspaces/workspaces.controller';

// MAINTAINABILITY NOTE: When a new controller is added to devcollab-api, add its class here.
// The test will then automatically enforce the deny-by-default invariant on all its methods.
const ALL_CONTROLLERS = [HealthController, AuthController, WorkspacesController] as const;

describe('DevCollab deny-by-default invariant', () => {
  for (const Controller of ALL_CONTROLLERS) {
    const proto = Controller.prototype;
    // Only test methods that are NestJS route handlers (have HTTP method path metadata)
    const methods = Object.getOwnPropertyNames(proto).filter((name) => {
      if (name === 'constructor' || typeof proto[name] !== 'function') return false;
      // Check if this method has a route path metadata (i.e., is decorated with @Get/@Post/etc.)
      const hasRoutePath = Reflect.getMetadata('path', proto[name] as object) !== undefined;
      return hasRoutePath;
    });

    describe(`${Controller.name}`, () => {
      for (const methodName of methods) {
        it(`"${methodName}" must have @Public() or @CheckAbility()`, () => {
          const handler = proto[methodName] as unknown;

          // Check @Public() at method level
          const isPublicOnMethod = Reflect.getMetadata(IS_PUBLIC_KEY, handler as object);
          // Check @Public() at class level (applies to all methods)
          const isPublicOnClass = Reflect.getMetadata(IS_PUBLIC_KEY, Controller);
          // Check @CheckAbility() at method level
          const hasCheckAbility = Reflect.getMetadata(CHECK_ABILITY_KEY, handler as object);

          expect(
            isPublicOnMethod || isPublicOnClass || hasCheckAbility,
            `\n\nVIOLATION: ${Controller.name}.${methodName}() has neither @Public() nor @CheckAbility().\n` +
              `This violates the deny-by-default security invariant.\n` +
              `Fix: Add @Public() if this is a public endpoint, or @CheckAbility(action, subject) if it requires authentication.\n`,
          ).toBeTruthy();
        });
      }
    });
  }
});
```
  </action>
  <verify>
Run: `cd /home/doctor/fernandomillan/apps/devcollab-api && npx vitest run test/unit/meta/controller-coverage.spec.ts 2>&1`
Expected: All tests pass including new tests for WorkspacesController methods (8 route handlers, each must have @CheckAbility).
  </verify>
  <done>
controller-coverage.spec.ts includes WorkspacesController. All tests pass (all 8 WorkspacesController methods have @CheckAbility). Zero test failures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Next.js 15 workspace UI pages</name>
  <files>
    apps/devcollab-web/app/w/[slug]/layout.tsx
    apps/devcollab-web/app/w/[slug]/page.tsx
    apps/devcollab-web/app/dashboard/page.tsx
    apps/devcollab-web/app/join/page.tsx
  </files>
  <action>
Create directory structure first: `apps/devcollab-web/app/w/[slug]/`

Create `apps/devcollab-web/app/w/[slug]/layout.tsx`:

```tsx
export default async function WorkspaceLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params; // CRITICAL: params is a Promise in Next.js 15

  return (
    <div style={{ fontFamily: 'system-ui, sans-serif' }}>
      <nav style={{ padding: '1rem 2rem', borderBottom: '1px solid #e5e7eb', background: '#fff' }}>
        <span style={{ fontWeight: 600 }}>Workspace: {slug}</span>
        <span style={{ marginLeft: '1rem' }}>
          <a href="/dashboard" style={{ color: '#3b82f6', textDecoration: 'none' }}>
            ← Dashboard
          </a>
        </span>
      </nav>
      <main style={{ padding: '2rem' }}>{children}</main>
    </div>
  );
}
```

Create `apps/devcollab-web/app/w/[slug]/page.tsx`:

```tsx
const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

async function getWorkspace(slug: string) {
  try {
    const res = await fetch(`${API_URL}/workspaces/${slug}`, {
      credentials: 'include',
      cache: 'no-store',
    });
    if (!res.ok) return null;
    return res.json();
  } catch {
    return null;
  }
}

export default async function WorkspacePage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params; // CRITICAL: params is a Promise in Next.js 15
  const workspace = await getWorkspace(slug);

  if (!workspace) {
    return (
      <div>
        <h1>Workspace not found</h1>
        <p>You may not be a member of this workspace, or it does not exist.</p>
      </div>
    );
  }

  return (
    <div>
      <h1 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '0.5rem' }}>
        {workspace.name}
      </h1>
      <p style={{ color: '#6b7280', marginBottom: '2rem' }}>/{workspace.slug}</p>
      <p>
        Members: <strong>{workspace.members?.length ?? 0}</strong>
      </p>
    </div>
  );
}
```

Create `apps/devcollab-web/app/join/page.tsx` (handles /join?token=...):

```tsx
'use client';

import { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { Suspense } from 'react';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

function JoinForm() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const token = searchParams.get('token') ?? '';
  const [status, setStatus] = useState<'idle' | 'joining' | 'success' | 'error'>('idle');
  const [message, setMessage] = useState('');

  useEffect(() => {
    if (token) setStatus('idle');
  }, [token]);

  async function handleJoin() {
    setStatus('joining');
    try {
      const res = await fetch(`${API_URL}/workspaces/join`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ token }),
      });
      if (res.ok) {
        setStatus('success');
        setMessage('You have joined the workspace. Redirecting...');
        setTimeout(() => router.push('/dashboard'), 1500);
      } else {
        const data = await res.json();
        setStatus('error');
        setMessage(data.message ?? 'Failed to join workspace');
      }
    } catch {
      setStatus('error');
      setMessage('Network error. Please try again.');
    }
  }

  if (!token) {
    return <p>No invite token provided. Check your invite link.</p>;
  }

  return (
    <div style={{ maxWidth: '400px' }}>
      <p style={{ marginBottom: '1rem', color: '#374151' }}>
        You have been invited to join a workspace.
      </p>
      {status === 'success' && <p style={{ color: '#059669' }}>{message}</p>}
      {status === 'error' && <p style={{ color: '#dc2626' }}>{message}</p>}
      {status !== 'success' && (
        <button
          onClick={handleJoin}
          disabled={status === 'joining'}
          style={{
            padding: '0.5rem 1.5rem',
            background: '#3b82f6',
            color: '#fff',
            border: 'none',
            borderRadius: '6px',
            cursor: status === 'joining' ? 'not-allowed' : 'pointer',
          }}
        >
          {status === 'joining' ? 'Joining...' : 'Accept Invite'}
        </button>
      )}
    </div>
  );
}

export default function JoinPage() {
  return (
    <main style={{ padding: '2rem', fontFamily: 'system-ui, sans-serif' }}>
      <h1 style={{ marginBottom: '1rem' }}>Join Workspace</h1>
      <Suspense fallback={<p>Loading...</p>}>
        <JoinForm />
      </Suspense>
    </main>
  );
}
```

Update `apps/devcollab-web/app/dashboard/page.tsx` to show workspaces and create form:

```tsx
'use client';

import { useState, useEffect } from 'react';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

interface Workspace {
  id: string;
  name: string;
  slug: string;
  members: Array<{ role: string; userId: string }>;
}

export default function DashboardPage() {
  const [workspaces, setWorkspaces] = useState<Workspace[]>([]);
  const [name, setName] = useState('');
  const [slug, setSlug] = useState('');
  const [creating, setCreating] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    fetch(`${API_URL}/workspaces`, { credentials: 'include' })
      .then((r) => r.json())
      .then((data) => Array.isArray(data) && setWorkspaces(data))
      .catch(() => {});
  }, []);

  async function handleCreate(e: React.FormEvent) {
    e.preventDefault();
    setCreating(true);
    setError('');
    try {
      const res = await fetch(`${API_URL}/workspaces`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name, slug: slug || undefined }),
      });
      if (res.ok) {
        const created = await res.json();
        setWorkspaces((prev) => [...prev, created]);
        setName('');
        setSlug('');
      } else {
        const data = await res.json();
        setError(data.message ?? 'Failed to create workspace');
      }
    } catch {
      setError('Network error. Please try again.');
    } finally {
      setCreating(false);
    }
  }

  return (
    <main style={{ padding: '2rem', fontFamily: 'system-ui, sans-serif', maxWidth: '700px' }}>
      <h1 style={{ marginBottom: '1.5rem' }}>Dashboard</h1>

      <section style={{ marginBottom: '2rem' }}>
        <h2 style={{ fontSize: '1.1rem', fontWeight: 600, marginBottom: '0.75rem' }}>
          Your Workspaces
        </h2>
        {workspaces.length === 0 ? (
          <p style={{ color: '#6b7280' }}>No workspaces yet. Create one below.</p>
        ) : (
          <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
            {workspaces.map((ws) => (
              <li key={ws.id} style={{ marginBottom: '0.5rem' }}>
                <a
                  href={`/w/${ws.slug}`}
                  style={{ color: '#3b82f6', textDecoration: 'none', fontWeight: 500 }}
                >
                  {ws.name}
                </a>
                <span style={{ color: '#9ca3af', marginLeft: '0.5rem', fontSize: '0.875rem' }}>
                  /{ws.slug} · {ws.members?.length ?? 0} member
                  {(ws.members?.length ?? 0) !== 1 ? 's' : ''}
                </span>
              </li>
            ))}
          </ul>
        )}
      </section>

      <section>
        <h2 style={{ fontSize: '1.1rem', fontWeight: 600, marginBottom: '0.75rem' }}>
          Create Workspace
        </h2>
        <form onSubmit={handleCreate} style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem', maxWidth: '320px' }}>
          <input
            type="text"
            placeholder="Workspace name"
            value={name}
            onChange={(e) => setName(e.target.value)}
            required
            style={{ padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '6px' }}
          />
          <input
            type="text"
            placeholder="Slug (optional, auto-generated)"
            value={slug}
            onChange={(e) => setSlug(e.target.value)}
            style={{ padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '6px' }}
          />
          {error && <p style={{ color: '#dc2626', fontSize: '0.875rem' }}>{error}</p>}
          <button
            type="submit"
            disabled={creating}
            style={{
              padding: '0.5rem 1rem',
              background: '#3b82f6',
              color: '#fff',
              border: 'none',
              borderRadius: '6px',
              cursor: creating ? 'not-allowed' : 'pointer',
            }}
          >
            {creating ? 'Creating...' : 'Create'}
          </button>
        </form>
      </section>

      <div style={{ marginTop: '2rem', borderTop: '1px solid #e5e7eb', paddingTop: '1rem' }}>
        <a href="/api/logout" style={{ color: '#6b7280', fontSize: '0.875rem' }}>
          Log out
        </a>
      </div>
    </main>
  );
}
```

NOTE: No purple colors used anywhere in the UI. Blues (#3b82f6) and grays (#6b7280, #9ca3af, etc.) only.
  </action>
  <verify>
Run: `cd /home/doctor/fernandomillan/apps/devcollab-web && npx tsc --noEmit 2>&1 | head -20`
Expected: No TypeScript errors in the new files.

Check no purple colors: `grep -r "purple\|#[0-9a-f]*[5-9][0-9a-f]*[5-9][0-9a-f]" apps/devcollab-web/app/w/ apps/devcollab-web/app/join/ 2>/dev/null | grep -i purple` → empty (no purple)

Verify params is awaited: `grep "await params" apps/devcollab-web/app/w/[slug]/layout.tsx apps/devcollab-web/app/w/[slug]/page.tsx`
  </verify>
  <done>
workspace layout and page created at apps/devcollab-web/app/w/[slug]/. Join page at apps/devcollab-web/app/join/page.tsx. Dashboard updated with workspace list and create form. All Next.js 15 params are awaited. TypeScript exits 0. No purple colors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Phase 16 workspace + RBAC implementation</name>
  <what-built>
  Complete Phase 16 implementation:
  - Plan 01: Prisma schema (Workspace, WorkspaceMember, InviteLink) + PrismaService accessors
  - Plan 02: WorkspaceAbilityFactory + async CaslAuthGuard + AppModule wiring
  - Plan 03: WorkspacesService + WorkspacesController (8 endpoints) + DTOs
  - Plan 04: meta-test updated + workspace web UI pages
  </what-built>
  <action>Human verifies the Phase 16 workspace, invite link, RBAC enforcement, and last-admin protection work end-to-end in a running Docker stack.</action>
  <how-to-verify>
  Start the DevCollab stack:
  ```
  docker compose up devcollab-postgres devcollab-migrate devcollab-api devcollab-web -d
  ```
  Wait ~30 seconds for migration to apply.

  1. Verify meta-test passes:
     ```
     cd apps/devcollab-api && npx vitest run test/unit/meta/controller-coverage.spec.ts
     ```
     Expected: All tests pass including WorkspacesController methods.

  2. Signup then login via the web UI at http://localhost:3002/login

  3. After login, check the dashboard at http://localhost:3002/dashboard:
     - "Your Workspaces" section should show "No workspaces yet"
     - Create a workspace using the form (e.g., name: "My Team", slug leave blank)
     - After creation, workspace appears in the list with link to /w/my-team

  4. Visit http://localhost:3002/w/my-team:
     - Workspace name "My Team" displayed
     - Member count: 1

  5. Test the API directly (success criteria 4 — Viewer 403):
     ```
     # Login as a second user via signup
     curl -c /tmp/viewer.cookie http://localhost:3003/auth/signup \
       -H "Content-Type: application/json" \
       -d '{"email":"viewer@test.com","password":"Pass123!","name":"Viewer User"}'

     # Generate invite link as Admin (first user — get cookie first)
     curl -b <admin-cookie> -X POST http://localhost:3003/workspaces/my-team/invite-links
     # Note the token in response

     # Join with viewer account
     curl -b /tmp/viewer.cookie -X POST http://localhost:3003/workspaces/join \
       -H "Content-Type: application/json" \
       -d '{"token":"<token-from-above>"}'

     # Try to create InviteLink as Contributor (should get 403)
     curl -b /tmp/viewer.cookie -X POST http://localhost:3003/workspaces/my-team/invite-links
     # Expected: 403 Forbidden
     ```

  6. Test last-admin protection (success criteria 5):
     ```
     # Try to remove yourself as the only Admin
     curl -b <admin-cookie> -X DELETE http://localhost:3003/workspaces/my-team/members/<your-userId>
     # Expected: 400 Bad Request "Cannot remove the last Admin from a workspace"
     ```
  </how-to-verify>
  <resume-signal>Type "approved" when all checks pass, or describe any failures found.</resume-signal>
</task>

</tasks>

<verification>
1. Meta-test: `cd apps/devcollab-api && npx vitest run test/unit/meta/controller-coverage.spec.ts` — all pass
2. TypeScript (api): `npx tsc --noEmit -p apps/devcollab-api/tsconfig.json` — exits 0
3. TypeScript (web): `cd apps/devcollab-web && npx tsc --noEmit` — exits 0
4. No purple: `grep -ri "purple" apps/devcollab-web/app/w/ apps/devcollab-web/app/join/` — empty
5. params awaited: `grep "await params" apps/devcollab-web/app/w/[slug]/layout.tsx apps/devcollab-web/app/w/[slug]/page.tsx` — 2 hits
</verification>

<success_criteria>
- controller-coverage.spec.ts includes WorkspacesController; all Vitest tests pass
- /w/[slug]/layout.tsx and /w/[slug]/page.tsx exist with `await params` (Next.js 15 correct pattern)
- /dashboard shows workspace list + create form
- /join?token=... page allows joining via invite link
- TypeScript exits 0 for both devcollab-api and devcollab-web
- Human verification: workspace creation, member join, Viewer 403, last-admin protection all confirmed
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspaces-membership-rbac/16-04-SUMMARY.md`
</output>
