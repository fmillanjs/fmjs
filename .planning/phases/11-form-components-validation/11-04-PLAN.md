---
phase: 11-form-components-validation
plan: "04"
type: execute
wave: 3
depends_on: ["11-02", "11-03"]
files_modified:
  - apps/web/components/tasks/task-form.tsx
  - apps/web/e2e/auth/form-accessibility.spec.ts
autonomous: false
requirements:
  - COMP-03

must_haves:
  truths:
    - "task-form uses Shadcn Select for status, priority, and assignee dropdowns (4 native selects replaced)"
    - "task-form title and description fields have aria-invalid wired via FormControl"
    - "task-form labels are all programmatically associated via htmlFor (FormLabel handles this)"
    - "All auth form routes pass axe WCAG AA audit with zero violations: /login, /signup, /reset-password"
    - "All form routes pass axe WCAG AA audit in both light and dark modes"
  artifacts:
    - path: "apps/web/components/tasks/task-form.tsx"
      provides: "Accessible task create/edit form with 4 Shadcn Select dropdowns"
      contains: "Form, FormField, FormItem, FormLabel, FormControl, FormMessage, Select, SelectTrigger, SelectContent, SelectItem"
    - path: "apps/web/e2e/auth/form-accessibility.spec.ts"
      provides: "axe WCAG AA audit for auth form routes in light and dark modes"
      exports: ["auth form accessibility tests"]
  key_links:
    - from: "apps/web/components/tasks/task-form.tsx"
      to: "apps/web/components/ui/select.tsx"
      via: "4x FormField with Shadcn Select for status, priority, assignee, dueDate type"
      pattern: "SelectTrigger.*SelectContent.*SelectItem"
    - from: "apps/web/e2e/auth/form-accessibility.spec.ts"
      to: "/login, /signup, /reset-password routes"
      via: "AxeBuilder WCAG AA audit via Playwright"
      pattern: "AxeBuilder.*withTags.*wcag2aa"
---

<objective>
Migrate the complex task-form (4 native selects + multi-field layout) to the Shadcn Form pattern, then add axe WCAG AA accessibility tests for the auth form routes to verify all Phase 11 changes achieve zero violations.

Purpose: task-form is the most-used form in the application — every task creation and edit goes through it. It has 4 native select elements (status, priority, assignee, dueDate type), a custom label toggle UI, and a modal wrapper. The accessibility tests provide automated WCAG verification to confirm the phase goal is achieved.

Output: task-form.tsx fully migrated with 4 Shadcn Selects; form-accessibility.spec.ts testing /login, /signup, /reset-password in both light and dark modes.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-form-components-validation/11-RESEARCH.md
@.planning/phases/11-form-components-validation/11-02-SUMMARY.md
@.planning/phases/11-form-components-validation/11-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate task-form.tsx with 4 Shadcn Select dropdowns</name>
  <files>
    apps/web/components/tasks/task-form.tsx
  </files>
  <action>
    task-form.tsx is the most complex form — 12 fields, 4 native selects, and a custom label toggle UI. Read the file first before starting.

    **Imports to add:**
    ```tsx
    import { Form, FormField, FormItem, FormLabel, FormControl, FormMessage } from '@/components/ui/form'
    import { Input } from '@/components/ui/input'
    import { Textarea } from '@/components/ui/textarea'
    import { Button } from '@/components/ui/button'
    import {
      Select,
      SelectContent,
      SelectItem,
      SelectTrigger,
      SelectValue,
    } from '@/components/ui/select'
    ```

    **useForm change:**
    ```tsx
    const form = useForm({
      resolver: mode === 'create' ? zodResolver(createTaskSchema) : zodResolver(updateTaskSchema),
      mode: 'onBlur',
      defaultValues: {
        title: task?.title || '',
        description: task?.description || '',
        status: task?.status || prefilledStatus || TaskStatus.TODO,
        priority: task?.priority || TaskPriority.MEDIUM,
        dueDate: task?.dueDate ? (new Date(task.dueDate).toISOString().split('T')[0] as any) : undefined,
        assigneeId: task?.assigneeId || undefined,
        labelIds: task?.labels.map((l) => l.id) || [],
        ...(mode === 'create' && { projectId }),
      },
    } as any)
    ```
    Note: Keep the `as any` cast — the schema union type is complex. The watch call changes to `const selectedLabelIds = form.watch('labelIds') || []` and setValue stays as `form.setValue(...)`.

    **Field migrations:**

    1. **Title** — FormField + Input:
       ```tsx
       <FormField control={form.control} name="title" render={({ field }) => (
         <FormItem>
           <FormLabel>Title <span className="text-[var(--red-11)]">*</span></FormLabel>
           <FormControl><Input type="text" {...field} placeholder="Task title" /></FormControl>
           <FormMessage />
         </FormItem>
       )} />
       ```

    2. **Description** — FormField + Textarea:
       ```tsx
       <FormField control={form.control} name="description" render={({ field }) => (
         <FormItem>
           <FormLabel>Description</FormLabel>
           <FormControl><Textarea rows={4} {...field} placeholder="Task description (optional)" /></FormControl>
           <FormMessage />
         </FormItem>
       )} />
       ```

    3. **Status** — FormField + Shadcn Select:
       ```tsx
       <FormField control={form.control} name="status" render={({ field }) => (
         <FormItem>
           <FormLabel>Status</FormLabel>
           <Select onValueChange={field.onChange} defaultValue={field.value}>
             <FormControl>
               <SelectTrigger><SelectValue placeholder="Select status" /></SelectTrigger>
             </FormControl>
             <SelectContent>
               <SelectItem value={TaskStatus.TODO}>To Do</SelectItem>
               <SelectItem value={TaskStatus.IN_PROGRESS}>In Progress</SelectItem>
               <SelectItem value={TaskStatus.DONE}>Done</SelectItem>
               <SelectItem value={TaskStatus.BLOCKED}>Blocked</SelectItem>
             </SelectContent>
           </Select>
           <FormMessage />
         </FormItem>
       )} />
       ```

    4. **Priority** — same Shadcn Select pattern:
       Options: LOW=Low, MEDIUM=Medium, HIGH=High, URGENT=Urgent

    5. **Due Date** — FormField + Input (type="date" — keep as native date input, no select needed):
       ```tsx
       <FormField control={form.control} name="dueDate" render={({ field }) => (
         <FormItem>
           <FormLabel>Due Date</FormLabel>
           <FormControl><Input type="date" {...field} /></FormControl>
           <FormMessage />
         </FormItem>
       )} />
       ```

    6. **Assignee** — FormField + Shadcn Select:
       ```tsx
       <Select onValueChange={field.onChange} defaultValue={field.value}>
         <FormControl>
           <SelectTrigger><SelectValue placeholder="Unassigned" /></SelectTrigger>
         </FormControl>
         <SelectContent>
           <SelectItem value="">Unassigned</SelectItem>
           {teamMembers.map((member) => (
             <SelectItem key={member.id} value={member.id}>
               {member.name || member.email}
             </SelectItem>
           ))}
         </SelectContent>
       </Select>
       ```

    **Labels toggle (keep as-is):**
    The labels section uses custom button toggles — NOT a select. This is a multi-select pattern using setValue('labelIds', ...). Keep the toggle logic unchanged. The label is already text "Labels" (no htmlFor needed since it's not an input — it's a visual group label). Add a `<div role="group" aria-labelledby="labels-heading">` wrapper with `<p id="labels-heading" className="...">Labels</p>` for accessibility.

    **Error div:**
    Add role="alert" to the error div at the top of the form.

    **Footer buttons:**
    Replace raw buttons with Button component:
    - Cancel: `<Button type="button" variant="outline" onClick={onClose} disabled={isSubmitting}>Cancel</Button>`
    - Submit: `<Button type="submit" disabled={isSubmitting}>{isSubmitting ? 'Saving...' : mode === 'create' ? 'Create Task' : 'Save Changes'}</Button>`

    **Wrap with Form:**
    The outer modal div (fixed inset-0...) and card div stay unchanged. Only the `<form>` element gains the `<Form {...form}>` wrapper.

    **Remove:** All `{...register(...)}` spreads.
  </action>
  <verify>
    ```bash
    # Check Shadcn Form + Select imports
    grep "from '@/components/ui/form'" apps/web/components/tasks/task-form.tsx
    grep "from '@/components/ui/select'" apps/web/components/tasks/task-form.tsx

    # Check 3 Select fields (status, priority, assignee) have onValueChange
    grep -c "onValueChange" apps/web/components/tasks/task-form.tsx

    # Check no register() calls remain
    grep "register(" apps/web/components/tasks/task-form.tsx || echo "Clean"

    # Check mode: 'onBlur'
    grep "mode: 'onBlur'" apps/web/components/tasks/task-form.tsx

    # TypeScript check
    cd apps/web && npx tsc --noEmit 2>&1 | grep "task-form" || echo "No TS errors"
    ```
  </verify>
  <done>
    task-form.tsx uses FormField for all fields. 3 native selects replaced with Shadcn Select (status, priority, assignee). Due date uses Input type="date". No register() calls remain. mode: 'onBlur' active. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add axe WCAG AA accessibility tests for auth form routes</name>
  <files>
    apps/web/e2e/auth/form-accessibility.spec.ts
  </files>
  <action>
    Create a new Playwright accessibility test file that audits the auth form routes using the same pattern as the existing portfolio accessibility tests at apps/web/e2e/portfolio/accessibility.spec.ts.

    The test must:
    1. Test /login, /signup, /reset-password routes (public — no auth required)
    2. Run in both light and dark modes (following the dark mode pattern from portfolio tests: addInitScript to set localStorage before navigation)
    3. Use AxeBuilder with wcag2a + wcag2aa + wcag21aa tags
    4. Assert zero violations

    ```typescript
    // apps/web/e2e/auth/form-accessibility.spec.ts
    import { test, expect } from '@playwright/test'
    import AxeBuilder from '@axe-core/playwright'

    // Auth form routes are public — no auth needed
    test.use({ storageState: { cookies: [], origins: [] } })

    const authFormRoutes = ['/login', '/signup', '/reset-password']

    test.describe('Auth Form Accessibility - WCAG AA', () => {
      for (const path of authFormRoutes) {
        test(`${path} - light mode`, async ({ page }) => {
          await page.goto(path)
          await page.waitForLoadState('networkidle')
          const results = await new AxeBuilder({ page })
            .withTags(['wcag2a', 'wcag2aa', 'wcag21aa'])
            .analyze()
          expect(results.violations).toEqual([])
        })

        test(`${path} - dark mode`, async ({ page }) => {
          // Set dark mode in localStorage BEFORE navigation so next-themes initializes
          // in dark mode — ensures CSS custom properties resolve correctly on first render.
          await page.addInitScript(() => {
            localStorage.setItem('theme', 'dark')
          })
          await page.goto(path)
          await page.waitForLoadState('networkidle')
          await page.waitForTimeout(200)
          const results = await new AxeBuilder({ page })
            .withTags(['wcag2a', 'wcag2aa', 'wcag21aa'])
            .analyze()
          expect(results.violations).toEqual([])
        })
      }
    })
    ```

    Then run the tests to verify the migrations from plans 02 and 03 produce zero violations:
    ```bash
    cd apps/web && npx playwright test e2e/auth/form-accessibility.spec.ts --reporter=list
    ```

    If violations are found, fix them in the relevant form file before marking this task done. Common issues to look for:
    - Missing FormMessage in a FormItem (Shadcn aria-describedby bug)
    - A field that wasn't migrated (still uses register pattern)
    - Color contrast issue on error text (text-[var(--red-11)] should be WCAG compliant from Phase 10)
  </action>
  <verify>
    ```bash
    # Test file exists
    ls apps/web/e2e/auth/form-accessibility.spec.ts

    # Run the tests (requires dev server running — start it first)
    cd /home/doctor/fernandomillan && docker compose -f docker-compose.dev.yml up -d 2>/dev/null || true
    cd apps/web && npx playwright test e2e/auth/form-accessibility.spec.ts --reporter=list 2>&1
    ```
  </verify>
  <done>
    form-accessibility.spec.ts exists and tests /login, /signup, /reset-password in both light and dark modes.
    All 6 tests pass with zero axe violations.
    Test output shows "6 passed".
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of keyboard navigation and ARIA attributes</name>
  <what-built>
    All 12 application forms migrated to Shadcn Form pattern:
    - 6 auth forms: login, signup, reset-password-request, reset-password, profile, change-password
    - 5 dashboard/portfolio forms: team-form, invite-member-form, project-form, comment-form, contact-form
    - 1 complex form: task-form with 3 Shadcn Select dropdowns
    - New: e2e/auth/form-accessibility.spec.ts (6 axe tests passing)
  </what-built>
  <how-to-verify>
    1. Start the dev server: `cd /home/doctor/fernandomillan && docker compose -f docker-compose.dev.yml up -d`
    2. Visit http://localhost:3000/login — tab through the form fields. Verify: Tab moves email → password → submit button. Enter key submits.
    3. On login form, submit with empty fields. Verify: error messages appear under each field (not just the submit button area). Tab to an input — its error message is announced.
    4. Type an invalid email then tab away. Verify: error appears immediately on blur (not on keystroke, not only on submit).
    5. Submit with invalid credentials. Verify: "Invalid email or password" error appears in a highlighted box above the form.
    6. Visit http://localhost:3000/signup — verify same keyboard behavior.
    7. Visit http://localhost:3000/teams (after login) → Create a task. Verify: Status and Priority dropdowns open with keyboard (Space/Enter), options navigable with arrow keys.
    8. Open browser DevTools → Accessibility panel. Click the email input on the login form. Verify: aria-invalid and aria-describedby attributes are present.
  </how-to-verify>
  <resume-signal>Type "approved" if keyboard navigation and ARIA attributes look correct, or describe issues found</resume-signal>
  <action>Human verifies keyboard navigation and ARIA attributes in browser as described in how-to-verify above.</action>
  <verify>All 8 verification steps in how-to-verify confirm correct behavior.</verify>
  <done>User types "approved" confirming keyboard navigation works and ARIA attributes (aria-invalid, aria-describedby) are present in DevTools.</done>
</task>

</tasks>

<verification>
- [ ] task-form.tsx uses FormField for all 12 fields
- [ ] task-form.tsx has 3 Shadcn Select dropdowns (status, priority, assignee) with onValueChange pattern
- [ ] No register() calls in task-form.tsx
- [ ] form-accessibility.spec.ts exists at apps/web/e2e/auth/form-accessibility.spec.ts
- [ ] All 6 axe tests pass (3 routes x 2 modes): `npx playwright test e2e/auth/form-accessibility.spec.ts`
- [ ] Human visual verification: keyboard navigation works, ARIA attributes visible in DevTools
</verification>

<success_criteria>
task-form.tsx migrated with accessible Shadcn Select dropdowns. Automated axe tests confirm all auth form routes pass WCAG AA with zero violations in both light and dark modes. Human verification confirms keyboard navigation and screen reader attributes function correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/11-form-components-validation/11-04-SUMMARY.md`
</output>
