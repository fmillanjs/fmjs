---
phase: 05.1-authentication-investigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/(dashboard)/layout.tsx
  - apps/web/lib/auth.ts
autonomous: true

must_haves:
  truths:
    - "All Server Components properly await auth() calls"
    - "Session callback logs show when session is accessed during SSR"
    - "Developer can see session state during Server Component rendering"
    - "Null session handling is explicit and documented"
  artifacts:
    - path: "apps/web/lib/auth.ts"
      provides: "Session callback logging for SSR debugging"
      contains: "SSR"
    - path: "apps/web/app/(dashboard)/layout.tsx"
      provides: "Session access pattern verification"
      min_lines: 65
    - path: ".planning/phases/05.1-authentication-investigation/05.1-SSR-AUDIT.md"
      provides: "Complete audit of Server Component auth() usage"
      min_lines: 30
  key_links:
    - from: "apps/web/app/(dashboard)/layout.tsx"
      to: "auth()"
      via: "await in async Server Component"
      pattern: "const session = await auth\\(\\)"
    - from: "apps/web/lib/auth.ts"
      to: "session callback"
      via: "NextAuth callbacks"
      pattern: "async session\\("
---

<objective>
Audit all Server Components for proper async session access and add diagnostic logging to understand SSR session behavior in Next.js 15.

Purpose: Verify that all Server Components correctly await auth() and handle null sessions, and identify any SSR-specific session access issues during initial page render.

Output: Complete audit document showing auth() usage patterns across codebase, plus session callback logging showing SSR access patterns.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-authentication-investigation/05.1-RESEARCH.md

# Current implementation files
@apps/web/lib/auth.ts
@apps/web/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSR session callback logging</name>
  <files>
    apps/web/lib/auth.ts
  </files>
  <action>
Update the session callback (around line 158-207) to add diagnostic logging that differentiates SSR from client-side session access.

At the very start of the session callback, before any logic, add:

```typescript
async session({ session, token }) {
  const customToken = token as typeof token & CustomJWT;

  // SSR diagnostic logging
  const isSSR = typeof window === 'undefined';
  console.log(`[NextAuth Session Callback] ${isSSR ? 'SSR' : 'Client'}:`, {
    timestamp: new Date().toISOString(),
    hasToken: !!customToken,
    hasSessionToken: !!customToken.sessionToken,
    tokenId: customToken.id || 'none',
  });

  // ... existing session callback logic
```

After successful user fetch and accessToken generation (around line 203), add:

```typescript
session.accessToken = accessToken;

console.log(`[NextAuth Session Callback] ${isSSR ? 'SSR' : 'Client'} Success:`, {
  userId: user.id,
  hasAccessToken: !!session.accessToken,
  accessTokenLength: accessToken.length,
});
```

Before returning empty session on Redis verification failure (around line 165-175), add:

```typescript
console.warn(`[NextAuth Session Callback] ${isSSR ? 'SSR' : 'Client'} Failure:`, {
  reason: 'Redis session not found or expired',
  sessionToken: customToken.sessionToken,
});
```

This logging will reveal:
1. Whether session callback is being called during SSR vs client hydration
2. Whether Redis session lookup succeeds during SSR
3. Whether accessToken is being generated during SSR
4. Timing of session callback invocations

Leave all existing logic unchanged - only add console.log statements.
  </action>
  <verify>
1. Start dev server: `npm run dev --workspace=web`
2. Navigate to http://localhost:3000/login in fresh incognito window
3. Login as demo1@teamflow.dev
4. Check terminal (server logs) for "[NextAuth Session Callback] SSR:" logs
5. Check browser console for "[NextAuth Session Callback] Client:" logs
6. Navigate to a team page
7. Verify both SSR and Client logs appear showing session access patterns
  </verify>
  <done>
Session callback logs clearly distinguish SSR from client-side access. Terminal shows SSR session callbacks during page render. Browser console shows client-side session callbacks during hydration/navigation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit Server Components for auth() usage patterns</name>
  <files>
    .planning/phases/05.1-authentication-investigation/05.1-SSR-AUDIT.md
  </files>
  <action>
Search the codebase for all Server Components that call auth() and document their usage patterns.

1. Find all layout.tsx and page.tsx files in app directory:
   ```bash
   find apps/web/app -name "layout.tsx" -o -name "page.tsx"
   ```

2. For each file, check if it imports and calls auth():
   - Grep for `import.*auth.*from.*@/lib/auth`
   - Grep for `auth()`

3. Create SSR-AUDIT.md with the following structure:

```markdown
# SSR Session Access Audit

**Audit Date:** 2026-02-15
**Next.js Version:** 15.1.0
**NextAuth Version:** 5.0.0-beta.30

## Findings Summary

- Total Server Components: X
- Components using auth(): Y
- Properly awaited: Z
- Missing await: N (list below)
- Null handling present: M

## Server Components Using Auth

### apps/web/app/(dashboard)/layout.tsx

**Status:** ✅ CORRECT

```typescript
const session = await auth();  // ✅ Properly awaited

if (!session?.user) {           // ✅ Null handling present
  redirect('/login');
}
```

**Pattern:** Await auth(), handle null with redirect

---

### [Repeat for each Server Component found]

## Issues Found

[List any components missing await or null handling]

## Recommendations

1. [Any patterns that should be updated]
2. [Any missing null checks]
3. [Any synchronous auth() calls to fix]

## Next.js 15 Compliance

**cookies() async requirement:** [Verification status]
**headers() async requirement:** [Verification status]
**auth() async requirement:** [Verification status - should always be awaited]
```

4. Search for any direct cookies() or headers() usage:
   ```bash
   grep -r "cookies()" apps/web/app --include="*.tsx" --include="*.ts"
   grep -r "headers()" apps/web/app --include="*.tsx" --include="*.ts"
   ```

5. Document any direct usage and verify it's awaited

6. Check if auth() is ever called without await:
   ```bash
   grep -r "= auth()" apps/web/app --include="*.tsx" --include="*.ts"
   grep -r "const session = auth()" apps/web/app
   ```

Include actual code excerpts in the audit document.
  </action>
  <verify>
1. Read .planning/phases/05.1-authentication-investigation/05.1-SSR-AUDIT.md
2. Verify it lists all Server Components using auth()
3. Verify each component shows whether await is present
4. Verify it documents null handling patterns
5. Verify it includes recommendations section
6. Check that dashboard layout is documented as correct pattern
  </verify>
  <done>
SSR-AUDIT.md exists documenting all Server Component auth() usage, showing which components properly await auth(), which handle null sessions, and listing any issues found. Clear recommendations provided for any non-compliant patterns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test SSR session access and document findings</name>
  <files>
    .planning/phases/05.1-authentication-investigation/05.1-FINDINGS.md
  </files>
  <action>
Test SSR session access in various scenarios and append findings to FINDINGS.md.

**Test Scenarios:**

1. **Fresh page load (SSR):**
   - Clear browser data
   - Login as demo1@teamflow.dev
   - Navigate to /teams
   - Check terminal logs for SSR session callback
   - Check if session.user is populated

2. **Client-side navigation:**
   - After scenario 1, click to navigate to a team
   - Check browser console for Client session callback
   - Verify session persists

3. **Page refresh:**
   - Refresh current page
   - Check terminal for SSR session callback
   - Verify session still present

4. **Session expiry simulation:**
   - Wait for Redis session TTL or manually delete from Redis
   - Refresh page
   - Check if properly redirects to login

Append to FINDINGS.md (create new section):

```markdown
## SSR Session Access Findings

**Test Date:** 2026-02-15

### Scenario 1: Fresh Page Load (SSR)

**Expected:** Session callback runs on server, auth() returns session

**Actual:**
- Terminal logs show: [paste actual log]
- Session populated: [yes/no]
- User redirected: [yes/no]
- Error messages: [if any]

**Analysis:** [What this reveals about SSR session access]

---

### Scenario 2: Client-Side Navigation

[Same structure]

---

### Scenario 3: Page Refresh

[Same structure]

---

### Scenario 4: Session Expiry

[Same structure]

---

## SSR Root Cause Analysis

Based on testing, the SSR session issue is caused by:

[State clear hypothesis with evidence from logs]

Possible causes:
1. ❌/✅ Session callback returns empty session during SSR
2. ❌/✅ Redis lookup fails during SSR
3. ❌/✅ cookies() not properly awaited
4. ❌/✅ Timing issue with session cookie availability
5. ❌/✅ auth() not awaited in some Server Components

**Confirmed cause:** [Based on log evidence]

## Recommended Fix

[What needs to change in Phase 5.2]
```

Include actual log excerpts and timestamps to show sequence of events.
  </action>
  <verify>
1. Read FINDINGS.md SSR section
2. Verify all 4 test scenarios are documented
3. Verify actual log excerpts are included (not just descriptions)
4. Verify root cause analysis is present with evidence
5. Verify recommended fix is stated
  </verify>
  <done>
FINDINGS.md includes comprehensive SSR session testing results with actual logs from server and client. Root cause of SSR session issue is identified with supporting evidence. Clear recommendation for Phase 5.2 implementation is documented.
  </done>
</task>

</tasks>

<verification>
1. Session callback logs distinguish SSR from client-side access
2. SSR-AUDIT.md documents all Server Component auth() usage patterns
3. FINDINGS.md includes SSR test results with actual log excerpts
4. Root cause hypothesis for SSR issue is documented
5. All Server Components using auth() are verified to use await
6. Null session handling patterns are documented
</verification>

<success_criteria>
- Complete visibility into when and how session callback is invoked during SSR
- All Server Components using auth() are documented and audited
- SSR session access patterns are tested and documented
- Root cause of SSR issues (if any) is identified with evidence
- Phase 5.2 has clear implementation guidance for SSR fixes
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-authentication-investigation/05.1-02-SUMMARY.md` following the summary template.
</output>
