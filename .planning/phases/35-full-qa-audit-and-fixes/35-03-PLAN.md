---
phase: 35-full-qa-audit-and-fixes
plan: 03
type: execute
wave: 2
depends_on:
  - 35-01
files_modified:
  - apps/teamflow/**
  - apps/web/app/(portfolio)/**
autonomous: false
requirements:
  - QA-02
  - QA-04

must_haves:
  truths:
    - "Recruiter can log into teamflow.fernandomillan.me with demo credentials and land on the project board"
    - "Kanban board displays tasks across columns (Todo, In Progress, Done)"
    - "Moving a task between columns persists the change after page refresh"
    - "Real-time presence indicator shows online users (WebSocket connected)"
    - "Task detail view opens and shows all fields"
    - "Lighthouse CI performance >= 0.90 on all 5 portfolio URLs: /, /projects, /projects/teamflow, /projects/devcollab, /contact"
  artifacts:
    - path: "apps/web/lighthouserc.json"
      provides: "Lighthouse CI configuration with production URL overrides"
      contains: "fernandomillan.me"
  key_links:
    - from: "teamflow.fernandomillan.me/login"
      to: "NextAuth /api/auth/callback/credentials"
      via: "credentials provider with AUTH_TRUST_HOST=true"
      pattern: "AUTH_TRUST_HOST"
    - from: "Kanban board WebSocket"
      to: "NestJS API Socket.IO server"
      via: "wss://teamflow.fernandomillan.me/socket.io"
      pattern: "socket.io"
---

<objective>
Walk the complete TeamFlow recruiter flow on live production, document and fix any bugs, then run Lighthouse CI against all 5 portfolio URLs as the final QA-04 gate for Phase 35.

Purpose: QA-02 requires the TeamFlow flow (login → project board → task management → real-time presence) works without errors. QA-04 requires Lighthouse performance >= 0.90 on all 5 public portfolio URLs. This is the final verification gate for Phase 35.
Output: Bug-free TeamFlow recruiter flow confirmed. Lighthouse CI report showing all 5 URLs >= 0.90 performance.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-full-qa-audit-and-fixes/35-RESEARCH.md
@.planning/phases/35-full-qa-audit-and-fixes/35-01-SUMMARY.md
@.planning/phases/35-full-qa-audit-and-fixes/35-02-SUMMARY.md

<interfaces>
<!-- Key context from Phase 34 fixes and research. -->

TeamFlow auth (Phase 34 fixes applied):
- AUTH_SECRET env var (v5 renamed from NEXTAUTH_SECRET) — set in Coolify
- AUTH_TRUST_HOST=true — set in Coolify (required for reverse proxy)
- Demo credentials from page.tsx: demo1@teamflow.dev / Password123

Phase 34 fixes that are live:
- PORT vs API_PORT env var mismatch — fixed
- Redis deadlock in connectToRedis() — fixed
- CORS_ORIGIN env var — fixed to match teamflow.fernandomillan.me
- AUTH_TRUST_HOST=true — added to Coolify

Socket.IO presence check (from research pitfall 2):
After login, open browser devtools → Network → WS tab.
Confirm: WebSocket connection to wss://teamflow.fernandomillan.me/socket.io/... established.
If connection fails: check CORS_ORIGIN env var in NestJS API container in Coolify.

Lighthouse CI — run against production (not localhost):
```bash
# From /home/doctor/fernandomillan/apps/web
# Override startServerCommand by using --collect.url flags directly
# CHROME_PATH required on WSL2 (from Phase 29 pattern):
CHROME_PATH=$(ls ~/.cache/puppeteer/chrome/linux-*/chrome-linux64/chrome 2>/dev/null | head -1)
npx lhci autorun \
  --collect.url="https://fernandomillan.me/" \
  --collect.url="https://fernandomillan.me/projects" \
  --collect.url="https://fernandomillan.me/projects/teamflow" \
  --collect.url="https://fernandomillan.me/projects/devcollab" \
  --collect.url="https://fernandomillan.me/contact" \
  --collect.numberOfRuns=3 \
  --collect.settings.chromeFlags="--no-sandbox --disable-dev-shm-usage" \
  --assert.assertions."categories:performance"=["error",{"minScore":0.9}] \
  --upload.target=temporary-public-storage
```

Note: The existing lighthouserc.json uses startServerCommand for localhost. When running with --collect.url CLI overrides, lhci skips startServerCommand entirely and audits the provided URLs directly.

Fix-then-redeploy pattern:
```bash
git add apps/teamflow/...
git commit -m "fix(teamflow): <description>"
git push origin main
# CI builds teamflow-web and teamflow-api images → Coolify redeploys
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: TeamFlow API health check and WebSocket pre-verification</name>
  <files></files>
  <action>
    Run automated checks to surface any infrastructure issues before the human walkthrough:

    1. Confirm TeamFlow frontend is reachable:
    ```bash
    curl -s -o /dev/null -w "%{http_code}" https://teamflow.fernandomillan.me/ 2>/dev/null
    ```
    Expected: 200.

    2. Confirm NextAuth login endpoint responds:
    ```bash
    curl -s -o /dev/null -w "%{http_code}" https://teamflow.fernandomillan.me/api/auth/providers 2>/dev/null
    ```
    Expected: 200 with JSON containing credentials provider.

    3. Confirm the NestJS API (separate container) is reachable:
    ```bash
    curl -s -o /dev/null -w "%{http_code}" https://teamflow.fernandomillan.me/api/health 2>/dev/null || echo "API health endpoint not available — try /api"
    ```

    Document results. If any check returns 502/503/connection refused, the Coolify container may be down — note it for the human to check Coolify dashboard before the walkthrough.

    If issues are found in source code (not infrastructure), implement fixes using the fix-then-redeploy pattern. Wait for CI/CD (~3-5 min) before re-checking.
  </action>
  <verify>
    TeamFlow frontend returns HTTP 200. NextAuth providers endpoint returns 200 with credentials provider in the JSON.
  </verify>
  <done>TeamFlow is reachable on production. No 502/503 errors. Auth endpoint responds correctly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: TeamFlow recruiter walkthrough — human browser verification</name>
  <what-built>
    TeamFlow infrastructure confirmed reachable (Task 1). The full recruiter flow requires human walkthrough — NextAuth session state, Kanban drag-and-drop, and WebSocket presence are all interactive browser features.
  </what-built>
  <how-to-verify>
    Walk this exact flow in a browser (incognito/private window):

    1. Open https://teamflow.fernandomillan.me in incognito
    2. Confirm: NextAuth login page is visible. Is the URL /login or /api/auth/signin?
    3. Enter email: demo1@teamflow.dev / password: Password123 — click Sign In
    4. Confirm: Redirected to /teams (teams list page)? Not an error or infinite loop?
    5. Click into a team → click into a project → Kanban board loads?
    6. Confirm: Tasks are visible across columns (not an empty board)
    7. Drag a task from one column to another — does the position persist? (Refresh the page to confirm it saved)
    8. Click a task to open its detail panel — do all fields (title, description, assignee, status) display?
    9. Check devtools → Network → WS tab: is there a WebSocket connection to wss://teamflow.fernandomillan.me?
    10. Confirm: Presence indicator (online users badge/avatar list) shows at least 1 user online (yourself)
    11. Click Logout (profile menu or logout link) — does it return to login page?

    For each step that fails:
    - Note the URL at time of failure
    - Note the browser console error (F12 → Console)
    - Note failed API calls (F12 → Network tab)
    - Report: "Step N failed: [description]"

    If ALL 11 steps pass: type "approved-teamflow"
    If any fails: describe each failure for Claude to investigate and fix.
  </how-to-verify>
  <resume-signal>Type "approved-teamflow" if all 11 steps pass, or describe each failure with step number and error details.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Lighthouse CI gate — all 5 portfolio URLs >= 0.90 performance</name>
  <files></files>
  <action>
    After the TeamFlow walkthrough checkpoint is cleared (and any fixes are deployed), run Lighthouse CI against all 5 production portfolio URLs.

    First, find Chrome path for WSL2 (from Phase 29 established pattern):
    ```bash
    CHROME_PATH=$(ls /home/doctor/.cache/puppeteer/chrome/linux-*/chrome-linux64/chrome 2>/dev/null | head -1)
    echo "Chrome: $CHROME_PATH"
    ```

    Run lhci from apps/web directory, targeting production URLs directly:
    ```bash
    cd /home/doctor/fernandomillan/apps/web && \
    CHROME_PATH=$(ls /home/doctor/.cache/puppeteer/chrome/linux-*/chrome-linux64/chrome 2>/dev/null | head -1) \
    npx lhci autorun \
      --collect.url="https://fernandomillan.me/" \
      --collect.url="https://fernandomillan.me/projects" \
      --collect.url="https://fernandomillan.me/projects/teamflow" \
      --collect.url="https://fernandomillan.me/projects/devcollab" \
      --collect.url="https://fernandomillan.me/contact" \
      --collect.numberOfRuns=3 \
      --collect.settings.chromeFlags="--no-sandbox --disable-dev-shm-usage" \
      --upload.target=temporary-public-storage 2>&1 | tail -40
    ```

    The command uses the CLI `--collect.url` flags which override `lighthouserc.json`'s `startServerCommand` — lhci will NOT start a local server and will audit the live URLs directly.

    If the command fails due to Chrome detection, try adding `--collect.chromePath=$CHROME_PATH` to the command.

    Interpret results:
    - If all 5 URLs pass performance >= 0.90: QA-04 is satisfied. Note the scores.
    - If any URL fails performance < 0.90: Identify which resource is causing the regression. DO NOT add new JS or images to fix it. DO NOT weaken the assertion. Investigate if any fix from Plan 35-01 or 35-02 introduced a performance regression. If the lighthouserc.json startServerCommand is interfering, modify lighthouserc.json to remove startServerCommand temporarily (or add a separate `--config=/dev/null` approach).
    - The upload.target=temporary-public-storage will print a URL with the full Lighthouse report — include that URL in the summary.
  </action>
  <verify>
    lhci autorun exits with code 0. Output contains "All assertions passed" or shows all 5 URLs with performance >= 0.90. The temporary-public-storage URL is printed and accessible.
  </verify>
  <done>Lighthouse CI passes: all 5 portfolio URLs (/, /projects, /projects/teamflow, /projects/devcollab, /contact) report performance >= 0.90. QA-04 satisfied.</done>
</task>

</tasks>

<verification>
1. TeamFlow health check: `curl -s -o /dev/null -w "%{http_code}" https://teamflow.fernandomillan.me/` returns 200
2. Human walkthrough: all 11 TeamFlow recruiter flow steps pass without errors
3. Lighthouse CI: `lhci autorun` exits 0 with all 5 URLs >= 0.90 performance
4. Any code fixes committed and pushed (no VPS hotfixes)
5. Lighthouse report URL from temporary-public-storage recorded in summary
</verification>

<success_criteria>
- Login → teams → project → Kanban → task management → presence → logout: all steps work without errors
- WebSocket connection to teamflow.fernandomillan.me established (presence indicators work)
- Lighthouse CI: all 5 portfolio URLs report performance >= 0.90 (QA-04 gate passes)
- Phase 35 complete: QA-01, QA-02, QA-03, QA-04 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/35-full-qa-audit-and-fixes/35-03-SUMMARY.md` following the standard summary template. Include:
- Every TeamFlow bug found and the fix applied
- Lighthouse CI scores for all 5 URLs (copy from lhci output)
- The temporary-public-storage report URL
- Confirmation that all 4 QA requirements (QA-01 through QA-04) are satisfied
</output>
