---
phase: 04-portfolio-polish
plan: 08
type: execute
wave: 4
depends_on: ["04-05", "04-06"]
files_modified:
  - apps/web/vitest.config.mts
  - apps/web/__tests__/setup.ts
  - apps/web/__tests__/api/contact.test.ts
  - apps/web/__tests__/components/ui/skeleton.test.tsx
  - apps/web/__tests__/components/ui/empty-state.test.tsx
  - apps/api/test/unit/rbac/ability.spec.ts
  - apps/api/test/unit/rbac/guards.spec.ts
  - apps/api/test/integration/tasks/tasks.spec.ts
  - apps/web/package.json
  - apps/api/package.json
autonomous: true

must_haves:
  truths:
    - "Vitest runs and passes unit tests for UI components"
    - "Contact form server action validation is tested"
    - "RBAC ability definitions have unit tests verifying role permissions"
    - "API endpoint validation is tested for task CRUD"
  artifacts:
    - path: "apps/web/vitest.config.mts"
      provides: "Vitest configuration for web app"
    - path: "apps/web/__tests__/setup.ts"
      provides: "Test setup with DOM matchers"
    - path: "apps/web/__tests__/api/contact.test.ts"
      provides: "Contact form validation tests"
    - path: "apps/api/test/unit/rbac/ability.spec.ts"
      provides: "RBAC ability factory unit tests"
    - path: "apps/api/test/unit/rbac/guards.spec.ts"
      provides: "RBAC guard unit tests"
  key_links:
    - from: "apps/web/vitest.config.mts"
      to: "apps/web/__tests__/"
      via: "test runner configuration"
      pattern: "setupFiles.*setup\\.ts"
    - from: "apps/api/test/unit/rbac/ability.spec.ts"
      to: "apps/api/src/auth/ability.factory.ts"
      via: "imports ability factory for testing"
      pattern: "import.*AbilityFactory|defineAbility"
---

<objective>
Set up testing infrastructure and write unit/integration tests for critical paths: RBAC permissions, contact form validation, UI components, and API endpoint validation.

Purpose: Testing demonstrates engineering maturity. RBAC and auth tests prove the security model works. Component tests prove UI reliability.
Output: Configured Vitest for web, unit tests for RBAC and components, integration tests for API validation.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-portfolio-polish/04-RESEARCH.md
@.planning/phases/04-portfolio-polish/04-05-SUMMARY.md
@apps/web/package.json
@apps/api/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vitest Setup + Web App Tests (Contact, Components)</name>
  <files>
    apps/web/package.json
    apps/web/vitest.config.mts
    apps/web/__tests__/setup.ts
    apps/web/__tests__/api/contact.test.ts
    apps/web/__tests__/components/ui/skeleton.test.tsx
    apps/web/__tests__/components/ui/empty-state.test.tsx
  </files>
  <action>
    Set up Vitest for the web app and write initial tests:

    1. **Install test dependencies** in apps/web:
       ```
       npm install -D vitest @vitejs/plugin-react jsdom @testing-library/react @testing-library/dom @testing-library/jest-dom vite-tsconfig-paths
       ```

    2. **Vitest config** (apps/web/vitest.config.mts):
       ```typescript
       import { defineConfig } from 'vitest/config'
       import react from '@vitejs/plugin-react'
       import tsconfigPaths from 'vite-tsconfig-paths'

       export default defineConfig({
         plugins: [tsconfigPaths(), react()],
         test: {
           environment: 'jsdom',
           setupFiles: ['./__tests__/setup.ts'],
           globals: true,
         },
       })
       ```

    3. **Test setup** (apps/web/__tests__/setup.ts):
       ```typescript
       import '@testing-library/jest-dom/vitest'
       ```

    4. **Add test script** to apps/web/package.json:
       - "test": "vitest run"
       - "test:watch": "vitest"

    5. **Contact form validation tests** (apps/web/__tests__/api/contact.test.ts):
       - Test the contactSchema directly (import from actions/contact.ts)
       - Test cases:
         - Empty data fails validation with all field errors
         - Missing name fails with name error
         - Invalid email fails with email error
         - Short message (<10 chars) fails with message error
         - Valid data passes validation
         - Message > 1000 chars fails (if max applied)

    6. **Skeleton component test** (apps/web/__tests__/components/ui/skeleton.test.tsx):
       - Renders with animate-pulse class
       - Accepts and applies custom className
       - Renders as a div element

    7. **EmptyState component test** (apps/web/__tests__/components/ui/empty-state.test.tsx):
       - Renders title and description
       - Renders icon
       - Renders action button when provided
       - Does not render action when not provided
  </action>
  <verify>
    - `cd apps/web && npx vitest run` — all tests pass
    - vitest.config.mts exists with jsdom environment
    - At least 6 contact validation test cases
    - At least 3 skeleton tests
    - At least 3 empty-state tests
  </verify>
  <done>
    Vitest configured for web app. Contact form schema has 6+ validation tests. Skeleton and EmptyState components have render tests. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: RBAC Unit Tests + API Validation Tests</name>
  <files>
    apps/api/package.json
    apps/api/test/unit/rbac/ability.spec.ts
    apps/api/test/unit/rbac/guards.spec.ts
    apps/api/test/integration/tasks/tasks.spec.ts
  </files>
  <action>
    Write RBAC and API tests for the NestJS backend:

    1. **Check existing test setup**: NestJS projects typically include Jest by default. Check if apps/api/package.json has jest or vitest. Use whichever is configured. If neither, set up Vitest for consistency.

    2. **RBAC Ability Factory tests** (apps/api/test/unit/rbac/ability.spec.ts):
       - Import the ability factory/definition from the auth module
       - Test each role's permissions:

       ADMIN role:
       - Can manage all resources (organizations, projects, tasks, users)
       - Can delete projects
       - Can view audit logs
       - Can remove members

       MANAGER role:
       - Can create projects
       - Can manage tasks
       - Can invite members
       - Cannot delete projects (only admin)
       - Cannot view organization-wide audit logs

       MEMBER role:
       - Can read projects
       - Can create/update own tasks
       - Cannot create projects
       - Cannot invite members
       - Cannot delete other users' tasks

       Each test: create ability for role, check can/cannot for specific actions.

    3. **RBAC Guard tests** (apps/api/test/unit/rbac/guards.spec.ts):
       - Test the RBAC guard logic:
       - Public routes bypass guard (returns true)
       - Missing user throws UnauthorizedException
       - User without required ability throws ForbiddenException
       - User with required ability passes (returns true)
       - Mock ExecutionContext with request containing user

    4. **Task API validation tests** (apps/api/test/integration/tasks/tasks.spec.ts):
       - Test task creation validation:
         - Missing title returns 400
         - Empty title returns 400
         - Title too long returns 400
         - Valid task data returns 201
       - Test task update validation:
         - Invalid status value returns 400
         - Invalid priority value returns 400
       - These can be unit tests of the validation schemas/DTOs rather than full HTTP integration tests (simpler, faster)
       - Import the Zod schemas or class-validator DTOs and test them directly
  </action>
  <verify>
    - `cd apps/api && npm test` (or npx vitest/jest) — all tests pass
    - RBAC tests cover ADMIN, MANAGER, MEMBER roles
    - At least 10 RBAC permission assertions
    - Task validation tests cover required fields and invalid values
  </verify>
  <done>
    RBAC ability factory has comprehensive tests for all three roles. Guard logic tests verify auth/authz enforcement. Task API validation tests confirm input validation works correctly. All tests pass.
  </done>
</task>

</tasks>

<verification>
- Web tests: `cd apps/web && npx vitest run` — all pass
- API tests: `cd apps/api && npm test` — all pass
- RBAC tests cover all 3 roles with 10+ assertions
- Contact validation tested with 6+ cases
- UI components have render tests
- Task validation tests verify input constraints
</verification>

<success_criteria>
Testing infrastructure is configured for both web and API apps. Critical security paths (RBAC) have unit tests. Contact form validation is tested. UI components have render tests. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/04-portfolio-polish/04-08-SUMMARY.md`
</output>
