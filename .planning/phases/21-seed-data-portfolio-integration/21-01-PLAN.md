---
phase: 21-seed-data-portfolio-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/devcollab-database/prisma/seed.ts
  - packages/devcollab-database/package.json
  - docker-compose.yml
autonomous: true
requirements: [SEED-01, SEED-02]

must_haves:
  truths:
    - "Running the seed script against an empty devcollab-postgres creates 3 users (Admin, Contributor, Viewer), 1 workspace with slug 'devcollab-demo', 5+ snippets in varied languages, 3+ Published posts each with a comment and reaction, and ActivityEvent records"
    - "Running the seed script a second time exits with 'Seed already applied — skipping' and creates no new records"
    - "The docker-compose devcollab-seed service runs after devcollab-migrate completes and seeds the database on first launch"
    - "Admin logs in with admin@demo.devcollab / Demo1234!, Contributor with contributor@demo.devcollab / Demo1234!, Viewer with viewer@demo.devcollab / Demo1234!"
  artifacts:
    - path: "packages/devcollab-database/prisma/seed.ts"
      provides: "Deterministic seed script with faker.seed(42)"
      contains: "faker.seed(42)"
    - path: "packages/devcollab-database/package.json"
      provides: "seed script entry"
      contains: "tsx"
    - path: "docker-compose.yml"
      provides: "devcollab-seed service"
      contains: "devcollab-seed"
  key_links:
    - from: "packages/devcollab-database/prisma/seed.ts"
      to: "packages/devcollab-database/src/client.ts"
      via: "relative import"
      pattern: "from '../src/client'"
    - from: "docker-compose.yml devcollab-seed"
      to: "devcollab-migrate"
      via: "depends_on service_completed_successfully"
      pattern: "service_completed_successfully"
---

<objective>
Create the deterministic seed script for the DevCollab demo workspace and register it in docker-compose so the database is pre-populated on first launch.

Purpose: Recruiters who visit the live demo can interact with realistic content immediately — three role accounts, code snippets, published posts with discussions, reactions, and activity history — without any manual setup.
Output: packages/devcollab-database/prisma/seed.ts, updated package.json, devcollab-seed docker service
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-seed-data-portfolio-integration/21-RESEARCH.md
@packages/devcollab-database/prisma/schema.prisma
@packages/devcollab-database/src/client.ts
@packages/devcollab-database/package.json
@docker-compose.yml
@packages/devcollab-database/Dockerfile.migrate
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write deterministic seed script</name>
  <files>packages/devcollab-database/prisma/seed.ts</files>
  <action>
Create `packages/devcollab-database/prisma/seed.ts` with the following exact implementation:

```typescript
import { faker } from '@faker-js/faker';
import * as bcrypt from 'bcrypt';
import { prisma } from '../src/client';

async function main() {
  faker.seed(42); // MUST be first — sets deterministic PRNG state

  // Idempotency guard: if admin user exists, seed already ran
  const existing = await prisma.user.findUnique({
    where: { email: 'admin@demo.devcollab' },
  });
  if (existing) {
    console.log('Seed already applied — skipping');
    return;
  }

  const password = await bcrypt.hash('Demo1234!', 12);

  // Create 3 users with fixed emails
  const admin = await prisma.user.create({
    data: { email: 'admin@demo.devcollab', name: 'Alex Admin', password },
  });
  const contributor = await prisma.user.create({
    data: { email: 'contributor@demo.devcollab', name: 'Casey Contributor', password },
  });
  const viewer = await prisma.user.create({
    data: { email: 'viewer@demo.devcollab', name: 'Victor Viewer', password },
  });

  // Create workspace with all three members
  const workspace = await prisma.workspace.create({
    data: {
      name: 'DevCollab Demo',
      slug: 'devcollab-demo',
      members: {
        create: [
          { userId: admin.id, role: 'Admin' },
          { userId: contributor.id, role: 'Contributor' },
          { userId: viewer.id, role: 'Viewer' },
        ],
      },
    },
  });

  // MemberJoined activity events for all three members
  for (const [userId] of [
    [admin.id],
    [contributor.id],
    [viewer.id],
  ]) {
    await prisma.activityEvent.create({
      data: {
        type: 'MemberJoined',
        workspaceId: workspace.id,
        actorId: userId as string,
        entityId: userId as string,
        entityType: 'User',
      },
    });
  }

  // Create 5 snippets with varied languages
  const LANGUAGES = ['typescript', 'python', 'rust', 'go', 'sql'];
  const SNIPPET_TITLES = [
    'Auth middleware pattern',
    'Fibonacci with memoization',
    'Async channel pattern',
    'HTTP server with graceful shutdown',
    'Workspace members query',
  ];
  const SNIPPET_CODE = [
    `// JWT middleware\nexport function requireAuth(req: Request, res: Response, next: NextFunction) {\n  const token = req.cookies['token'];\n  if (!token) return res.status(401).json({ message: 'Unauthorized' });\n  try {\n    req.user = jwt.verify(token, process.env.JWT_SECRET!);\n    next();\n  } catch {\n    res.status(401).json({ message: 'Invalid token' });\n  }\n}`,
    `def fib(n: int, memo: dict = {}) -> int:\n    if n in memo:\n        return memo[n]\n    if n <= 1:\n        return n\n    memo[n] = fib(n - 1, memo) + fib(n - 2, memo)\n    return memo[n]`,
    `use tokio::sync::mpsc;\n\n#[tokio::main]\nasync fn main() {\n    let (tx, mut rx) = mpsc::channel::<String>(32);\n    tokio::spawn(async move {\n        while let Some(msg) = rx.recv().await {\n            println!("received: {msg}");\n        }\n    });\n    tx.send("hello".to_string()).await.unwrap();\n}`,
    `package main\n\nimport (\n\t"context"\n\t"log"\n\t"net/http"\n\t"os/signal"\n)\n\nfunc main() {\n\tctx, stop := signal.NotifyContext(context.Background(), os.Interrupt)\n\tdefer stop()\n\tsrv := &http.Server{Addr: ":8080"}\n\tgo srv.ListenAndServe()\n\t<-ctx.Done()\n\tsrv.Shutdown(context.Background())\n\tlog.Println("server stopped")\n}`,
    `SELECT u.name, wm.role, w.name AS workspace\nFROM workspace_members wm\nJOIN users u ON u.id = wm."userId"\nJOIN workspaces w ON w.id = wm."workspaceId"\nWHERE w.slug = 'devcollab-demo'\nORDER BY wm.role;`,
  ];

  for (let i = 0; i < 5; i++) {
    const authorId = i % 2 === 0 ? admin.id : contributor.id;
    const snippet = await prisma.snippet.create({
      data: {
        title: SNIPPET_TITLES[i],
        language: LANGUAGES[i],
        code: SNIPPET_CODE[i],
        authorId,
        workspaceId: workspace.id,
      },
    });
    await prisma.activityEvent.create({
      data: {
        type: 'SnippetCreated',
        workspaceId: workspace.id,
        actorId: authorId,
        entityId: snippet.id,
        entityType: 'Snippet',
      },
    });
  }

  // Create 3 published posts with comments including @mentions and reactions
  const POST_TITLES = [
    'Architecture Decision Record: Why We Chose Postgres tsvector',
    'Onboarding Guide for New Contributors',
    'Weekly Engineering Update — February 2026',
  ];
  const POST_CONTENT = [
    `# Architecture Decision Record: Why We Chose Postgres tsvector\n\n## Context\n\nDevCollab needed full-text search across snippets and posts. We evaluated Meilisearch, Elasticsearch, and Postgres tsvector.\n\n## Decision\n\nWe chose **Postgres tsvector** with GIN indexes and a trigger-based update pattern.\n\n## Rationale\n\n- Zero additional infrastructure: no extra Docker service, no managed service cost\n- Adequate performance at portfolio scale (< 10k documents)\n- The trigger pattern eliminates migration drift — a common pitfall with GENERATED ALWAYS AS columns in Prisma\n- ts_headline() provides highlighted search results out of the box\n\n## Consequences\n\nSearch quality is good for exact and prefix matches. Fuzzy matching requires pg_trgm (deferred). The GIN index lives in manual migration SQL, not in the Prisma schema, preventing index recreation on every migrate dev run.`,
    `# Onboarding Guide for New Contributors\n\nWelcome to DevCollab! This guide will get you up and running in under 30 minutes.\n\n## Prerequisites\n\n- Docker and Docker Compose v2\n- Node.js 20+\n- An understanding of TypeScript and React\n\n## Quick Start\n\n\`\`\`bash\ngit clone https://github.com/fernandomillan/devcollab\ncd devcollab\ndocker compose up\n\`\`\`\n\nThe seed script runs automatically on first launch. Log in with:\n- **Admin**: admin@demo.devcollab / Demo1234!\n- **Contributor**: contributor@demo.devcollab / Demo1234!\n- **Viewer**: viewer@demo.devcollab / Demo1234!\n\n## Architecture Overview\n\nDevCollab is a Turborepo monorepo with two apps: devcollab-web (Next.js 15, port 3002) and devcollab-api (NestJS 11, port 3003). The shared database package lives in packages/devcollab-database.`,
    `# Weekly Engineering Update — February 2026\n\nHere's what shipped this week across the DevCollab codebase.\n\n## Shipped\n\n- **Full-Text Search** (Phase 20): Cmd+K modal with debounced tsvector search, ts_headline() amber highlights, grouped results by type. Zero migration drift — verified with prisma migrate dev x3 ritual.\n- **Notifications** (Phase 19): @mention notifications with bell icon + unread badge. 60s polling. Cursor-paginated activity feed with 30s refresh.\n- **Reactions** (Phase 18): Emoji reactions on posts and snippets. toggleReaction idempotency with P2002 race condition guard.\n\n## Next Up\n\nPhase 21: Seed data + portfolio integration. Realistic demo workspace content. DevCollab card + case study on the portfolio site.\n\n## Notes\n\nThe tsvector trigger pattern (not GENERATED ALWAYS AS) is now the project standard for any future search fields. See the Phase 20 ADR for full context.`,
  ];

  for (let i = 0; i < 3; i++) {
    const authorId = i === 0 ? admin.id : contributor.id;
    const daysAgo = 3 - i;
    const post = await prisma.post.create({
      data: {
        title: POST_TITLES[i],
        content: POST_CONTENT[i],
        status: 'Published',
        publishedAt: new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000),
        authorId,
        workspaceId: workspace.id,
      },
    });

    await prisma.activityEvent.create({
      data: {
        type: 'PostCreated',
        workspaceId: workspace.id,
        actorId: authorId,
        entityId: post.id,
        entityType: 'Post',
      },
    });

    // Comment with @mention (admin mentions contributor)
    const comment = await prisma.comment.create({
      data: {
        content: `@Casey Contributor great post! ${faker.lorem.sentence()}`,
        authorId: admin.id,
        postId: post.id,
      },
    });

    // Notification for @mention
    await prisma.notification.create({
      data: {
        type: 'mention',
        recipientId: contributor.id,
        actorId: admin.id,
        commentId: comment.id,
        workspaceId: workspace.id,
        read: false,
      },
    });

    // Viewer replies to the comment
    await prisma.comment.create({
      data: {
        content: `${faker.lorem.sentence()} +1 from me.`,
        authorId: viewer.id,
        postId: post.id,
        parentId: comment.id,
      },
    });

    // Reaction on the post
    await prisma.reaction.create({
      data: {
        emoji: i === 0 ? 'heart' : i === 1 ? 'thumbs_up' : 'plus_one',
        userId: contributor.id,
        postId: post.id,
      },
    });
  }

  console.log('Seed complete — DevCollab demo workspace ready');
  console.log('  Workspace URL: /w/devcollab-demo');
  console.log('  Admin:       admin@demo.devcollab / Demo1234!');
  console.log('  Contributor: contributor@demo.devcollab / Demo1234!');
  console.log('  Viewer:      viewer@demo.devcollab / Demo1234!');
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

Key implementation notes:
- `faker.seed(42)` is the FIRST line of main() — before any faker calls
- Import uses `'../src/client'` (relative) NOT `'@devcollab/database'` — bypasses workspace alias issues in tsx
- `import * as bcrypt from 'bcrypt'` — bcrypt is hoisted to root node_modules by npm workspaces
- The idempotency guard checks `admin@demo.devcollab` by unique email — if found, exits immediately
- Notification uses `prisma.notification.create` (not createMany) — the @unique constraint is `[recipientId, actorId, commentId, type]`; each post creates one unique comment so no conflict
- `entityType` is a plain String (not enum) — 'Snippet', 'Post', 'User' are all valid
- `type` on ActivityEvent IS an enum — 'MemberJoined', 'PostCreated', 'SnippetCreated' are valid values
- Valid emoji values: 'thumbs_up' | 'heart' | 'plus_one' | 'laugh'
- No purple colors anywhere (per project rule)
  </action>
  <verify>
    Validate that the file compiles by running: `cd /home/doctor/fernandomillan && node_modules/.bin/tsx --tsconfig packages/devcollab-database/tsconfig.json packages/devcollab-database/prisma/seed.ts 2>&1 | head -5`

    If devcollab-postgres is running: the output should be either "Seed already applied — skipping" or "Seed complete — DevCollab demo workspace ready"

    If not running: tsx will fail at prisma connection (expected) but TypeScript compilation errors would appear before the runtime error.

    Type-check only: `cd /home/doctor/fernandomillan && node_modules/.bin/tsc --noEmit --project packages/devcollab-database/tsconfig.json` — this will error on rootDir constraint, which is expected (tsconfig excludes prisma/). The file is valid TypeScript regardless; tsx transpiles without rootDir enforcement.
  </verify>
  <done>
    packages/devcollab-database/prisma/seed.ts exists and contains faker.seed(42), the idempotency guard checking admin@demo.devcollab, the relative import from '../src/client', 3 users (Admin/Contributor/Viewer), 1 workspace with slug 'devcollab-demo', 5 snippets in TypeScript/Python/Rust/Go/SQL, 3 Published posts with comments/@mentions/reactions, MemberJoined+PostCreated+SnippetCreated ActivityEvents.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register seed in package.json and add docker-compose service</name>
  <files>packages/devcollab-database/package.json, docker-compose.yml</files>
  <action>
**Step A — Update packages/devcollab-database/package.json:**

Add `"seed"` to the `scripts` section and add a `"prisma"` section:

```json
{
  "name": "@devcollab/database",
  "version": "0.1.0",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts"
  },
  "scripts": {
    "generate": "prisma generate --schema=./prisma/schema.prisma",
    "migrate:dev": "prisma migrate dev --schema=./prisma/schema.prisma",
    "migrate:deploy": "prisma migrate deploy --schema=./prisma/schema.prisma",
    "seed": "tsx prisma/seed.ts"
  },
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  },
  "dependencies": {
    "@prisma/client": "^5.22.0"
  },
  "devDependencies": {
    "prisma": "^5.22.0",
    "typescript": "~5.6.0"
  }
}
```

Note: `tsx` resolves from root node_modules/.bin/tsx via npm workspace hoisting — no need to add it as a devDependency.

**Step B — Add devcollab-seed service to docker-compose.yml:**

Find the `devcollab-migrate` service block in docker-compose.yml. After the closing of `devcollab-migrate` (before `devcollab-api`), insert the new `devcollab-seed` service:

```yaml
  devcollab-seed:
    build:
      context: .
      dockerfile: packages/devcollab-database/Dockerfile.migrate
    command: ["node_modules/.bin/tsx", "packages/devcollab-database/prisma/seed.ts"]
    depends_on:
      devcollab-migrate:
        condition: service_completed_successfully
    networks:
      - devcollab-network
    environment:
      DEVCOLLAB_DATABASE_URL: postgresql://${DEVCOLLAB_POSTGRES_USER:-devcollab}:${DEVCOLLAB_POSTGRES_PASSWORD:-devcollab}@devcollab-postgres:5432/${DEVCOLLAB_POSTGRES_DB:-devcollab}
```

Also update `devcollab-api` depends_on to add `devcollab-seed`:

Find the `devcollab-api` depends_on block which currently has:
```yaml
    depends_on:
      devcollab-migrate:
        condition: service_completed_successfully
```

Add devcollab-seed to it:
```yaml
    depends_on:
      devcollab-migrate:
        condition: service_completed_successfully
      devcollab-seed:
        condition: service_completed_successfully
```

**Critical: Dockerfile.migrate already has `COPY node_modules ./node_modules`** which includes `tsx` at `node_modules/.bin/tsx` — the seed service can use the same Docker image with a different command.

**Also: The seed.ts uses relative import `'../src/client'` which resolves as `packages/devcollab-database/src/client.ts` from the WORKDIR `/app` of the container.** The Dockerfile.migrate only copies `packages/devcollab-database/prisma` and `node_modules`. It does NOT copy `packages/devcollab-database/src/`. Add a COPY for src in a new Dockerfile.seed OR override by copying src in the same image.

Since Dockerfile.migrate does not copy `src/`, the seed service needs a different Dockerfile. Create `packages/devcollab-database/Dockerfile.seed`:

```dockerfile
FROM node:20-alpine AS runner
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Copy what's needed for seeding (includes src/ for prisma client)
COPY packages/devcollab-database/prisma ./packages/devcollab-database/prisma
COPY packages/devcollab-database/src ./packages/devcollab-database/src
COPY node_modules ./node_modules

ENV DEVCOLLAB_DATABASE_URL=${DEVCOLLAB_DATABASE_URL}

CMD ["node_modules/.bin/tsx", "packages/devcollab-database/prisma/seed.ts"]
```

Then update the devcollab-seed service in docker-compose.yml to use this Dockerfile:

```yaml
  devcollab-seed:
    build:
      context: .
      dockerfile: packages/devcollab-database/Dockerfile.seed
    depends_on:
      devcollab-migrate:
        condition: service_completed_successfully
    networks:
      - devcollab-network
    environment:
      DEVCOLLAB_DATABASE_URL: postgresql://${DEVCOLLAB_POSTGRES_USER:-devcollab}:${DEVCOLLAB_POSTGRES_PASSWORD:-devcollab}@devcollab-postgres:5432/${DEVCOLLAB_POSTGRES_DB:-devcollab}
```

Also update devcollab-api's depends_on to include devcollab-seed as shown above.

Also add `packages/devcollab-database/Dockerfile.seed` to the files_modified list (it needs to be created).
  </action>
  <verify>
    1. `cat /home/doctor/fernandomillan/packages/devcollab-database/package.json` — should contain `"seed": "tsx prisma/seed.ts"` and `"prisma": { "seed": "tsx prisma/seed.ts" }`
    2. `grep -A 10 "devcollab-seed" /home/doctor/fernandomillan/docker-compose.yml` — should show the service definition with Dockerfile.seed
    3. `grep -A 8 "devcollab-api:" /home/doctor/fernandomillan/docker-compose.yml | grep -A 5 "depends_on"` — should show both devcollab-migrate and devcollab-seed conditions
    4. `cat /home/doctor/fernandomillan/packages/devcollab-database/Dockerfile.seed` — should COPY both prisma/ and src/
  </verify>
  <done>
    package.json has seed script using tsx. docker-compose.yml has devcollab-seed service depending on devcollab-migrate:service_completed_successfully. devcollab-api depends on devcollab-seed:service_completed_successfully. Dockerfile.seed copies both prisma/ and src/ directories.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, validate the seed end-to-end against the running devcollab-postgres container:

```bash
# Check if devcollab-postgres is running
docker ps | grep devcollab-postgres

# If running, run seed directly:
cd /home/doctor/fernandomillan
DEVCOLLAB_DATABASE_URL="postgresql://devcollab:devcollab@localhost:5435/devcollab" \
  node_modules/.bin/tsx packages/devcollab-database/prisma/seed.ts

# Verify idempotency (run again — should print "Seed already applied — skipping")
DEVCOLLAB_DATABASE_URL="postgresql://devcollab:devcollab@localhost:5435/devcollab" \
  node_modules/.bin/tsx packages/devcollab-database/prisma/seed.ts

# Verify records were created:
docker exec devcollab-postgres psql -U devcollab -d devcollab \
  -c "SELECT email, name FROM users;" \
  -c "SELECT slug FROM workspaces;" \
  -c "SELECT COUNT(*) as snippets FROM snippets;" \
  -c "SELECT COUNT(*) as posts FROM posts;" \
  -c "SELECT COUNT(*) as activities FROM activity_events;"
```

Expected: 3 users, 1 workspace (devcollab-demo), 5 snippets, 3 posts, 9+ activity events.
</verification>

<success_criteria>
- packages/devcollab-database/prisma/seed.ts exists with faker.seed(42), idempotency guard, 3 users, 5 snippets in 5 languages, 3 published posts, @mention comments, reactions, activity events
- Running seed twice produces "Seed already applied — skipping" on the second run
- packages/devcollab-database/package.json has "seed": "tsx prisma/seed.ts" and "prisma": { "seed": ... }
- docker-compose.yml has devcollab-seed service with service_completed_successfully dependency on devcollab-migrate
- devcollab-api depends on devcollab-seed:service_completed_successfully
- packages/devcollab-database/Dockerfile.seed copies both prisma/ and src/ directories
</success_criteria>

<output>
After completion, create `.planning/phases/21-seed-data-portfolio-integration/21-01-SUMMARY.md`
</output>
