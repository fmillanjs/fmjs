---
phase: 34-live-auth-investigation-fix
task: 3
total_tasks: 3
status: in_progress
last_updated: 2026-02-25T00:00:00.000Z
---

<current_state>
DevCollab login FIXED (cookie domain env var). TeamFlow login BROKEN — DB never seeded + missing Coolify env vars (NEXTAUTH_SECRET, NEXTAUTH_URL, DATABASE_URL not set for TeamFlow web service).
</current_state>

<completed_work>

## Plan 34-01 (complete)
- Task 1: `scripts/diagnose-live-auth.sh` created — 7-section diagnostic toolkit ✓
- Task 2: `devcollab-seed` service added to `coolify-compose.yml`, seed image build step added to `deploy.yml` ✓
- Task 3 (checkpoint): Diagnosis ran manually on VPS. Findings: JWT_SECRET and REDIS_URL missing from TeamFlow, DevCollab seed not run ✓

## Plan 34-02 task 1 — Code fixes applied and pushed:
- `packages/database/prisma/schema.prisma`: added `binaryTargets = ["native", "linux-musl-openssl-3.0.x"]` ✓
- `apps/web/Dockerfile`: added `openssl` to runner stage ✓
- `packages/devcollab-database/Dockerfile.seed`: rewrote to use turbo prune + npm ci ✓
- `packages/devcollab-database/package.json`: added `@faker-js/faker`, `bcrypt`, `tsx` as proper deps ✓
- `apps/devcollab-api/src/auth/auth.controller.ts`: added `COOKIE_DOMAIN` env var support ✓
- `scripts/seed-devcollab-live.js`: plain JS seed script for manual one-shot seeding ✓
- `scripts/seed-teamflow-live.js`: plain JS seed script for TeamFlow manual seeding ✓ (commit 3189525)

## VPS manual actions done:
- DevCollab DB seeded manually ✓
- DevCollab: `COOKIE_DOMAIN=.fernandomillan.me` added to devcollab-api in Coolify ✓
- TeamFlow: `JWT_SECRET` and `REDIS_URL` added in Coolify ✓

## Status:
- DevCollab login: WORKING ✓ (admin@demo.devcollab / Demo1234!)
- TeamFlow login: BROKEN — needs env vars + seed (see remaining_work)

</completed_work>

<remaining_work>

## TeamFlow fix — 3 manual actions needed in Coolify + VPS:

### Step 1: Add missing env vars to TeamFlow web service in Coolify
Navigate to Coolify → TeamFlow web service → Environment Variables, add:
```
NEXTAUTH_SECRET=<generate: node -e "console.log(require('crypto').randomBytes(64).toString('base64'))">
NEXTAUTH_URL=https://teamflow.fernandomillan.me
DATABASE_URL=<same value as TeamFlow API's DATABASE_URL>
```
Redeploy after saving.

### Step 2: Seed TeamFlow DB (first time only)
```bash
# SSH to VPS, then:
CONTAINER=$(docker ps --filter "name=teamflow" --filter "name=api" --format "{{.Names}}" | head -1)
echo "Container: $CONTAINER"
docker exec -i $CONTAINER node < scripts/seed-teamflow-live.js
```
Expected output: Users created (3), Organization + memberships, Projects (2), Tasks (15), Comments (15), Audit log (20)

### Step 3: Verify both apps
- TeamFlow: https://teamflow.fernandomillan.me/login → demo1@teamflow.dev / Password123
- DevCollab: https://devcollab.fernandomillan.me/login → admin@demo.devcollab / Demo1234!

## After both pass:
- Create 34-01-SUMMARY.md
- Create 34-02-SUMMARY.md
- Run GSD verifier for phase 34
- Update ROADMAP.md and STATE.md

</remaining_work>

<root_cause_analysis>

TeamFlow login failure has 3 causes:

1. **NEXTAUTH_SECRET not set in Coolify** — NextAuth v5 throws immediately if AUTH_SECRET/NEXTAUTH_SECRET
   is missing in production. This env var was never added (only JWT_SECRET + REDIS_URL were added).

2. **NEXTAUTH_URL not set in Coolify** — Without this, NextAuth may produce incorrect callback URLs
   and CSRF validation may fail. Value: `https://teamflow.fernandomillan.me`

3. **TeamFlow DB has no users** — The TeamFlow API only runs `prisma db push` (schema sync, no seed).
   No user accounts exist so credentials always fail.
   Fix: `scripts/seed-teamflow-live.js` created (commit 3189525) — run it once on VPS.

Note: `DATABASE_URL` must also be set for the TeamFlow **web** service in Coolify. The web app
connects to Postgres directly in the NextAuth `authorize` callback (lib/auth.ts → @repo/database).

</root_cause_analysis>

<decisions_made>

- **Cookie domain fix**: Set `COOKIE_DOMAIN=.fernandomillan.me` via env var (not hardcoded). ✓
- **Seed approach**: Plain JS (`scripts/seed-teamflow-live.js`) with absolute requires — no tsx/faker. ✓
- **Prisma binary target**: `linux-musl-openssl-3.0.x` — Alpine 3.x ships OpenSSL 3, not 1.1. ✓
- **TeamFlow seed data**: 3 users, 2 projects, 15 tasks — enough for a convincing demo without faker. ✓

</decisions_made>

<next_action>
1. Add NEXTAUTH_SECRET + NEXTAUTH_URL + DATABASE_URL to TeamFlow web service in Coolify
2. Redeploy TeamFlow web
3. SSH to VPS: docker exec -i <teamflow-api-container> node < scripts/seed-teamflow-live.js
4. Test: https://teamflow.fernandomillan.me/login → demo1@teamflow.dev / Password123
5. If passes: create SUMMARYs and run verifier
</next_action>
