---
phase: 34-live-auth-investigation-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/diagnose-live-auth.sh
  - coolify-compose.yml
autonomous: false
requirements:
  - LIVE-01
  - LIVE-02

must_haves:
  truths:
    - "A diagnostic script exists that tests all known auth failure points for both apps in one run"
    - "The coolify-compose.yml has a devcollab-seed service so seed runs on every deployment"
    - "The human has run the diagnostic script against live VPS and reported findings back"
  artifacts:
    - path: "scripts/diagnose-live-auth.sh"
      provides: "Executable diagnostic script covering API reachability, CORS, seed status, JWT secret presence, Redis, and NextAuth config for both apps"
      min_lines: 80
    - path: "coolify-compose.yml"
      provides: "Production compose with devcollab-seed service after devcollab-migrate"
      contains: "devcollab-seed"
  key_links:
    - from: "scripts/diagnose-live-auth.sh"
      to: "live VPS"
      via: "curl + docker logs commands"
      pattern: "curl.*devcollab|curl.*teamflow"
    - from: "coolify-compose.yml"
      to: "devcollab-seed service"
      via: "depends_on devcollab-migrate"
      pattern: "devcollab-seed"
---

<objective>
Diagnose the broken authentication on both live apps and add the missing seed service to the production compose, so the root cause is known before any fix is applied.

Purpose: Login is broken on devcollab.fernandomillan.me and teamflow.fernandomillan.me. The root cause is unknown — it could be NEXT_PUBLIC_API_URL pointing to localhost, CORS misconfiguration, missing env vars in Coolify, unseeded databases, Redis unreachable, or JWT_SECRET mismatch. Guessing and deploying blindly wastes cycles. This plan produces a runnable diagnostic script and ensures the seed gap is closed in the compose file regardless of other findings.

Output: `scripts/diagnose-live-auth.sh` (diagnostic toolkit), updated `coolify-compose.yml` (seed service added), and a human-verified findings report from running the script on/against the live VPS.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-live-auth-investigation-fix/34-RESEARCH.md
@coolify-compose.yml
@apps/devcollab-api/src/main.ts
@apps/web/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write diagnostic script covering all six known failure classes</name>
  <files>scripts/diagnose-live-auth.sh</files>
  <action>
Create `scripts/diagnose-live-auth.sh` as an executable bash script. This script is run FROM the local machine (it uses curl against live HTTPS endpoints) or from the VPS. Structure it in labeled sections:

**SECTION 1 — DevCollab API reachability:**
```bash
echo "=== [1] DevCollab API health ==="
curl -s -o /dev/null -w "%{http_code}" https://devcollab-api.fernandomillan.me/health || \
curl -s -o /dev/null -w "%{http_code}" https://api.devcollab.fernandomillan.me/health
```
Try both subdomain patterns since the live API domain is not confirmed. Print the HTTP status code and URL tried.

**SECTION 2 — DevCollab login with demo credentials (seed check + CORS check):**
```bash
echo "=== [2] DevCollab login attempt ==="
curl -s -w "\nHTTP_STATUS:%{http_code}" \
  -X POST "https://<devcollab-api-domain>/auth/login" \
  -H "Content-Type: application/json" \
  -H "Origin: https://devcollab.fernandomillan.me" \
  --include \
  -d '{"email":"admin@demo.devcollab","password":"Demo1234!"}'
```
Expected: 200 + `Set-Cookie: devcollab_token=`. 401 = seed not run. CORS error = `DEVCOLLAB_WEB_URL` wrong. Connection refused = wrong API domain.

**SECTION 3 — TeamFlow NextAuth providers endpoint:**
```bash
echo "=== [3] TeamFlow NextAuth providers ==="
curl -s https://teamflow.fernandomillan.me/api/auth/providers
```
Expected: JSON with `credentials` key. 500 = `NEXTAUTH_SECRET` or `NEXTAUTH_URL` missing.

**SECTION 4 — TeamFlow API reachability:**
```bash
echo "=== [4] TeamFlow API health ==="
curl -s -o /dev/null -w "%{http_code}" https://api-teamflow.fernandomillan.me/api/health || \
curl -s -o /dev/null -w "%{http_code}" https://teamflow-api.fernandomillan.me/api/health
```

**SECTION 5 — TeamFlow session endpoint (Redis/NextAuth alive check):**
```bash
echo "=== [5] TeamFlow session endpoint ==="
curl -s https://teamflow.fernandomillan.me/api/auth/session
```
Expected: `{}` or `{"user":null}`. Any 5xx = NextAuth internal failure (missing secret, Redis down).

**SECTION 6 — Docker container logs (requires SSH into VPS as root):**
Add commented instructions:
```bash
# Run these on VPS after: sudo su -
# docker logs devcollab-api --tail 50 2>&1 | grep -i "error\|cors\|jwt\|seed"
# docker logs devcollab-web --tail 50 2>&1 | grep -i "error\|api_url\|localhost"
# docker logs teamflow-web --tail 50 2>&1 | grep -i "error\|redis\|jwt\|nextauth"
# docker logs teamflow-api --tail 50 2>&1 | grep -i "error\|cors\|jwt"
# To list container names: docker ps --format '{{.Names}}'
```

**SECTION 7 — JWT_SECRET fingerprint check (run on VPS as root):**
Add commented instructions:
```bash
# On VPS, inspect running env vars (partial reveal only):
# docker inspect devcollab-api --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -i jwt | cut -c1-60
# docker inspect teamflow-web --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -i jwt | cut -c1-60
# docker inspect teamflow-api --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -i jwt | cut -c1-60
# Both teamflow-web and teamflow-api JWT_SECRET values must be identical
```

Make the script executable: `chmod +x scripts/diagnose-live-auth.sh`

Add a `FINDINGS TEMPLATE` comment block at the bottom of the script:
```bash
# ============================================================
# FINDINGS TEMPLATE — fill in and report back after running:
# ============================================================
# [1] DevCollab API domain: _____ HTTP status: _____
# [2] DevCollab login result: _____ (200/401/CORS error/refused)
# [3] TeamFlow providers JSON: _____ (has credentials / 500 error)
# [4] TeamFlow API domain: _____ HTTP status: _____
# [5] TeamFlow session JSON: _____ ({} / error message)
# [6] Notable container log lines: _____
# [7] JWT_SECRET match (web vs api): same / different / not set
# ============================================================
```
  </action>
  <verify>
    <automated>bash -n scripts/diagnose-live-auth.sh && echo "Script syntax OK" && test -x scripts/diagnose-live-auth.sh && echo "Script is executable"</automated>
    <manual>Open scripts/diagnose-live-auth.sh and confirm all 7 sections are present. Run the curl portions against live URLs to check Section 1-5 output.</manual>
  </verify>
  <done>scripts/diagnose-live-auth.sh exists, is executable, passes bash syntax check, and contains all 7 diagnostic sections with the FINDINGS TEMPLATE at the bottom.</done>
</task>

<task type="auto">
  <name>Task 2: Add devcollab-seed service to coolify-compose.yml</name>
  <files>coolify-compose.yml</files>
  <action>
Edit `coolify-compose.yml` to add a `devcollab-seed` service after the existing `devcollab-migrate` service. This is a permanent fix — the seed will run on every deployment, ensuring demo users exist regardless of prior state.

Add this service block after the `devcollab-migrate` service definition:

```yaml
  devcollab-seed:
    image: ghcr.io/fernandomillan-dev/fernandomillan/devcollab-seed:latest
    restart: "no"
    depends_on:
      devcollab-migrate:
        condition: service_completed_successfully
    environment:
      DEVCOLLAB_DATABASE_URL: ${DEVCOLLAB_DATABASE_URL}
```

Note: The `devcollab-seed` Docker image must also be built and pushed to GHCR in CI. This requires adding a build step to `deploy.yml`. Do that in this same task:

In `.github/workflows/deploy.yml`, inside the `build-and-push-devcollab` job, add a new step after the `devcollab-api` image build step:

```yaml
      - name: Build and push devcollab-seed image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/devcollab-database/Dockerfile.seed
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/devcollab-seed:latest
            ghcr.io/${{ github.repository }}/devcollab-seed:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/devcollab-seed:latest
          cache-to: type=inline
```

The seed script (`packages/devcollab-database/prisma/seed.ts`) is idempotent — it checks for the admin user before creating any records, so running it on every deployment is safe.
  </action>
  <verify>
    <automated>grep -q "devcollab-seed" coolify-compose.yml && echo "seed service present in compose" && grep -q "devcollab-seed" .github/workflows/deploy.yml && echo "seed image build step present in CI"</automated>
  </verify>
  <done>coolify-compose.yml contains a `devcollab-seed` service that depends on `devcollab-migrate`, and `.github/workflows/deploy.yml` builds and pushes the `devcollab-seed` image in the `build-and-push-devcollab` job.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Run diagnostic script on live VPS and report findings</name>
  <what-built>
    - scripts/diagnose-live-auth.sh — complete diagnostic toolkit for both apps
    - coolify-compose.yml — devcollab-seed service added (will take effect on next deployment)
    - .github/workflows/deploy.yml — seed image build step added
  </what-built>
  <how-to-verify>
    Run the diagnostic script to identify the root cause of auth failures:

    **Step 1 — Run curl diagnostics from your local machine:**
    ```bash
    bash scripts/diagnose-live-auth.sh
    ```
    Record the output for sections 1-5.

    **Step 2 — SSH into VPS and run sections 6-7:**
    ```bash
    ssh <your-vps>
    sudo su -
    docker ps --format '{{.Names}}'  # get actual container names
    docker logs <devcollab-api-container> --tail 50 2>&1 | grep -iE "error|cors|jwt|seed"
    docker logs <devcollab-web-container> --tail 50 2>&1 | grep -iE "error|api_url|localhost"
    docker logs <teamflow-web-container> --tail 50 2>&1 | grep -iE "error|redis|jwt|nextauth"
    docker logs <teamflow-api-container> --tail 50 2>&1 | grep -iE "error|cors|jwt"
    docker inspect <teamflow-web-container> --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -iE "jwt|redis|nextauth|database" | cut -c1-80
    docker inspect <teamflow-api-container> --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -iE "jwt|cors" | cut -c1-80
    ```

    **Step 3 — Fill in the FINDINGS TEMPLATE** (bottom of the script) and share results.

    **What to look for:**
    - Section 1/4: API domain pattern (api-devcollab.* or devcollab-api.*)
    - Section 2: 401 = seed not run; CORS error = DEVCOLLAB_WEB_URL wrong; refused = NEXT_PUBLIC_API_URL baked wrong
    - Section 3: 500 = NEXTAUTH_SECRET/NEXTAUTH_URL missing; `{credentials: ...}` = NextAuth is up
    - Section 5: `{}` = Redis may be up; 5xx = NextAuth broken
    - Section 6: Look for Redis connection errors, JWT errors, CORS rejections, "localhost" in URLs
    - Section 7: JWT_SECRET fingerprints must match between teamflow-web and teamflow-api
  </how-to-verify>
  <resume-signal>Share the findings from the diagnostic script (filled FINDINGS TEMPLATE + any notable log lines), then type "diagnosis complete" to proceed to Plan 02 fixes.</resume-signal>
  <action>Human runs scripts/diagnose-live-auth.sh locally and runs section 6-7 commands on VPS via SSH. Reports findings using the FINDINGS TEMPLATE at the bottom of the script.</action>
  <verify>Human confirms all 7 sections of the diagnostic script were run and findings are reported.</verify>
  <done>Root causes of auth failure on both DevCollab and TeamFlow are identified and reported.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/diagnose-live-auth.sh` passes with no syntax errors
2. `grep -q "devcollab-seed" coolify-compose.yml` returns true
3. `grep -q "devcollab-seed" .github/workflows/deploy.yml` returns true
4. The seed service in coolify-compose.yml depends on `devcollab-migrate: condition: service_completed_successfully`
5. Human has run the diagnostic and reported findings back (checkpoint gate)
</verification>

<success_criteria>
- Diagnostic script exists and covers all 6 known failure classes
- coolify-compose.yml has devcollab-seed so seed runs on every future deployment
- CI builds and pushes devcollab-seed image
- Root causes of auth failure on both apps are known before any fix is attempted
</success_criteria>

<output>
After completion, create `.planning/phases/34-live-auth-investigation-fix/34-01-SUMMARY.md`
</output>
