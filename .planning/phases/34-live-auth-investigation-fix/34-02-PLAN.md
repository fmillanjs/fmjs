---
phase: 34-live-auth-investigation-fix
plan: 02
type: execute
wave: 2
depends_on:
  - 34-01
files_modified:
  - coolify-compose.yml
  - .github/workflows/deploy.yml
autonomous: false
requirements:
  - LIVE-01
  - LIVE-02
  - LIVE-03
  - LIVE-04

must_haves:
  truths:
    - "Recruiter can log into devcollab.fernandomillan.me with admin@demo.devcollab / Demo1234! and land in the demo workspace"
    - "Recruiter can log into teamflow.fernandomillan.me with demo1@teamflow.dev / Password123 and land on the teams dashboard"
    - "DevCollab workspace shows seeded snippets, posts, and members after login — not an empty state"
    - "TeamFlow dashboard shows task columns and drag-and-drop works after login"
  artifacts:
    - path: "coolify-compose.yml"
      provides: "Production compose with all confirmed fixes applied"
    - path: ".github/workflows/deploy.yml"
      provides: "CI pipeline with any required build-arg or seed fixes"
    - path: "scripts/seed-teamflow-live.sh"
      provides: "One-shot TeamFlow seed script for running against live DB via VPS"
  key_links:
    - from: "devcollab.fernandomillan.me/login"
      to: "devcollab-api /auth/login"
      via: "POST with Origin header + credentials:include"
      pattern: "NEXT_PUBLIC_API_URL.*devcollab-api"
    - from: "teamflow.fernandomillan.me/login"
      to: "NextAuth CredentialsProvider"
      via: "JWT strategy + Redis session"
      pattern: "NEXTAUTH_SECRET|NEXTAUTH_URL|REDIS_URL"
    - from: "teamflow-web session callback"
      to: "teamflow-api bearer validation"
      via: "JWT_SECRET shared between both services"
      pattern: "JWT_SECRET"
---

<objective>
Apply all fixes identified in Plan 01 diagnosis and verify end-to-end login works on both live apps.

Purpose: Phase 34's goal is recruiters being able to log in and use both live demos. This plan translates the diagnosed root causes into targeted code and configuration fixes, triggers redeployment, and verifies the full login flow on both apps.

Output: Working login on devcollab.fernandomillan.me and teamflow.fernandomillan.me with seeded demo content visible post-login.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-live-auth-investigation-fix/34-RESEARCH.md
@.planning/phases/34-live-auth-investigation-fix/34-01-SUMMARY.md
@coolify-compose.yml
@apps/devcollab-api/src/main.ts
@apps/web/lib/auth.ts
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply all code-level fixes based on diagnosis findings</name>
  <files>coolify-compose.yml, .github/workflows/deploy.yml, scripts/seed-teamflow-live.sh</files>
  <action>
Read the findings from `34-01-SUMMARY.md` first. Apply fixes for each confirmed root cause:

**FIX A — If NEXT_PUBLIC_API_URL is baked to localhost (most likely for DevCollab):**
Verify in `deploy.yml` that the `build-and-push-devcollab` job passes `NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_DEVCOLLAB_API_URL }}` as a build-arg. This is already in the workflow. The fix is confirming the GitHub secret `NEXT_PUBLIC_DEVCOLLAB_API_URL` is set to the live API URL (determined from diagnosis). If the secret was missing, document it in the SUMMARY for the human to add in GitHub Actions settings. No code change needed — the workflow is already correct.

**FIX B — If DevCollab seed was not run (users don't exist):**
The `devcollab-seed` service was added to `coolify-compose.yml` in Plan 01 Task 2. Confirm it is present and correct. The next Coolify deployment will auto-seed.

**FIX C — If TeamFlow seed was not run:**
Create `scripts/seed-teamflow-live.sh`:
```bash
#!/bin/bash
# Run TeamFlow seed against live DB
# Usage: DATABASE_URL="<live_teamflow_db_url>" bash scripts/seed-teamflow-live.sh
set -e
echo "Running TeamFlow seed against live database..."
cd packages/database
DATABASE_URL="${DATABASE_URL}" npx prisma db push --schema=prisma/schema.prisma --skip-generate
DATABASE_URL="${DATABASE_URL}" npm run seed
echo "TeamFlow seed complete."
```
Make it executable. The human runs this from the VPS or locally if they have the live DATABASE_URL.

**FIX D — If NEXTAUTH_URL, NEXTAUTH_SECRET, or REDIS_URL are wrong/missing in Coolify:**
These are Coolify environment variable issues — no code changes needed. Document exact required values in the SUMMARY:
- `NEXTAUTH_URL` = `https://teamflow.fernandomillan.me`
- `NEXTAUTH_SECRET` = any 32+ char random string (must be stable across restarts)
- `REDIS_URL` = the Redis service URL as configured in Coolify (e.g., `redis://teamflow-redis:6379` if using a Coolify-managed Redis, or whatever the diagnosis revealed)
- `JWT_SECRET` = same value in BOTH teamflow-web service AND teamflow-api service in Coolify (min 32 chars)
- `DEVCOLLAB_WEB_URL` = `https://devcollab.fernandomillan.me` in the devcollab-api Coolify service

**FIX E — If CORS error due to wrong DEVCOLLAB_WEB_URL:**
No code change needed. `apps/devcollab-api/src/main.ts` already uses `process.env.DEVCOLLAB_WEB_URL`. Confirm the Coolify env var for `devcollab-api` service is set to `https://devcollab.fernandomillan.me` (not http, not without trailing path, no typos).

**FIX F — If any code fix is required for TeamFlow Redis connection:**
Check `apps/web/lib/redis.ts`. The default fallback is `redis://localhost:6380`. In production, `REDIS_URL` must be set. If the diagnosis shows Redis is actually a Coolify-managed container on the same network, the URL might be `redis://teamflow-redis:6379` or similar. No code change needed — just the env var.

After applying code fixes (only B and C require file changes), verify the compose and script are correct. All other fixes are env var changes documented for the human to apply in Coolify.
  </action>
  <verify>
    <automated>bash -n scripts/seed-teamflow-live.sh && echo "Seed script syntax OK" && test -x scripts/seed-teamflow-live.sh && echo "Executable" && grep -q "devcollab-seed" coolify-compose.yml && echo "Seed service in compose"</automated>
  </verify>
  <done>scripts/seed-teamflow-live.sh exists and is executable, coolify-compose.yml has the seed service from Plan 01, and all code-addressable fixes are applied. A complete list of Coolify env var changes required is documented in the task output.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Apply Coolify env var fixes, redeploy, and verify end-to-end login on both apps</name>
  <what-built>
    - All code-level fixes applied (seed services, CI pipeline correct)
    - scripts/seed-teamflow-live.sh for manual TeamFlow seeding
    - Documentation of all required Coolify env var fixes
  </what-built>
  <how-to-verify>
    Apply the Coolify env var fixes and trigger redeployment:

    **Step 1 — Fix Coolify environment variables:**
    In the Coolify dashboard, update each service's environment variables:
    - **devcollab-api service**: Set `DEVCOLLAB_WEB_URL=https://devcollab.fernandomillan.me`
    - **teamflow-web service**: Set `NEXTAUTH_URL=https://teamflow.fernandomillan.me`, `NEXTAUTH_SECRET=<32+ char secret>`, `JWT_SECRET=<32+ char secret — SAME as teamflow-api>`, `REDIS_URL=<redis url from diagnosis>`
    - **teamflow-api service**: Set `JWT_SECRET=<same value as teamflow-web>`

    **Step 2 — Add GitHub Actions secrets if missing** (for NEXT_PUBLIC_API_URL bake):
    In GitHub repo settings → Secrets → Actions:
    - `NEXT_PUBLIC_DEVCOLLAB_API_URL` = `https://<live devcollab api domain>` (from diagnosis findings)
    - `NEXT_PUBLIC_TEAMFLOW_API_URL` = `https://<live teamflow api domain>` (from diagnosis)
    - `NEXT_PUBLIC_TEAMFLOW_WS_URL` = `wss://<live teamflow api domain>` (from diagnosis)

    **Step 3 — Run TeamFlow seed if not already seeded** (from VPS or locally):
    ```bash
    DATABASE_URL="<live teamflow DATABASE_URL>" bash scripts/seed-teamflow-live.sh
    ```

    **Step 4 — Trigger redeployment:**
    Push a commit to main (the code changes in this phase will trigger CI + Coolify deploy).
    Or trigger manually from Coolify dashboard for both DevCollab and TeamFlow services.

    **Step 5 — Wait for deployment to complete** (check Coolify UI for green status).

    **Step 6 — Verify login on DevCollab:**
    1. Open https://devcollab.fernandomillan.me/login in an incognito window
    2. Enter: `admin@demo.devcollab` / `Demo1234!`
    3. Expected: Redirected to `/w/devcollab-demo` — workspace loads with snippets, posts, and members visible
    4. Verify DevTools Network tab shows API calls going to the live API domain (not localhost)

    **Step 7 — Verify login on TeamFlow:**
    1. Open https://teamflow.fernandomillan.me in an incognito window
    2. Enter: `demo1@teamflow.dev` / `Password123`
    3. Expected: Redirected to `/teams` — project dashboard loads with task columns visible
    4. Verify drag-and-drop moves a task to another column
    5. Verify presence indicator shows (green dot / user avatar in header)

    **Pass criteria:**
    - Both logins succeed without redirect loops, blank screens, or errors
    - Both dashboards show seeded content (not empty state)
    - DevCollab workspace has snippets, posts, members populated
    - TeamFlow has task columns with tasks, drag-and-drop works
  </how-to-verify>
  <resume-signal>Type "auth fixed" if both apps log in successfully and show seeded content. Type "partial: {which app failed}" if one app still has issues and describe the error seen.</resume-signal>
  <action>Human applies Coolify env var fixes, adds GitHub Actions secrets if missing, runs TeamFlow seed if needed, triggers redeployment, then verifies login end-to-end on both apps in an incognito browser.</action>
  <verify>Human confirms both login flows succeed and seeded content is visible on both apps.</verify>
  <done>LIVE-01 through LIVE-04 are all satisfied: both apps accept demo credentials and show seeded content post-login.</done>
</task>

</tasks>

<verification>
1. `curl -X POST https://<devcollab-api-domain>/auth/login -H "Content-Type: application/json" -H "Origin: https://devcollab.fernandomillan.me" -d '{"email":"admin@demo.devcollab","password":"Demo1234!"}'` returns 200 + Set-Cookie header
2. `curl https://teamflow.fernandomillan.me/api/auth/providers` returns JSON containing `credentials`
3. `curl https://teamflow.fernandomillan.me/api/auth/session` returns `{}` (not 5xx)
4. Human verified both login flows end-to-end in incognito browser
5. DevCollab workspace `/w/devcollab-demo` loads with content (snippets, posts, members)
6. TeamFlow `/teams` dashboard loads with task columns and drag-and-drop functional
</verification>

<success_criteria>
- LIVE-01: User can log into devcollab.fernandomillan.me with seeded demo credentials — VERIFIED by human
- LIVE-02: User can log into teamflow.fernandomillan.me with seeded demo credentials — VERIFIED by human
- LIVE-03: DevCollab workspace loads with seeded content post-login — VERIFIED by human
- LIVE-04: TeamFlow project loads with tasks, drag-and-drop works, real-time presence visible — VERIFIED by human
</success_criteria>

<output>
After completion, create `.planning/phases/34-live-auth-investigation-fix/34-02-SUMMARY.md`
</output>
