---
phase: 06.1-user-flow-architecture-audit
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/e2e/edge-cases/permission-errors.spec.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Permission denial E2E tests redirect to /teams after unauthorized access"
    - "All edge case permission tests pass without auth redirect failures"
  artifacts:
    - path: "apps/web/e2e/edge-cases/permission-errors.spec.ts"
      provides: "E2E tests validating RBAC permission denials with correct redirect expectations"
      min_lines: 200
  key_links:
    - from: "apps/web/e2e/edge-cases/permission-errors.spec.ts"
      to: "middleware auth redirect"
      via: "page.waitForURL('/teams')"
      pattern: "waitForURL\\('/teams'\\)"
---

<objective>
Fix outdated auth redirect URL expectations in permission error E2E tests to match current application behavior (/teams instead of /), resolving 5 failing tests and restoring edge case test suite to passing state.

Purpose: Close Gap 1 from Phase 6.1 verification - auth.setup.ts was updated to expect /teams redirect (commit 974b7d7) but permission-errors.spec.ts was not updated, causing 5 test failures and breaking the edge case test suite.

Output: Updated permission error E2E tests with correct redirect expectations, restoring 100% edge case test pass rate.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-user-flow-architecture-audit/06.1-VERIFICATION.md

# Gap context
Gap 1: Auth redirect URL outdated (BLOCKER - PARTIALLY FIXED)
- auth.setup.ts fixed to expect /teams (commit 974b7d7)
- permission-errors.spec.ts still expects / redirect (5 tests failing)
- Fix needed: Update lines 26, 77, 120, 162, 194

# Reference files
@apps/web/e2e/edge-cases/permission-errors.spec.ts
@apps/web/e2e/auth/auth.setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update permission error test redirect expectations</name>
  <files>apps/web/e2e/edge-cases/permission-errors.spec.ts</files>
  <action>
Update permission error E2E tests to expect redirect to /teams instead of / when unauthorized users attempt protected actions.

Specific changes required (from VERIFICATION.md Gap 1):
- Line 26: Change `await page.waitForURL('/')` to `await page.waitForURL('/teams')`
- Line 77: Change `await page.waitForURL('/')` to `await page.waitForURL('/teams')`
- Line 120: Change `await page.waitForURL('/')` to `await page.waitForURL('/teams')`
- Line 162: Change `await page.waitForURL('/')` to `await page.waitForURL('/teams')`
- Line 194: Change `await page.waitForURL('/')` to `await page.waitForURL('/teams')`

Context: The application redirects unauthenticated users to /login, then after successful login redirects to /teams (the default authenticated landing page). The auth.setup.ts was updated in commit 974b7d7 to reflect this behavior, but permission-errors.spec.ts was not updated, causing test failures.

Verify all 5 failing tests are for scenarios where:
1. User is not logged in or session expired
2. User attempts protected action (e.g., admin-only delete)
3. Middleware redirects to /login
4. After login, redirects to /teams

Do NOT change any other assertions or test logic - only update the redirect URL expectations from / to /teams.
  </action>
  <verify>
Run permission error E2E tests to verify all pass:
```bash
cd apps/web
npx playwright test e2e/edge-cases/permission-errors.spec.ts --project=chromium
```

Should show 5/5 tests passing (previously 0/5 passing). Output should confirm:
- "member cannot access admin-only pages" - PASS
- "member cannot delete projects" - PASS
- "manager cannot delete projects" - PASS
- "last admin cannot remove themselves" - PASS
- "non-member cannot access team resources" - PASS

Also run full edge case test suite to ensure no regressions:
```bash
npx playwright test e2e/edge-cases/ --project=chromium
```

Should show 33/33 tests passing across all edge case categories (100% coverage restored).
  </verify>
  <done>
All 5 permission error tests pass with correct /teams redirect expectations. Edge case test suite restored to 100% pass rate (33/33 tests). No test logic changed - only redirect URL updated to match current application behavior.
  </done>
</task>

</tasks>

<verification>
Run complete edge case test suite to verify gap closure:
```bash
cd apps/web
npx playwright test e2e/edge-cases/ --project=chromium --reporter=html
```

Expected results:
- All 5 permission-errors.spec.ts tests pass (previously 0/5)
- All 33 edge case tests pass (100% coverage)
- No regressions in other edge case test files

Generate HTML report to review:
```bash
npx playwright show-report
```

Verify EDGE-CASE-CHECKLIST.md status:
- Permission errors: 5/5 passing (previously 0/5)
- Overall coverage: 33/33 passing (100%)
</verification>

<success_criteria>
1. All 5 lines updated in permission-errors.spec.ts (26, 77, 120, 162, 194)
2. All redirect expectations changed from / to /teams
3. All 5 permission error tests pass without failures
4. Full edge case test suite shows 33/33 passing (100% coverage restored)
5. No changes to test logic or assertions - only redirect URL updated
6. Gap 1 from VERIFICATION.md is fully closed (no longer PARTIAL status)
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-user-flow-architecture-audit/06.1-04-SUMMARY.md`
</output>
