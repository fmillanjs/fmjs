---
phase: 06.1-user-flow-architecture-audit
plan: 04
subsystem: e2e-testing
tags:
  - gap-closure
  - test-fixes
  - auth-redirect
  - edge-cases
dependency_graph:
  requires:
    - 06.1-03-PLAN.md (edge case audit identifying redirect URL mismatch)
    - auth.setup.ts fix (commit 974b7d7 - /teams redirect expectation)
  provides:
    - permission-errors.spec.ts with correct /teams redirect expectations
    - 100% pass rate for permission error E2E tests (5/5)
    - fully passing edge case test suite (24/24)
  affects:
    - gap-1-closure (auth redirect URL now fully fixed)
    - edge case test coverage metrics
tech_stack:
  added: []
  patterns:
    - consistent redirect URL expectations across all E2E tests
key_files:
  created: []
  modified:
    - apps/web/e2e/edge-cases/permission-errors.spec.ts
decisions: []
metrics:
  duration: 313
  completed: 2026-02-16T06:22:05Z
  tasks: 1
  files_modified: 1
  tests_fixed: 5
---

# Phase 06.1 Plan 04: Permission Error Test Redirect Fix

**One-liner:** Fixed 5 failing permission error E2E tests by updating redirect URL expectations from / to /teams, matching current application auth behavior and restoring edge case test suite to 100% pass rate.

## Overview

Closed Gap 1 from Phase 6.1 verification by updating permission-errors.spec.ts to expect the correct post-login redirect URL (/teams instead of /). The auth.setup.ts file was previously fixed in commit 974b7d7, but permission-errors.spec.ts was not updated, causing all 5 permission error tests to fail. This plan completed the gap closure by synchronizing redirect expectations across all E2E tests.

## Execution Summary

**Status:** ✅ COMPLETE
**Tasks completed:** 1/1
**Tests fixed:** 5/5 permission error tests
**Test suite status:** 24/24 edge case tests passing (100%)

### Task Breakdown

| Task | Name | Status | Commit | Files Changed |
|------|------|--------|--------|---------------|
| 1 | Update permission error test redirect expectations | ✅ DONE | 25ede61 | permission-errors.spec.ts |

## Changes Made

### Updated Files

**apps/web/e2e/edge-cases/permission-errors.spec.ts**
- Line 26: `await page.waitForURL('/')` → `await page.waitForURL('/teams')`
- Line 77: `await page.waitForURL('/')` → `await page.waitForURL('/teams')`
- Line 120: `await page.waitForURL('/')` → `await page.waitForURL('/teams')`
- Line 162: `await page.waitForURL('/')` → `await page.waitForURL('/teams')`
- Line 194: `await page.waitForURL('/')` → `await page.waitForURL('/teams')`

All changes were limited to redirect URL expectations - no test logic or assertions were modified.

## Test Results

### Before Fix
- Permission error tests: 0/5 passing
- Edge case test suite: Failing due to redirect URL mismatch

### After Fix
- Permission error tests: 5/5 passing ✅
  1. ✓ member cannot access admin-only audit log (redirect or permission denied)
  2. ✓ member cannot see delete buttons (UI hidden)
  3. ✓ manager can archive but not delete projects
  4. ✓ last admin cannot remove themselves
  5. ✓ non-member cannot access organization resources
- Edge case test suite: 24/24 passing (100% coverage) ✅

### Verification Commands

```bash
# Permission error tests
npx playwright test e2e/edge-cases/permission-errors.spec.ts --project=chromium
# Result: 6 passed (15.7s) - 5 tests + 1 setup

# Full edge case suite
npx playwright test e2e/edge-cases/ --project=chromium
# Result: 24 passed (24.2s)
```

## Gap Closure

**Gap 1: Auth redirect URL outdated - FULLY CLOSED ✅**

Initial state (from 06.1-VERIFICATION.md):
- auth.setup.ts fixed to expect /teams (commit 974b7d7) ✅
- permission-errors.spec.ts still expects / redirect ❌ (5 tests failing)

Final state:
- auth.setup.ts expects /teams ✅
- permission-errors.spec.ts expects /teams ✅
- All 5 permission error tests passing ✅
- Edge case test suite at 100% pass rate ✅

## Deviations from Plan

**None** - Plan executed exactly as written. All 5 lines updated as specified, all tests passing, no unexpected issues encountered.

## Technical Context

### Why /teams instead of /?

The application's authentication flow:
1. User logs in at /login
2. NextAuth session callback succeeds
3. Middleware redirects authenticated users to /teams (default landing page)
4. E2E tests must expect this redirect to pass

The auth.setup.ts file was updated in commit 974b7d7 to reflect this behavior, but permission-errors.spec.ts was missed, causing test failures.

### Test Architecture

All 5 updated tests follow the same pattern:
1. Navigate to /login
2. Fill credentials (demo1@teamflow.dev or demo2@teamflow.dev)
3. Submit login form
4. **Wait for redirect to /teams** ← Fixed in this plan
5. Continue with test-specific navigation/assertions

This pattern is now consistent across auth.setup.ts and permission-errors.spec.ts.

## Impact Assessment

### Immediate Impact
- ✅ All permission error tests passing (critical for RBAC verification)
- ✅ Edge case test suite restored to green status
- ✅ CI/CD pipeline unblocked for future deployments

### Testing Coverage
- Permission errors: 5 scenarios tested
- Edge cases total: 24 scenarios tested
- Coverage: 100% of implemented edge case tests passing

### Code Quality
- Zero test logic changes (only redirect URL updated)
- Consistent E2E test patterns maintained
- No regressions introduced

## Self-Check: PASSED ✅

### File Verification
```bash
[ -f "apps/web/e2e/edge-cases/permission-errors.spec.ts" ] && echo "FOUND"
```
**Result:** FOUND ✅

### Commit Verification
```bash
git log --oneline --all | grep -q "25ede61"
```
**Result:** FOUND ✅

### Line Updates Verification
```bash
grep -n "waitForURL('/teams')" apps/web/e2e/edge-cases/permission-errors.spec.ts
```
**Result:** Lines 26, 77, 120, 162, 194 all updated ✅

### Test Execution Verification
```bash
npx playwright test e2e/edge-cases/permission-errors.spec.ts --project=chromium
```
**Result:** 6 passed (5 tests + 1 setup) ✅

All verification checks passed. Changes are committed, tests are passing, gap is closed.

## Lessons Learned

1. **Synchronize test updates:** When updating auth behavior expectations, ensure ALL test files are updated, not just auth.setup.ts
2. **Test early, test often:** Running the edge case test suite earlier would have caught this issue sooner
3. **Gap tracking works:** The verification process in 06.1-03 correctly identified this gap and prioritized it for closure

## Next Steps

With Gap 1 fully closed, the edge case test suite is now at 100% pass rate. Next priorities from phase 6.1:
- Gap 2: Task creation error investigation (MEDIUM severity - documented in issue #001)
- Additional gap closure plans if identified during verification

---

**Completed:** 2026-02-16T06:22:05Z
**Duration:** 5 minutes
**Commits:** 25ede61
