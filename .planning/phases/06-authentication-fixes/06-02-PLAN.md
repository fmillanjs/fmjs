---
phase: 06-authentication-fixes
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - e2e/websocket-auth.spec.ts
  - .planning/phases/06-authentication-fixes/06-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "User can connect to WebSocket after login without authentication errors"
    - "User sees live presence indicators in project view"
    - "User sees real-time task updates when tasks are created or moved"
    - "User sees real-time comments appearing instantly"
    - "System handles concurrent edits with conflict detection"
    - "E2E test verifies WebSocket authentication flow automatically"
  artifacts:
    - path: "e2e/websocket-auth.spec.ts"
      provides: "Automated WebSocket authentication E2E test"
      exports: []
      min_lines: 60
    - path: ".planning/phases/06-authentication-fixes/06-VERIFICATION.md"
      provides: "Complete verification results for all Phase 3 features"
      contains: "VERIFICATION COMPLETE"
  key_links:
    - from: "apps/web/lib/websocket.ts"
      to: "apps/api/src/modules/events/events.gateway.ts"
      via: "Socket.IO connection with JWT auth"
      pattern: "socket\\.auth.*token"
    - from: "e2e/websocket-auth.spec.ts"
      to: "WebSocket server"
      via: "page.on('websocket') listener"
      pattern: "page\\.on\\('websocket'"
---

<objective>
Verify that JWT_SECRET configuration fix unblocks all Phase 3 real-time collaboration features through manual testing and automated E2E verification.

Purpose: Confirm WebSocket authentication now succeeds with matching JWT secrets, enabling presence indicators, real-time task updates, live comments, and conflict detection. Validate that all Phase 3 requirements (REAL-01 through REAL-07) are now functional.

Output: Complete verification documentation, automated E2E test for WebSocket authentication, and confirmation that all 8 blocked Phase 3 requirements are now working.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-authentication-fixes/06-RESEARCH.md
@.planning/phases/06-authentication-fixes/06-01-SUMMARY.md
@.planning/phases/03-real-time-collaboration/03-01-SUMMARY.md
@.planning/phases/03-real-time-collaboration/03-02-SUMMARY.md
@.planning/phases/03-real-time-collaboration/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Manual WebSocket connection verification</name>
  <files>.planning/phases/06-authentication-fixes/06-VERIFICATION.md</files>
  <action>
Verify WebSocket authentication succeeds by testing actual login and connection flow, then document results.

**Prerequisites:**
- Both apps running from Plan 01 Task 3 (backend on :3001, frontend on :3000)
- If not running, start them now

**Test Procedure:**

**1. Open browser with DevTools**
- Navigate to: http://localhost:3000/login
- Open DevTools Console (F12 → Console tab)
- Open DevTools Network tab → filter by "WS" to see WebSocket connections

**2. Login as demo user**
- Email: demo1@teamflow.dev
- Password: Password123!
- Click "Sign In"

**3. Navigate to team workspace**
- Should redirect to /teams after login
- Click on "Demo Workspace" (or any team)
- This triggers WebSocket connection to project room

**4. Verify WebSocket connection in DevTools Console**
Look for these log messages:
```
[WebSocket Client] Initializing connection: { url: 'ws://localhost:3001', hasToken: true, tokenLength: <number> }
[WebSocket Client] Connected to server
```

**5. Verify backend accepted connection (check API terminal)**
Look for backend logs:
```
[WS Handshake] Auth object: { token: 'eyJhbGc...' }
[WS Auth] Token received: { type: 'Bearer', length: <number> }
[WS Auth] Decoded token (unverified): { header: { alg: 'HS256' }, payload: { sub: '...', email: '...' } }
[WS Auth] Verification SUCCESS: { sub: '...', email: 'demo1@teamflow.dev', role: 'ADMIN' }
```

**CRITICAL: Look for "Verification SUCCESS"** - this confirms JWT_SECRET fix worked.

**6. Check for authentication errors**
In browser console, look for:
- ❌ NO "Invalid token" errors
- ❌ NO "Unauthorized" errors
- ❌ NO connection failures
- ✓ Connection established successfully

**7. Document results**
Create `.planning/phases/06-authentication-fixes/06-VERIFICATION.md` with:

```markdown
# Phase 6: Authentication Fixes - Verification Results

**Date:** <current-date>
**Tester:** Claude (automated)

## WebSocket Connection Test

**Test:** Manual login and WebSocket connection
**Status:** [PASS/FAIL]

### Browser Console Output
<paste relevant logs>

### Backend Terminal Output
<paste relevant logs>

### Verification Status
- [ ] WebSocket connection established
- [ ] Backend logged "Verification SUCCESS"
- [ ] No "Invalid token" errors
- [ ] No "Unauthorized" errors

**Result:** WebSocket authentication [WORKING/FAILED]
**Root cause resolution:** JWT_SECRET mismatch [CONFIRMED FIXED/STILL PRESENT]

---
```

**If test FAILS:**
- Check secret lengths still match (both ~88 chars)
- Verify .env and .env.local have identical JWT_SECRET
- Check for typos or whitespace differences
- Restart both servers to reload environment variables
- Re-run test
  </action>
  <verify>
Check verification document exists:
```bash
ls -la .planning/phases/06-authentication-fixes/06-VERIFICATION.md
```

Check document contains results:
```bash
grep -E "Verification SUCCESS|PASS|FAIL" .planning/phases/06-authentication-fixes/06-VERIFICATION.md
```

Expected: File exists with test results documented
  </verify>
  <done>
- Manual WebSocket connection test performed
- Browser DevTools console logs captured
- Backend terminal logs captured
- Verification document created with test results
- WebSocket authentication status confirmed (PASS or FAIL with details)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
WebSocket authentication fix verified through manual testing. JWT_SECRET configuration should now allow successful WebSocket connections, unblocking all Phase 3 real-time features.

**What to verify:**
1. WebSocket connects successfully after login (no "Invalid token" errors)
2. All Phase 3 real-time features are now functional:
   - Presence indicators showing active users
   - Real-time task updates (create, move, edit)
   - Real-time comments appearing instantly
   - Conflict detection and warnings

**Test context:**
- Backend should show "Verification SUCCESS" in logs
- Frontend should show "Connected to server" in console
- No authentication errors in either terminal or browser console
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Both apps running (backend :3001, frontend :3000)
- Logged in as demo1@teamflow.dev
- Viewing a project workspace (Demo Workspace recommended)

**Test 1: Presence Indicators**
1. Note current presence indicator (top of project page)
2. Open new incognito window
3. Login as demo2@teamflow.dev / Password123!
4. Navigate to same project in incognito window
5. **Expected:** Original window shows presence indicator with 2 users

**Test 2: Real-Time Task Updates**
1. In original window, view Kanban board
2. In incognito window, create a new task in "TODO" column
3. **Expected:** Original window immediately shows new task appear (no refresh needed)
4. In incognito window, drag task to "IN_PROGRESS"
5. **Expected:** Original window shows task move instantly

**Test 3: Real-Time Comments**
1. In original window, open a task detail panel
2. In incognito window, open same task detail panel
3. In incognito window, add a comment: "Testing real-time sync"
4. **Expected:** Original window shows comment appear instantly below existing comments

**Test 4: Conflict Detection**
1. In both windows, open same task for editing
2. In incognito window, edit task title and save
3. In original window, edit task title (different text) and attempt to save
4. **Expected:** Original window shows conflict warning with version mismatch error

**Test 5: Connection Stability**
1. Check browser DevTools console for "[WebSocket Client] Connected to server"
2. Check backend terminal for "[WS Auth] Verification SUCCESS"
3. Navigate between projects
4. **Expected:** No disconnections or authentication errors

**Success Criteria:**
- ✓ All 5 tests pass
- ✓ No "Invalid token" errors in logs
- ✓ Presence, tasks, comments update in real-time
- ✓ Conflict detection shows version warnings

**If any test fails:**
- Check 06-VERIFICATION.md for WebSocket connection status
- Verify secret fingerprints match (from Plan 01)
- Check browser console for error messages
- Check backend logs for authentication failures
  </how-to-verify>
  <resume-signal>
Type one of:
- "approved" - All tests passed, Phase 3 features working
- "partial" - Some tests passed, describe which failed
- "failed" - WebSocket still not working, describe errors seen

Include any error messages or unexpected behavior observed.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create E2E WebSocket authentication test</name>
  <files>e2e/websocket-auth.spec.ts</files>
  <action>
Create automated Playwright E2E test to verify WebSocket authentication flow, preventing future regressions.

**Create new file:** `e2e/websocket-auth.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('WebSocket Authentication', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });

  test('should connect to WebSocket after login without authentication errors', async ({ page }) => {
    // Track WebSocket connections
    const wsConnections: { url: string; connected: boolean }[] = [];
    const wsErrors: string[] = [];

    page.on('websocket', (ws) => {
      const connection = { url: ws.url(), connected: false };
      wsConnections.push(connection);

      console.log('[Test] WebSocket connection initiated:', ws.url());

      ws.on('framereceived', (event) => {
        const payload = event.payload;
        console.log('[Test] Frame received:', payload.length, 'bytes');
      });

      ws.on('framesent', (event) => {
        const payload = event.payload;
        console.log('[Test] Frame sent:', payload.length, 'bytes');
      });

      ws.on('close', () => {
        console.log('[Test] WebSocket closed');
      });
    });

    // Track console errors for authentication failures
    page.on('console', (msg) => {
      if (msg.type() === 'error') {
        const text = msg.text();
        if (text.includes('Invalid token') || text.includes('Unauthorized') || text.includes('authentication')) {
          wsErrors.push(text);
          console.error('[Test] Auth error detected:', text);
        }
      }
    });

    // Navigate to teams page (triggers WebSocket connection)
    await page.goto('http://localhost:3000/teams');
    await page.waitForURL('**/teams/**');

    // Wait for WebSocket connection to establish
    await page.waitForTimeout(2000);

    // Verify WebSocket connected
    expect(wsConnections.length).toBeGreaterThan(0);
    expect(wsConnections[0].url).toContain('ws://localhost:3001');

    // Verify no authentication errors
    expect(wsErrors).toHaveLength(0);

    // Navigate to demo workspace
    await page.click('text=Demo Workspace');
    await page.waitForURL('**/teams/**/projects');

    // Wait for project room connection
    await page.waitForTimeout(1000);

    // Verify still no auth errors after room join
    expect(wsErrors).toHaveLength(0);

    console.log('[Test] WebSocket authentication verified successfully');
    console.log('[Test] Connections:', wsConnections.length);
    console.log('[Test] Errors:', wsErrors.length);
  });

  test('should maintain WebSocket connection across navigation', async ({ page }) => {
    const wsErrors: string[] = [];

    page.on('console', (msg) => {
      if (msg.type() === 'error' && msg.text().includes('Invalid token')) {
        wsErrors.push(msg.text());
      }
    });

    // Navigate through multiple pages
    await page.goto('http://localhost:3000/teams');
    await page.waitForTimeout(1000);

    await page.click('text=Demo Workspace');
    await page.waitForTimeout(1000);

    await page.click('text=Projects');
    await page.waitForTimeout(1000);

    // Verify no authentication errors during navigation
    expect(wsErrors).toHaveLength(0);
  });
});
```

**Key test assertions:**
1. WebSocket connection URL matches expected ws://localhost:3001
2. No "Invalid token" or "Unauthorized" errors in console
3. Connection remains stable across navigation
4. WebSocket frames sent/received successfully

**Why E2E test matters:**
Prevents regression - if JWT_SECRET configuration breaks again (e.g., during deployment, environment changes), CI/CD will catch it before production.

**Test execution:**
This test runs in CI/CD pipeline (already configured in Phase 4) and can be run locally:
```bash
npm run test:e2e
```
  </action>
  <verify>
Run E2E test locally:
```bash
cd /home/doctor/fernandomillan
npm run test:e2e -- websocket-auth.spec.ts
```

Expected output:
```
✓ WebSocket Authentication > should connect to WebSocket after login without authentication errors
✓ WebSocket Authentication > should maintain WebSocket connection across navigation

2 passed (Xms)
```

If test fails, check error output for specific assertion failures.
  </verify>
  <done>
- e2e/websocket-auth.spec.ts created with 2 test cases
- Test verifies WebSocket connection without authentication errors
- Test verifies connection stability across navigation
- E2E test passes locally (or documented failure with reason)
- Test integrated into existing Playwright test suite
  </done>
</task>

<task type="auto">
  <name>Task 3: Update verification document and ROADMAP status</name>
  <files>
    .planning/phases/06-authentication-fixes/06-VERIFICATION.md
    .planning/ROADMAP.md
  </files>
  <action>
Complete verification documentation with full Phase 3 feature testing results and update ROADMAP to reflect unblocked requirements.

**Step 1: Update 06-VERIFICATION.md**

Append to existing verification document:

```markdown

## Phase 3 Real-Time Features Testing

**Date:** <current-date>

### Feature Verification Results

| Requirement | Feature | Status | Notes |
|-------------|---------|--------|-------|
| REAL-01 | Live updates when tasks created | [PASS/FAIL] | [observations] |
| REAL-02 | Live updates when tasks moved | [PASS/FAIL] | [observations] |
| REAL-03 | Live updates when tasks edited | [PASS/FAIL] | [observations] |
| REAL-04 | Live comments appearing instantly | [PASS/FAIL] | [observations] |
| REAL-05 | Presence indicators showing active users | [PASS/FAIL] | [observations] |
| REAL-06 | Optimistic UI with rollback on failure | [PASS/FAIL] | [observations] |
| REAL-07 | Conflict detection with version checking | [PASS/FAIL] | [observations] |

### E2E Test Results

**Test Suite:** e2e/websocket-auth.spec.ts
**Status:** [PASS/FAIL]
**Tests Run:** 2
**Tests Passed:** [0-2]
**Tests Failed:** [0-2]

**Output:**
<paste test output>

---

## VERIFICATION COMPLETE

**Overall Status:** Phase 6 authentication fixes [SUCCESSFUL/NEEDS ATTENTION]

**Root Cause Resolution:**
- JWT_SECRET mismatch between frontend and backend: ✓ RESOLVED
- Consistent 512-bit secret deployed: ✓ CONFIRMED
- Fail-fast validation prevents future misconfiguration: ✓ IMPLEMENTED

**Phase 3 Features Status:**
- [X/8] requirements now functional
- WebSocket authentication: [WORKING/BLOCKED]
- Real-time collaboration: [ENABLED/DISABLED]

**Next Steps:**
[If all passed]: Phase 6 complete - all Phase 3 features unblocked
[If issues remain]: Document specific failures and recommended follow-up actions
```

Fill in status/observations based on checkpoint results and E2E test output.

**Step 2: Update ROADMAP.md**

Find Phase 3 section and update Success Criteria checkmarks:

```markdown
### Phase 3: Real-Time Collaboration

**Success Criteria** (what must be TRUE):
  1. ✓ User sees live updates when other users create tasks, move tasks between columns, or change task details without page refresh
  2. ✓ User sees live updates when comments are added to tasks they are viewing
  3. ✓ User sees presence indicators showing how many users are viewing the same project
  4. ✓ User experiences optimistic UI updates with automatic rollback on server failure
  5. ✓ System detects concurrent edits and shows clear conflict resolution UI to user
  6. ✓ WebSocket events use Redis pub/sub enabling horizontal scaling across multiple server instances
```

Also update Phase 6 section:

```markdown
### Phase 6: Authentication Fixes

**Goal:** Fix JWT_SECRET configuration mismatch to unblock Phase 3 real-time collaboration features
**Depends on:** Phase 5.1
**Plans:** 2 plans

Plans:
- [x] 06-01-PLAN.md — JWT configuration fix (add to .env.local, remove fallback, validation, rotate secret)
- [x] 06-02-PLAN.md — End-to-end verification (manual WebSocket test + Phase 3 features + E2E test)

**Status:** Complete
```

And update progress table:

```markdown
| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
...
| 6. Authentication Fixes | 2/2 | ✓ Complete | <current-date> |
```
  </action>
  <verify>
Check verification document is complete:
```bash
grep "VERIFICATION COMPLETE" .planning/phases/06-authentication-fixes/06-VERIFICATION.md
```

Check ROADMAP updated:
```bash
grep -A2 "Phase 6: Authentication Fixes" .planning/ROADMAP.md | grep "2/2"
```

Expected: Both checks pass showing completion
  </verify>
  <done>
- 06-VERIFICATION.md completed with all test results
- ROADMAP.md Phase 3 Success Criteria updated with checkmarks
- ROADMAP.md Phase 6 marked complete (2/2 plans)
- Progress table updated with completion date
- All documentation reflects accurate project state
  </done>
</task>

</tasks>

<verification>
**Overall Phase Verification:**

1. **WebSocket connection verified:**
   ```bash
   grep "Verification SUCCESS" .planning/phases/06-authentication-fixes/06-VERIFICATION.md
   ```
   Expected: Manual test shows backend verification success

2. **E2E test passes:**
   ```bash
   npm run test:e2e -- websocket-auth.spec.ts
   ```
   Expected: 2/2 tests pass

3. **Phase 3 features working:**
   - Presence indicators display active users
   - Tasks update in real-time across windows
   - Comments appear instantly
   - Conflict detection shows warnings

4. **Documentation complete:**
   ```bash
   ls -la .planning/phases/06-authentication-fixes/06-VERIFICATION.md
   grep "VERIFICATION COMPLETE" .planning/phases/06-authentication-fixes/06-VERIFICATION.md
   ```
   Expected: File exists with complete verification results

**Success criteria:**
- ✓ WebSocket authentication succeeds (no "Invalid token" errors)
- ✓ All Phase 3 requirements functional
- ✓ E2E test prevents future regressions
- ✓ Documentation complete and ROADMAP updated
</verification>

<success_criteria>
**Phase 6 Plan 02 is complete when:**

1. **Manual verification successful:**
   - WebSocket connects without authentication errors
   - Backend logs show "Verification SUCCESS"
   - Frontend console shows "Connected to server"
   - 06-VERIFICATION.md documents test results

2. **Human checkpoint approved:**
   - User confirmed all 5 verification tests pass
   - Presence indicators work
   - Real-time task updates work
   - Real-time comments work
   - Conflict detection works

3. **E2E test implemented and passing:**
   - e2e/websocket-auth.spec.ts created
   - Test verifies WebSocket connection succeeds
   - Test verifies no authentication errors
   - Test passes locally (2/2 tests)

4. **Documentation complete:**
   - 06-VERIFICATION.md has complete results for all Phase 3 features
   - ROADMAP.md Phase 3 Success Criteria checked
   - ROADMAP.md Phase 6 marked complete

**Phase 6 COMPLETE:** JWT_SECRET configuration fixed, WebSocket authentication working, all Phase 3 real-time collaboration features unblocked and verified functional.
</success_criteria>

<output>
After completion, create `.planning/phases/06-authentication-fixes/06-02-SUMMARY.md` documenting:
- Manual WebSocket connection test results
- Human verification checkpoint feedback
- Phase 3 feature testing results (all 7 requirements)
- E2E test implementation and results
- Any issues encountered and resolutions
- Confirmation that Phase 3 features are now fully operational
</output>
