---
phase: 03-real-time-collaboration
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - apps/api/src/modules/tasks/tasks.service.ts
  - apps/api/src/modules/tasks/dto/update-task.dto.ts
  - apps/web/components/tasks/kanban-board.tsx
  - apps/web/components/tasks/task-detail-panel.tsx
  - apps/web/components/ui/conflict-warning.tsx
  - packages/shared/src/validators/task.schema.ts
autonomous: false

must_haves:
  truths:
    - "System returns 409 Conflict when a task update includes a stale version number"
    - "User sees a conflict warning toast when their edit conflicts with another user's edit"
    - "Conflict warning provides a clear action to refresh and see the latest data"
    - "Version number is sent with every task update request from the frontend"
    - "All real-time features work together end-to-end across multiple browser tabs"
  artifacts:
    - path: "apps/web/components/ui/conflict-warning.tsx"
      provides: "Conflict warning toast/banner component"
      contains: "ConflictWarning"
    - path: "apps/api/src/modules/tasks/tasks.service.ts"
      provides: "Version check in update methods"
      contains: "ConflictException"
  key_links:
    - from: "apps/web/components/tasks/kanban-board.tsx"
      to: "apps/api/src/modules/tasks/tasks.service.ts"
      via: "API call with version field"
      pattern: "version"
    - from: "apps/api/src/modules/tasks/tasks.service.ts"
      to: "apps/web/components/ui/conflict-warning.tsx"
      via: "409 response triggers conflict UI"
      pattern: "409|ConflictException"
---

<objective>
Implement version-based conflict detection for concurrent task edits and verify all real-time features work together end-to-end.

Purpose: Conflict detection is the "senior engineer" feature — it shows understanding of distributed systems challenges. Combined with end-to-end verification, this completes the real-time collaboration phase.
Output: Working conflict detection with user-friendly UI + verified real-time collaboration across all features.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-collaboration/03-RESEARCH.md
@.planning/phases/03-real-time-collaboration/03-01-SUMMARY.md
@.planning/phases/03-real-time-collaboration/03-02-SUMMARY.md
@.planning/phases/03-real-time-collaboration/03-03-SUMMARY.md

Key existing files:
@apps/api/src/modules/tasks/tasks.service.ts
@apps/api/src/modules/tasks/dto/update-task.dto.ts
@apps/web/components/tasks/kanban-board.tsx
@apps/web/components/tasks/task-detail-panel.tsx
@packages/shared/src/validators/task.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Version-based conflict detection backend and frontend integration</name>
  <files>
    apps/api/src/modules/tasks/tasks.service.ts
    apps/api/src/modules/tasks/dto/update-task.dto.ts
    apps/web/components/ui/conflict-warning.tsx
    apps/web/components/tasks/kanban-board.tsx
    apps/web/components/tasks/task-detail-panel.tsx
    packages/shared/src/validators/task.schema.ts
  </files>
  <action>
    1. Add `version` field to UpdateTaskDto and UpdateTaskStatusDto:
       - In `apps/api/src/modules/tasks/dto/update-task.dto.ts`: Add `version?: number` (optional — not all clients may send it initially)
       - In `packages/shared/src/validators/task.schema.ts`: Add `version: z.number().int().optional()` to update schemas

    2. Add version conflict check to `tasks.service.ts`:
       - In `update()` method: Before the Prisma update, check `if (dto.version !== undefined && dto.version !== task.version)`. If mismatch, throw `new ConflictException('Task was modified by another user. Please refresh to see the latest version.')`
       - Import `ConflictException` from `@nestjs/common`
       - In `updateStatus()` method: Same version check with `dto.version`
       - The `version: { increment: 1 }` should already be in the update data from Plan 01

    3. Create `apps/web/components/ui/conflict-warning.tsx`:
       - A toast-style notification component:
         * Fixed position bottom-right (or use existing toast system if one exists — check for sonner, react-hot-toast, or custom)
         * Yellow/amber background (warning, not error)
         * Icon: exclamation triangle
         * Message: "This task was modified by another user."
         * Action button: "Refresh" that calls a provided callback to refetch
         * Auto-dismiss after 10 seconds
         * Animate in/out with transition
       - Export `showConflictWarning(onRefresh: () => void)` function or use a state-based approach
       - DO NOT use purple in any warning colors

    4. Update `kanban-board.tsx` drag-drop to send version:
       - In `handleDragEnd`: When calling `api.patch('/tasks/${taskId}/status', ...)`, include the task's current version: `{ status: targetStatus, version: task.version }`
       - Handle 409 response: If the API returns 409, show ConflictWarning toast and refetch tasks
       - The existing optimistic revert already handles the visual state on error

    5. Update `task-detail-panel.tsx` to send version on edits:
       - When inline editing saves (title, description, status, priority, assignee), include `version` in the PATCH request body
       - Handle 409 response: Show conflict warning, offer to refresh the task detail
       - After refresh, the task detail shows the latest server state

    6. Update real-time task event handling to include version:
       - When a `task:updated` WebSocket event arrives, the task object should include `version`
       - Update local task state with the new version number so subsequent edits from the current user use the correct version
       - This prevents stale version conflicts after receiving real-time updates
  </action>
  <verify>
    - `cd apps/api && npx tsc --noEmit` passes
    - `cd apps/web && npx tsc --noEmit` passes
    - `grep -r "ConflictException" apps/api/src/modules/tasks/tasks.service.ts` shows version check
    - `grep -r "version" apps/web/components/tasks/kanban-board.tsx` shows version sent with API calls
    - ConflictWarning component exists
    - `grep -r "409" apps/web/components/tasks/` shows conflict handling
  </verify>
  <done>
    Version mismatch returns 409 Conflict from API, frontend sends version with all task updates, conflict warning UI appears on 409, user can refresh to see latest data, version updates flow through WebSocket events
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of all real-time features</name>
  <files>N/A — verification only</files>
  <action>
    Human verification of complete Phase 3 real-time collaboration system. What was built:
    1. Redis-backed WebSocket infrastructure with project rooms
    2. Real-time task CRUD updates (create, move, edit, delete)
    3. Real-time comment updates
    4. Presence tracking (who is viewing the project)
    5. Optimistic UI with rollback
    6. Version-based conflict detection with warning UI

    **Prerequisites:**
    - Make sure Docker containers are running (postgres + redis): `docker ps`
    - Start the API: `cd apps/api && npm run start:dev`
    - Start the web app: `cd apps/web && npm run dev`

    **Test 1: WebSocket Connection**
    1. Open browser DevTools Console
    2. Navigate to any project page (e.g., demo workspace project)
    3. Verify "WS connected" appears in console
    4. Check Network tab -> WS tab shows active WebSocket connection

    **Test 2: Real-Time Task Updates (open 2 browser tabs)**
    1. Open the same project in Tab A and Tab B (use demo workspace)
    2. In Tab A: Create a new task via the Kanban board
    3. Verify: Task appears in Tab B without refreshing
    4. In Tab B: Drag the task to a different column
    5. Verify: Task moves in Tab A without refreshing
    6. In Tab A: Click a task and edit its title
    7. Verify: Title updates in Tab B without refreshing
    8. In Tab B: Delete a task
    9. Verify: Task disappears in Tab A without refreshing

    **Test 3: Real-Time Comments**
    1. In Tab A: Open a task detail page
    2. In Tab B: Navigate to the same task
    3. In Tab A: Add a comment
    4. Verify: Comment appears in Tab B without refreshing

    **Test 4: Presence Indicators**
    1. In Tab A: Look at the project page header
    2. Verify: Presence indicator shows at least 1 active user
    3. Open Tab B on the same project
    4. Verify: Presence count increases in both tabs
    5. Close Tab B
    6. Verify: Presence count decreases in Tab A

    **Test 5: Conflict Detection**
    1. In Tab A: Open a task detail
    2. In Tab B: Edit the same task's title and save
    3. In Tab A: Try to edit the same task's title and save
    4. Verify: Tab A shows a conflict warning (amber/yellow toast)
    5. Click "Refresh" in the conflict warning
    6. Verify: Task shows Tab B's changes

    **Test 6: Optimistic UI Rollback**
    1. Stop the API server (Ctrl+C)
    2. In Tab A: Try to drag a task to a different column
    3. Verify: Task briefly moves (optimistic) then reverts back
    4. Restart the API server

    **Test 7: Reconnection**
    1. Navigate to a project
    2. Stop and restart the API server
    3. Verify: WebSocket reconnects (check console)
    4. Verify: Data is fresh after reconnection
  </action>
  <verify>User confirms all 7 tests pass by typing "approved"</verify>
  <done>All real-time collaboration features verified working end-to-end: task updates, comments, presence, conflict detection, optimistic rollback, and reconnection</done>
</task>

</tasks>

<verification>
1. Backend: ConflictException thrown on version mismatch
2. Frontend: Version sent with all PATCH requests
3. UI: ConflictWarning component renders on 409
4. Integration: All 7 end-to-end tests pass
5. No purple in any UI component
</verification>

<success_criteria>
- 409 Conflict response on stale version updates
- Conflict warning toast displays with refresh action
- All real-time features verified working across two browser tabs
- WebSocket reconnects and refetches after disconnection
- Optimistic UI reverts on API failure
- No visual regressions in existing UI
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-collaboration/03-04-SUMMARY.md`
</output>
