---
phase: 03-real-time-collaboration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/providers/websocket-provider.tsx
  - apps/web/hooks/use-websocket.ts
  - apps/web/hooks/use-real-time-tasks.ts
  - apps/web/components/tasks/kanban-board.tsx
  - apps/web/components/tasks/task-list-view.tsx
  - apps/web/app/(dashboard)/teams/[teamId]/projects/[projectId]/page.tsx
  - apps/web/lib/websocket.ts
autonomous: true

must_haves:
  truths:
    - "User sees new tasks appear on Kanban board when another user creates a task (no page refresh)"
    - "User sees tasks move between columns when another user drags a task (no page refresh)"
    - "User sees task details change when another user edits a task (no page refresh)"
    - "User sees tasks disappear when another user deletes a task (no page refresh)"
    - "Optimistic UI updates work for drag-drop with automatic revert on API error"
    - "WebSocket reconnects and refetches latest data after disconnection"
  artifacts:
    - path: "apps/web/providers/websocket-provider.tsx"
      provides: "React context provider managing WebSocket connection lifecycle"
      contains: "WebSocketProvider"
    - path: "apps/web/hooks/use-websocket.ts"
      provides: "Hook to access WebSocket connection from context"
      exports: ["useWebSocket"]
    - path: "apps/web/hooks/use-real-time-tasks.ts"
      provides: "Hook that listens for task WebSocket events and updates local state"
      exports: ["useRealTimeTasks"]
    - path: "apps/web/components/tasks/kanban-board.tsx"
      provides: "Kanban board with real-time task updates from other users"
      contains: "useRealTimeTasks"
  key_links:
    - from: "apps/web/hooks/use-real-time-tasks.ts"
      to: "apps/web/hooks/use-websocket.ts"
      via: "useWebSocket() hook call"
      pattern: "useWebSocket"
    - from: "apps/web/components/tasks/kanban-board.tsx"
      to: "apps/web/hooks/use-real-time-tasks.ts"
      via: "useRealTimeTasks() hook integration"
      pattern: "useRealTimeTasks"
    - from: "apps/web/providers/websocket-provider.tsx"
      to: "apps/web/lib/websocket.ts"
      via: "Socket.IO connection with JWT auth"
      pattern: "getSocket|io\\("
---

<objective>
Build the frontend real-time task update system: a WebSocket provider for connection management, a custom hook for real-time task state updates, and integration into the Kanban board and list view so users see live changes from other users without page refresh.

Purpose: This is the most visible real-time feature — users see tasks appear, move, change, and disappear in real-time. Demonstrates React 19 useOptimistic with WebSocket sync.
Output: Kanban board and list view that update in real-time when any user in the project makes changes.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-collaboration/03-RESEARCH.md
@.planning/phases/03-real-time-collaboration/03-01-SUMMARY.md

Key existing files:
@apps/web/lib/websocket.ts
@apps/web/components/tasks/kanban-board.tsx
@apps/web/components/tasks/kanban-column.tsx
@packages/shared/src/types/task.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebSocket provider and real-time task hooks</name>
  <files>
    apps/web/providers/websocket-provider.tsx
    apps/web/hooks/use-websocket.ts
    apps/web/hooks/use-real-time-tasks.ts
    apps/web/lib/websocket.ts
  </files>
  <action>
    1. Update `apps/web/lib/websocket.ts`:
       - The existing singleton pattern is fine but needs to handle reconnection better
       - Add a `reconnect` event listener that logs reconnection
       - Keep the existing getSocket and disconnectSocket functions

    2. Create `apps/web/providers/websocket-provider.tsx`:
       - React context provider that manages WebSocket connection lifecycle
       - On mount: Fetch session via `/api/auth/session`, get `accessToken`, call `getSocket(token)` from lib/websocket.ts
       - Store socket in React context
       - On unmount: `disconnectSocket()`
       - Provide `socket` (Socket | null) and `isConnected` (boolean) via context
       - Handle `connect`/`disconnect` events to update `isConnected` state
       - Export `WebSocketProvider` and `useWebSocketContext` hook
       - This provider should wrap the dashboard layout (not the entire app — only authenticated pages need WebSocket)

    3. Create `apps/web/hooks/use-websocket.ts`:
       - Simple hook that calls `useWebSocketContext()` and returns the socket
       - Convenience wrapper so components don't need to import the context directly

    4. Create `apps/web/hooks/use-real-time-tasks.ts`:
       - Hook: `useRealTimeTasks(projectId, currentUserId, tasks, setTasks)`
       - On mount: Emit `join:project` with projectId to subscribe to room
       - Listen for `task:created`: If event.userId !== currentUserId, add task to state
       - Listen for `task:updated` and `task:status_changed`: If event.userId !== currentUserId, update task in state by replacing matching ID
       - Listen for `task:deleted`: If event.userId !== currentUserId, remove task from state by ID
       - On socket reconnect (`connect` event): Refetch all tasks from API to reconcile missed events during disconnection. Use `api.get('/projects/${projectId}/tasks', token)` pattern already used in kanban-board.tsx
       - CRITICAL: Always filter by `event.userId !== currentUserId` to prevent infinite loops (the user who made the change already has the optimistic update)
       - Cleanup: `leave:project`, remove all listeners
       - Dependencies: [socket, projectId, currentUserId]
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` compiles without errors
    - Files exist: providers/websocket-provider.tsx, hooks/use-websocket.ts, hooks/use-real-time-tasks.ts
    - Provider exports WebSocketProvider
    - Hook exports useRealTimeTasks
    - Event listener cleanup exists in useEffect return
  </verify>
  <done>
    WebSocket provider manages connection lifecycle with JWT auth, useRealTimeTasks hook listens for task events and updates local state, reconnection triggers data refetch, all events filtered by userId to prevent self-update loops
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate real-time hooks into Kanban board, list view, and project layout</name>
  <files>
    apps/web/components/tasks/kanban-board.tsx
    apps/web/components/tasks/task-list-view.tsx
    apps/web/app/(dashboard)/teams/[teamId]/projects/[projectId]/page.tsx
    apps/web/app/(dashboard)/layout.tsx
  </files>
  <action>
    1. Add `WebSocketProvider` to the dashboard layout:
       - Edit `apps/web/app/(dashboard)/layout.tsx`
       - Import WebSocketProvider
       - Wrap children with `<WebSocketProvider>{children}</WebSocketProvider>`
       - This ensures WebSocket connection is available to all dashboard pages

    2. Update `apps/web/components/tasks/kanban-board.tsx`:
       - Import and call `useRealTimeTasks(projectId, currentUserId, tasks, setTasks)`
       - Need to get `currentUserId` — use `useSession()` from next-auth/react (already available in client components)
       - The hook will automatically handle join:project, event listening, and cleanup
       - The existing `useState(initialTasks)` + `useOptimistic(tasks)` pattern remains unchanged
       - Real-time updates from other users flow into `tasks` state via `setTasks`, which automatically flows to `optimisticTasks`
       - The existing `handleFormSuccess` which refetches tasks after form submission can remain as-is (belt-and-suspenders approach)

    3. Update `apps/web/components/tasks/task-list-view.tsx` (if it exists):
       - Check if there's a separate list view component
       - If it manages its own task state, integrate `useRealTimeTasks` similarly
       - If it receives tasks as props from the project page, the project page integration is sufficient

    4. Update project page if needed:
       - The project page (`apps/web/app/(dashboard)/teams/[teamId]/projects/[projectId]/page.tsx`) is likely a Server Component that passes initialTasks to KanbanBoard
       - Since KanbanBoard is already a client component managing its own state, the integration in step 2 is sufficient
       - No changes needed to the Server Component unless the page also renders a list view with its own state

    5. Add a small visual indicator for WebSocket connection status:
       - In the project page header area, add a small dot (green when connected, gray when disconnected)
       - Use `useWebSocket()` hook to get `isConnected` state
       - This is subtle but proves real-time is working visually
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` compiles without errors
    - KanbanBoard component imports and calls useRealTimeTasks
    - Dashboard layout wraps children with WebSocketProvider
    - `grep -r "useRealTimeTasks" apps/web/components/` shows integration
    - `grep -r "WebSocketProvider" apps/web/app/` shows provider in layout
  </verify>
  <done>
    Kanban board receives real-time task updates from other users, list view updates in sync, WebSocket provider wraps dashboard layout, connection status indicator visible, optimistic UI continues working for local changes
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `cd apps/web && npx tsc --noEmit` passes
2. Provider in layout: `grep "WebSocketProvider" apps/web/app/(dashboard)/layout.tsx`
3. Hook integration: `grep "useRealTimeTasks" apps/web/components/tasks/kanban-board.tsx`
4. Event filtering: `grep "currentUserId" apps/web/hooks/use-real-time-tasks.ts` confirms self-update prevention
5. Cleanup: `grep "socket.off" apps/web/hooks/use-real-time-tasks.ts` confirms listener cleanup
6. Reconnect handling: `grep "connect" apps/web/hooks/use-real-time-tasks.ts` confirms refetch on reconnect
</verification>

<success_criteria>
- WebSocket connects with JWT auth when user enters dashboard
- Joining a project page subscribes to project room
- Task creation by another user appears in real-time on Kanban board
- Task drag-drop by another user moves card in real-time
- Task edit by another user updates card details in real-time
- Task deletion by another user removes card in real-time
- Reconnection after disconnect triggers data refetch
- No infinite loops from self-update events
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-collaboration/03-02-SUMMARY.md`
</output>
