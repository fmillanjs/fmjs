---
phase: 03-real-time-collaboration
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/api/src/modules/events/events.gateway.ts
  - apps/web/hooks/use-project-presence.ts
  - apps/web/components/project/presence-indicator.tsx
  - apps/web/hooks/use-real-time-comments.ts
  - apps/web/components/tasks/task-detail-panel.tsx
  - apps/web/components/tasks/comment-thread.tsx
autonomous: true

must_haves:
  truths:
    - "User sees presence indicators showing who else is viewing the same project"
    - "Presence count updates when users join or leave the project"
    - "User sees new comments appear in real-time when another user comments on a task they are viewing"
    - "User sees comment edits and deletions in real-time"
  artifacts:
    - path: "apps/web/hooks/use-project-presence.ts"
      provides: "Hook for tracking active users in a project room"
      exports: ["useProjectPresence"]
    - path: "apps/web/components/project/presence-indicator.tsx"
      provides: "UI component showing active user avatars and count"
      contains: "PresenceIndicator"
    - path: "apps/web/hooks/use-real-time-comments.ts"
      provides: "Hook for real-time comment updates on a task"
      exports: ["useRealTimeComments"]
  key_links:
    - from: "apps/web/hooks/use-project-presence.ts"
      to: "apps/web/hooks/use-websocket.ts"
      via: "useWebSocket() for socket access"
      pattern: "useWebSocket"
    - from: "apps/web/components/project/presence-indicator.tsx"
      to: "apps/web/hooks/use-project-presence.ts"
      via: "useProjectPresence() hook call"
      pattern: "useProjectPresence"
    - from: "apps/web/components/tasks/task-detail-panel.tsx"
      to: "apps/web/hooks/use-real-time-comments.ts"
      via: "useRealTimeComments() hook integration"
      pattern: "useRealTimeComments"
---

<objective>
Implement presence tracking (showing who is viewing a project) and real-time comment updates (live comment feed when viewing a task), completing the collaboration experience.

Purpose: Presence indicators create awareness ("Sarah is also looking at this project") and real-time comments enable live discussion on tasks. Both are key collaboration signals for a portfolio showcase.
Output: Presence avatars on project page header + live-updating comment threads on task detail.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-collaboration/03-RESEARCH.md
@.planning/phases/03-real-time-collaboration/03-01-SUMMARY.md

Key existing files:
@apps/api/src/modules/events/events.gateway.ts
@apps/web/components/tasks/task-detail-panel.tsx
@apps/web/components/tasks/comment-thread.tsx
@apps/web/components/tasks/comment-form.tsx
@apps/web/hooks/use-websocket.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend presence tracking + frontend presence indicator</name>
  <files>
    apps/api/src/modules/events/events.gateway.ts
    apps/web/hooks/use-project-presence.ts
    apps/web/components/project/presence-indicator.tsx
    apps/web/app/(dashboard)/teams/[teamId]/projects/[projectId]/page.tsx
  </files>
  <action>
    1. Add presence request handler to `events.gateway.ts`:
       - Add `@SubscribeMessage('presence:request')` handler
       - Input: projectId string
       - Use `this.server.in('project:${projectId}').fetchSockets()` to get all connected sockets in room
       - Map sockets to `{ userId, email, name }` from `socket.data.user`
       - Deduplicate by userId (a user might have multiple tabs)
       - Return `{ activeUsers, count }` as acknowledgment callback response

    2. Ensure `join:project` and `leave:project` handlers (from Plan 01) emit presence events:
       - On join: `this.server.to('project:${projectId}').emit('presence:join', { userId, email, name, projectId })`
       - On leave: `this.server.to('project:${projectId}').emit('presence:leave', { userId, projectId })`
       - On disconnect: Iterate rooms client was in, emit presence:leave for each project room

    3. Create `apps/web/hooks/use-project-presence.ts`:
       - Hook: `useProjectPresence(projectId: string)`
       - On mount: Emit `presence:request` with callback to get initial active users
       - Listen for `presence:join`: Add user to list (deduplicate by userId)
       - Listen for `presence:leave`: Remove user from list
       - Return `{ activeUsers, count }` where activeUsers is `Array<{ userId, email, name }>`
       - Cleanup: Remove listeners on unmount
       - Depend on socket and projectId

    4. Create `apps/web/components/project/presence-indicator.tsx`:
       - Props: `{ projectId: string }`
       - Use `useProjectPresence(projectId)` hook
       - Display:
         * If 0 active users (or only self): Show nothing
         * Show overlapping avatar circles (first letter of email/name) with blue background and white border
         * Show max 3 avatars, then "+N more" if more than 3
         * Tooltip on hover showing user email/name
         * Small text: "N active users"
       - DO NOT use the color purple in any avatar or indicator (per user constraint)
       - Colors for avatars: blue-500, green-500, orange-500 (rotate)

    5. Add PresenceIndicator to the project page header:
       - This may be in the project page Server Component â€” if so, create a thin client wrapper
       - Or add it to the project layout/header component near the project name
       - Show it alongside project title: "Project Name [avatar circles] 3 active"
  </action>
  <verify>
    - `cd apps/api && npx tsc --noEmit` passes
    - `cd apps/web && npx tsc --noEmit` passes
    - Gateway has presence:request handler
    - PresenceIndicator component exists
    - useProjectPresence hook exports
    - `grep -r "fetchSockets" apps/api/src/modules/events/` confirms server-side presence query
  </verify>
  <done>
    Backend returns list of active users in project room via fetchSockets, frontend displays presence indicator with avatar circles and count, presence updates live when users join/leave
  </done>
</task>

<task type="auto">
  <name>Task 2: Real-time comment updates hook and task detail integration</name>
  <files>
    apps/web/hooks/use-real-time-comments.ts
    apps/web/components/tasks/task-detail-panel.tsx
    apps/web/components/tasks/comment-thread.tsx
  </files>
  <action>
    1. Create `apps/web/hooks/use-real-time-comments.ts`:
       - Hook: `useRealTimeComments(taskId: string, projectId: string, currentUserId: string, comments, setComments)`
       - The hook assumes the component is already subscribed to the project room (via useRealTimeTasks or direct join)
       - Listen for `comment:created`: If event.taskId === taskId && event.userId !== currentUserId, add comment to state
       - Listen for `comment:updated`: If event.taskId === taskId && event.userId !== currentUserId, update comment in state
       - Listen for `comment:deleted`: If event.taskId === taskId && event.userId !== currentUserId, remove comment from state
       - Cleanup: Remove listeners on unmount
       - Dependencies: [socket, taskId, currentUserId]

    2. Update `apps/web/components/tasks/task-detail-panel.tsx`:
       - The task detail panel currently shows comments via CommentThread
       - Check if comments are managed as state here or in CommentThread
       - If comments come from task.comments (initial data), convert to local state: `const [comments, setComments] = useState(task.comments)`
       - Add `useRealTimeComments(task.id, task.projectId, currentUserId, comments, setComments)`
       - Pass `comments` and `setComments` to CommentThread if needed
       - Also listen for task-level updates: if another user edits the task currently being viewed, update the task data shown in the detail panel. Use the WebSocket hook or listen directly for `task:updated` where taskId matches.

    3. Update `apps/web/components/tasks/comment-thread.tsx`:
       - If this component manages its own comment state, integrate useRealTimeComments here instead
       - Ensure the component re-renders when comments change (it should if using state)
       - When a new comment arrives from another user, optionally add a subtle highlight/animation (e.g., brief green background fade) to indicate it's new. A simple `animate-pulse` class that removes after 2 seconds is sufficient.

    4. After a user submits a comment via CommentForm:
       - The server will broadcast the comment via WebSocket
       - The submitting user already sees their own comment (added optimistically or after API response)
       - The `userId !== currentUserId` filter prevents duplicate display
       - Other users viewing the same task see the new comment appear in real-time
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - useRealTimeComments hook exists and exports
    - Task detail panel or comment thread integrates the hook
    - `grep -r "useRealTimeComments" apps/web/components/` shows integration
    - `grep -r "comment:created" apps/web/hooks/use-real-time-comments.ts` shows event listener
    - Cleanup function removes all listeners
  </verify>
  <done>
    Comments update in real-time when another user adds/edits/deletes a comment on the same task, new comments have subtle visual indicator, no duplicate comments from self-updates
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `cd apps/api && npx tsc --noEmit` and `cd apps/web && npx tsc --noEmit` pass
2. Presence: Gateway has presence:request handler with fetchSockets
3. Presence UI: PresenceIndicator renders avatar circles
4. Comments: useRealTimeComments listens for comment:created/updated/deleted
5. Integration: Task detail panel uses real-time comment hook
6. No purple: `grep -r "purple" apps/web/components/project/presence-indicator.tsx` returns nothing
</verification>

<success_criteria>
- Presence indicator shows active user count and avatars on project page
- Joining a project updates presence for all other users in the room
- Leaving/disconnecting updates presence (removes user)
- New comments from other users appear in real-time in task detail
- Comment edits/deletes from other users reflected in real-time
- No self-update duplicates for either presence or comments
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-collaboration/03-03-SUMMARY.md`
</output>
