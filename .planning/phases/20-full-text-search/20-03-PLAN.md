---
phase: 20-full-text-search
plan: "03"
type: execute
wave: 3
depends_on:
  - "20-02"
files_modified:
  - apps/devcollab-web/components/search/SearchModal.tsx
  - apps/devcollab-web/components/search/SearchResults.tsx
  - apps/devcollab-web/components/WorkspaceNav.tsx
autonomous: false

requirements:
  - SRCH-01
  - SRCH-02
  - SRCH-03

must_haves:
  truths:
    - "Pressing Cmd+K (Mac) or Ctrl+K (Windows/Linux) opens a search modal from any workspace page"
    - "Pressing Escape or clicking outside the modal closes it"
    - "Typing in the modal triggers a debounced search (300ms) against the API and shows results"
    - "Results are displayed in two sections: Posts and Snippets"
    - "Matching terms appear highlighted (rendered as <mark> elements from ts_headline output)"
    - "Each result is a clickable link navigating to the post or snippet detail page"
    - "Running prisma migrate dev three consecutive times generates zero new migration files on runs 2 and 3"
  artifacts:
    - path: "apps/devcollab-web/components/search/SearchModal.tsx"
      provides: "Cmd+K global search modal with debounced fetch, Escape/backdrop close, useEffect keydown"
      exports: ["SearchModal"]
      min_lines: 80
    - path: "apps/devcollab-web/components/search/SearchResults.tsx"
      provides: "Grouped Posts + Snippets sections with dangerouslySetInnerHTML headline rendering"
      exports: ["SearchResults"]
    - path: "apps/devcollab-web/components/WorkspaceNav.tsx"
      provides: "SearchModal injected — renders conditionally when open"
      contains: "SearchModal"
  key_links:
    - from: "apps/devcollab-web/components/WorkspaceNav.tsx"
      to: "apps/devcollab-web/components/search/SearchModal.tsx"
      via: "<SearchModal slug={slug} /> rendered inside WorkspaceNav JSX"
      pattern: "SearchModal"
    - from: "apps/devcollab-web/components/search/SearchModal.tsx"
      to: "/workspaces/:slug/search"
      via: "fetch(`${API_URL}/workspaces/${slug}/search?q=${query}`, { credentials: 'include' })"
      pattern: "workspaces.*search"
    - from: "apps/devcollab-web/components/search/SearchResults.tsx"
      to: "post/snippet detail pages"
      via: "href links /w/${slug}/posts/${id} and /w/${slug}/snippets/${id}"
      pattern: "/w/\\$\\{slug\\}/(posts|snippets)"
---

<objective>
Build the frontend search experience: a Cmd+K triggered modal with debounced search, grouped results (Posts / Snippets), ts_headline highlighting, and clickable links to detail pages.

Purpose: Delivers SRCH-03 (Cmd+K shortcut) and completes SRCH-01/SRCH-02 from the user's perspective. The modal is injected into WorkspaceNav so it is available on all workspace pages. No new npm packages needed.
Output: SearchModal.tsx + SearchResults.tsx + updated WorkspaceNav.tsx + human verification that the full search flow works and the prisma migrate dev x3 ritual passes.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-full-text-search/20-RESEARCH.md
@.planning/phases/20-full-text-search/20-02-SUMMARY.md
@apps/devcollab-web/components/WorkspaceNav.tsx
@apps/devcollab-web/components/notifications/BellIcon.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build SearchModal and SearchResults components</name>
  <files>apps/devcollab-web/components/search/SearchModal.tsx</files>
  <files>apps/devcollab-web/components/search/SearchResults.tsx</files>
  <action>
Create directory `apps/devcollab-web/components/search/` with two files.

**File 1: `apps/devcollab-web/components/search/SearchResults.tsx`**

This is a pure presentational component — no state, no fetch. Renders two grouped sections with highlighted results using `dangerouslySetInnerHTML` for the ts_headline output.

```tsx
'use client';

type PostResult = {
  id: string;
  title: string;
  status: string;
  headline: string;
  workspaceId: string;
  authorId: string;
};

type SnippetResult = {
  id: string;
  title: string;
  language: string;
  headline: string;
  workspaceId: string;
  authorId: string;
};

type SearchResultsData = {
  posts: PostResult[];
  snippets: SnippetResult[];
};

type Props = {
  results: SearchResultsData | null;
  loading: boolean;
  slug: string;
};

export default function SearchResults({ results, loading, slug }: Props) {
  if (loading) {
    return (
      <div style={{ padding: '1rem 1.25rem', color: '#6b7280', fontSize: '13px' }}>
        Searching...
      </div>
    );
  }

  if (!results) return null;

  const hasPosts = results.posts.length > 0;
  const hasSnippets = results.snippets.length > 0;
  const isEmpty = !hasPosts && !hasSnippets;

  if (isEmpty) {
    return (
      <div style={{ padding: '1rem 1.25rem', color: '#6b7280', fontSize: '13px' }}>
        No results found.
      </div>
    );
  }

  return (
    <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
      {hasPosts && (
        <section>
          <div
            style={{
              padding: '0.5rem 1.25rem',
              fontSize: '11px',
              fontWeight: 600,
              color: '#9ca3af',
              textTransform: 'uppercase',
              letterSpacing: '0.05em',
              borderTop: '1px solid #f3f4f6',
            }}
          >
            Posts
          </div>
          {results.posts.map((post) => (
            <a
              key={post.id}
              href={`/w/${slug}/posts/${post.id}`}
              style={{
                display: 'block',
                padding: '0.625rem 1.25rem',
                textDecoration: 'none',
                borderBottom: '1px solid #f9fafb',
              }}
              onMouseEnter={(e) => {
                (e.currentTarget as HTMLAnchorElement).style.background = '#f9fafb';
              }}
              onMouseLeave={(e) => {
                (e.currentTarget as HTMLAnchorElement).style.background = 'transparent';
              }}
            >
              <div style={{ fontWeight: 500, fontSize: '14px', color: '#111827', marginBottom: '2px' }}>
                {post.title}
                {post.status === 'Draft' && (
                  <span style={{ marginLeft: '6px', fontSize: '11px', color: '#9ca3af' }}>(Draft)</span>
                )}
              </div>
              <div
                dangerouslySetInnerHTML={{ __html: post.headline }}
                style={{ fontSize: '12px', color: '#6b7280', lineHeight: 1.5 }}
              />
            </a>
          ))}
        </section>
      )}

      {hasSnippets && (
        <section>
          <div
            style={{
              padding: '0.5rem 1.25rem',
              fontSize: '11px',
              fontWeight: 600,
              color: '#9ca3af',
              textTransform: 'uppercase',
              letterSpacing: '0.05em',
              borderTop: '1px solid #f3f4f6',
            }}
          >
            Snippets
          </div>
          {results.snippets.map((snippet) => (
            <a
              key={snippet.id}
              href={`/w/${slug}/snippets/${snippet.id}`}
              style={{
                display: 'block',
                padding: '0.625rem 1.25rem',
                textDecoration: 'none',
                borderBottom: '1px solid #f9fafb',
              }}
              onMouseEnter={(e) => {
                (e.currentTarget as HTMLAnchorElement).style.background = '#f9fafb';
              }}
              onMouseLeave={(e) => {
                (e.currentTarget as HTMLAnchorElement).style.background = 'transparent';
              }}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '2px' }}>
                <span style={{ fontWeight: 500, fontSize: '14px', color: '#111827' }}>
                  {snippet.title}
                </span>
                <span
                  style={{
                    fontSize: '10px',
                    background: '#f3f4f6',
                    color: '#6b7280',
                    padding: '1px 6px',
                    borderRadius: '4px',
                    fontFamily: 'monospace',
                  }}
                >
                  {snippet.language}
                </span>
              </div>
              <div
                dangerouslySetInnerHTML={{ __html: snippet.headline }}
                style={{ fontSize: '12px', color: '#6b7280', lineHeight: 1.5, fontFamily: 'monospace' }}
              />
            </a>
          ))}
        </section>
      )}
    </div>
  );
}
```

Add a global CSS rule for `<mark>` tag styling. Since this project uses inline styles, add a `<style>` tag inside SearchModal (see File 2).

**File 2: `apps/devcollab-web/components/search/SearchModal.tsx`**

```tsx
'use client';
import { useState, useEffect, useRef } from 'react';
import SearchResults from './SearchResults';

type PostResult = {
  id: string;
  title: string;
  status: string;
  headline: string;
  workspaceId: string;
  authorId: string;
};

type SnippetResult = {
  id: string;
  title: string;
  language: string;
  headline: string;
  workspaceId: string;
  authorId: string;
};

type SearchResultsData = {
  posts: PostResult[];
  snippets: SnippetResult[];
};

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3003';

export default function SearchModal({ slug }: { slug: string }) {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<SearchResultsData | null>(null);
  const [loading, setLoading] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  // Keyboard shortcut: Cmd+K (Mac) or Ctrl+K (Windows/Linux)
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault(); // Prevents browser address bar from stealing focus
        setOpen((prev) => !prev);
      }
      if (e.key === 'Escape') {
        setOpen(false);
      }
    };
    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, []);

  // Focus input when modal opens; reset when it closes
  useEffect(() => {
    if (open) {
      setTimeout(() => inputRef.current?.focus(), 0);
    } else {
      setQuery('');
      setResults(null);
    }
  }, [open]);

  // Debounced search: 300ms after user stops typing
  useEffect(() => {
    if (!query.trim()) {
      setResults(null);
      return;
    }
    const t = setTimeout(async () => {
      setLoading(true);
      try {
        const res = await fetch(
          `${API_URL}/workspaces/${slug}/search?q=${encodeURIComponent(query)}`,
          { credentials: 'include' },
        );
        if (res.ok) {
          setResults(await res.json());
        }
      } catch {
        // Network error — silently fail, results stay null
      } finally {
        setLoading(false);
      }
    }, 300);
    return () => clearTimeout(t);
  }, [query, slug]);

  if (!open) return null;

  return (
    <>
      {/* mark tag styling — scoped to search modal */}
      <style>{`
        mark {
          background: #fef3c7;
          color: #92400e;
          padding: 0 2px;
          border-radius: 2px;
          font-style: normal;
        }
      `}</style>

      {/* Backdrop — click to close */}
      <div
        onClick={() => setOpen(false)}
        style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0, 0, 0, 0.3)',
          zIndex: 100,
        }}
      />

      {/* Modal */}
      <div
        style={{
          position: 'fixed',
          top: '20%',
          left: '50%',
          transform: 'translateX(-50%)',
          width: '560px',
          maxWidth: '90vw',
          background: 'white',
          borderRadius: '12px',
          boxShadow: '0 8px 32px rgba(0, 0, 0, 0.18)',
          zIndex: 101,
          overflow: 'hidden',
        }}
      >
        <input
          ref={inputRef}
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Search posts and snippets... (Esc to close)"
          style={{
            width: '100%',
            padding: '1rem 1.25rem',
            border: 'none',
            outline: 'none',
            fontSize: '15px',
            borderBottom: '1px solid #e5e7eb',
            boxSizing: 'border-box',
          }}
        />
        <SearchResults results={results} loading={loading} slug={slug} />
      </div>
    </>
  );
}
```

Note: The `<mark>` highlight color uses amber (#fef3c7 / #92400e) — NOT purple, per project rule.
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/devcollab-web && npx tsc --noEmit 2>/dev/null || npx next build --dry-run 2>/dev/null; echo "tsc check done"
```

File existence:
```bash
ls apps/devcollab-web/components/search/
```
Expected: `SearchModal.tsx` and `SearchResults.tsx`.

Check no purple colors in the new files:
```bash
grep -i "purple\|#[89a-f][0-9a-f][0-9a-f]" apps/devcollab-web/components/search/SearchModal.tsx apps/devcollab-web/components/search/SearchResults.tsx || echo "No purple — OK"
```
  </verify>
  <done>
- SearchModal.tsx and SearchResults.tsx created in components/search/
- SearchModal listens for Cmd+K/Ctrl+K (with e.preventDefault()), Escape closes, backdrop click closes
- SearchResults renders Posts section and Snippets section with dangerouslySetInnerHTML for headline
- Links use correct patterns: /w/${slug}/posts/${id} and /w/${slug}/snippets/${id}
- No purple colors used anywhere in the new files
  </done>
</task>

<task type="auto">
  <name>Task 2: Inject SearchModal into WorkspaceNav</name>
  <files>apps/devcollab-web/components/WorkspaceNav.tsx</files>
  <action>
Open `apps/devcollab-web/components/WorkspaceNav.tsx`. The current file is a 'use client' component showing navigation links and BellIcon.

Add the SearchModal import at the top:
```tsx
import SearchModal from './search/SearchModal';
```

Add a search trigger button in the nav bar (between the navigation links and BellIcon), and render `<SearchModal slug={slug} />` inside the component's JSX. The modal renders conditionally when open (controlled by its own internal state), so it only needs to be mounted once.

The updated nav should look like:

```tsx
'use client';
import BellIcon from './notifications/BellIcon';
import SearchModal from './search/SearchModal';

export default function WorkspaceNav({ slug }: { slug: string }) {
  return (
    <nav
      style={{
        padding: '0.75rem 2rem',
        borderBottom: '1px solid #e5e7eb',
        background: 'white',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
      }}
    >
      <span style={{ fontWeight: 600, fontSize: '15px' }}>Workspace: {slug}</span>
      <div style={{ display: 'flex', alignItems: 'center', gap: '1.25rem' }}>
        <a
          href={`/w/${slug}`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Overview
        </a>
        <a
          href={`/w/${slug}/posts`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Posts
        </a>
        <a
          href={`/w/${slug}/snippets`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Snippets
        </a>
        <a
          href={`/w/${slug}/activity`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Activity
        </a>
        {/* Search trigger — Cmd+K also opens the modal */}
        <span
          style={{
            fontSize: '13px',
            color: '#9ca3af',
            border: '1px solid #e5e7eb',
            borderRadius: '6px',
            padding: '3px 10px',
            cursor: 'default',
            userSelect: 'none',
          }}
        >
          Search <kbd style={{ fontSize: '11px', color: '#6b7280' }}>⌘K</kbd>
        </span>
        <BellIcon />
        <a
          href="/dashboard"
          style={{ color: '#3b82f6', textDecoration: 'none', fontSize: '14px' }}
        >
          Dashboard
        </a>
      </div>
      {/* SearchModal: rendered here so it is always mounted in workspace layout */}
      <SearchModal slug={slug} />
    </nav>
  );
}
```

The `<SearchModal slug={slug} />` renders null when closed (controlled by its own `open` state), so it does not affect layout when not active.
  </action>
  <verify>
Check WorkspaceNav imports SearchModal:
```bash
grep "SearchModal" apps/devcollab-web/components/WorkspaceNav.tsx
```
Expected: 2 lines (import + JSX usage).

TypeScript compilation of devcollab-web:
```bash
cd apps/devcollab-web && npx tsc --noEmit 2>&1 | head -20
```
Expected: no errors related to SearchModal or WorkspaceNav.
  </verify>
  <done>
- WorkspaceNav.tsx imports SearchModal and renders `<SearchModal slug={slug} />` inside the nav
- A visual "Search ⌘K" indicator appears in the nav bar
- TypeScript compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification — full search flow and prisma migrate dev x3 ritual</name>
  <action>
All automated work for Phase 20 is complete. This checkpoint verifies:
1. The search modal is visually functional (Cmd+K, Escape, backdrop)
2. Search results are returned and displayed correctly with highlighting
3. The prisma migrate dev x3 ritual passes (zero new migrations on runs 2 and 3)
  </action>
  <what-built>
Complete Phase 20 search feature:
- Postgres tsvector columns + trigger functions + GIN indexes on Post and Snippet tables
- GET /workspaces/:slug/search?q= endpoint returning grouped { posts, snippets } with ts_headline highlighting
- SearchModal component (Cmd+K opens, Escape/backdrop closes, 300ms debounce, grouped results with mark highlights)
- Injected into WorkspaceNav — available on all workspace pages
- The prisma migrate dev x3 ritual (described in STATE.md blockers section)
  </what-built>
  <how-to-verify>
Run these verification steps in order:

**Step 1: Start the Docker stack**
```bash
docker compose up -d
```
Wait for all services to be healthy. Confirm devcollab-web is at http://localhost:3002 and devcollab-api is at http://localhost:3003.

**Step 2: Log in and navigate to a workspace**
- Open http://localhost:3002
- Log in with an existing account
- Navigate to a workspace (e.g., http://localhost:3002/w/{your-slug})

**Step 3: Verify the search trigger appears in the nav**
- Look at the top nav bar
- Confirm you see "Search ⌘K" indicator next to the bell icon

**Step 4: Test Cmd+K opens the modal**
- Press Cmd+K (Mac) or Ctrl+K (Windows/Linux)
- Confirm: a modal appears centered on screen with a search input field
- The input should be focused automatically

**Step 5: Test Escape closes the modal**
- With modal open, press Escape
- Confirm: modal closes

**Step 6: Test backdrop click closes the modal**
- Press Cmd+K to open modal
- Click outside the modal (on the dark backdrop)
- Confirm: modal closes

**Step 7: Test search returns results**
- Open modal (Cmd+K)
- Type a word that exists in any of your posts or snippets (try a common word from the title)
- Wait ~400ms for debounce
- Confirm: results appear grouped into "Posts" and "Snippets" sections
- Confirm: matching terms appear highlighted in amber (not purple, not blue — amber/yellow)

**Step 8: Test prefix matching**
- Clear the search input
- Type only the first 3-4 characters of a known word
- Confirm: results still appear (partial word matching works)

**Step 9: Test clicking a result navigates**
- Click on any result in the modal
- Confirm: you are navigated to the correct post or snippet detail page

**Step 10: Test special characters don't crash**
- Open modal (Cmd+K)
- Type `react(hooks)||auth`
- Confirm: returns empty results (no error, no 500 status in browser network tab)

**Step 11: Run the prisma migrate dev x3 ritual** (CRITICAL — Phase 20 blocker from STATE.md)
```bash
# Run 1
cd packages/devcollab-database && npx prisma migrate dev --schema prisma/schema.prisma --name ritual-1 2>&1 | tail -5

# Run 2 (MUST generate zero new files)
cd packages/devcollab-database && npx prisma migrate dev --schema prisma/schema.prisma --name ritual-2 2>&1 | tail -5

# Run 3 (MUST generate zero new files)
cd packages/devcollab-database && npx prisma migrate dev --schema prisma/schema.prisma --name ritual-3 2>&1 | tail -5
```
Expected output on runs 2 and 3: "Already in sync, no schema changes found" or "No pending migrations to apply".
If new migration files are created in runs 2 or 3, the GIN index is in the Prisma schema — check and remove `@@index([searchVector], type: Gin)` from schema.prisma.
  </how-to-verify>
  <resume-signal>Type "approved" if all 11 steps pass. Or describe which steps failed and what you observed.</resume-signal>
</task>

</tasks>

<verification>
Complete Phase 20 verification checklist:
1. SRCH-01: User can search posts and snippets by text, workspace-scoped, prefix matching works
2. SRCH-02: Results grouped into Posts/Snippets sections, ts_headline highlights visible in amber
3. SRCH-03: Cmd+K opens modal from any workspace page, Escape and backdrop close it
4. Migration drift eliminated: prisma migrate dev x3 produces zero new files on runs 2 and 3
</verification>

<success_criteria>
- All four Phase 20 success criteria confirmed by human verification:
  1. Workspace-scoped search returns posts and snippets with prefix matching
  2. Results grouped with ts_headline highlighting visible in browser
  3. Cmd+K opens modal, Escape/backdrop closes it — functional on all workspace pages
  4. Prisma migrate dev x3 ritual passes — zero new migrations on runs 2 and 3
</success_criteria>

<output>
After completion, create `.planning/phases/20-full-text-search/20-03-SUMMARY.md` following the summary template.

Then update `.planning/STATE.md`:
- Phase: 20 of 21 (Full-Text Search) — COMPLETE
- Plan: 3 of 3 — COMPLETE
- Remove the "Phase 20 (Search) — Validation ritual" blocker from Blockers/Concerns
- Next action: Execute Phase 21 (Seed Data + Portfolio Integration)
</output>
