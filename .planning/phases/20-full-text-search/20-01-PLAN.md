---
phase: 20-full-text-search
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/devcollab-database/prisma/schema.prisma
  - packages/devcollab-database/prisma/migrations/20260218_add_fts_tsvector/migration.sql
  - apps/devcollab-api/src/core/database/prisma.service.ts
autonomous: true
requirements:
  - SRCH-01
  - SRCH-02

must_haves:
  truths:
    - "Post and Snippet models have a searchVector column (tsvector) in the Prisma schema marked @db.Unsupported"
    - "A manually-written migration SQL file adds the tsvector columns, trigger functions, triggers, backfill, and GIN indexes"
    - "PrismaService exposes $queryRaw and $executeRaw delegation getters bound to the Prisma client"
    - "Running prisma migrate dev twice after this plan generates zero new migration files on run 2"
  artifacts:
    - path: "packages/devcollab-database/prisma/schema.prisma"
      provides: "Updated Post and Snippet models with searchVector Unsupported(tsvector)?"
      contains: "searchVector Unsupported"
    - path: "packages/devcollab-database/prisma/migrations/20260218_add_fts_tsvector/migration.sql"
      provides: "Trigger-based tsvector migration — columns, triggers, backfill, GIN indexes"
      contains: "tsvector_update_trigger"
    - path: "apps/devcollab-api/src/core/database/prisma.service.ts"
      provides: "PrismaService with $queryRaw and $executeRaw delegation"
      contains: "$queryRaw"
  key_links:
    - from: "packages/devcollab-database/prisma/schema.prisma"
      to: "packages/devcollab-database/prisma/migrations/20260218_add_fts_tsvector/migration.sql"
      via: "manual migration — schema declares Unsupported column, migration SQL creates it with trigger"
      pattern: "searchVector Unsupported"
    - from: "apps/devcollab-api/src/core/database/prisma.service.ts"
      to: "this.client.$queryRaw"
      via: "get $queryRaw() { return this.client.$queryRaw.bind(this.client); }"
      pattern: "\\$queryRaw.*bind"
---

<objective>
Add Postgres full-text search infrastructure: tsvector columns on Post and Snippet using the trigger-based pattern (NOT GENERATED ALWAYS AS), GIN indexes, and PrismaService raw query delegation.

Purpose: This is the database foundation that the search API (Plan 02) depends on. The trigger pattern is the only approach that passes the "prisma migrate dev x3 generates zero new migrations" validation ritual. No external services or npm packages needed.
Output: Updated Prisma schema, manually-written migration SQL applied to devcollab-postgres, PrismaService with $queryRaw/$executeRaw getters.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-full-text-search/20-RESEARCH.md
@packages/devcollab-database/prisma/schema.prisma
@apps/devcollab-api/src/core/database/prisma.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add searchVector to Prisma schema and write migration SQL</name>
  <files>packages/devcollab-database/prisma/schema.prisma</files>
  <files>packages/devcollab-database/prisma/migrations/20260218_add_fts_tsvector/migration.sql</files>
  <action>
1. In `packages/devcollab-database/prisma/schema.prisma`, append one field to the `Snippet` model and one to the `Post` model:

```prisma
model Snippet {
  // ... existing fields unchanged ...
  searchVector Unsupported("tsvector")?
}

model Post {
  // ... existing fields unchanged ...
  searchVector Unsupported("tsvector")?
}
```

CRITICAL: Do NOT add `@@index([searchVector], type: Gin)` to the schema. The GIN index goes only in the migration SQL. Adding it to the schema causes Prisma migration drift (Pitfall 1 in RESEARCH.md).

2. Create directory `packages/devcollab-database/prisma/migrations/20260218_add_fts_tsvector/` and write `migration.sql` with the complete trigger-based tsvector setup:

```sql
-- Add bare tsvector column to Post (no DEFAULT, no GENERATED)
ALTER TABLE "Post" ADD COLUMN IF NOT EXISTS "searchVector" tsvector;

-- Add bare tsvector column to Snippet
ALTER TABLE "Snippet" ADD COLUMN IF NOT EXISTS "searchVector" tsvector;

-- Trigger function for Post: title (weight A) + content (weight B)
CREATE OR REPLACE FUNCTION post_search_vector_update() RETURNS trigger AS $$
BEGIN
  NEW."searchVector" :=
    setweight(to_tsvector('english', coalesce(NEW.title, '')), 'A') ||
    setweight(to_tsvector('english', coalesce(NEW.content, '')), 'B');
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

-- Trigger for Post
DROP TRIGGER IF EXISTS post_search_vector_trigger ON "Post";
CREATE TRIGGER post_search_vector_trigger
  BEFORE INSERT OR UPDATE ON "Post"
  FOR EACH ROW EXECUTE FUNCTION post_search_vector_update();

-- Trigger function for Snippet: title (weight A) + code (weight B)
CREATE OR REPLACE FUNCTION snippet_search_vector_update() RETURNS trigger AS $$
BEGIN
  NEW."searchVector" :=
    setweight(to_tsvector('english', coalesce(NEW.title, '')), 'A') ||
    setweight(to_tsvector('english', coalesce(NEW.code, '')), 'B');
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

-- Trigger for Snippet
DROP TRIGGER IF EXISTS snippet_search_vector_trigger ON "Snippet";
CREATE TRIGGER snippet_search_vector_trigger
  BEFORE INSERT OR UPDATE ON "Snippet"
  FOR EACH ROW EXECUTE FUNCTION snippet_search_vector_update();

-- Backfill existing rows (triggers only fire on INSERT/UPDATE, not on historical rows)
UPDATE "Post" SET "searchVector" =
  setweight(to_tsvector('english', coalesce(title, '')), 'A') ||
  setweight(to_tsvector('english', coalesce(content, '')), 'B');

UPDATE "Snippet" SET "searchVector" =
  setweight(to_tsvector('english', coalesce(title, '')), 'A') ||
  setweight(to_tsvector('english', coalesce(code, '')), 'B');

-- GIN indexes (NOT in Prisma schema — only here in manual migration SQL)
CREATE INDEX IF NOT EXISTS "Post_searchVector_idx" ON "Post" USING GIN ("searchVector");
CREATE INDEX IF NOT EXISTS "Snippet_searchVector_idx" ON "Snippet" USING GIN ("searchVector");
```

3. Apply this migration using the established pattern for this project (prisma migrate diff --from-url + direct psql apply + prisma migrate resolve --applied). Check the docker-compose.yml for the devcollab-postgres connection details. The database is on port 5435. Run the following sequence:

```bash
# Apply the SQL directly against devcollab-postgres
docker exec -i $(docker ps --filter "name=devcollab-postgres" --format "{{.Names}}" | head -1) \
  psql -U devcollab -d devcollab < packages/devcollab-database/prisma/migrations/20260218_add_fts_tsvector/migration.sql

# Mark it as applied in the Prisma migrations table
cd packages/devcollab-database && npx prisma migrate resolve \
  --applied 20260218_add_fts_tsvector \
  --schema prisma/schema.prisma
```

4. Regenerate the Prisma client to include the updated schema:
```bash
cd packages/devcollab-database && npx prisma generate --schema prisma/schema.prisma
```
  </action>
  <verify>
Run twice to confirm zero drift:

```bash
# Run 1 (should apply nothing — just applied)
cd packages/devcollab-database && npx prisma migrate dev --schema prisma/schema.prisma --name drift-check-1

# Run 2 (MUST generate zero new migration files)
cd packages/devcollab-database && npx prisma migrate dev --schema prisma/schema.prisma --name drift-check-2
```

Expected: Both runs report "Already in sync, no schema changes found" or "No pending migrations". If a new file appears in `prisma/migrations/`, delete it and consult RESEARCH.md Pitfall 1.

Also verify the column exists in the DB:
```bash
docker exec -i $(docker ps --filter "name=devcollab-postgres" --format "{{.Names}}" | head -1) \
  psql -U devcollab -d devcollab -c "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='Post' AND column_name='searchVector';"
```
  </verify>
  <done>
- `schema.prisma` contains `searchVector Unsupported("tsvector")?` on both Post and Snippet models
- `prisma/migrations/20260218_add_fts_tsvector/migration.sql` exists with triggers + GIN indexes + backfill
- Two consecutive `prisma migrate dev` runs produce zero new migration files
- `information_schema.columns` confirms `searchVector` column exists on Post and Snippet tables
  </done>
</task>

<task type="auto">
  <name>Task 2: Add $queryRaw and $executeRaw delegation to PrismaService</name>
  <files>apps/devcollab-api/src/core/database/prisma.service.ts</files>
  <action>
Open `apps/devcollab-api/src/core/database/prisma.service.ts`. The current file ends at the `activityEvent` getter. Add two more getters immediately after `activityEvent`:

```typescript
get $queryRaw() {
  return this.client.$queryRaw.bind(this.client);
}

get $executeRaw() {
  return this.client.$executeRaw.bind(this.client);
}
```

CRITICAL: The `.bind(this.client)` is mandatory. Tagged template literals (Prisma.sql`...`) use `this` internally. Without binding, the tagged template loses context and throws `TypeError: this.client.$queryRaw is not a function` at runtime.

Do NOT add any new imports — the existing `prisma` import from `@devcollab/database` already provides the client type.
  </action>
  <verify>
TypeScript must compile without errors:
```bash
cd apps/devcollab-api && npx tsc --noEmit
```

Confirm the getters are present in the compiled output:
```bash
grep -n "\$queryRaw\|\$executeRaw" apps/devcollab-api/src/core/database/prisma.service.ts
```
Expected: 2 lines matching (one per getter).
  </verify>
  <done>
- `prisma.service.ts` has `get $queryRaw()` and `get $executeRaw()` getters both using `.bind(this.client)`
- `npx tsc --noEmit` exits with code 0 (no TypeScript errors)
  </done>
</task>

</tasks>

<verification>
Full plan verification:
1. `packages/devcollab-database/prisma/schema.prisma` — both Post and Snippet models contain `searchVector Unsupported("tsvector")?` with NO `@@index` for GIN
2. `packages/devcollab-database/prisma/migrations/20260218_add_fts_tsvector/migration.sql` — contains ALTER TABLE, CREATE OR REPLACE FUNCTION, CREATE TRIGGER, UPDATE (backfill), CREATE INDEX USING GIN for both Post and Snippet
3. `apps/devcollab-api/src/core/database/prisma.service.ts` — has `$queryRaw` and `$executeRaw` getters with `.bind(this.client)`
4. Running `prisma migrate dev` twice in a row produces zero new migration files on run 2
5. `npx tsc --noEmit` in devcollab-api exits cleanly
</verification>

<success_criteria>
- GIN indexes exist on devcollab-postgres Post."searchVector" and Snippet."searchVector"
- Zero migration drift: consecutive `prisma migrate dev` runs are idempotent
- PrismaService.$queryRaw is callable from NestJS services (Plan 02 prerequisite satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/20-full-text-search/20-01-SUMMARY.md` following the summary template.
</output>
