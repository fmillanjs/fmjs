---
phase: 27-infrastructure-foundation-prisma-fix
task: 1
total_tasks: 4
status: in_progress
last_updated: 2026-02-20T03:57:07.845Z
---

<current_state>
Plan 27-03 is the manual infrastructure plan (no code — VPS, DNS, Coolify, GitHub setup). All code changes are done and committed. We are actively fixing Docker build/runtime issues discovered during first Coolify deployment attempts.

Three Dockerfile bug-fix commits have been made this session:
1. `eae80a6` — packages/config missing from turbo prune output (all 4 Dockerfiles)
2. `0e1854f` — @nestjs/cli not hoisted to root node_modules (api + devcollab-api)
3. `64a8667` — OpenSSL not installed in builder/runner stages (api + devcollab-api)

teamflow-api built successfully but is crash-looping (59+ restarts) due to the OpenSSL fix just pushed — awaiting confirmation that the redeploy resolves it.
</current_state>

<completed_work>

- Plan 27-01 ✓ — Prisma runtime import fix, SameSite=None cookie, devcollab-web Dockerfile build-arg
- Plan 27-02 ✓ — GHA deploy-devcollab job + coolify-compose.yml (later approach pivoted)
- Deployment approach pivot ✓ — Coolify GitHub source integration (not GHCR images)
- Dockerfile fixes ✓ (this session):
  - All 4 Dockerfiles: `COPY --from=pruner /app/packages/config ./packages/config` in builder stage (turbo prune omits it — no package.json)
  - api + devcollab-api: copy workspace-specific node_modules (`apps/api/node_modules`, `apps/devcollab-api/node_modules`) + add to PATH — @nestjs/cli NOT hoisted to root due to peer dep conflict with @nestjs/common in root package.json
  - api + devcollab-api: `apk add openssl` in both builder and runner stages — Prisma schema engine binary requires libssl at build time (to detect target) and runtime (to execute)
- teamflow-api Docker IMAGE built successfully ✓
- Coolify env vars set ✓ (user confirmed: all env vars + build vars added)
- Coolify PostgreSQL + Redis services started ✓

</completed_work>

<remaining_work>

**Immediate (Docker runtime fix being verified):**
- Confirm teamflow-api redeploy succeeds with OpenSSL fix (no more crash loop)

**Plan 27-03 remaining tasks:**
- Task 2 — Deploy remaining 3 apps: teamflow-web, devcollab-api, devcollab-web (trigger Coolify deploys — all Dockerfile fixes are already pushed)
- Task 3 — DNS setup: A records for all 6 domains → VPS IP:
  - fernandomillan.me + www.fernandomillan.me (additional domain on teamflow-web)
  - teamflow.fernandomillan.me, teamflow-api.fernandomillan.me
  - devcollab.fernandomillan.me, devcollab-api.fernandomillan.me
- Task 4 — E2E verification:
  - All HTTPS domains load with valid TLS
  - teamflow-web: API calls hit teamflow-api.fernandomillan.me (not localhost)
  - devcollab-web: API calls hit devcollab-api.fernandomillan.me (not localhost)
  - Login sets SameSite=None; Secure cookie (check Chrome DevTools → Application → Cookies)
  - TeamFlow WebSocket works via wss://teamflow-api.fernandomillan.me

</remaining_work>

<decisions_made>

- Deployment: Coolify GitHub source integration (not GHCR) — simpler, no registry auth needed
- Database: Coolify-managed PostgreSQL (port 5432 internal) and Redis — user's choice
- Domain: *.fernandomillan.me (NOT .dev) — corrected early in v3.0
- Portfolio domain: fernandomillan.me as additional domain on teamflow-web Application (not a separate app)
- NEXT_PUBLIC vars: must be BUILD VARIABLES in Coolify (not runtime env vars) — baked at Docker build time
- teamflow-api uses `prisma db push` (no migrations dir); devcollab-api uses `prisma migrate deploy`
- packages/config workaround: copy from pruner stage directly (cleaner than adding package.json to packages/config)
- @nestjs/cli workaround: copy workspace node_modules from installer + add to PATH (root has @nestjs/common in devDeps causing conflict)
- OpenSSL: install in both builder AND runner — builder needs it so Prisma detects openssl-3.0.x target; runner needs it so engine binary can load libssl

</decisions_made>

<blockers>

- OpenSSL fix just pushed (commit 64a8667) — awaiting redeploy confirmation before moving to next apps
- devcollab-web likely has a similar workspace node_modules issue if it has any non-hoisted devDependencies — but Next.js builds don't use CLI binaries the same way, less likely to hit this
- NEXT_PUBLIC build variables: verify in Coolify that NEXT_PUBLIC_API_URL and NEXT_PUBLIC_WS_URL are marked as Build Variables (not just env vars) on teamflow-web and devcollab-web applications

</blockers>

<context>
We're iterating on Docker deployment issues. The pattern has been: fix one error → deploy → new error surfaces. Each fix is a real bug, not a symptom. After the OpenSSL fix lands, the flow should be:
1. Confirm teamflow-api is healthy
2. Deploy teamflow-web (Next.js — likely fewer issues, no CLI binaries needed)
3. Deploy devcollab-api (same fixes already applied)
4. Deploy devcollab-web (same packages/config fix applied)
5. DNS → E2E verify

The coolify-compose.yml in the repo root is dead code (leftover from the GHCR approach pivot) — harmless but can be cleaned up later.
</context>

<next_action>
Check if teamflow-api is healthy after the OpenSSL redeploy. If healthy, move to triggering teamflow-web deploy next. Watch for any new errors in each app's logs — the Dockerfile fixes are comprehensive but there may be app-level env var issues once the containers are actually running.
</next_action>
