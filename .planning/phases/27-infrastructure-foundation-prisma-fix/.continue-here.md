---
phase: 27-infrastructure-foundation-prisma-fix
task: 2
total_tasks: 4
status: in_progress
last_updated: 2026-02-20T07:30:00.202Z
---

<current_state>
Plan 27-03 (manual deployment) is blocked on CI passing. We pivoted from
Coolify-builds-from-source to pre-built GHCR images (Option B) to avoid OOM on
the VPS. The GHA workflow has been updated and Coolify apps have been configured
to pull from GHCR. CI is now running and we are clearing build failures one by one.

Latest CI run is on commit d6c7f84 — fixing postgres crash-loop (missing env var
defaults). Waiting to see if this run passes the "Wait for PostgreSQL" step.
</current_state>

<completed_work>

- Plan 27-01 ✓ — Prisma runtime import fix, SameSite=None cookie, devcollab-web Dockerfile build-arg
- Plan 27-02 ✓ — GHA deploy-devcollab job + coolify-compose.yml
- Deployment pivot ✓ — switched from Coolify GitHub source builds → pre-built GHCR images
- CI fixes this session (all committed and pushed):
  - `b8be86c` — add NEXT_PUBLIC build-args to GHA + deploy-devcollab webhook job
  - `25c6469` — remove unused lint script from devcollab-api (no ESLint configured)
  - `62cdbb9` — remove unconfigured lint script from devcollab-web (next lint no config)
  - `ad14634` — fix trailing comma in devcollab-web/package.json (caused npm ci to fail with misleading "no lockfile" error)
  - `559a26c` — update Skeleton test to match bg-muted design token (was checking old bg-gray-200)
  - `66e937b` — only start postgres+redis in CI test job (avoid building Dockerfile.seed/migrate which COPY node_modules excluded by .dockerignore)
  - `d6c7f84` — add default values for postgres env vars in docker-compose.yml (:-postgres / :-teamflow)
- Coolify apps (teamflow-web, teamflow-api, devcollab-web, devcollab-api) configured to pull from GHCR images
- VPS GHCR auth configured as root (/root/.docker/config.json)
- GitHub secrets added: NEXT_PUBLIC_TEAMFLOW_API_URL, NEXT_PUBLIC_TEAMFLOW_WS_URL, NEXT_PUBLIC_DEVCOLLAB_API_URL

</completed_work>

<remaining_work>

**Immediate: Confirm CI passes** (latest run on d6c7f84 still running)
- If postgres fix works, CI will proceed through migrations → API start → Playwright tests → Lighthouse → build-and-push → deploy webhooks

**If more CI failures surface:** Fix them one by one (paste error here on resume)

**After CI goes green:**
- Task 3 — DNS setup: A records for all 6 domains → VPS IP:
  - fernandomillan.me + www.fernandomillan.me
  - teamflow.fernandomillan.me, teamflow-api.fernandomillan.me
  - devcollab.fernandomillan.me, devcollab-api.fernandomillan.me
- Task 4 — E2E verification:
  - All HTTPS domains load with valid TLS
  - DevCollab API calls go to devcollab-api.fernandomillan.me (not localhost)
  - Login sets SameSite=None; Secure cookie
  - Push to main triggers auto-deploy in both GHA and Coolify

**Remaining GitHub secret to add (after Coolify is fully set up):**
- `COOLIFY_DEVCOLLAB_WEBHOOK_URL` — user already did this in Step 4 earlier this session

</remaining_work>

<decisions_made>

- Switched from Coolify GitHub source builds → GHCR pre-built images to avoid VPS OOM during Docker builds
- CI test job only starts `postgres` and `redis` services (not full docker compose) — devcollab Dockerfiles require node_modules which .dockerignore excludes
- postgres env vars use :-defaults (postgres/postgres/teamflow) so CI needs no .env file
- NEXT_PUBLIC vars use separate secret names per app (NEXT_PUBLIC_TEAMFLOW_API_URL vs NEXT_PUBLIC_DEVCOLLAB_API_URL) since both Dockerfiles declare ARG NEXT_PUBLIC_API_URL but need different values

</decisions_made>

<blockers>

- CI still running — postgres crash-loop fix (d6c7f84) may reveal further failures in Playwright or API test steps
- devcollab-api Prisma issue: the Dockerfile.migrate and Dockerfile.seed in packages/devcollab-database COPY node_modules which is excluded by .dockerignore — these are broken for local `docker compose up` but not needed for CI (we only start postgres+redis). Not blocking deployment (devcollab-api Dockerfile handles migrate in CMD directly). Can be fixed in Phase 28 cleanup if needed.

</blockers>

<context>
We're in a whack-a-mole CI fixing session. Each commit reveals the next layer.
The fixes so far are all legitimate pre-existing issues (not introduced by our changes)
that the CI never ran before. The pipeline architecture is correct — just needs
these environment and config issues cleared. Once CI goes green, the GHCR images
will be built with correct NEXT_PUBLIC values and Coolify will auto-deploy.

The Playwright E2E tests (auth, visual regression, accessibility) are the next
likely failure point — they may need a running API to pass. The API is started in
the test job but may have issues without all env vars set. Watch for that.
</context>

<next_action>
Check if latest CI run (commit d6c7f84) passed the postgres startup step.
If new error appears, paste it here and fix. If CI goes fully green, move to
DNS setup (Task 3) — add A records for all 6 domains pointing to VPS IP.
</next_action>
