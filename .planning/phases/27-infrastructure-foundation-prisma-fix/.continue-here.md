---
phase: 27-infrastructure-foundation-prisma-fix
task: 1
total_tasks: 4
status: in_progress
last_updated: 2026-02-20T00:11:33.021Z
---

<current_state>
Phase 27 Plans 01 and 02 are fully committed. Plan 03 is a manual human-action plan (no code — VPS, DNS, Coolify, GitHub setup). The user is in the middle of setting up Coolify and has deviated from the original GHCR-based deployment plan. We adapted to their actual approach (Coolify GitHub source integration) and fixed the Dockerfiles accordingly. The user has already added 4 Application resources in Coolify. Still needs to trigger the first deploy and verify it works.
</current_state>

<completed_work>

- Plan 27-01 ✓ — Prisma runtime import fix, SameSite=None cookie, devcollab-web Dockerfile build-arg (commits c748476, 98f5536, a53bab4, 5ee392c)
- Plan 27-02 ✓ — GHA deploy-devcollab job + coolify-compose.yml (commits b930fd6, 8392f7c, da657fd) — later partially reverted
- Deployment approach pivot ✓ — Switched from GHCR-based deployment to Coolify GitHub source integration
- Dockerfile migration fixes ✓ — commit f166953:
  - devcollab-api: runs `prisma migrate deploy` on startup
  - teamflow-api: runs `prisma db push` on startup (no migrations dir)
  - apps/web: added ARG/ENV for NEXT_PUBLIC_API_URL and NEXT_PUBLIC_WS_URL
  - deploy.yml: removed deploy-devcollab job (no longer needed)
- Domain correction — all .dev references corrected to .me throughout discussion
- Coolify services decided — user chose Coolify-managed PostgreSQL and Redis (not AWS Lightsail)
- Main portfolio clarified — apps/web serves both portfolio (fernandomillan.me) and TeamFlow; no separate app needed, just add fernandomillan.me as additional domain on teamflow-web Application

</completed_work>

<remaining_work>

Plan 27-03 Task 1 — Coolify Application setup (partially done):
- User has added 4 Applications in Coolify: devcollab-api, devcollab-web, teamflow-api, teamflow-web
- User has added Coolify-managed PostgreSQL and Redis services
- User has added env vars to each application
- Still needed: set NEXT_PUBLIC_API_URL and NEXT_PUBLIC_WS_URL as BUILD VARIABLES (not runtime env vars) on teamflow-web and devcollab-web
- Still needed: add fernandomillan.me as additional domain on teamflow-web Application
- Still needed: trigger first deploy / push to main and verify builds succeed

Plan 27-03 Task 2 — DNS setup:
- DNS A records needed for all domains pointing to VPS IP:
  - devcollab.fernandomillan.me
  - devcollab-api.fernandomillan.me
  - teamflow.fernandomillan.me
  - teamflow-api.fernandomillan.me
  - fernandomillan.me (+ www.fernandomillan.me)

Plan 27-03 Task 3 — End-to-end verification:
- All HTTPS domains load with valid TLS
- DevCollab Network tab: API calls go to devcollab-api.fernandomillan.me (not localhost)
- Login sets SameSite=None; Secure cookie
- TeamFlow real-time (WebSocket) works via wss://teamflow-api.fernandomillan.me

</remaining_work>

<decisions_made>

- Deployment approach: Coolify GitHub source integration (not GHCR images + webhook) — simpler, no GHCR auth needed
- Database: Coolify-managed PostgreSQL and Redis (not AWS Lightsail) — user's choice
- Portfolio domain: fernandomillan.me should be an additional domain on teamflow-web Application (same app/same container) — not a separate Application
- Migrations: devcollab-api uses `prisma migrate deploy` (has migrations/); teamflow-api uses `prisma db push` (no migrations dir exists yet)
- NEXT_PUBLIC vars: must be BUILD VARIABLES in Coolify (not runtime env vars) — baked at Docker build time, not runtime
- NEXT_PUBLIC_WS_URL for teamflow-web should be wss://teamflow-api.fernandomillan.me (WebSocket URL for real-time)
- Domain corrected from .dev to .me — all domains are *.fernandomillan.me
- GHA deploy-devcollab job removed — Coolify auto-deploys from GitHub source on push to main
- coolify-compose.yml kept in repo but unused (was for GHCR approach)

</decisions_made>

<blockers>

- NEXT_PUBLIC build variables: In Coolify UI, user needs to find the "Build Variable" toggle/checkbox for NEXT_PUBLIC_API_URL and NEXT_PUBLIC_WS_URL on teamflow-web and devcollab-web. If Coolify doesn't have this UI clearly, look for "Build Args" section separate from "Environment Variables"
- TeamFlow has no prisma migrations directory — using `prisma db push` for initial deploy is fine, but schema changes later won't be tracked. Should create proper migrations after initial deploy succeeds.
- devcollab-web also uses NEXT_PUBLIC_API_URL but the Dockerfile already has ARG/ENV from Plan 01 — only needs to be set as build variable in Coolify

</blockers>

<context>
We're at the Coolify configuration stage. The code changes are all done and committed. The remaining work is purely infrastructure: Coolify UI configuration, DNS, and verification. The user is actively setting up Coolify as we speak. The next thing they need to do is:
1. Mark NEXT_PUBLIC vars as build variables in Coolify (critical — otherwise API URL is undefined in production)
2. Add fernandomillan.me as additional domain on teamflow-web
3. Push to main (or manually trigger deploy in Coolify) to kick off the first build
4. Watch the build logs for errors
5. Set up DNS records

The coolify-compose.yml in repo root is now dead code but harmless.
</context>

<next_action>
Start with: Check Coolify UI on devcollab-web and teamflow-web Applications — find "Environment Variables" section → look for a build variable toggle on NEXT_PUBLIC_API_URL. If unclear, check Coolify docs or look for a separate "Build Arguments" section. Once that's set, trigger a manual deploy from Coolify UI and watch the build logs.
</next_action>
