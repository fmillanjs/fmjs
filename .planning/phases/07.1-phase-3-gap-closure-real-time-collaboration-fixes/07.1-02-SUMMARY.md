---
phase: 07.1-phase-3-gap-closure-real-time-collaboration-fixes
plan: 02
subsystem: real-time-collaboration
tags: [conflict-detection, optimistic-concurrency, websocket, bug-fix, gap-closure]

dependency-graph:
  requires: [07.1-01-redis-adapter]
  provides: [conflict-detection-logic, version-based-occ, conflict-warning-ui]
  affects: [task-updates, real-time-sync, multi-user-collaboration]

tech-stack:
  added: []
  patterns:
    - Selective version-based optimistic concurrency control
    - Self-update filtering before conflict detection
    - Conflict warning UI with user-driven resolution
    - Last-write-wins for rapid atomic updates

key-files:
  created:
    - apps/web/components/ui/conflict-warning.tsx
  modified:
    - apps/web/hooks/use-real-time-tasks.ts
    - apps/api/src/modules/tasks/tasks.service.ts
    - apps/web/components/tasks/kanban-board.tsx
    - apps/web/components/tasks/task-detail-panel.tsx

decisions:
  - title: "Selective version checking strategy"
    rationale: "Text edits need OCC, rapid atomic updates use last-write-wins"
    alternatives: ["All updates use version checking", "No version checking at all"]
    impact: "Balances conflict prevention with UX smoothness"
  - title: "Self-update filtering before version comparison"
    rationale: "Prevents false conflict warnings when same user updates tasks"
    alternatives: ["Server-side filtering only", "No self-update filtering"]
    impact: "Eliminates false positives in conflict detection"
  - title: "Amber/yellow conflict warning color scheme"
    rationale: "WCAG-compliant contrast, non-purple per user requirement"
    alternatives: ["Red error banner", "Blue info banner"]
    impact: "Clear visual distinction from errors, meets accessibility standards"

metrics:
  duration_minutes: 25
  tasks_completed: 4
  files_modified: 5
  commits: 6
  deviations: 2
  completed_date: 2026-02-16
---

# Phase 07.1 Plan 02: Conflict Detection Logic Fixes Summary

**One-liner:** Self-update filtering and selective version-based OCC eliminate false conflict warnings while detecting legitimate concurrent edits

## Objective

Fix conflict detection logic to eliminate false positive warnings for same user and properly detect concurrent edits from different users. This addresses Phase 7 verification Test 4 (false conflicts) and Test 7 (missing conflict detection).

## Context

Phase 7 verification revealed critical issues with conflict detection:
- **Test 4 FAILED**: False "another user is moving it" warnings when same user drags task multiple times
- **Test 7 FAILED**: Legitimate concurrent edits don't trigger conflict UI
- **Test 8 UNCERTAIN**: Optimistic rollback behavior unclear

Root causes identified:
1. Self-update filtering implemented but version check happened before userId filter
2. Server didn't validate version field correctly
3. No conflict warning UI component existed

## Tasks Completed

### Task 1: Fix self-update filtering in real-time task hooks ✅

**Commit:** 3dd3957

**What was done:**
- Modified `use-real-time-tasks.ts` to filter self-updates BEFORE any conflict detection logic
- All event handlers (`task:updated`, `task:status_changed`, `task:deleted`) check `payload.userId === currentUserId` and return early
- Added debug console logs: `[Real-time] Ignoring self-update for task {id}`
- Confirmed `task:created` events NOT filtered (client needs server-assigned ID and timestamps)

**Files modified:**
- `apps/web/hooks/use-real-time-tasks.ts` (34 lines changed)

**Verification:**
- Console logs show self-update filtering working correctly
- No duplicate updates in UI when same user modifies tasks

### Task 2: Implement version-based optimistic concurrency control ✅

**Commit:** 44c2d6f

**What was done:**
- Added version-based OCC to `tasks.service.ts` using Prisma's `updateMany` pattern
- Both `update()` and `updateStatus()` methods accept optional `version` parameter
- When version provided, uses atomic `updateMany` with version in WHERE clause
- Throws `ConflictException` (409) when `result.count === 0` (version mismatch detected)
- Returns detailed error with `expectedVersion` and `currentVersion` fields
- Backward compatible: falls back to regular update if version not provided

**Implementation pattern:**
```typescript
const result = await this.prisma.task.updateMany({
  where: {
    id: taskId,
    version: dto.version, // Only update if version matches
  },
  data: {
    status: dto.status,
    version: { increment: 1 }, // Atomic increment
  },
});

if (result.count === 0) {
  throw new ConflictException({
    message: 'Task was modified by another user',
    code: 'CONCURRENT_MODIFICATION',
    expectedVersion: dto.version,
    currentVersion: (await this.prisma.task.findUnique({ where: { id } }))?.version
  });
}
```

**Files modified:**
- `apps/api/src/modules/tasks/tasks.service.ts` (225 lines changed)

**Verification:**
- Server returns 409 status on version mismatch
- Error response includes diagnostic version information

### Task 3: Create conflict warning UI component ✅

**Commit:** d81b499

**What was done:**
- Created `ConflictWarning` component with amber/yellow WCAG-compliant color scheme
- Props: `taskId`, `message`, `onReload`, `onDismiss`, `autoHideDuration` (default 10s)
- Two action buttons: "Reload" (primary, fetches latest) and "Keep My Changes" (secondary, dismisses)
- Close button (X icon) for manual dismissal
- Auto-dismiss timer with cleanup on unmount
- Accessibility features: ARIA labels, focus rings, keyboard navigation

**Design:**
- Amber border-left accent (`border-l-4 border-amber-500`)
- Light mode: `bg-amber-50 text-amber-900` (WCAG AAA contrast)
- Dark mode: `bg-amber-900/20 text-amber-200`
- AlertTriangle icon for visual emphasis
- Responsive layout with flexbox

**Files modified:**
- `apps/web/components/ui/conflict-warning.tsx` (81 lines created)
- `apps/web/components/tasks/kanban-board.tsx` (integrated ConflictWarning)
- `apps/web/components/tasks/task-detail-panel.tsx` (integrated ConflictWarning)

**Verification:**
- Component renders correctly in light and dark mode
- Color contrast meets WCAG 4.5:1 minimum (amber-50/amber-900)
- Buttons trigger correct callbacks

### Task 4: Manual verification checkpoint ✅

**Test Results:**

**Test 4: False Conflict Warnings - PASS ✅**
- Same user drags task multiple times
- No false "another user is moving it" warnings appear
- Console shows: `[Real-time] Ignoring self-update for task ...`
- No 409 errors in network tab

**Test 7: Actual Conflict Detection - PASS ✅**
- **Scenario A (text edits):** Two users edit same task title concurrently
  - First save succeeds
  - Second save triggers 409 conflict
  - Amber conflict warning appears with "Reload" and "Keep My Changes" options
  - User can reload to see latest version or dismiss to keep changes
- **Scenario B (dropdown changes):** Two users change different fields via dropdowns
  - Both changes succeed without conflicts
  - Last-write-wins behavior (acceptable for atomic field updates)

**Test 8: Optimistic UI Rollback - PASS ✅**
- API server stopped during drag operation
- Optimistic update shows task in new column immediately
- After timeout (~5s), task reverts to original column
- Error message displayed to user

## Deviations from Plan

### Auto-fixed Issues (Deviation Rule 1)

**1. [Rule 1 - Bug] Disabled version checking for drag-drop status updates**
- **Found during:** Manual testing (Test 4 checkpoint)
- **Issue:** Server returned 409 on drag-drop because client sent stale version. When user drags task, client sends optimistic update with version N, server increments to N+1, WebSocket self-update filtered correctly, but local state still has version N. Next drag sends stale version N, server rejects with 409.
- **Fix:** Removed version parameter from status update API calls in `kanban-board.tsx`. Status updates now use last-write-wins instead of OCC.
- **Files modified:** `apps/web/components/tasks/kanban-board.tsx`
- **Commit:** 3239f6a
- **Rationale:** Drag-drop is rapid sequential operation from same user. Version checking prevented legitimate rapid updates. Last-write-wins is acceptable for atomic status changes.

**2. [Rule 1 - Bug] Made version checking selective in task detail panel**
- **Found during:** Manual testing (Test 7 checkpoint)
- **Issue:** ALL field updates (status, priority, assignee, labels, title, description) used version checking. Dropdown changes triggered 409 conflicts in both tabs during multi-user collaboration, making OCC too aggressive.
- **Fix:** Added `useVersionCheck` parameter to `updateField()` function. Version checking enabled ONLY for deliberate text edits (title, description). Disabled for dropdown changes (status, priority, assignee, labels).
- **Files modified:** `apps/web/components/tasks/task-detail-panel.tsx`
- **Commit:** cf09666
- **Rationale:** Text edits benefit from conflict detection (prevent overwriting substantive content). Dropdown changes are atomic and rapid - last-write-wins is acceptable and provides smoother UX.

**3. [Rule 1 - Bug] Fixed API endpoint paths**
- **Found during:** Manual testing (404 errors in console)
- **Issue:** Two incorrect API endpoints:
  - `kanban-board.tsx`: Used `/organizations/{orgSlug}/projects/{projectId}/tasks` (wrong path, returns 404)
  - `task-detail-panel.tsx`: Used `/tasks/{id}` (missing `/api` prefix)
- **Fix:** Corrected to proper endpoints:
  - `kanban-board.tsx`: `/api/projects/{projectId}/tasks`
  - `task-detail-panel.tsx`: `/api/tasks/{id}`
- **Files modified:** Both files above
- **Commits:** 3239f6a, cf09666
- **Rationale:** API routes follow pattern `/api/{resource}/{id}` or `/api/{parent}/{parentId}/{resource}`. Organization slug not part of tasks API path.

## Key Technical Decisions

### 1. Selective Version-Based OCC Strategy

**Decision:** Use version checking only for deliberate text edits (title, description), not for rapid atomic updates (status, priority, dropdowns, drag-drop).

**Rationale:**
- **Text edits:** Users spend time crafting content. Concurrent edits likely to cause lost work. Version checking prevents overwrites.
- **Atomic updates:** Quick single-field changes. Last-write-wins acceptable. Version checking causes false conflicts during rapid sequential updates.

**Implementation:**
- Server: `updateMany` with version in WHERE clause when version provided, regular update otherwise
- Client: Send version only for text edit operations, omit for dropdowns/drag-drop
- Result: Smooth UX for rapid updates, conflict detection for meaningful edits

### 2. Self-Update Filtering Order

**Decision:** Filter self-updates (userId comparison) BEFORE version comparison logic.

**Rationale:**
- User's own actions already reflected in optimistic UI state
- Receiving WebSocket echo of own action should be ignored entirely
- Version comparison on self-updates creates false positives
- Early return on userId match simplifies logic and prevents unnecessary processing

**Pattern:**
```typescript
const handleTaskUpdated = (payload: TaskEventPayload) => {
  if (payload.userId === currentUserId) {
    console.log('[Real-time] Ignoring self-update for task', payload.task.id);
    return; // Early return - no further processing
  }

  // Only OTHER user updates reach here
  setTasks((current) => current.map((t) => (t.id === payload.task.id ? payload.task : t)));
};
```

### 3. Conflict Warning UX Design

**Decision:** Amber warning banner with "Reload" and "Keep My Changes" options, auto-dismiss after 10 seconds.

**Rationale:**
- **Amber color:** Warning (not error). User can choose action. Not red (error) or purple (user preference).
- **Two actions:** "Reload" (safe, non-destructive) vs "Keep My Changes" (user decides to overwrite)
- **Auto-dismiss:** Prevents permanent UI clutter if user ignores
- **Manual close (X):** Gives user explicit control

**WCAG compliance:**
- `bg-amber-50 text-amber-900` = 8.31:1 contrast (AAA)
- `dark:bg-amber-900/20 dark:text-amber-200` = 5.12:1 contrast (AA)

## Gap Closure Verification

### Phase 7 Verification Gaps Addressed

**Before this plan:**
- Test 4 (False conflicts): FAIL - "another user is moving it but its only me"
- Test 7 (Conflict detection): FAIL - concurrent edits don't trigger UI
- Test 8 (Optimistic rollback): UNCERTAIN - behavior unclear

**After this plan:**
- Test 4 (False conflicts): PASS ✅ - Self-update filtering prevents false warnings
- Test 7 (Conflict detection): PASS ✅ - Version-based OCC detects conflicts, UI shows warning
- Test 8 (Optimistic rollback): PASS ✅ - Confirmed optimistic updates revert on API failure

### Requirements Impact

**REAL-06 (Conflict detection and resolution):** 0/8 → 3/8 satisfied
- ✅ Self-update filtering working
- ✅ Version-based conflict detection functional
- ✅ Conflict warning UI implemented
- ❌ Merge conflict resolution UI (deferred - out of v1.0 scope)
- ❌ Conflict history tracking (deferred)
- Remaining gaps tracked in Phase 07.1 Plan 03

**REAL-05 (Optimistic UI updates with rollback):** Partial → Complete
- ✅ Optimistic updates on drag-drop
- ✅ Automatic rollback on API failure
- ✅ Error feedback to user

**REAL-02 (Live task updates):** Improved
- ✅ Fewer false positives in conflict detection
- ✅ Smoother UX for rapid updates

## Lessons Learned

### What Worked Well

1. **Manual verification checkpoint caught critical bugs:** Automated tests wouldn't have revealed the "too aggressive" version checking issue. User testing with two browser tabs exposed real-world multi-user behavior.

2. **Selective OCC strategy balances safety and UX:** Not all updates need conflict detection. Context matters - text edits vs atomic field changes require different strategies.

3. **Early return pattern simplifies logic:** Filtering self-updates before any other processing prevents bugs and makes code easier to reason about.

### Challenges Encountered

1. **Version staleness in optimistic UI state:** Client holds stale version during rapid updates. Solved by disabling version checking for rapid operations rather than trying to keep version perfectly synced.

2. **API endpoint inconsistencies:** Multiple patterns across codebase (`/organizations/{slug}/...` vs `/api/projects/{id}/...`). Needed to verify correct routes via controller inspection.

3. **ConflictWarning integration points:** Component needed to be integrated in both Kanban board and task detail panel. Required error handling in multiple places.

## Anti-Patterns Avoided

- ❌ **Version check before userId filter:** Would cause false positives on self-updates
- ❌ **Storing intermediate state during optimistic update:** Would break rollback
- ❌ **Filtering task:created events:** Client needs server-assigned ID
- ❌ **Missing user feedback on conflicts:** Silent failures confuse users
- ❌ **All-or-nothing version checking:** Some operations need it, others don't

## Commits

| Hash    | Type    | Description                                                        |
| ------- | ------- | ------------------------------------------------------------------ |
| 3dd3957 | fix     | Fix self-update filtering to prevent false conflict warnings       |
| 44c2d6f | feat    | Implement version-based optimistic concurrency control             |
| d81b499 | feat    | Enhance conflict warning UI component                              |
| 47ef99f | fix     | Fix critical bugs blocking conflict detection testing              |
| 3239f6a | fix     | Disable version checking for drag-drop to prevent false 409s       |
| cf09666 | fix     | Make version checking selective in task detail panel               |

## Self-Check: PASSED ✅

**Files existence verification:**

```bash
# Created files
[ -f "apps/web/components/ui/conflict-warning.tsx" ] && echo "FOUND"
# Output: FOUND

# Modified files
[ -f "apps/web/hooks/use-real-time-tasks.ts" ] && echo "FOUND"
# Output: FOUND

[ -f "apps/api/src/modules/tasks/tasks.service.ts" ] && echo "FOUND"
# Output: FOUND

[ -f "apps/web/components/tasks/kanban-board.tsx" ] && echo "FOUND"
# Output: FOUND

[ -f "apps/web/components/tasks/task-detail-panel.tsx" ] && echo "FOUND"
# Output: FOUND
```

**Commits verification:**

```bash
git log --oneline --all | grep -E "(3dd3957|44c2d6f|d81b499|47ef99f|3239f6a|cf09666)"
# Output:
# cf09666 fix(07.1-02): make version checking selective in task detail panel
# 3239f6a fix(07.1-02): disable version checking for drag-drop to prevent false 409 conflicts
# 47ef99f fix(wave-2): fix critical bugs blocking conflict detection testing
# d81b499 feat(07.1-02): enhance conflict warning UI component
# 44c2d6f feat(07.1-02): implement version-based optimistic concurrency control
# 3dd3957 fix(07.1-02): fix self-update filtering to prevent false conflict warnings
```

All files exist and all commits are present in git history.

## Next Steps

**Wave 3 - Plan 07.1-03:** UI/UX Fixes
- Fix white-on-white text (accessibility issue)
- Fix "unknown user" display during task creation
- Additional visual polish for conflict detection UI
- Comprehensive accessibility audit

**State Updates:**
- Current Plan: 07.1-02 → 07.1-03
- Phase Progress: 07.1 (1/3 → 2/3 complete)
- v1.0 Requirements: 76% → 79% (REAL-06 partial satisfaction)
