---
phase: 12-critical-route-migration
plan: 04
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - apps/web/components/tasks/task-filters.tsx
  - apps/web/components/tasks/task-search.tsx
autonomous: true
requirements:
  - MIG-02
  - MIG-03

must_haves:
  truths:
    - "Status, Priority, Assignee, Labels, and Sort filter dropdowns use Shadcn Popover (not custom absolute-positioned divs)"
    - "The openDropdown shared state is removed from task-filters.tsx"
    - "Task search uses Shadcn Input with the same debounce + nuqs logic unchanged"
    - "All custom dropdown divs (absolute z-10 bg-card border rounded shadow) are deleted"
    - "Filter toggle buttons use Shadcn Button"
  artifacts:
    - path: "apps/web/components/tasks/task-filters.tsx"
      provides: "Filter UI with Popover dropdowns and Button triggers"
      contains: "PopoverContent"
    - path: "apps/web/components/tasks/task-search.tsx"
      provides: "Search input using Shadcn Input"
      contains: "Input"
  key_links:
    - from: "apps/web/components/tasks/task-filters.tsx"
      to: "@/components/ui/popover"
      via: "import"
      pattern: "from '@/components/ui/popover'"
    - from: "apps/web/components/tasks/task-filters.tsx"
      to: "nuqs useQueryStates"
      via: "unchanged filter logic"
      pattern: "useQueryStates"
---

<objective>
Migrate TaskFilters from five custom dropdown divs (manually positioned with absolute z-10, sharing a single openDropdown state) to independent Shadcn Popover components. Migrate TaskSearch from raw input to Shadcn Input. Both components keep their nuqs URL state logic completely unchanged.

Purpose: MIG-02 + MIG-03. Popovers handle click-outside dismissal, collision detection, and keyboard navigation automatically. The old shared openDropdown state is a known accessibility gap (only one dropdown can be open, no ARIA expanded).
Output: task-filters.tsx uses Popover for all 5 dropdowns, Button for all triggers, no openDropdown state. task-search.tsx uses Shadcn Input.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-critical-route-migration/12-RESEARCH.md
@apps/web/components/tasks/task-filters.tsx
@apps/web/components/tasks/task-search.tsx
@apps/web/components/ui/popover.tsx
@apps/web/components/ui/button.tsx
@apps/web/components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate task-filters.tsx — replace 5 custom dropdowns with Popover + Button</name>
  <files>apps/web/components/tasks/task-filters.tsx</files>
  <action>
    Replace all five dropdown patterns with independent Popover components. Remove shared openDropdown state.

    1. Add imports:
       ```tsx
       import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
       import { Button } from '@/components/ui/button';
       import { Badge } from '@/components/ui/badge';
       ```

    2. Remove the `openDropdown` state entirely:
       Delete: `const [openDropdown, setOpenDropdown] = useState<string | null>(null);`
       Also remove the `useState` import if it becomes unused (keep if still needed for other state — check first).

    3. Remove `setOpenDropdown(null)` calls from `setAssignee` and `setSortBy` functions (no longer needed since each Popover is independent).

    4. For each of the five dropdown blocks (Status, Priority, Assignee, Labels, Sort), replace the `<div className="relative">` wrapper with `<Popover>`:

       Pattern for Status (and Priority, Labels — same structure):
       ```tsx
       <Popover>
         <PopoverTrigger asChild>
           <Button variant="outline" size="sm" className="gap-1.5">
             Status
             {filters.status && filters.status.length > 0 && (
               <Badge variant="default" className="h-5 min-w-5 px-1.5 text-xs">
                 {filters.status.length}
               </Badge>
             )}
             <ChevronDown className="h-4 w-4 opacity-50" />
           </Button>
         </PopoverTrigger>
         <PopoverContent className="w-56 p-2" align="start">
           <div className="space-y-1">
             {statusOptions.map((option) => (
               <label key={option.value} className="flex items-center gap-2 px-2 py-1.5 hover:bg-muted/50 rounded cursor-pointer">
                 <input type="checkbox" checked={filters.status?.includes(option.value) || false}
                   onChange={() => toggleStatus(option.value)} className="rounded border-border" />
                 <span className={`px-2 py-0.5 rounded text-xs font-medium ${option.color}`}>{option.label}</span>
               </label>
             ))}
           </div>
         </PopoverContent>
       </Popover>
       ```

       For Assignee (uses buttons inside, not checkboxes — keep the existing button items):
       ```tsx
       <Popover>
         <PopoverTrigger asChild>
           <Button variant="outline" size="sm" className="gap-1.5">
             Assignee
             {filters.assignee && (
               <Badge variant="default" className="h-5 min-w-5 px-1.5 text-xs">1</Badge>
             )}
             <ChevronDown className="h-4 w-4 opacity-50" />
           </Button>
         </PopoverTrigger>
         <PopoverContent className="w-64 p-2 max-h-80 overflow-y-auto" align="start">
           {/* existing assignee button list — unchanged */}
         </PopoverContent>
       </Popover>
       ```

       For Sort (uses button list items — keep existing):
       ```tsx
       <Popover>
         <PopoverTrigger asChild>
           <Button variant="outline" size="sm" className="gap-1.5">
             Sort by: {sortOptions.find((o) => o.value === filters.sortBy)?.label}
             <ChevronDown className="h-4 w-4 opacity-50" />
           </Button>
         </PopoverTrigger>
         <PopoverContent className="w-48 p-2" align="start">
           {/* existing sort option buttons — unchanged */}
         </PopoverContent>
       </Popover>
       ```

    5. Wrap the Sort Order toggle button in Shadcn Button:
       ```tsx
       <Button variant="outline" size="sm" onClick={toggleSortOrder} title={...}>
         {filters.sortOrder === 'asc' ? '↑' : '↓'}
       </Button>
       ```

    6. Wrap the "Clear all filters" button in Shadcn Button:
       ```tsx
       <Button variant="ghost" size="sm" onClick={clearAllFilters} className="text-[var(--red-11)] hover:bg-[var(--red-3)] gap-1">
         <X className="w-4 h-4" />
         Clear all filters
       </Button>
       ```

    The nuqs filter logic (toggleStatus, togglePriority, setAssignee, toggleLabel, setSortBy, toggleSortOrder, clearAllFilters) is COMPLETELY UNCHANGED.
  </action>
  <verify>
    `grep "openDropdown\|absolute z-10" apps/web/components/tasks/task-filters.tsx` returns empty.
    `grep "PopoverContent\|PopoverTrigger" apps/web/components/tasks/task-filters.tsx` returns 5+ matches.
    `grep "useQueryStates" apps/web/components/tasks/task-filters.tsx` returns a match (nuqs logic preserved).
    `npx tsc --noEmit` passes.
  </verify>
  <done>All 5 filter dropdowns use Popover. openDropdown state is gone. Button wraps all trigger elements. nuqs filter logic unchanged. Old absolute-positioned dropdown divs deleted.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate task-search.tsx — replace raw input with Shadcn Input</name>
  <files>apps/web/components/tasks/task-search.tsx</files>
  <action>
    Replace the raw `<input>` element with Shadcn `Input`. Keep all debounce logic and nuqs state unchanged.

    1. Add import:
       ```tsx
       import { Input } from '@/components/ui/input';
       ```

    2. Find the raw `<input>` element (currently inside a `<div className="relative">` with search icon positioning). Replace the raw element:
       Before: `<input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Search tasks..." className="w-full pl-10 pr-10 py-2 border border-border rounded-md ..." />`
       After: `<Input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Search tasks..." className="pl-10 pr-10" />`

    3. Keep the `<div className="relative">` wrapper and the absolute-positioned Search icon div and clear-button — only the `<input>` element changes to `<Input>`. The Input component renders a standard input so the `pl-10 pr-10` className padding works the same way for icon spacing.

    The debounce useEffect, nuqs useQueryState, handleClear, and inputValue state are ALL UNCHANGED.
  </action>
  <verify>
    `grep "<input" apps/web/components/tasks/task-search.tsx` returns empty (raw input replaced).
    `grep "Input" apps/web/components/tasks/task-search.tsx` returns the import and usage.
    `grep "useQueryState\|debounce\|setTimeout" apps/web/components/tasks/task-search.tsx` returns matches (nuqs + debounce preserved).
    `npx tsc --noEmit` passes.
  </verify>
  <done>task-search.tsx uses Shadcn Input. Debounce and nuqs logic unchanged. Raw input element deleted.</done>
</task>

</tasks>

<verification>
1. `grep "absolute z-10\|openDropdown" apps/web/components/tasks/task-filters.tsx` returns empty
2. `grep "PopoverContent" apps/web/components/tasks/task-filters.tsx` returns 5 matches (one per filter)
3. `grep "<input" apps/web/components/tasks/task-search.tsx` returns empty
4. `npx tsc --noEmit` passes for both files
</verification>

<success_criteria>
TaskFilters uses independent Popovers for all 5 dropdowns — no shared state, no absolute positioning. TaskSearch uses Shadcn Input. nuqs URL state logic is untouched in both files.
</success_criteria>

<output>
After completion, create `.planning/phases/12-critical-route-migration/12-04-SUMMARY.md`
</output>
