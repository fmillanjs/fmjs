---
phase: 01-foundation-authentication
plan: 04
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - apps/web/package.json
  - apps/web/lib/auth.ts
  - apps/web/lib/auth.config.ts
  - apps/web/middleware.ts
  - apps/web/app/api/auth/[...nextauth]/route.ts
  - apps/web/app/layout.tsx
  - apps/web/app/(auth)/login/page.tsx
  - apps/web/app/(auth)/signup/page.tsx
  - apps/web/app/(auth)/layout.tsx
  - apps/web/components/auth/login-form.tsx
  - apps/web/components/auth/signup-form.tsx
  - apps/web/components/providers/session-provider.tsx
  - apps/web/app/(dashboard)/layout.tsx
  - apps/web/app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can create an account with email, name, and password via /signup"
    - "User can log in with email and password via /login"
    - "User can log out from any authenticated page"
    - "Unauthenticated users are redirected to /login when accessing protected routes"
    - "Session persists across browser restarts (JWT stored in cookie)"
  artifacts:
    - path: "apps/web/lib/auth.ts"
      provides: "NextAuth v5 configuration with Credentials provider"
      contains: "NextAuth"
    - path: "apps/web/middleware.ts"
      provides: "Edge middleware protecting dashboard routes"
      contains: "auth"
    - path: "apps/web/app/(auth)/login/page.tsx"
      provides: "Login page with form"
      contains: "LoginForm"
    - path: "apps/web/app/(auth)/signup/page.tsx"
      provides: "Signup page with form"
      contains: "SignUpForm"
    - path: "apps/web/components/auth/login-form.tsx"
      provides: "Login form with Zod validation"
      contains: "loginSchema"
  key_links:
    - from: "apps/web/components/auth/login-form.tsx"
      to: "@repo/shared/validators"
      via: "import loginSchema for client validation"
      pattern: "loginSchema.*@repo/shared"
    - from: "apps/web/components/auth/signup-form.tsx"
      to: "@repo/shared/validators"
      via: "import signUpSchema for client validation"
      pattern: "signUpSchema.*@repo/shared"
    - from: "apps/web/lib/auth.ts"
      to: "@repo/database"
      via: "PrismaAdapter for user storage"
      pattern: "PrismaAdapter"
    - from: "apps/web/middleware.ts"
      to: "apps/web/lib/auth.ts"
      via: "auth function for session check"
      pattern: "auth"
---

<objective>
Set up Next.js frontend with NextAuth v5 authentication, including login/signup forms with Zod validation, session management, and route protection middleware.

Purpose: Frontend authentication is the user-facing side of the auth system. Users need to be able to create accounts, log in, and have their sessions persist. This covers AUTH-01 (signup), AUTH-02 (login + session persistence), AUTH-03 (logout), AUTH-06 (secure sessions via JWT cookies).

Output: Working login and signup flows with session persistence and route protection.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure NextAuth v5 with Credentials provider and Prisma adapter</name>
  <files>
    apps/web/package.json
    apps/web/lib/auth.ts
    apps/web/lib/auth.config.ts
    apps/web/middleware.ts
    apps/web/app/api/auth/[...nextauth]/route.ts
    apps/web/app/layout.tsx
    apps/web/components/providers/session-provider.tsx
    apps/web/app/(dashboard)/layout.tsx
    apps/web/app/(dashboard)/page.tsx
  </files>
  <action>
    Install auth dependencies in web workspace:
    ```bash
    npm install next-auth@beta @auth/prisma-adapter bcrypt --workspace=apps/web
    npm install -D @types/bcrypt --workspace=apps/web
    ```

    **apps/web/lib/auth.config.ts:**
    Separate auth config for edge runtime (middleware can't use Prisma):
    ```typescript
    import type { NextAuthConfig } from 'next-auth';

    export const authConfig: NextAuthConfig = {
      pages: {
        signIn: '/login',
        error: '/auth/error',
      },
      callbacks: {
        authorized({ auth, request: { nextUrl } }) {
          const isLoggedIn = !!auth?.user;
          const isOnDashboard = nextUrl.pathname.startsWith('/dashboard') || nextUrl.pathname === '/';
          const isOnAuth = nextUrl.pathname.startsWith('/login') || nextUrl.pathname.startsWith('/signup');

          if (isOnDashboard) {
            if (isLoggedIn) return true;
            return false; // Redirect to login
          }

          if (isOnAuth && isLoggedIn) {
            return Response.redirect(new URL('/', nextUrl));
          }

          return true;
        },
      },
      providers: [], // Providers added in full auth.ts
    };
    ```

    **apps/web/lib/auth.ts:**
    Full NextAuth v5 config as shown in research Pattern 4:
    - PrismaAdapter from @auth/prisma-adapter using prisma from @repo/database
    - Session strategy: 'jwt', maxAge: 30 days
    - Credentials provider: validate with loginSchema from @repo/shared, bcrypt compare, return user with id, email, name, role
    - JWT callback: add id and role to token
    - Session callback: add id and role to session.user
    - Extend NextAuth session type with `declare module 'next-auth'` for id and role
    - Export: handlers, auth, signIn, signOut

    **apps/web/middleware.ts:**
    ```typescript
    export { auth as middleware } from '@/lib/auth';
    export const config = {
      matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
    };
    ```

    Note: Since this uses authConfig (not full auth.ts), it runs on Edge without Prisma. The `authorized` callback handles route protection.

    **apps/web/app/api/auth/[...nextauth]/route.ts:**
    ```typescript
    import { handlers } from '@/lib/auth';
    export const { GET, POST } = handlers;
    ```

    **apps/web/components/providers/session-provider.tsx:**
    Client component wrapping children with NextAuth's SessionProvider.

    **apps/web/app/layout.tsx:**
    Root layout wrapping children with SessionProvider. Basic HTML structure with Inter font.

    **apps/web/app/(dashboard)/layout.tsx:**
    Dashboard layout with navigation bar showing user name, role, and logout button. Use `auth()` server-side to get session. Redirect to /login if no session.

    **apps/web/app/(dashboard)/page.tsx:**
    Simple dashboard home page showing "Welcome, {user.name}" and role badge. Server component using `auth()`.
  </action>
  <verify>
    ```bash
    cd apps/web && npx next build 2>&1 | tail -5  # Build succeeds
    ```
    Start the app and verify NextAuth routes respond:
    ```bash
    cd apps/web && npm run dev &
    sleep 5
    curl -s http://localhost:3000/api/auth/providers | jq .  # Shows credentials provider
    kill %1
    ```
  </verify>
  <done>
    NextAuth v5 configured with Credentials provider and Prisma adapter. JWT sessions with 30-day expiry. Middleware protects dashboard routes and redirects unauthenticated users to /login. Session includes user id and role.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login and signup forms with Zod validation</name>
  <files>
    apps/web/app/(auth)/layout.tsx
    apps/web/app/(auth)/login/page.tsx
    apps/web/app/(auth)/signup/page.tsx
    apps/web/components/auth/login-form.tsx
    apps/web/components/auth/signup-form.tsx
  </files>
  <action>
    Install form dependencies:
    ```bash
    npm install react-hook-form @hookform/resolvers --workspace=apps/web
    ```

    **apps/web/app/(auth)/layout.tsx:**
    Centered layout for auth pages. Simple card-style container with logo/title. No navigation bar (public pages).

    **apps/web/components/auth/signup-form.tsx:**
    Client component ("use client"):
    - React Hook Form with zodResolver(signUpSchema) from @repo/shared/validators
    - Fields: name, email, password with real-time validation errors
    - On submit: call server action or fetch to /api/auth/signup endpoint
    - The signup flow: hash password with bcrypt, create user in DB via Prisma, then auto-sign-in via NextAuth signIn()
    - Handle errors: duplicate email (show "Email already registered"), server errors
    - Link to /login at bottom: "Already have an account?"
    - Use basic Tailwind styling (no component library needed yet — keep it functional)

    **Important for signup:** NextAuth's Credentials provider only handles login. For SIGNUP, create a Next.js server action (or API route) at apps/web/app/(auth)/signup/actions.ts:
    ```typescript
    'use server'
    import { signUpSchema } from '@repo/shared/validators/auth.schema';
    import { prisma } from '@repo/database';
    import bcrypt from 'bcrypt';

    export async function signUp(formData: { email: string; password: string; name: string }) {
      const parsed = signUpSchema.safeParse(formData);
      if (!parsed.success) {
        return { error: parsed.error.issues[0].message };
      }

      // Check if user exists
      const existing = await prisma.user.findUnique({ where: { email: parsed.data.email } });
      if (existing) {
        return { error: 'Email already registered' };
      }

      // Create user
      const hashedPassword = await bcrypt.hash(parsed.data.password, 12);
      await prisma.user.create({
        data: {
          email: parsed.data.email,
          name: parsed.data.name,
          password: hashedPassword,
          role: 'MEMBER', // Default role
        },
      });

      return { success: true };
    }
    ```

    After successful signup, client-side calls `signIn('credentials', { email, password, redirect: false })` to auto-login, then router.push('/').

    **apps/web/components/auth/login-form.tsx:**
    Client component ("use client"):
    - React Hook Form with zodResolver(loginSchema) from @repo/shared/validators
    - Fields: email, password with validation errors
    - On submit: call NextAuth `signIn('credentials', { email, password, redirect: false })`
    - Handle errors: invalid credentials ("Invalid email or password")
    - Link to /signup: "Don't have an account?"
    - Link to /reset-password: "Forgot password?" (will be implemented in Plan 05)
    - Use basic Tailwind styling

    **apps/web/app/(auth)/login/page.tsx:** Server component rendering LoginForm.
    **apps/web/app/(auth)/signup/page.tsx:** Server component rendering SignUpForm.

    Both pages have appropriate page titles via metadata export.

    Add logout functionality to the dashboard layout:
    - Logout button calls NextAuth `signOut({ redirect: true, callbackUrl: '/login' })`
  </action>
  <verify>
    Start the app and verify pages render:
    ```bash
    cd apps/web && npm run dev &
    sleep 5
    curl -s http://localhost:3000/signup | grep -i "sign up"  # Signup page renders
    curl -s http://localhost:3000/login | grep -i "log in"    # Login page renders
    kill %1
    ```
    Manual test flow:
    1. Visit /signup, fill form, submit → user created in DB
    2. Visit /login, enter credentials → redirected to dashboard
    3. Refresh page → still logged in (session persists)
    4. Click logout → redirected to /login
  </verify>
  <done>
    Login page at /login with email/password form using Zod validation from @repo/shared. Signup page at /signup with name/email/password form creating users with bcrypt hashed passwords. Auto-login after signup. Logout button in dashboard. Session persists across page refreshes. Same Zod schemas validate on both client and server.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /signup, create account → user exists in database with hashed password
2. Navigate to /login, enter credentials → redirected to dashboard showing user name and role
3. Refresh browser → session persists (still logged in)
4. Click logout → redirected to /login
5. Navigate to / without session → redirected to /login
6. Navigate to /login with session → redirected to /
7. Invalid signup (weak password) → shows validation errors from Zod
8. Invalid login (wrong password) → shows "Invalid email or password"
</verification>

<success_criteria>
- NextAuth v5 configured with Credentials provider and JWT sessions
- Signup creates user with bcrypt-hashed password and auto-logs in
- Login validates credentials and creates session
- Logout destroys session and redirects to login
- Middleware redirects unauthenticated users to login
- Middleware redirects authenticated users away from auth pages
- Forms use shared Zod schemas from @repo/shared for client validation
- Session includes user id and role for RBAC in later plans
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-04-SUMMARY.md`
</output>
