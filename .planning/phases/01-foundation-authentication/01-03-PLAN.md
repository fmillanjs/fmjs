---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - apps/api/src/main.ts
  - apps/api/src/app.module.ts
  - apps/api/src/core/database/prisma.service.ts
  - apps/api/src/core/database/database.module.ts
  - apps/api/src/core/config/config.module.ts
  - apps/api/src/core/config/env.validation.ts
  - apps/api/src/common/pipes/zod-validation.pipe.ts
  - apps/api/src/common/filters/http-exception.filter.ts
  - apps/api/src/common/interceptors/logging.interceptor.ts
  - apps/api/src/health/health.controller.ts
  - apps/api/src/health/health.module.ts
  - apps/api/src/health/indicators/prisma.indicator.ts
  - apps/api/src/health/indicators/redis.indicator.ts
  - apps/api/package.json
autonomous: true

must_haves:
  truths:
    - "NestJS API starts on port 3001 and responds to HTTP requests"
    - "GET /health returns JSON with database and redis status"
    - "Swagger docs are accessible at /api/docs"
    - "Invalid request bodies return structured Zod validation errors"
  artifacts:
    - path: "apps/api/src/main.ts"
      provides: "NestJS bootstrap with Swagger, CORS, global pipes"
      contains: "SwaggerModule"
    - path: "apps/api/src/core/database/prisma.service.ts"
      provides: "Prisma service for dependency injection"
      contains: "PrismaService"
    - path: "apps/api/src/health/health.controller.ts"
      provides: "Health check endpoint"
      contains: "@Get"
    - path: "apps/api/src/common/pipes/zod-validation.pipe.ts"
      provides: "Global Zod validation pipe"
      contains: "ZodValidationPipe"
  key_links:
    - from: "apps/api/src/core/database/prisma.service.ts"
      to: "@repo/database"
      via: "imports Prisma client"
      pattern: "@repo/database"
    - from: "apps/api/src/main.ts"
      to: "apps/api/src/app.module.ts"
      via: "NestFactory.create"
      pattern: "NestFactory\\.create.*AppModule"
    - from: "apps/api/src/health/health.controller.ts"
      to: "apps/api/src/health/indicators/prisma.indicator.ts"
      via: "dependency injection"
      pattern: "PrismaHealthIndicator"
---

<objective>
Scaffold the NestJS backend API with Prisma integration, Swagger documentation, health checks, global validation pipe, and exception handling.

Purpose: The backend API is the foundation for auth module, RBAC guards, audit logging, and WebSocket gateway in subsequent plans. Without proper NestJS scaffolding (DI, global pipes, Swagger), those plans cannot execute. Covers TECH-04 (Swagger), TECH-05 (health checks).

Output: Running NestJS API at localhost:3001 with health checks and Swagger docs.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: NestJS core scaffold with Prisma, config, validation, and exception handling</name>
  <files>
    apps/api/package.json
    apps/api/src/main.ts
    apps/api/src/app.module.ts
    apps/api/src/core/database/prisma.service.ts
    apps/api/src/core/database/database.module.ts
    apps/api/src/core/config/config.module.ts
    apps/api/src/core/config/env.validation.ts
    apps/api/src/common/pipes/zod-validation.pipe.ts
    apps/api/src/common/filters/http-exception.filter.ts
    apps/api/src/common/interceptors/logging.interceptor.ts
  </files>
  <action>
    First, install NestJS dependencies in the api workspace:
    ```bash
    npm install @nestjs/core @nestjs/common @nestjs/platform-express @nestjs/config @nestjs/swagger reflect-metadata rxjs class-transformer nestjs-zod ioredis --workspace=apps/api
    npm install -D @types/express --workspace=apps/api
    ```

    **apps/api/src/core/database/prisma.service.ts:**
    Injectable service wrapping Prisma client from @repo/database. Implements OnModuleInit (connect on init) and OnModuleDestroy (disconnect on destroy). Use singleton scope (NOT request scope yet — that comes in Plan 07 for audit context).

    **apps/api/src/core/database/database.module.ts:**
    Global module exporting PrismaService.

    **apps/api/src/core/config/env.validation.ts:**
    Zod schema validating required env vars: DATABASE_URL, REDIS_URL, JWT_SECRET, API_PORT. Log clear error messages on missing vars.

    **apps/api/src/core/config/config.module.ts:**
    Wraps @nestjs/config ConfigModule.forRoot() with the Zod validation function. isGlobal: true.

    **apps/api/src/common/pipes/zod-validation.pipe.ts:**
    Custom PipeTransform that validates request body against a Zod schema. Returns structured error response { statusCode: 400, message: 'Validation failed', errors: [...] } where errors array has { field, message } objects. Register as global pipe in main.ts.

    **apps/api/src/common/filters/http-exception.filter.ts:**
    Global exception filter catching HttpException, Prisma errors, and unknown errors. Returns consistent JSON: { statusCode, message, error, timestamp, path }. Log unhandled errors with stack trace.

    **apps/api/src/common/interceptors/logging.interceptor.ts:**
    Logs incoming requests (method, URL, user ID if available) and response time. Use console.log for now (Winston comes later in Plan 07).

    **apps/api/src/app.module.ts:**
    Import: ConfigModule (global), DatabaseModule (global), HealthModule. Register global pipes, filters, interceptors via APP_PIPE, APP_FILTER, APP_INTERCEPTOR providers.

    **apps/api/src/main.ts:**
    Bootstrap NestJS app:
    - Enable CORS for process.env.NEXTAUTH_URL (http://localhost:3000)
    - Set global prefix: 'api' (all routes start with /api)
    - Setup Swagger: title "TeamFlow API", version "1.0", description, bearer auth, tag "health"
    - Mount Swagger at /api/docs
    - Listen on process.env.API_PORT || 3001
    - Log startup message with port
  </action>
  <verify>
    ```bash
    cd apps/api && npx ts-node -e "import './src/main'" 2>&1 | head -5  # Should start without import errors
    # Or better: add a build script and run:
    cd apps/api && npx nest build && node dist/main.js &
    sleep 3
    curl http://localhost:3001/api/docs-json | head -20  # Swagger JSON exists
    kill %1
    ```
  </verify>
  <done>
    NestJS API has core infrastructure: Prisma service, config validation, Zod validation pipe, exception filter, logging interceptor, and Swagger setup. App module imports all global modules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Health check endpoints with Prisma and Redis indicators</name>
  <files>
    apps/api/src/health/health.module.ts
    apps/api/src/health/health.controller.ts
    apps/api/src/health/indicators/prisma.indicator.ts
    apps/api/src/health/indicators/redis.indicator.ts
  </files>
  <action>
    Install terminus:
    ```bash
    npm install @nestjs/terminus --workspace=apps/api
    ```

    **apps/api/src/health/indicators/prisma.indicator.ts:**
    Extends HealthIndicator from @nestjs/terminus. `isHealthy(key: string)` method runs `prisma.$queryRaw\`SELECT 1\`` — returns healthy if succeeds, throws HealthCheckError if fails. Inject PrismaService.

    **apps/api/src/health/indicators/redis.indicator.ts:**
    Extends HealthIndicator. Creates ioredis client from process.env.REDIS_URL. `isHealthy(key: string)` runs `redis.ping()` — returns healthy if "PONG", throws HealthCheckError otherwise. Clean up connection on module destroy.

    **apps/api/src/health/health.controller.ts:**
    ```typescript
    @Controller('health')
    export class HealthController {
      @Get()
      @HealthCheck()
      check() {
        return this.health.check([
          () => this.prismaHealth.isHealthy('database'),
          () => this.redisHealth.isHealthy('redis'),
          () => this.memory.checkHeap('memory_heap', 300 * 1024 * 1024),
        ]);
      }
    }
    ```

    **apps/api/src/health/health.module.ts:**
    Import TerminusModule. Provide PrismaHealthIndicator, RedisHealthIndicator. Import DatabaseModule for PrismaService access.

    After creating files, start the API and test:
    ```bash
    cd apps/api && npx nest build && node dist/main.js &
    sleep 3
    curl -s http://localhost:3001/api/health | jq .
    kill %1
    ```
  </action>
  <verify>
    ```bash
    curl -s http://localhost:3001/api/health | jq .
    ```
    Expected response:
    ```json
    {
      "status": "ok",
      "info": {
        "database": { "status": "up" },
        "redis": { "status": "up" },
        "memory_heap": { "status": "up" }
      }
    }
    ```
    Also verify Swagger at: `curl -s http://localhost:3001/api/docs-json | jq .info`
  </verify>
  <done>
    GET /api/health returns JSON with database, redis, and memory status. All three indicators show "up" when Docker containers are running. Swagger docs accessible at /api/docs with health endpoints documented.
  </done>
</task>

</tasks>

<verification>
1. `curl http://localhost:3001/api/health` returns status "ok" with database and redis "up"
2. `curl http://localhost:3001/api/docs-json` returns Swagger JSON
3. Sending invalid JSON to a POST endpoint returns structured validation error
4. NestJS starts without errors when Docker Postgres and Redis are running
</verification>

<success_criteria>
- NestJS API runs on port 3001
- GET /api/health returns database, redis, memory status
- Swagger documentation at /api/docs
- Global Zod validation pipe returns structured errors
- Global exception filter produces consistent error responses
- Prisma service connects to Docker Postgres
- Redis indicator connects to Docker Redis
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
