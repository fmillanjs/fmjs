---
phase: 19-notifications-activity-feed
plan: 03
type: execute
wave: 3
depends_on: [19-02]
files_modified:
  - apps/devcollab-web/app/w/[slug]/layout.tsx
  - apps/devcollab-web/app/w/[slug]/activity/page.tsx
  - apps/devcollab-web/components/WorkspaceNav.tsx
  - apps/devcollab-web/components/notifications/BellIcon.tsx
  - apps/devcollab-web/components/notifications/NotificationList.tsx
  - apps/devcollab-web/components/activity/ActivityFeed.tsx
autonomous: true
requirements: [NOTF-02, NOTF-03, FEED-01]

must_haves:
  truths:
    - "Bell icon is visible in the workspace nav with a red badge showing unread count > 0"
    - "Clicking the bell opens a panel listing notifications with links to source content"
    - "User can click 'Mark all read' and the badge count drops to 0 immediately"
    - "Activity feed page at /w/:slug/activity shows workspace events in reverse-chronological order"
    - "Activity feed has a 'Load More' button that appends older events"
    - "Activity feed refreshes with new events at the top within 30 seconds without page reload"
    - "Bell icon polls unread count every 60 seconds (interval cleaned up on unmount)"
  artifacts:
    - path: "apps/devcollab-web/components/WorkspaceNav.tsx"
      provides: "Client component nav bar with BellIcon and activity link"
      exports: ["WorkspaceNav"]
    - path: "apps/devcollab-web/components/notifications/BellIcon.tsx"
      provides: "Bell with badge + 60s polling + panel toggle"
      exports: ["BellIcon"]
    - path: "apps/devcollab-web/components/notifications/NotificationList.tsx"
      provides: "List of notifications with mark-read and mark-all-read"
      exports: ["NotificationList"]
    - path: "apps/devcollab-web/components/activity/ActivityFeed.tsx"
      provides: "Activity feed with Load More + 30s polling merge"
      exports: ["ActivityFeed"]
    - path: "apps/devcollab-web/app/w/[slug]/activity/page.tsx"
      provides: "Server Component page that SSR-fetches initial feed events"
    - path: "apps/devcollab-web/app/w/[slug]/layout.tsx"
      provides: "Updated workspace layout using WorkspaceNav client component"
  key_links:
    - from: "apps/devcollab-web/components/notifications/BellIcon.tsx"
      to: "/api (devcollab-api) GET /notifications/unread-count"
      via: "setInterval(fetchUnreadCount, 60000) in useEffect"
      pattern: "notifications/unread-count"
    - from: "apps/devcollab-web/components/notifications/NotificationList.tsx"
      to: "/api GET /notifications + PATCH /notifications/read-all"
      via: "fetch on open + markAllRead click handler"
      pattern: "notifications"
    - from: "apps/devcollab-web/components/activity/ActivityFeed.tsx"
      to: "/api GET /workspaces/:slug/activity"
      via: "setInterval(refreshFeed, 30000) in useEffect + loadMore handler"
      pattern: "workspaces.*activity"
    - from: "apps/devcollab-web/app/w/[slug]/layout.tsx"
      to: "apps/devcollab-web/components/WorkspaceNav.tsx"
      via: "import and render <WorkspaceNav slug={slug} />"
      pattern: "WorkspaceNav"
---

<objective>
Build the frontend notification and activity feed surfaces: WorkspaceNav (client component with bell + nav links), BellIcon (60s polling unread badge + panel), NotificationList (list with mark-read actions), ActivityFeed (30s refresh + cursor pagination Load More), activity feed page, and update the workspace layout to use WorkspaceNav.

Purpose: Delivers the user-facing Phase 19 features — bell icon, notification panel, and activity feed.
Output: 6 files created/modified. All frontend surfaces wired to the Phase 02 API endpoints.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-notifications-activity-feed/19-RESEARCH.md
@.planning/phases/19-notifications-activity-feed/19-02-SUMMARY.md

@apps/devcollab-web/app/w/[slug]/layout.tsx
@apps/devcollab-web/app/w/[slug]/posts/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BellIcon, NotificationList, WorkspaceNav, and update workspace layout</name>
  <files>
    apps/devcollab-web/components/notifications/BellIcon.tsx
    apps/devcollab-web/components/notifications/NotificationList.tsx
    apps/devcollab-web/components/WorkspaceNav.tsx
    apps/devcollab-web/app/w/[slug]/layout.tsx
  </files>
  <action>
**Create `apps/devcollab-web/components/notifications/NotificationList.tsx`:**

This component is opened by BellIcon. It fetches the full notification list on mount, renders each item with a link, and provides mark-individual and mark-all-read actions.

```tsx
'use client';
import { useState, useEffect, useCallback } from 'react';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

type NotificationItem = {
  id: string;
  type: string;
  read: boolean;
  createdAt: string;
  actor: { id: string; name: string | null; email: string };
  comment: { id: string; postId: string | null; snippetId: string | null } | null;
  workspace: { id: string; slug: string; name: string };
};

function notificationLink(n: NotificationItem): string {
  if (n.comment?.postId) return `/w/${n.workspace.slug}/posts/${n.comment.postId}`;
  if (n.comment?.snippetId) return `/w/${n.workspace.slug}/snippets/${n.comment.snippetId}`;
  return `/w/${n.workspace.slug}`;
}

export default function NotificationList({ onCountChange }: { onCountChange: () => void }) {
  const [notifications, setNotifications] = useState<NotificationItem[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchNotifications = useCallback(async () => {
    try {
      const res = await fetch(`${API_URL}/notifications`, {
        credentials: 'include',
        cache: 'no-store',
      });
      if (res.ok) {
        const data = await res.json();
        setNotifications(data);
      }
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchNotifications();
  }, [fetchNotifications]);

  const markRead = async (id: string) => {
    await fetch(`${API_URL}/notifications/${id}/read`, {
      method: 'PATCH',
      credentials: 'include',
    });
    setNotifications((prev) =>
      prev.map((n) => (n.id === id ? { ...n, read: true } : n)),
    );
    onCountChange();
  };

  const markAllRead = async () => {
    await fetch(`${API_URL}/notifications/read-all`, {
      method: 'PATCH',
      credentials: 'include',
    });
    setNotifications((prev) => prev.map((n) => ({ ...n, read: true })));
    onCountChange();
  };

  if (loading) return <div style={{ padding: '1rem', fontSize: '14px' }}>Loading...</div>;
  if (notifications.length === 0) {
    return <div style={{ padding: '1rem', fontSize: '14px', color: '#6b7280' }}>No notifications</div>;
  }

  const unreadCount = notifications.filter((n) => !n.read).length;

  return (
    <div>
      {unreadCount > 0 && (
        <div style={{ padding: '0.5rem 1rem', borderBottom: '1px solid #f3f4f6' }}>
          <button
            onClick={markAllRead}
            style={{
              background: 'none',
              border: 'none',
              cursor: 'pointer',
              fontSize: '12px',
              color: '#3b82f6',
              padding: 0,
            }}
          >
            Mark all read
          </button>
        </div>
      )}
      <ul style={{ listStyle: 'none', margin: 0, padding: 0, maxHeight: '320px', overflowY: 'auto' }}>
        {notifications.map((n) => {
          const actor = n.actor.name ?? n.actor.email;
          return (
            <li
              key={n.id}
              style={{
                padding: '0.75rem 1rem',
                borderBottom: '1px solid #f3f4f6',
                background: n.read ? 'white' : '#eff6ff',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'flex-start',
                gap: '0.5rem',
              }}
            >
              <div>
                <a
                  href={notificationLink(n)}
                  style={{ color: '#111827', textDecoration: 'none', fontSize: '13px' }}
                >
                  <strong>{actor}</strong> mentioned you
                </a>
                <div style={{ fontSize: '11px', color: '#9ca3af', marginTop: '2px' }}>
                  {new Date(n.createdAt).toLocaleString()}
                </div>
              </div>
              {!n.read && (
                <button
                  onClick={() => markRead(n.id)}
                  style={{
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '11px',
                    color: '#3b82f6',
                    whiteSpace: 'nowrap',
                    padding: 0,
                    flexShrink: 0,
                  }}
                >
                  Mark read
                </button>
              )}
            </li>
          );
        })}
      </ul>
    </div>
  );
}
```

**Create `apps/devcollab-web/components/notifications/BellIcon.tsx`:**

IMPORTANT: Badge uses red (#ef4444) — NOT purple (project rule prohibits purple).
setInterval MUST have cleanup: return () => clearInterval(id).

```tsx
'use client';
import { useState, useEffect, useCallback } from 'react';
import NotificationList from './NotificationList';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';
const POLL_INTERVAL_MS = 60_000;

export default function BellIcon() {
  const [unreadCount, setUnreadCount] = useState(0);
  const [open, setOpen] = useState(false);

  const fetchUnreadCount = useCallback(async () => {
    try {
      const res = await fetch(`${API_URL}/notifications/unread-count`, {
        credentials: 'include',
        cache: 'no-store',
      });
      if (res.ok) {
        const data = await res.json();
        setUnreadCount(data.count);
      }
    } catch {
      // Network error — keep last known count
    }
  }, []);

  useEffect(() => {
    fetchUnreadCount();
    const id = setInterval(fetchUnreadCount, POLL_INTERVAL_MS);
    return () => clearInterval(id); // REQUIRED: cleanup prevents interval leak on remount
  }, [fetchUnreadCount]);

  return (
    <div style={{ position: 'relative', display: 'inline-block' }}>
      <button
        onClick={() => setOpen((prev) => !prev)}
        aria-label="Notifications"
        style={{
          background: 'none',
          border: 'none',
          cursor: 'pointer',
          fontSize: '1.25rem',
          lineHeight: 1,
          padding: '4px',
        }}
      >
        {'\uD83D\uDD14'}
      </button>
      {unreadCount > 0 && (
        <span
          style={{
            position: 'absolute',
            top: '-2px',
            right: '-2px',
            background: '#ef4444',
            color: 'white',
            borderRadius: '999px',
            fontSize: '11px',
            minWidth: '16px',
            height: '16px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '0 3px',
            pointerEvents: 'none',
          }}
        >
          {unreadCount > 99 ? '99+' : unreadCount}
        </span>
      )}
      {open && (
        <div
          style={{
            position: 'absolute',
            top: 'calc(100% + 8px)',
            right: 0,
            width: '320px',
            background: 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
            zIndex: 50,
          }}
        >
          <div
            style={{
              padding: '0.75rem 1rem',
              borderBottom: '1px solid #e5e7eb',
              fontWeight: 600,
              fontSize: '14px',
              display: 'flex',
              justifyContent: 'space-between',
            }}
          >
            <span>Notifications</span>
            <button
              onClick={() => setOpen(false)}
              style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '14px', color: '#6b7280' }}
            >
              x
            </button>
          </div>
          <NotificationList onCountChange={fetchUnreadCount} />
        </div>
      )}
    </div>
  );
}
```

**Create `apps/devcollab-web/components/WorkspaceNav.tsx`:**

Keep layout.tsx as a Server Component (it awaits async params). Extract only the nav into this Client Component.

```tsx
'use client';
import BellIcon from './notifications/BellIcon';

export default function WorkspaceNav({ slug }: { slug: string }) {
  return (
    <nav
      style={{
        padding: '0.75rem 2rem',
        borderBottom: '1px solid #e5e7eb',
        background: 'white',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
      }}
    >
      <span style={{ fontWeight: 600, fontSize: '15px' }}>Workspace: {slug}</span>
      <div style={{ display: 'flex', alignItems: 'center', gap: '1.25rem' }}>
        <a
          href={`/w/${slug}`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Overview
        </a>
        <a
          href={`/w/${slug}/posts`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Posts
        </a>
        <a
          href={`/w/${slug}/snippets`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Snippets
        </a>
        <a
          href={`/w/${slug}/activity`}
          style={{ color: '#374151', textDecoration: 'none', fontSize: '14px' }}
        >
          Activity
        </a>
        <BellIcon />
        <a
          href="/dashboard"
          style={{ color: '#3b82f6', textDecoration: 'none', fontSize: '14px' }}
        >
          Dashboard
        </a>
      </div>
    </nav>
  );
}
```

**Update `apps/devcollab-web/app/w/[slug]/layout.tsx`:**

Keep as Server Component (no 'use client'). Replace the inline nav with `<WorkspaceNav slug={slug} />`.

```tsx
import WorkspaceNav from '../../../components/WorkspaceNav';

export default async function WorkspaceLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params; // CRITICAL: params is a Promise in Next.js 15

  return (
    <div style={{ fontFamily: 'system-ui, sans-serif' }}>
      <WorkspaceNav slug={slug} />
      <main style={{ padding: '2rem' }}>{children}</main>
    </div>
  );
}
```

Note: The import path `'../../../components/WorkspaceNav'` is correct — layout.tsx is at `app/w/[slug]/layout.tsx` so three levels up reaches `app/`, then `../components/WorkspaceNav` would be wrong. Verify the correct relative path: from `apps/devcollab-web/app/w/[slug]/layout.tsx` to `apps/devcollab-web/components/WorkspaceNav.tsx` is `../../../components/WorkspaceNav`.
  </action>
  <verify>
`cd /home/doctor/fernandomillan/apps/devcollab-web && npx tsc --noEmit`
Expected: 0 TypeScript errors.
  </verify>
  <done>
4 files created/updated. `tsc --noEmit` passes. WorkspaceNav is a client component. BellIcon polls with 60s interval + cleanup. NotificationList shows notifications + mark-read. layout.tsx is a Server Component using WorkspaceNav.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ActivityFeed component and activity feed page</name>
  <files>
    apps/devcollab-web/components/activity/ActivityFeed.tsx
    apps/devcollab-web/app/w/[slug]/activity/page.tsx
  </files>
  <action>
**Create `apps/devcollab-web/components/activity/ActivityFeed.tsx`:**

Polling behavior:
- On mount: renders `initialEvents` from SSR props
- Every 30 seconds: fetches first page (no cursor) and MERGES new events at top (does NOT replace list)
- "Load More": appends older events using `nextCursor`
- setInterval MUST be cleaned up

IMPORTANT: Merge logic prevents the "Load More collapse" pitfall — existing items are NOT discarded on a refresh poll.
Colors: use gray/blue palette only — NO purple anywhere.

```tsx
'use client';
import { useState, useEffect, useCallback } from 'react';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';
const REFRESH_INTERVAL_MS = 30_000;

type ActivityEvent = {
  id: string;
  type: string;
  entityId: string;
  entityType: string;
  createdAt: string;
  workspaceSlug?: string;
  actor: { id: string; name: string | null; email: string };
};

function activityLabel(event: ActivityEvent): string {
  const actor = event.actor.name ?? event.actor.email;
  switch (event.type) {
    case 'MemberJoined':   return `${actor} joined the workspace`;
    case 'PostCreated':    return `${actor} created a post`;
    case 'PostUpdated':    return `${actor} updated a post`;
    case 'SnippetCreated': return `${actor} created a snippet`;
    case 'SnippetUpdated': return `${actor} updated a snippet`;
    default:               return `${actor} performed an action`;
  }
}

function entityLink(event: ActivityEvent, slug: string): string | null {
  if (event.entityType === 'Post') return `/w/${slug}/posts/${event.entityId}`;
  if (event.entityType === 'Snippet') return `/w/${slug}/snippets/${event.entityId}`;
  return null;
}

export default function ActivityFeed({
  slug,
  initialEvents,
  initialNextCursor,
}: {
  slug: string;
  initialEvents: ActivityEvent[];
  initialNextCursor: string | null;
}) {
  const [events, setEvents] = useState<ActivityEvent[]>(initialEvents);
  const [nextCursor, setNextCursor] = useState<string | null>(initialNextCursor);
  const [loadingMore, setLoadingMore] = useState(false);

  const fetchFirstPage = useCallback(async () => {
    try {
      const res = await fetch(`${API_URL}/workspaces/${slug}/activity`, {
        credentials: 'include',
        cache: 'no-store',
      });
      if (res.ok) {
        const data = await res.json();
        // MERGE new events at top — do NOT replace existing list (prevents Load More collapse)
        setEvents((prev) => {
          const existingIds = new Set(prev.map((e) => e.id));
          const newEvents = (data.events as ActivityEvent[]).filter(
            (e) => !existingIds.has(e.id),
          );
          return newEvents.length > 0 ? [...newEvents, ...prev] : prev;
        });
        // Do NOT update nextCursor on a refresh poll — keep the existing pagination cursor
      }
    } catch {
      // Network error — keep current list
    }
  }, [slug]);

  // 30-second refresh poll for new events at the top
  useEffect(() => {
    const id = setInterval(fetchFirstPage, REFRESH_INTERVAL_MS);
    return () => clearInterval(id); // REQUIRED: cleanup on unmount
  }, [fetchFirstPage]);

  const loadMore = async () => {
    if (!nextCursor || loadingMore) return;
    setLoadingMore(true);
    try {
      const url = `${API_URL}/workspaces/${slug}/activity?cursor=${encodeURIComponent(nextCursor)}`;
      const res = await fetch(url, { credentials: 'include', cache: 'no-store' });
      if (res.ok) {
        const data = await res.json();
        setEvents((prev) => [...prev, ...(data.events as ActivityEvent[])]);
        setNextCursor(data.nextCursor);
      }
    } finally {
      setLoadingMore(false);
    }
  };

  if (events.length === 0) {
    return (
      <p style={{ color: '#6b7280', fontSize: '14px' }}>
        No activity yet. Create posts, snippets, or invite members to see events here.
      </p>
    );
  }

  return (
    <div>
      <ul style={{ listStyle: 'none', margin: 0, padding: 0 }}>
        {events.map((event) => {
          const link = entityLink(event, slug);
          return (
            <li
              key={event.id}
              style={{
                padding: '0.75rem 0',
                borderBottom: '1px solid #f3f4f6',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                gap: '1rem',
              }}
            >
              <div>
                <span style={{ fontSize: '14px', color: '#111827' }}>
                  {link ? (
                    <a href={link} style={{ color: '#111827', textDecoration: 'none' }}>
                      {activityLabel(event)}
                    </a>
                  ) : (
                    activityLabel(event)
                  )}
                </span>
              </div>
              <span style={{ fontSize: '12px', color: '#9ca3af', whiteSpace: 'nowrap' }}>
                {new Date(event.createdAt).toLocaleString()}
              </span>
            </li>
          );
        })}
      </ul>
      {nextCursor && (
        <div style={{ marginTop: '1rem', textAlign: 'center' }}>
          <button
            onClick={loadMore}
            disabled={loadingMore}
            style={{
              background: '#f9fafb',
              border: '1px solid #e5e7eb',
              borderRadius: '6px',
              padding: '0.5rem 1.5rem',
              cursor: loadingMore ? 'not-allowed' : 'pointer',
              fontSize: '14px',
              color: '#374151',
            }}
          >
            {loadingMore ? 'Loading...' : 'Load More'}
          </button>
        </div>
      )}
    </div>
  );
}
```

**Create `apps/devcollab-web/app/w/[slug]/activity/page.tsx`:**

Server Component — SSR-fetches initial feed events with cookie forwarding (same pattern as post/snippet detail pages in Phase 17-18).

```tsx
import { cookies } from 'next/headers';
import ActivityFeed from '../../../../components/activity/ActivityFeed';

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:3003';

async function getInitialFeed(slug: string, token: string) {
  try {
    const res = await fetch(`${API_URL}/workspaces/${slug}/activity`, {
      headers: { Cookie: `devcollab_token=${token}` },
      cache: 'no-store',
    });
    if (!res.ok) return { events: [], nextCursor: null };
    return res.json();
  } catch {
    return { events: [], nextCursor: null };
  }
}

export default async function ActivityPage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  const cookieStore = await cookies();
  const token = cookieStore.get('devcollab_token')?.value ?? '';

  const { events, nextCursor } = await getInitialFeed(slug, token);

  return (
    <div>
      <h1 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '1.5rem', color: '#111827' }}>
        Activity Feed
      </h1>
      <ActivityFeed
        slug={slug}
        initialEvents={events}
        initialNextCursor={nextCursor}
      />
    </div>
  );
}
```
  </action>
  <verify>
1. `cd /home/doctor/fernandomillan/apps/devcollab-web && npx tsc --noEmit` — 0 TypeScript errors
2. `cd /home/doctor/fernandomillan && npx next build apps/devcollab-web` — build succeeds with 0 errors (validates SSR Server Component + Client Component boundary)
  </verify>
  <done>
ActivityFeed.tsx and activity/page.tsx created. `tsc --noEmit` passes. `next build` succeeds. ActivityFeed has 30s polling with merge logic. Activity page SSR-fetches initial events with cookie forwarding.
  </done>
</task>

</tasks>

<verification>
- `tsc --noEmit` in apps/devcollab-web passes with 0 errors
- `next build` in apps/devcollab-web succeeds (no SSR hydration boundary violations)
- layout.tsx remains a Server Component (no 'use client') with WorkspaceNav as child
- BellIcon badge uses #ef4444 (red) — no purple anywhere in new files
- ActivityFeed merge logic: new events are prepended, existing items not discarded
</verification>

<success_criteria>
1. BellIcon polls /notifications/unread-count every 60s with setInterval cleanup on unmount
2. NotificationList fetches full list on open, supports mark-individual-read and mark-all-read
3. WorkspaceNav renders nav links (Overview, Posts, Snippets, Activity) + BellIcon + Dashboard link
4. Workspace layout.tsx stays a Server Component and renders WorkspaceNav
5. ActivityFeed polls every 30s, merges new events at top, supports Load More with cursor pagination
6. Activity page SSR-fetches initial feed with cookie forwarding
7. No purple colors in any new file
</success_criteria>

<output>
After completion, create `.planning/phases/19-notifications-activity-feed/19-03-SUMMARY.md`
</output>
