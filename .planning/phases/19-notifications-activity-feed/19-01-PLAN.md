---
phase: 19-notifications-activity-feed
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/devcollab-database/prisma/schema.prisma
  - packages/devcollab-database/prisma/migrations/20260218_add_notifications_activity/migration.sql
  - apps/devcollab-api/src/core/database/prisma.service.ts
  - apps/devcollab-api/src/workspaces/workspace-ability.factory.ts
autonomous: true
requirements: [NOTF-01, NOTF-02, NOTF-03, FEED-01]

must_haves:
  truths:
    - "Notification and ActivityEvent tables exist in devcollab-postgres with all indexed columns"
    - "PrismaService exposes .notification and .activityEvent getters usable by NestJS services"
    - "CASL ability factory grants ActivityEvent read to Contributor and Viewer roles"
    - "Notification and ActivityEvent are in the Subject type union so @CheckAbility compiles"
  artifacts:
    - path: "packages/devcollab-database/prisma/schema.prisma"
      provides: "Notification + ActivityEvent models with back-refs on User/Comment/Workspace"
      contains: "model Notification"
    - path: "packages/devcollab-database/prisma/migrations/20260218_add_notifications_activity/migration.sql"
      provides: "DDL for Notification and ActivityEvent tables"
    - path: "apps/devcollab-api/src/core/database/prisma.service.ts"
      provides: ".notification and .activityEvent getters"
      exports: ["notification", "activityEvent"]
    - path: "apps/devcollab-api/src/workspaces/workspace-ability.factory.ts"
      provides: "Extended Subject union + ActivityEvent grants"
      contains: "ActivityEvent"
  key_links:
    - from: "apps/devcollab-api/src/core/database/prisma.service.ts"
      to: "packages/devcollab-database/prisma/schema.prisma"
      via: "Prisma client regeneration after schema change"
      pattern: "activityEvent"
    - from: "apps/devcollab-api/src/workspaces/workspace-ability.factory.ts"
      to: "CaslAuthGuard"
      via: "Subject type cast on line 73 of casl-auth.guard.ts"
      pattern: "ActivityEvent.*Subject"
---

<objective>
Add Notification and ActivityEvent Prisma models, apply migration to devcollab-postgres, add PrismaService getters, and extend the CASL ability factory to include the new subjects.

Purpose: This is the foundation layer for Phase 19. All NestJS services in Plan 02 depend on these Prisma models and CASL subjects being in place first.
Output: Two new tables in devcollab-postgres, two new PrismaService getters, CASL Subject union extended.
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-notifications-activity-feed/19-RESEARCH.md

@packages/devcollab-database/prisma/schema.prisma
@apps/devcollab-api/src/core/database/prisma.service.ts
@apps/devcollab-api/src/workspaces/workspace-ability.factory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Notification + ActivityEvent models to schema.prisma with back-references</name>
  <files>packages/devcollab-database/prisma/schema.prisma</files>
  <action>
Add the following to schema.prisma AFTER the existing Reaction model:

1. New enum:
```prisma
enum ActivityEventType {
  MemberJoined
  PostCreated
  PostUpdated
  SnippetCreated
  SnippetUpdated
}
```

2. New Notification model:
```prisma
model Notification {
  id          String   @id @default(cuid())
  type        String   @default("mention")
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  recipientId String
  actorId     String
  commentId   String?
  workspaceId String

  recipient   User      @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  actor       User      @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  comment     Comment?  @relation(fields: [commentId], references: [id], onDelete: SetNull)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([recipientId, actorId, commentId, type])
  @@index([recipientId, read])
  @@index([recipientId, createdAt])
  @@index([workspaceId])
}
```

3. New ActivityEvent model:
```prisma
model ActivityEvent {
  id          String            @id @default(cuid())
  type        ActivityEventType
  entityId    String
  entityType  String
  createdAt   DateTime          @default(now())

  workspaceId String
  actorId     String

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  actor       User      @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
  @@index([actorId])
}
```

4. Back-references on existing models (add to each model's field list):

On User model, add after `reactions Reaction[]`:
```prisma
  notificationsReceived Notification[] @relation("NotificationRecipient")
  notificationsSent     Notification[] @relation("NotificationActor")
  activityEvents        ActivityEvent[]
```

On Comment model, add after `reactions Reaction[]`:
```prisma
  notifications         Notification[]
```

On Workspace model, add after `posts Post[]`:
```prisma
  notifications         Notification[]
  activityEvents        ActivityEvent[]
```

IMPORTANT: entityType on ActivityEvent is `String` (not an enum) — stores 'Post', 'Snippet', or 'User' as plain string. This allows flexibility for future entity types.
  </action>
  <verify>
Run: `cd /home/doctor/fernandomillan && npx prisma validate --schema=packages/devcollab-database/prisma/schema.prisma`
Expected: "The schema at ... is valid"
  </verify>
  <done>
`prisma validate` exits 0 with no errors. schema.prisma contains model Notification, model ActivityEvent, enum ActivityEventType, and back-references on User/Comment/Workspace models.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate migration SQL, apply to devcollab-postgres, regenerate Prisma client, add PrismaService getters, update CASL Subject union</name>
  <files>
    packages/devcollab-database/prisma/migrations/20260218_add_notifications_activity/migration.sql
    apps/devcollab-api/src/core/database/prisma.service.ts
    apps/devcollab-api/src/workspaces/workspace-ability.factory.ts
  </files>
  <action>
**Step 1 — Generate migration SQL using live DB diff (devcollab-postgres is running on port 5435):**
```bash
cd /home/doctor/fernandomillan
mkdir -p packages/devcollab-database/prisma/migrations/20260218_add_notifications_activity
npx prisma migrate diff \
  --from-url "postgresql://devcollab:devcollab@localhost:5435/devcollab" \
  --to-schema-datamodel packages/devcollab-database/prisma/schema.prisma \
  --script \
  > packages/devcollab-database/prisma/migrations/20260218_add_notifications_activity/migration.sql
```

**Step 2 — Apply migration:**
```bash
cd /home/doctor/fernandomillan
npx prisma migrate deploy \
  --schema=packages/devcollab-database/prisma/schema.prisma
```
If migrate deploy requires DATABASE_URL env: set `DEVCOLLAB_DATABASE_URL=postgresql://devcollab:devcollab@localhost:5435/devcollab` before running.

**Step 3 — Regenerate Prisma client (CRITICAL after schema change):**
```bash
cd /home/doctor/fernandomillan
npx prisma generate --schema=packages/devcollab-database/prisma/schema.prisma
```

**Step 4 — Add getters to PrismaService** (`apps/devcollab-api/src/core/database/prisma.service.ts`):
After the existing `get reaction()` getter, append:
```typescript
  get notification() {
    return this.client.notification;
  }

  get activityEvent() {
    return this.client.activityEvent;
  }
```

**Step 5 — Update CASL ability factory** (`apps/devcollab-api/src/workspaces/workspace-ability.factory.ts`):

Update the Subject type union (currently ends at `'Comment' | 'all'`):
```typescript
export type Subject =
  | 'Workspace'
  | 'WorkspaceMember'
  | 'InviteLink'
  | 'Post'
  | 'Snippet'
  | 'Comment'
  | 'Reaction'
  | 'Notification'
  | 'ActivityEvent'
  | 'User'
  | 'all';
```

In the ability builder, add grants for Contributor role (after the existing `cannot('create', 'InviteLink')` line):
```typescript
      can('read', 'ActivityEvent');
      can('read', 'Notification');
      can('update', 'Notification');
```

Note: Viewer already has `can('read', 'all')` which covers ActivityEvent read. Admin has `can('manage', 'all')` which covers both. No Viewer-specific changes needed.

Note on `'Reaction'` and `'User'`: Adding these to the Subject union is safe — the guard's type cast on line 73 of casl-auth.guard.ts will accept them. They were missing from the union before; add them now as part of this cleanup.
  </action>
  <verify>
1. `npx prisma migrate status --schema=packages/devcollab-database/prisma/schema.prisma` — shows all migrations applied
2. `cd apps/devcollab-api && npx tsc --noEmit` — TypeScript compiles with no errors (tests the new Subject union and getter return types)
3. `docker exec devcollab-postgres psql -U devcollab -d devcollab -c "\dt"` — shows Notification and ActivityEvent tables
  </verify>
  <done>
Migration applied successfully. TypeScript compiles with 0 errors. `\dt` in devcollab-postgres shows `notification` and `activity_event` tables. PrismaService has `.notification` and `.activityEvent` getters. WorkspaceAbilityFactory Subject union includes Notification, ActivityEvent, Reaction, User.
  </done>
</task>

</tasks>

<verification>
- `prisma validate` passes on updated schema.prisma
- `prisma migrate status` shows all migrations applied
- `tsc --noEmit` in devcollab-api passes with 0 errors
- Notification and ActivityEvent tables visible in devcollab-postgres
</verification>

<success_criteria>
1. schema.prisma contains Notification + ActivityEvent models with all specified fields, indexes, and back-references
2. Migration SQL file exists and migration is applied to devcollab-postgres
3. Prisma client regenerated — `.prisma/devcollab-client` contains Notification and ActivityEvent types
4. PrismaService exposes `.notification` and `.activityEvent` getters
5. WorkspaceAbilityFactory Subject union includes Notification, ActivityEvent, Reaction, User; Contributor grants cover ActivityEvent + Notification reads
</success_criteria>

<output>
After completion, create `.planning/phases/19-notifications-activity-feed/19-01-SUMMARY.md`
</output>
