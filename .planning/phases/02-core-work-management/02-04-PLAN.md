---
phase: 02-core-work-management
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - apps/api/src/modules/tasks/tasks.controller.ts
  - apps/api/src/modules/tasks/tasks.service.ts
  - apps/api/src/modules/tasks/tasks.module.ts
  - apps/api/src/modules/tasks/dto/create-task.dto.ts
  - apps/api/src/modules/tasks/dto/update-task.dto.ts
  - apps/api/src/modules/comments/comments.controller.ts
  - apps/api/src/modules/comments/comments.service.ts
  - apps/api/src/modules/comments/comments.module.ts
  - apps/api/src/app.module.ts
  - apps/api/src/main.ts
autonomous: true

must_haves:
  truths:
    - "User can create tasks with title, description, due date, priority, status, labels, assignee"
    - "User can edit any task field via PATCH /tasks/:id"
    - "User can delete tasks via DELETE /tasks/:id"
    - "User can assign tasks to team members"
    - "User can update task status (for Kanban drag-drop)"
    - "User can add comments to tasks"
    - "Task history captured via audit events for all mutations"
    - "All task queries scoped by organization via project relationship"
  artifacts:
    - path: "apps/api/src/modules/tasks/tasks.controller.ts"
      provides: "Tasks REST endpoints"
      exports: ["TasksController"]
    - path: "apps/api/src/modules/tasks/tasks.service.ts"
      provides: "Task business logic with org scoping and audit events"
      exports: ["TasksService"]
    - path: "apps/api/src/modules/comments/comments.controller.ts"
      provides: "Comments REST endpoints"
      exports: ["CommentsController"]
  key_links:
    - from: "apps/api/src/modules/tasks/tasks.service.ts"
      to: "prisma.task"
      via: "database queries scoped by project.organizationId"
      pattern: "project:\\s*\\{\\s*organizationId"
    - from: "apps/api/src/modules/tasks/tasks.service.ts"
      to: "eventEmitter"
      via: "audit events for all task mutations"
      pattern: "eventEmitter\\.emit\\('task\\."
    - from: "apps/api/src/modules/comments/comments.service.ts"
      to: "prisma.comment"
      via: "database queries"
      pattern: "prisma\\.comment\\.(create|findMany)"
---

<objective>
Create NestJS modules for Tasks and Comments with full CRUD endpoints, filtering, organization scoping, and audit event emission. Tasks support all fields: title, description, due date, priority, status, labels, assignee. Comments are threaded under tasks.

Purpose: Tasks are the core entity of TeamFlow. This plan delivers the complete backend for task management including the status update endpoint needed for Kanban drag-and-drop.
Output: Working /tasks and /comments API endpoints with filtering and audit trail
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-work-management/02-RESEARCH.md
@.planning/phases/02-core-work-management/02-03-SUMMARY.md
@apps/api/src/modules/projects/projects.service.ts
@apps/api/src/core/rbac/ability.factory.ts
@apps/api/src/core/audit/audit.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Tasks module with full CRUD, filtering, and audit events</name>
  <files>
    apps/api/src/modules/tasks/tasks.controller.ts
    apps/api/src/modules/tasks/tasks.service.ts
    apps/api/src/modules/tasks/tasks.module.ts
    apps/api/src/modules/tasks/dto/create-task.dto.ts
    apps/api/src/modules/tasks/dto/update-task.dto.ts
    apps/api/src/app.module.ts
    apps/api/src/main.ts
  </files>
  <action>
    **Create DTOs:**
    - `create-task.dto.ts`: createZodDto(createTaskSchema)
    - `update-task.dto.ts`: createZodDto(updateTaskSchema) and createZodDto(updateTaskStatusSchema)

    **Create tasks.service.ts:**
    - Inject PrismaService, AbilityFactory, EventEmitter2

    - Helper `verifyProjectAccess(projectId, userId)`: Find project with org, verify user membership in org. Return project with organizationId. Throw NotFoundException/ForbiddenException.

    - Helper `verifyTaskAccess(taskId, userId)`: Find task with project.organization, verify membership. Return task. Throw NotFoundException/ForbiddenException.

    - `create(dto: CreateTaskDto, user)`:
      - Verify project access
      - If assigneeId provided, verify assignee is member of same organization
      - Create task with: title, description, status, priority, dueDate, position (auto-calculate: count of tasks with same status in project), projectId, assigneeId, createdById: user.id
      - Connect labels if labelIds provided (verify labels belong to same organization)
      - Include assignee, labels, createdBy in response
      - Emit 'task.created' event with full task data

    - `findAllByProject(projectId, userId, filters)`:
      - Verify project access
      - Build WHERE clause with:
        - projectId (required)
        - project.organizationId (CRITICAL: prevent cross-tenant)
        - status filter (optional, from query param)
        - priority filter (optional)
        - assigneeId filter (optional)
        - label filter (optional: tasks where labels.some.id in labelIds)
        - search filter (optional: title OR description contains, mode insensitive)
      - Include: assignee { id, name, image }, labels, _count { comments }
      - OrderBy: configurable (createdAt desc default, also support: dueDate, priority, status)
      - Return tasks array

    - `findById(taskId, userId)`:
      - Verify task access
      - Include: assignee, labels, comments (with author, ordered by createdAt asc), createdBy, project
      - Return full task detail

    - `update(taskId, dto: UpdateTaskDto, user)`:
      - Verify task access
      - Capture previous state for audit diff
      - If assigneeId changed, verify new assignee is org member
      - If labelIds provided, disconnect all current labels and connect new ones
      - Update task fields
      - Emit 'task.updated' event with {previous, current} for audit trail
      - Include assignee, labels in response

    - `updateStatus(taskId, status: TaskStatus, user)`:
      - Verify task access
      - Capture previous status
      - Update status field only (optimized for drag-drop)
      - Emit 'task.status_changed' event with {previousStatus, newStatus}
      - Return updated task

    - `remove(taskId, user)`:
      - Verify task access
      - Check ability can('delete', 'Task')
      - Delete task (cascade deletes comments)
      - Emit 'task.deleted' event

    **Create tasks.controller.ts:**
    - `@Post('projects/:projectId/tasks')` create — create task in project
    - `@Get('projects/:projectId/tasks')` findAll — list with filters: @Query() status, priority, assigneeId, labels, search, sortBy, sortOrder
    - `@Get('tasks/:id')` findOne — task detail with comments
    - `@Patch('tasks/:id')` update — edit task fields
    - `@Patch('tasks/:id/status')` updateStatus — Kanban drag-drop
    - `@Delete('tasks/:id')` remove — delete task

    **Create tasks.module.ts** and register in app.module.ts. Add 'tasks' Swagger tag.
  </action>
  <verify>
    Start API and test:
    1. POST /projects/:id/tasks with full fields → 201 (task created with labels, assignee)
    2. GET /projects/:id/tasks → 200 (task list with assignee, labels, comment count)
    3. GET /projects/:id/tasks?status=TODO → 200 (filtered)
    4. GET /projects/:id/tasks?search=keyword → 200 (search)
    5. GET /tasks/:id → 200 (full detail with comments)
    6. PATCH /tasks/:id → 200 (updated, audit event emitted)
    7. PATCH /tasks/:id/status → 200 (status changed)
    8. DELETE /tasks/:id → 200 (deleted)
  </verify>
  <done>Tasks API fully functional with CRUD, filtering, search, status updates for Kanban, label assignment, assignee management, and comprehensive audit events for all mutations.</done>
</task>

<task type="auto">
  <name>Task 2: Create Comments module and activity/audit query endpoints</name>
  <files>
    apps/api/src/modules/comments/comments.controller.ts
    apps/api/src/modules/comments/comments.service.ts
    apps/api/src/modules/comments/comments.module.ts
    apps/api/src/app.module.ts
  </files>
  <action>
    **Create comments.service.ts:**
    - Inject PrismaService, EventEmitter2

    - `create(taskId, content, user)`:
      - Verify user has access to task's project's organization
      - Create comment with content, taskId, authorId: user.id
      - Emit 'comment.created' event
      - Return comment with author { id, name, image }

    - `findAllByTask(taskId, userId)`:
      - Verify task access (user is member of task's org)
      - Find all comments for task, ordered by createdAt asc
      - Include author { id, name, image }

    - `update(commentId, content, user)`:
      - Find comment, verify user is author OR admin
      - Update content
      - Emit 'comment.updated' event

    - `remove(commentId, user)`:
      - Find comment, verify user is author OR admin
      - Delete comment
      - Emit 'comment.deleted' event

    **Create comments.controller.ts:**
    - `@Post('tasks/:taskId/comments')` create — add comment to task
    - `@Get('tasks/:taskId/comments')` findAll — list comments
    - `@Patch('comments/:id')` update — edit comment
    - `@Delete('comments/:id')` remove — delete comment

    **Also add activity/audit query endpoints to existing infrastructure:**

    Add to tasks.controller.ts or create a new activity endpoint:
    - `@Get('projects/:projectId/activity')` — query AuditLog where entityType IN ('Task', 'Comment', 'Project') AND related to this project. Paginated (offset + limit, default 20). Include actor name. Order by timestamp desc.
    - `@Get('teams/:teamId/audit-log')` — Admin only. Query all AuditLog entries for entities in this organization. Support search (action contains), filter by entityType, date range. Paginated.

    **Create comments.module.ts** and register in app.module.ts. Add 'comments' Swagger tag.
  </action>
  <verify>
    Test:
    1. POST /tasks/:id/comments → 201 (comment with author)
    2. GET /tasks/:id/comments → 200 (comment list with authors)
    3. PATCH /comments/:id as author → 200
    4. DELETE /comments/:id as non-author non-admin → 403
    5. GET /projects/:id/activity → 200 (paginated activity feed)
    6. GET /teams/:id/audit-log as admin → 200 (searchable audit log)
    7. GET /teams/:id/audit-log as member → 403
  </verify>
  <done>Comments API functional with CRUD and author/admin restrictions. Activity feed endpoint returns project-scoped audit entries. Admin audit log endpoint returns searchable, filterable organization-wide audit entries.</done>
</task>

</tasks>

<verification>
1. API starts with Tasks, Comments modules registered
2. Task CRUD with all fields works correctly
3. Task filtering by status, priority, assignee, labels, and search works
4. Organization scoping prevents cross-tenant task access
5. All mutations emit audit events with previous/current state
6. Comments enforce author-only editing
7. Activity feed and audit log endpoints return paginated results
</verification>

<success_criteria>
- TASK-01: Create tasks with title, description, due date
- TASK-02: Edit any task field
- TASK-03: Delete tasks
- TASK-04: Assign tasks to team members
- TASK-05: Set task priority
- TASK-06: Set task status
- TASK-07: Add labels to tasks
- TASK-08: Add comments to tasks (backend)
- TASK-09: Task history via audit events (backend)
- AUDIT-05: Activity feed endpoint (backend)
- AUDIT-06: Audit log endpoint (backend)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-work-management/02-04-SUMMARY.md`
</output>
