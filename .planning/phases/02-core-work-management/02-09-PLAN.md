---
phase: 02-core-work-management
plan: 09
type: execute
wave: 7
depends_on: ["02-07"]
files_modified:
  - apps/web/components/tasks/task-detail-panel.tsx
  - apps/web/components/tasks/comment-thread.tsx
  - apps/web/components/tasks/comment-form.tsx
  - apps/web/components/tasks/task-history.tsx
  - apps/web/app/(dashboard)/teams/[teamId]/projects/[projectId]/tasks/[taskId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view full task detail with all fields"
    - "User can add comments to a task"
    - "User can view comment thread on a task"
    - "User can view task history showing all changes"
    - "Comments show author name, avatar, and relative timestamp"
    - "Task history shows what changed, who changed it, and when"
  artifacts:
    - path: "apps/web/components/tasks/task-detail-panel.tsx"
      provides: "Full task detail view"
    - path: "apps/web/components/tasks/comment-thread.tsx"
      provides: "Comment list for a task"
    - path: "apps/web/components/tasks/task-history.tsx"
      provides: "Task change history timeline"
  key_links:
    - from: "apps/web/components/tasks/comment-thread.tsx"
      to: "/api"
      via: "GET /tasks/:id/comments"
      pattern: "api\\.get.*comments"
    - from: "apps/web/components/tasks/task-history.tsx"
      to: "/api"
      via: "GET audit log filtered by task entity"
      pattern: "api\\.get.*activity|audit"
---

<objective>
Build the task detail view with comment thread and task change history. This provides the deep-dive view when a user clicks on a task card from the Kanban board or list view.

Purpose: Comments and history demonstrate collaborative workflow capability. Task history (via audit log) shows the full lifecycle of a task — who changed what and when. This is a key differentiator for recruiter evaluation.
Output: Task detail page with comment thread and change history timeline
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-work-management/02-RESEARCH.md
@.planning/phases/02-core-work-management/02-07-SUMMARY.md
@.planning/phases/02-core-work-management/02-04-SUMMARY.md
@apps/web/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task detail page with editable fields and comment thread</name>
  <files>
    apps/web/app/(dashboard)/teams/[teamId]/projects/[projectId]/tasks/[taskId]/page.tsx
    apps/web/components/tasks/task-detail-panel.tsx
    apps/web/components/tasks/comment-thread.tsx
    apps/web/components/tasks/comment-form.tsx
  </files>
  <action>
    **Create components/tasks/task-detail-panel.tsx:**
    - Client component
    - Props: task (TaskDetail), teamMembers, labels, onUpdate callback
    - Layout: two-column on desktop (main content left, metadata sidebar right)

    **Main content area (left):**
    - Title: editable inline (click to edit, Enter to save, Escape to cancel)
    - Description: editable markdown-style textarea (click to edit, save/cancel buttons)
    - Comment thread section below description

    **Metadata sidebar (right):**
    - Status: dropdown selector with colored badges
    - Priority: dropdown selector with colored badges
    - Assignee: dropdown with team member avatars
    - Labels: multi-select with colored dots
    - Due date: date picker
    - Created by: name + avatar (read-only)
    - Created: relative date (read-only)
    - Updated: relative date (read-only)

    Each metadata field change calls API PATCH /tasks/:id immediately (inline editing, no separate save button). Show saving indicator briefly.

    **Delete button** at bottom of sidebar with confirmation dialog.

    **Create components/tasks/comment-thread.tsx:**
    - Props: comments (CommentWithAuthor[]), taskId
    - Renders list of comments, each showing:
      - Author avatar + name
      - Relative timestamp (e.g., "2 hours ago" via date-fns formatDistanceToNow)
      - Comment content
      - Edit/Delete buttons (visible on hover, only for comment author or admin)
    - Empty state: "No comments yet. Be the first to comment."

    **Create components/tasks/comment-form.tsx:**
    - Textarea for new comment
    - "Comment" button (disabled when empty)
    - onSubmit: POST /tasks/:taskId/comments
    - Clear textarea on success
    - Show new comment immediately (optimistic add to list)

    **Create tasks/[taskId]/page.tsx:**
    - Server Component
    - Fetch: GET /tasks/:taskId (includes comments, labels, assignee)
    - Fetch: GET /teams/:teamId/members (for assignee dropdown)
    - Fetch: GET /teams/:teamId/labels (for label dropdown)
    - Render TaskDetailPanel with comment thread
    - Breadcrumb: Team > Project > Task Title
    - Back button to project page
  </action>
  <verify>
    1. /teams/[teamId]/projects/[projectId]/tasks/[taskId] shows full task detail
    2. Inline edit title and description works
    3. Changing status/priority/assignee/labels saves immediately
    4. Comment form submits and shows new comment
    5. Edit/delete own comments works
    6. Breadcrumb navigation works
    7. Delete task with confirmation works
  </verify>
  <done>Task detail page with inline editing of all fields, comment thread with add/edit/delete, and metadata sidebar. All changes save immediately via API.</done>
</task>

<task type="auto">
  <name>Task 2: Create task history timeline from audit log</name>
  <files>
    apps/web/components/tasks/task-history.tsx
  </files>
  <action>
    **Create components/tasks/task-history.tsx:**
    - Client component
    - Props: taskId, projectId
    - Fetches task history from API: GET /projects/:projectId/activity?entityType=Task&entityId=:taskId (or a dedicated endpoint if available)
    - Displays as vertical timeline (line connecting events)

    **Each history entry shows:**
    - Actor avatar + name
    - Action description in human-readable format:
      - "Created this task" (task.created)
      - "Changed status from To Do to In Progress" (task.status_changed with changes.previous/current)
      - "Changed priority from Medium to High" (task.updated with specific field changes)
      - "Assigned to [Name]" (task.updated with assigneeId change)
      - "Added label [Label Name]" (task.updated with label changes)
      - "Added a comment" (comment.created)
      - "Deleted a comment" (comment.deleted)
    - Relative timestamp

    **Parse audit log changes field:**
    - changes contains {previous: {...}, current: {...}} for updates
    - Compare fields to determine what changed
    - Format field names: assigneeId → "assignee", dueDate → "due date"
    - Format values: status enum → human-readable, dates → formatted

    **Layout:**
    - Tab or expandable section on task detail page (below comments or in a separate tab)
    - Show most recent 20 entries initially
    - "Load more" button for older entries
    - Empty state: "No history yet."

    **Integrate into task detail page:**
    - Add tabs or accordion: "Comments" and "History"
    - Or show both: comments thread above, history timeline below (collapsible)
  </action>
  <verify>
    1. Task history shows timeline of changes
    2. Status changes display correctly (e.g., "Changed status from To Do to In Progress")
    3. Assignment changes show user names
    4. Creation event shows
    5. Comments events show
    6. Timeline is chronological (newest first)
    7. Load more button works for long histories
  </verify>
  <done>Task history timeline displays all changes from audit log in human-readable format. Each entry shows who changed what and when. Integrated into task detail page.</done>
</task>

</tasks>

<verification>
1. Task detail page shows all task fields with inline editing
2. Comment thread works (add, edit, delete)
3. Task history shows complete change timeline
4. Audit log entries translated to human-readable format
5. Navigation from Kanban/List to task detail and back works
6. Metadata changes save immediately
</verification>

<success_criteria>
- TASK-02: User can edit any task field (inline editing UI)
- TASK-03: User can delete tasks (UI with confirmation)
- TASK-08: User can add comments to tasks (UI)
- TASK-09: User can view task history and changes (UI)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-work-management/02-09-SUMMARY.md`
</output>
