---
phase: 02-core-work-management
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - apps/api/src/modules/projects/projects.controller.ts
  - apps/api/src/modules/projects/projects.service.ts
  - apps/api/src/modules/projects/projects.module.ts
  - apps/api/src/modules/projects/dto/create-project.dto.ts
  - apps/api/src/modules/projects/dto/update-project.dto.ts
  - apps/api/src/modules/labels/labels.controller.ts
  - apps/api/src/modules/labels/labels.service.ts
  - apps/api/src/modules/labels/labels.module.ts
  - apps/api/src/app.module.ts
  - apps/api/src/main.ts
autonomous: true

must_haves:
  truths:
    - "User can create projects within their team via POST /teams/:teamId/projects"
    - "User can view all projects in their team via GET /teams/:teamId/projects"
    - "User can edit project details via PATCH /projects/:id"
    - "User can archive projects via PATCH /projects/:id with status ARCHIVED"
    - "Admin can delete projects via DELETE /projects/:id"
    - "Non-admin cannot delete projects (403)"
    - "Labels can be created and listed per organization"
  artifacts:
    - path: "apps/api/src/modules/projects/projects.controller.ts"
      provides: "Projects REST endpoints"
      exports: ["ProjectsController"]
    - path: "apps/api/src/modules/projects/projects.service.ts"
      provides: "Project business logic with org scoping"
      exports: ["ProjectsService"]
    - path: "apps/api/src/modules/labels/labels.service.ts"
      provides: "Label CRUD with org scoping"
      exports: ["LabelsService"]
  key_links:
    - from: "apps/api/src/modules/projects/projects.service.ts"
      to: "prisma.project"
      via: "database queries scoped by organizationId"
      pattern: "organizationId"
    - from: "apps/api/src/modules/labels/labels.service.ts"
      to: "prisma.label"
      via: "database queries scoped by organizationId"
      pattern: "organizationId"
---

<objective>
Create NestJS modules for Projects and Labels with full CRUD endpoints, organization-scoped queries, and role-based access control. Projects belong to organizations; Labels are organization-scoped for task tagging.

Purpose: Projects are the container for tasks. Labels enable task categorization. Both must enforce organization scoping to prevent cross-tenant data leakage.
Output: Working /projects and /labels API endpoints
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-work-management/02-RESEARCH.md
@.planning/phases/02-core-work-management/02-02-SUMMARY.md
@apps/api/src/modules/teams/teams.service.ts
@apps/api/src/core/rbac/ability.factory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Projects module with CRUD endpoints and organization scoping</name>
  <files>
    apps/api/src/modules/projects/projects.controller.ts
    apps/api/src/modules/projects/projects.service.ts
    apps/api/src/modules/projects/projects.module.ts
    apps/api/src/modules/projects/dto/create-project.dto.ts
    apps/api/src/modules/projects/dto/update-project.dto.ts
    apps/api/src/app.module.ts
    apps/api/src/main.ts
  </files>
  <action>
    **Create DTOs:**
    - `create-project.dto.ts`: createZodDto(createProjectSchema) from @repo/shared
    - `update-project.dto.ts`: createZodDto(updateProjectSchema) from @repo/shared

    **Create projects.service.ts:**
    - Inject PrismaService, AbilityFactory, EventEmitter2
    - Helper method `verifyMembership(userId, orgId)`: Check user is member of organization. Throw ForbiddenException if not.
    - `create(orgId, dto, user)`: Verify membership. Check ability can('create', 'Project'). Create project with organizationId. Emit 'project.created'. Return project.
    - `findAllByOrg(orgId, userId)`: Verify membership. Find all projects where organizationId = orgId. Include _count of tasks. Order by createdAt desc.
    - `findById(projectId, userId)`: Find project, verify user is member of project's organization. Include task count.
    - `update(projectId, dto, user)`: Find project, verify membership in org. Check ability can('update', 'Project'). Update project. Emit 'project.updated'. Return updated project.
    - `archive(projectId, user)`: Same as update but sets status to ARCHIVED. Emit 'project.archived'.
    - `remove(projectId, user)`: Find project, verify membership. Check user role is ADMIN (only admin can delete). Delete project. Emit 'project.deleted'. Throw ForbiddenException for non-admin.

    CRITICAL: Every query must include `organizationId` in WHERE clause to prevent cross-tenant data leakage. Use pattern: `project: { organizationId }` for task-level queries.

    **Create projects.controller.ts:**
    - `@Post('teams/:teamId/projects')` create — scoped to team
    - `@Get('teams/:teamId/projects')` findAll — list projects in team
    - `@Get('projects/:id')` findOne — single project
    - `@Patch('projects/:id')` update — edit project
    - `@Patch('projects/:id/archive')` archive — archive project
    - `@Delete('projects/:id')` remove — delete (admin only)
    - Use @CheckAbility decorators appropriately

    **Create projects.module.ts** and register in app.module.ts. Add 'projects' Swagger tag.
  </action>
  <verify>
    Start API and test:
    1. POST /teams/:teamId/projects → 201 (project created in team)
    2. GET /teams/:teamId/projects → 200 (list with task counts)
    3. GET /projects/:id → 200 (project details)
    4. PATCH /projects/:id → 200 (updated)
    5. PATCH /projects/:id/archive → 200 (status = ARCHIVED)
    6. DELETE /projects/:id as admin → 200 (deleted)
    7. DELETE /projects/:id as member → 403
  </verify>
  <done>Projects API fully functional with CRUD, archiving, admin-only deletion, and organization scoping. All mutations emit audit events.</done>
</task>

<task type="auto">
  <name>Task 2: Create Labels module with CRUD endpoints</name>
  <files>
    apps/api/src/modules/labels/labels.controller.ts
    apps/api/src/modules/labels/labels.service.ts
    apps/api/src/modules/labels/labels.module.ts
    apps/api/src/app.module.ts
  </files>
  <action>
    **Create labels.service.ts:**
    - Inject PrismaService
    - `create(orgId, name, color, userId)`: Verify membership. Create label with organizationId. Predefined palette of 10 colors: #ef4444 (red), #f97316 (orange), #eab308 (yellow), #22c55e (green), #06b6d4 (cyan), #3b82f6 (blue), #8b5cf6 (violet - NOT purple per user instruction), #ec4899 (pink), #64748b (slate), #f43f5e (rose). If no color provided, use random from palette. Return label.
    - `findAllByOrg(orgId, userId)`: Verify membership. Find all labels for organization.
    - `update(labelId, name, color, userId, orgId)`: Find label, verify belongs to org. Update. Return.
    - `remove(labelId, userId, orgId)`: Find label, verify belongs to org. Delete. Tasks keep their other labels (implicit m2m handles this).

    **Create labels.controller.ts:**
    - `@Post('teams/:teamId/labels')` create
    - `@Get('teams/:teamId/labels')` findAll
    - `@Patch('labels/:id')` update
    - `@Delete('labels/:id')` remove

    **Create labels.module.ts** and register in app.module.ts.

    Note: Label operations are relatively simple. Manager and Admin can create/edit/delete labels. Members can read.
  </action>
  <verify>
    Test:
    1. POST /teams/:teamId/labels with name and color → 201
    2. GET /teams/:teamId/labels → 200 (list of labels)
    3. PATCH /labels/:id → 200 (updated)
    4. DELETE /labels/:id → 200 (deleted)
  </verify>
  <done>Labels API functional with CRUD, organization scoping, predefined color palette. Labels can be assigned to tasks via the tasks API (Plan 04).</done>
</task>

</tasks>

<verification>
1. API starts without errors with ProjectsModule and LabelsModule
2. All project endpoints enforce organization membership
3. Project deletion restricted to Admin role
4. Labels scoped to organization (unique name per org)
5. Swagger shows projects and labels endpoints
</verification>

<success_criteria>
- PROJ-01: User can create projects within a team
- PROJ-02: User can view all projects in their team
- PROJ-03: User can edit project details
- PROJ-04: User can archive completed projects
- PROJ-05: Admin can delete projects
- Labels CRUD ready for task assignment
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-work-management/02-03-SUMMARY.md`
</output>
