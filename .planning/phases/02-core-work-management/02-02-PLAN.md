---
phase: 02-core-work-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/api/src/modules/teams/teams.controller.ts
  - apps/api/src/modules/teams/teams.service.ts
  - apps/api/src/modules/teams/teams.module.ts
  - apps/api/src/modules/teams/dto/create-team.dto.ts
  - apps/api/src/modules/teams/dto/invite-member.dto.ts
  - apps/api/src/core/rbac/ability.factory.ts
  - apps/api/src/app.module.ts
  - apps/api/src/main.ts
autonomous: true

must_haves:
  truths:
    - "User can create a team/workspace via POST /teams"
    - "User can invite members to team via POST /teams/:id/members"
    - "User can view all team members and roles via GET /teams/:id/members"
    - "Admin can remove members via DELETE /teams/:id/members/:userId"
    - "Non-admin cannot remove members (403)"
    - "All team queries scoped by organizationId"
  artifacts:
    - path: "apps/api/src/modules/teams/teams.controller.ts"
      provides: "Teams REST endpoints"
      exports: ["TeamsController"]
    - path: "apps/api/src/modules/teams/teams.service.ts"
      provides: "Team business logic with org scoping"
      exports: ["TeamsService"]
    - path: "apps/api/src/core/rbac/ability.factory.ts"
      provides: "Updated CASL rules with Organization subject"
      contains: "Organization"
  key_links:
    - from: "apps/api/src/modules/teams/teams.service.ts"
      to: "prisma.organization"
      via: "database queries"
      pattern: "prisma\\.organization\\.(create|findMany|findFirst)"
    - from: "apps/api/src/modules/teams/teams.service.ts"
      to: "prisma.membership"
      via: "membership management"
      pattern: "prisma\\.membership\\.(create|delete|findMany)"
---

<objective>
Create NestJS teams module with REST endpoints for organization CRUD and membership management. Update CASL ability factory to support organization-scoped permissions.

Purpose: Teams/Organizations are the tenant boundary for all data. This module must exist before projects or tasks can be created. The RBAC update ensures all Phase 2 features respect organization scoping.
Output: Working /teams API endpoints with organization-scoped RBAC
</objective>

<execution_context>
@/home/doctor/.claude/get-shit-done/workflows/execute-plan.md
@/home/doctor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-work-management/02-RESEARCH.md
@.planning/phases/02-core-work-management/02-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-06-SUMMARY.md
@apps/api/src/core/rbac/ability.factory.ts
@apps/api/src/modules/users/users.controller.ts
@apps/api/src/app.module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CASL ability factory with organization-scoped subjects and create Teams DTOs</name>
  <files>
    apps/api/src/core/rbac/ability.factory.ts
    apps/api/src/modules/teams/dto/create-team.dto.ts
    apps/api/src/modules/teams/dto/invite-member.dto.ts
  </files>
  <action>
    **Update ability.factory.ts:**
    - Add 'Organization' and 'Membership' to the Subject type union
    - Update UserContext interface: organizationId is now required for org-scoped operations (keep optional for backward compat)
    - ADMIN: can manage all (unchanged)
    - MANAGER: add can('read', 'Organization'), can('read', 'Membership'), can('create', 'Task') (already there)
    - MEMBER: add can('read', 'Organization'), can('read', 'Membership')
    - Only ADMIN can: create Organization, delete Organization, manage Membership (invite/remove)
    - MANAGER can: invite members (create Membership), but cannot remove members — actually per requirements, only Admin can manage membership. Keep it simple: Admin manages membership, Manager/Member can only read.

    Actually, re-reading requirements: TEAM-02 says "User can invite members" and TEAM-04 says "Admin only can remove members". So inviting is more permissive. Let Admin and Manager invite, only Admin remove.

    Updated CASL rules:
    - ADMIN: manage all (no change)
    - MANAGER: can('create', 'Organization'), can('read', 'Organization'), can('create', 'Membership'), can('read', 'Membership')
    - MEMBER: can('read', 'Organization'), can('read', 'Membership')
    - Nobody except ADMIN can delete Membership

    **Create DTOs** using createZodDto pattern from Phase 1:
    - `create-team.dto.ts`: Import createTeamSchema from @repo/shared, `export class CreateTeamDto extends createZodDto(createTeamSchema) {}`
    - `invite-member.dto.ts`: Import inviteMemberSchema from @repo/shared, `export class InviteMemberDto extends createZodDto(inviteMemberSchema) {}`
  </action>
  <verify>
    Run `cd apps/api && npx tsc --noEmit` — should compile with no errors. Verify ability factory builds correctly.
  </verify>
  <done>CASL ability factory supports Organization and Membership subjects. DTOs created with shared Zod schemas.</done>
</task>

<task type="auto">
  <name>Task 2: Create Teams module with controller, service, and register in app</name>
  <files>
    apps/api/src/modules/teams/teams.controller.ts
    apps/api/src/modules/teams/teams.service.ts
    apps/api/src/modules/teams/teams.module.ts
    apps/api/src/app.module.ts
    apps/api/src/main.ts
  </files>
  <action>
    **Create teams.service.ts:**
    - Inject PrismaService, AbilityFactory, EventEmitter2
    - `create(dto: CreateTeamDto, user)`: Create Organization with slug (slugify name, lowercase, replace spaces with hyphens). Auto-create Membership for creator with ADMIN role. Emit 'team.created' event. Return org with members.
    - `findAllForUser(userId: string)`: Find all organizations where user has membership. Include member count.
    - `findById(orgId: string, userId: string)`: Find organization by ID, verify user is member. Include members with user details.
    - `inviteMember(orgId: string, dto: InviteMemberDto, currentUser)`: Check currentUser is ADMIN or MANAGER in this org (query membership). Find user by email. Create membership. Emit 'team.member.invited' event. Throw ForbiddenException if not authorized. Throw NotFoundException if user not found. Throw ConflictException if already a member.
    - `removeMember(orgId: string, targetUserId: string, currentUser)`: Check currentUser is ADMIN in this org. Cannot remove self if last admin. Delete membership. Emit 'team.member.removed' event.
    - `getMembers(orgId: string, userId: string)`: Verify user is member of org. Return all memberships with user details (id, name, email, image, role, joinedAt).

    **Create teams.controller.ts:**
    - `@Controller('teams')`, `@UseGuards(JwtAuthGuard)` (already global, but explicit is fine)
    - `@Post()` create — @Body() CreateTeamDto, @CurrentUser() user → 201
    - `@Get()` findAll — @CurrentUser() user → list of user's teams
    - `@Get(':id')` findOne — @Param('id') id, @CurrentUser() user → team with members
    - `@Get(':id/members')` getMembers — @Param('id') id, @CurrentUser() user → member list
    - `@Post(':id/members')` inviteMember — @Param('id') id, @Body() InviteMemberDto, @CurrentUser() user → 201
    - `@Delete(':id/members/:userId')` removeMember — @Param('id') id, @Param('userId') userId, @CurrentUser() user → 200
    - Add `@CheckAbility('read', 'Organization')` on GET endpoints, `@CheckAbility('create', 'Organization')` on POST create

    **Create teams.module.ts:**
    - Import PrismaService (or DatabaseModule), RbacModule
    - Provide TeamsService, export TeamsService (needed by future projects module)

    **Update app.module.ts:**
    - Import TeamsModule

    **Update main.ts:**
    - Add 'teams' to Swagger tags

    All mutations must emit events for audit logging (use existing AuditEventPayload pattern from Phase 1). Include entityType: 'Organization' or 'Membership', action: 'TEAM_CREATED', 'MEMBER_INVITED', 'MEMBER_REMOVED'.
  </action>
  <verify>
    Start API: `cd apps/api && npm run start:dev`. Test with curl:
    1. POST /teams with valid JWT → 201 (team created, creator is admin member)
    2. GET /teams with valid JWT → 200 (list of user's teams)
    3. GET /teams/:id → 200 (team with members)
    4. GET /teams/:id/members → 200 (member list)
    5. POST /teams/:id/members with email → 201 (member invited) — need second user
    6. DELETE /teams/:id/members/:userId as non-admin → 403
    7. Swagger at /api/docs shows teams endpoints
  </verify>
  <done>Teams API fully functional: create team, list teams, view team, invite member, remove member (admin only), list members. All mutations emit audit events. Organization scoping enforced.</done>
</task>

</tasks>

<verification>
1. API starts without errors
2. All 6 team endpoints respond correctly
3. Organization scoping prevents cross-team data access
4. Admin-only operations return 403 for non-admins
5. Audit events emitted for team mutations
6. Swagger documentation updated with teams tag
</verification>

<success_criteria>
- TEAM-01: User can create a team/workspace
- TEAM-02: User can invite members to their team
- TEAM-03: User can view all team members and their roles
- TEAM-04: Admin can remove members from team
- Organization-scoped RBAC ready for downstream plans
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-work-management/02-02-SUMMARY.md`
</output>
